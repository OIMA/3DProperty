Array.forEach||(Array.forEach=function(a,c,b){for(var d=a.length,e=0;e<d;e++)e in a&&c.call(b,a[e],e,a)});Array.map||(Array.map=function(a,c,b){for(var d=a.length,e=[],f=0;f<d;f++)f in a&&(e[f]=c.call(b,a[f],f,a));return e});Array.filter||(Array.filter=function(a,c,b){for(var d=a.length,e=[],f=0;f<d;f++)if(f in a){var g=a[f];c.call(b,g,f,a)&&e.push(g)}return e});
var x3dom={canvases:[],x3dNS:"http://www.web3d.org/specifications/x3d-namespace",x3dextNS:"http://philip.html5.org/x3d/ext",xsltNS:"http://www.w3.org/1999/XSL/x3dom.Transform",xhtmlNS:"http://www.w3.org/1999/xhtml",nodeTypes:{},nodeTypesLC:{},components:{},geoCache:[]};x3dom.caps={PLATFORM:navigator.platform,AGENT:navigator.userAgent};
x3dom.registerNodeType=function(a,c,b){void 0===x3dom.components[c]&&(x3dom.components[c]={});b._typeName=a;b._compName=c;x3dom.components[c][a]=b;x3dom.nodeTypes[a]=b;x3dom.nodeTypesLC[a.toLowerCase()]=b};x3dom.isX3DElement=function(a){return a.nodeType===Node.ELEMENT_NODE&&a.localName&&(x3dom.nodeTypes[a.localName]||x3dom.nodeTypesLC[a.localName.toLowerCase()]||"x3d"===a.localName.toLowerCase()||"websg"===a.localName.toLowerCase()||"scene"===a.localName.toLowerCase()||"route"===a.localName.toLowerCase())};
x3dom.extend=function(a){function c(){}c.prototype=a.prototype||a;return new c};x3dom.getStyle=function(a,c){var b="";document.defaultView.getComputedStyle&&document.defaultView.getComputedStyle(a,null)?b=document.defaultView.getComputedStyle(a,null).getPropertyValue(c):a.currentStyle&&(c=c.replace(/\-(\w)/g,function(a,c){return c.toUpperCase()}),b=a.currentStyle[c]);return b};
function defineClass(a,c,b){function d(){}a&&(d.prototype=a.prototype,c.prototype=new d,c.prototype.constructor=c,c.superClass=a);if(b)for(var e in b)c.prototype[e]=b[e];return c}x3dom.isa=function(a,c){function b(a){return a===c?!0:a.prototype&&a.prototype.constructor&&a.prototype.constructor.superClass?b(a.prototype.constructor.superClass):!1}return a?a.constructor===c?!0:void 0===a.constructor.superClass?!1:b(a.constructor.superClass):!1};x3dom.getGlobal=function(){return function(){return this}.call(null)};
x3dom.loadJS=function(a,c,b){if(!1===b?b:1){if(a=c?c.trim()+a:a,c=new XMLHttpRequest)c.open("GET",a,!1),c.send(null),eval(c.responseText)}else{b=document.getElementsByTagName("HEAD").item(0);var d=document.createElement("script");a=c?c.trim()+a:a;b?(x3dom.debug.logError("Trying to load external JS file: "+a),d.type="text/javascript",d.src=a,b.appendChild(d,b.firstChild)):alert("No document object found. Can't load components!")}};
function array_to_object(a){for(var c={},b=0;b<a.length;b++)c[a[b]]="";return c}window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a,c){window.setTimeout(a,16)}}();
x3dom.toggleFullScreen=function(){if(document.fullScreen||document.mozFullScreen||document.webkitIsFullScreen)document.cancelFullScreen?document.cancelFullScreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen();else{var a=document.documentElement;a.requestFullScreen?a.requestFullScreen():a.mozRequestFullScreen?a.mozRequestFullScreen():a.webkitRequestFullScreen&&a.webkitRequestFullScreen()}};
x3dom.debug={INFO:"INFO",WARNING:"WARNING",ERROR:"ERROR",EXCEPTION:"EXCEPTION",isActive:!1,isFirebugAvailable:!1,isSetup:!1,isAppend:!1,numLinesLogged:0,maxLinesToLog:1E4,logContainer:null,setup:function(){if(!x3dom.debug.isSetup){try{void 0!==window.console.firebug&&(x3dom.debug.isFirebugAvailable=!0)}catch(a){x3dom.debug.isFirebugAvailable=!1}x3dom.debug.setupLogContainer();x3dom.debug.isSetup=!0}},activate:function(a){x3dom.debug.isActive=!0;x3dom.debug.logContainer.style.display=a?"block":"none";
x3dom.debug.isAppend||("Microsoft Internet Explorer"==navigator.appName?(x3dom.debug.logContainer.style.marginLeft="8px",document.documentElement.appendChild(x3dom.debug.logContainer)):document.body.appendChild(x3dom.debug.logContainer),x3dom.debug.isAppend=!0)},setupLogContainer:function(){x3dom.debug.logContainer=document.createElement("div");x3dom.debug.logContainer.id="x3dom_logdiv";x3dom.debug.logContainer.setAttribute("class","x3dom-logContainer");x3dom.debug.logContainer.style.clear="both"},
doLog:function(a,c){if(x3dom.debug.isActive&&(x3dom.debug.numLinesLogged===x3dom.debug.maxLinesToLog&&(a="Maximum number of log lines (="+x3dom.debug.maxLinesToLog+") reached. Deactivating logging..."),!(x3dom.debug.numLinesLogged>x3dom.debug.maxLinesToLog))){var b=document.createElement("p");b.style.margin=0;switch(c){case x3dom.debug.INFO:b.style.color="#00ff00";break;case x3dom.debug.WARNING:b.style.color="#cd853f";break;case x3dom.debug.ERROR:b.style.color="#ff4500";break;case x3dom.debug.EXCEPTION:b.style.color=
"#ffff00";break;default:b.style.color="#00ff00"}try{b.innerHTML=c+": "+a,x3dom.debug.logContainer.insertBefore(b,x3dom.debug.logContainer.firstChild)}catch(d){void 0!==window.console.firebug&&window.console.warn(a)}if(x3dom.debug.isFirebugAvailable)switch(c){case x3dom.debug.INFO:window.console.info(a);break;case x3dom.debug.WARNING:window.console.warn(a);break;case x3dom.debug.ERROR:window.console.error(a);break;case x3dom.debug.EXCEPTION:window.console.debug(a)}x3dom.debug.numLinesLogged++}},logInfo:function(a){x3dom.debug.doLog(a,
x3dom.debug.INFO)},logWarning:function(a){x3dom.debug.doLog(a,x3dom.debug.WARNING)},logError:function(a){x3dom.debug.doLog(a,x3dom.debug.ERROR)},logException:function(a){x3dom.debug.doLog(a,x3dom.debug.EXCEPTION)},assert:function(a,c){a||x3dom.debug.doLog("Assertion failed in "+x3dom.debug.assert.caller.name+": "+c,x3dom.debug.ERROR)},typeOf:function(a){var c=typeof a;return"object"!==c||a?c:"null"},exists:function(a,c,b){b=b||"function";return(a?this.typeOf(a[c]):"null")===b},dumpFields:function(a){var c=
"",b;for(b in a)c+=b+", ";c+="\n";x3dom.debug.logInfo(c);return c}};x3dom.debug.setup();x3dom.arc={};x3dom.arc.instance=null;x3dom.arc.Limits=function(a,c,b){this._min=a;this._max=c;this.getValue=function(a){a=this._min+(this._max-this._min)*a;return this._max>=a?this._min<=a?a:this._min:this._max}};
x3dom.arc.ARF=function(a,c,b,d,e,f,g,h){this._name=a;this._stateValue=[0.5,0.5];this._limits=new x3dom.arc.Limits(c,b);this._factorGetterFunc=e;this._factorSetterFunc=f;this._setterFunc=h;this._getterFunc=g;this._dirFac=d;this.getFactor=function(){return this._factorGetterFunc()};this.update=function(a,c){var b=this._stateValue[a]+c*this._dirFac;this._stateValue[a]=0<=b?1>=b?b:1:0;this._setterFunc(this._limits.getValue(this._stateValue[a]))};this.reset=function(){this._stateValue[0]=0.5;this._stateValue[1]=
0.5}};
x3dom.arc.AdaptiveRenderControl=defineClass(null,function(a){x3dom.arc.instance=this;this._scene=a;this._targetFrameRate=[];this._targetFrameRate[0]=this._scene._vf.minFrameRate;this._targetFrameRate[1]=this._scene._vf.maxFrameRate;this._currentState=0;var c=this._scene.getEnvironment();this._arfs=[];this._arfs.push(new x3dom.arc.ARF("smallFeatureCulling",0,10,-1,function(){return c._vf.smallFeatureFactor},function(a){c._vf.smallFeatureFactor=a},function(){return c._vf.smallFeatureThreshold},function(a){c._vf.smallFeatureThreshold=
a}));this._arfs.push(new x3dom.arc.ARF("lowPriorityCulling",0,100,1,function(){return c._vf.lowPriorityFactor},function(a){c._vf.lowPriorityFactor=a},function(){return 100*c._vf.lowPriorityThreshold},function(a){c._vf.lowPriorityThreshold=a/100}));this._arfs.push(new x3dom.arc.ARF("tessellationDetailCulling",1,12,-1,function(){return c._vf.tessellationErrorFactor},function(a){c._vf.tessellationErrorFactor=a},function(){return c.tessellationErrorThreshold},function(a){c.tessellationErrorThreshold=
a}));this._stepWidth=0.1},{update:function(a,c){this._currentState=a;var b=c-this._targetFrameRate[a];this._stepWidth=10<Math.abs(b)?0.1:0.01;var d=0,e=[],f,g=this._arfs.length;for(f=0;f<g;++f)e[f]=this._arfs[f].getFactor(),0<e[f]&&(d+=e[f]);b=0>b?-1:1;for(f=0;f<g;++f)0<e[f]&&(e[f]/=d,this._arfs[f].update(a,this._stepWidth*e[f]*b))},reset:function(){for(var a=0,c=this._arfs.length;a<c;++a)this._arfs[a].reset()}});
var Request=function(a,c,b){this.url=a;this.priority=b;this.xhr=new XMLHttpRequest;this.onloadCallbacks=[c];var d=this;this.xhr.onload=function(){x3dom.DownloadManager.debugOutput&&x3dom.debug.logInfo("Download manager received data for URL '"+d.url+"'.");--x3dom.DownloadManager.activeDownloads;if(!1===x3dom.DownloadManager.stallToKeepOrder||!1===x3dom.DownloadManager.resultGetsStalled(d.priority)){var a;for(a=0;a<d.onloadCallbacks.length;++a)d.onloadCallbacks[a](d.xhr.response);x3dom.DownloadManager.removeDownload(d);
x3dom.DownloadManager.updateStalledResults()}else x3dom.DownloadManager.debugOutput&&x3dom.debug.logInfo("Download manager stalled downloaded result for URL '"+d.url+"'.");x3dom.DownloadManager.tryNextDownload()}};Request.prototype.send=function(){this.xhr.open("GET",encodeURI(this.url),!0);this.xhr.responseType="arraybuffer";this.xhr.send(null);x3dom.DownloadManager.debugOutput&&x3dom.debug.logInfo("Download manager posted XHR for URL '"+this.url+"'.")};
x3dom.DownloadManager={requests:[],maxDownloads:6,activeDownloads:0,debugOutput:!1,stallToKeepOrder:!1,toggleDebugOutput:function(a){this.debugOutput=a},toggleStrictReturnOrder:function(a){this.stallToKeepOrder=!1},removeDownload:function(a){var c,b,d=!1;for(c=0;c<this.requests.length&&!d;++c)if(this.requests[c])for(b=0;b<this.requests[c].length;++b)if(this.requests[c][b]===a){this.requests[c].splice(b,1);d=!0;break}},tryNextDownload:function(){var a,c,b;if(this.activeDownloads<this.maxDownloads){for(c=
0;c<this.requests.length&&!a;++c)if(this.requests[c])for(b=0;b<this.requests[c].length;++b)if(this.requests[c][b].xhr.readyState===XMLHttpRequest.UNSENT){a=this.requests[c][b];break}a&&(a.send(),++this.activeDownloads)}},resultGetsStalled:function(a){var c;for(c=0;c<a;++c)if(this.requests[c]&&this.requests[c].length)return!0;return!1},updateStalledResults:function(){if(x3dom.DownloadManager.stallToKeepOrder){var a,c,b,d,e=!1;for(a=0;a<this.requests.length&&!e;++a)if(this.requests[a])for(c=0;c<this.requests[a].length;++c)if(d=
this.requests[a][c],d.xhr.readyState===XMLHttpRequest.DONE){x3dom.DownloadManager.debugOutput&&x3dom.debug.logInfo("Download manager releases stalled result for URL '"+d.url+"'.");for(b=0;b<d.onloadCallbacks.length;++b)d.onloadCallbacks[b](d.xhr.response);this.requests[a].splice(c,1)}else e=!0}},get:function(a,c,b){var d,e,f,g=!1,h,k,l;if(a.length!==c.length||a.length!==b.length)x3dom.debug.logError("DownloadManager: The number of given urls, onload callbacks and priorities is not equal. Ignoring requests.");
else{for(f=0;f<a.length;++f)if(void 0===!c[f]||void 0===!b[f])x3dom.debug.logError('DownloadManager: No onload callback and / or priority specified. Ignoring request for "'+h+'"');else{h=a[f];k=c[f];l=b[f];for(d=0;d<this.requests.length&&!g;++d)if(this.requests[d])for(e=0;e<this.requests[d].length;++e)if(this.requests[d][e].url===h){this.requests[d][e].onloadCallbacks.push(k);x3dom.DownloadManager.debugOutput&&x3dom.debug.logInfo("Download manager appended onload callback for URL '"+h+"' to a registered request using the same URL.");
g=!0;break}g||(d=new Request(h,k,l),this.requests[l]?this.requests[l].push(d):this.requests[l]=[d])}for(d=0;d<a.length&&this.activeDownloads<this.maxDownloads;++d)this.tryNextDownload()}}};var JOB_WAITING_FOR_DATA=0,JOB_DATA_AVAILABLE=1,JOB_GETTING_PROCESSED=2,JOB_FINISHED=3;
x3dom.RefinementJobManager=function(){var a=this;"undefined"!==typeof Worker?(this.worker=new Worker((new x3dom.RefinementJobWorker).toBlob()),this.worker.postMessage=this.worker.webkitPostMessage||this.worker.postMessage,this.worker.addEventListener("message",function(c){return a.messageFromWorker(c)},!1)):x3dom.RefinementJobManager.suppressOnWorkersNotSupported||(x3dom.RefinementJobManager.suppressOnWorkersNotSupported=!0,x3dom.RefinementJobManager.onWorkersNotSupported());this.attributes=[]};
x3dom.RefinementJobManager.suppressOnTransferablesNotSupported=!0;x3dom.RefinementJobManager.suppressOnWorkersNotSupported=!1;x3dom.RefinementJobManager.onTransferablesNotSupported=function(){alert("Your browser does not support transferables.\nThis application might run slower than expected due to data cloning operations.")};x3dom.RefinementJobManager.onWorkersNotSupported=function(){alert("WebWorkers are not supported by your browser. Unable to use RefinementJobManager.")};
x3dom.RefinementJobManager.prototype.addResultBuffer=function(a,c){this.attributes[a]={resultBuffer:c.buffer,resultBufferBytesPerElement:c.BYTES_PER_ELEMENT,jobs:[]}};
x3dom.RefinementJobManager.prototype.addRefinementJob=function(a,c,b,d,e,f,g,h,k,l){var n=this;this.attributes[a].jobs.push({priority:c,url:b,level:d,finishedCallback:e,stride:f,numComponentsList:g,bitsPerLevelList:h,readOffsetList:k,writeOffsetList:l,state:JOB_WAITING_FOR_DATA,dataBuffer:{}});var q;(function(a,c){q=function(b){n.jobInputDataLoaded(a,c,b)}})(a,b);x3dom.DownloadManager.get([b],[q],[c])};
x3dom.RefinementJobManager.prototype.jobInputDataLoaded=function(a,c,b){var d,e=this.attributes[a].jobs;for(d=0;d<e.length;++d)e[d].url===c&&(e[d].state=JOB_DATA_AVAILABLE,e[d].dataBuffer=b,this.tryNextJob(a))};
x3dom.RefinementJobManager.prototype.tryNextJob=function(a){var c,b=this.attributes[a].jobs,d=!0,e=-1;for(c=0;c<b.length;++c){if(b[c].state===JOB_GETTING_PROCESSED){d=!1;break}-1===e&&b[c].state===JOB_DATA_AVAILABLE&&(e=c)}d&&-1!==e&&(c=b[e],c.state=JOB_GETTING_PROCESSED,this.worker.postMessage({msg:"processJob",attributeId:a,level:c.level,stride:c.stride,numComponentsList:c.numComponentsList,bitsPerLevelList:c.bitsPerLevelList,readOffsetList:c.readOffsetList,writeOffsetList:c.writeOffsetList,resultBufferBytesPerElement:this.attributes[a].resultBufferBytesPerElement,
dataBuffer:c.dataBuffer,resultBuffer:this.attributes[a].resultBuffer},[c.dataBuffer,this.attributes[a].resultBuffer]),(0<c.dataBuffer.byteLength||0<this.attributes[a].resultBuffer.byteLength)&&!x3dom.RefinementJobManager.suppressOnTransferablesNotSupported&&(x3dom.RefinementJobManager.suppressOnTransferablesNotSupported=!0,x3dom.RefinementJobManager.onTransferablesNotSupported()))};
x3dom.RefinementJobManager.prototype.processedDataAvailable=function(a,c){var b,d=this.attributes[a].jobs;this.attributes[a].resultBuffer=c;for(b=0;b<d.length;++b)if(d[b].state===JOB_GETTING_PROCESSED){d[b].state=JOB_FINISHED;d[b].finishedCallback(a,this.getBufferView(a));break}};x3dom.RefinementJobManager.prototype.continueProcessing=function(a){this.tryNextJob(a)};
x3dom.RefinementJobManager.prototype.messageFromWorker=function(a){if(a.data.msg)switch(a.data.msg){case "jobFinished":this.processedDataAvailable(a.data.attributeId,a.data.resultBuffer);break;case "log":x3dom.debug.logInfo("Message from Worker Context: "+a.data.txt)}};
x3dom.RefinementJobManager.prototype.getBufferView=function(a){a=this.attributes[a];switch(a.resultBufferBytesPerElement){case 1:return new Uint8Array(a.resultBuffer);case 2:return new Uint16Array(a.resultBuffer);case 4:return new Uint32Array(a.resultBuffer);default:x3dom.debug.logError("Unable to create BufferView: the given number of "+a.resultBufferBytesPerElement+" bytes per element does not match any Uint buffer type.")}};
URL="undefined"!==typeof URL?URL:"undefined"!==typeof webkitURL?webkitURL:void 0;x3dom.RefinementJobWorker=function(){};x3dom.RefinementJobWorker.prototype.subtract=function(a,c){return[a[0]-c[0],a[1]-c[1],a[2]-c[2]]};x3dom.RefinementJobWorker.prototype.normalize=function(a){var c=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]),c=1/c;return[a[0]*c,a[1]*c,a[2]*c]};x3dom.RefinementJobWorker.prototype.cross=function(a,c){return[a[1]*c[2]-a[2]*c[1],a[2]*c[0]-a[0]*c[2],a[0]*c[1]-a[1]*c[0]]};
x3dom.RefinementJobWorker.prototype.log=function(a){postMessage({msg:"log",txt:a})};
x3dom.RefinementJobWorker.prototype.processJob=function(a,c,b,d,e,f,g,h,k){2===d.length&&3===d[0]&&2===d[1]&&6===e[0]&&2===e[1]?(b=8*k.BYTES_PER_ELEMENT-2-2*c,c=8*k.BYTES_PER_ELEMENT-1-1*c,addBits_3x2_2x1(h,k,b,c)):2===d.length&&3===d[0]&&3===d[1]&&6===e[0]&&0===e[1]?(b=8*k.BYTES_PER_ELEMENT-2-2*c,addBits_3x2_3x2_computeNormals(h,k,b)):addBits(c,b,d,e,f,g,h,k);postMessage({msg:"jobFinished",attributeId:a,resultBuffer:k.buffer},[k.buffer])};
x3dom.RefinementJobWorker.prototype.onmessage=function(a){var c,b;if(a.data.msg)switch(a.data.msg){case "processJob":for(c=b=0;c<a.data.bitsPerLevelList.length;++c)b+=a.data.bitsPerLevelList[c];b=Math.ceil(b/8);processJob(a.data.attributeId,a.data.level,a.data.stride,a.data.numComponentsList,a.data.bitsPerLevelList,a.data.readOffsetList,a.data.writeOffsetList,getBufferView(b,a.data.dataBuffer),getBufferView(a.data.resultBufferBytesPerElement,a.data.resultBuffer))}};
x3dom.RefinementJobWorker.prototype.getBufferView=function(a,c){switch(a){case 1:return new Uint8Array(c);case 2:return new Uint16Array(c);case 4:return new Uint32Array(c);default:log("ERROR: The estimated element length of "+a+" bytes does not match any known Uint buffer type.")}};
x3dom.RefinementJobWorker.prototype.addBits_3x2_2x1=function(a,c,b,d){var e=0,f=a.length,g,h,k,l,n;for(g=0;g<f;++g)h=a[g],k=(h&192)>>>6,k<<=b,l=(h&48)>>>4,l<<=b,n=(h&12)>>>2,n<<=b,c[e++]|=k,c[e++]|=l,c[e++]|=n,++e,k=(h&2)>>>1,k<<=d,h&=1,h<<=d,c[e++]|=k,c[e++]|=h};
x3dom.RefinementJobWorker.prototype.addBits_3x2_3x2_computeNormals=function(a,c,b){var d=0,e=a.length,f,g,h,k,l=0,n=[];for(f=0;f<e;++f)g=a[f],h=(g&192)>>>6,h<<=b,k=(g&48)>>>4,k<<=b,g=(g&12)>>>2,g<<=b,c[d++]|=h,c[d++]|=k,c[d++]|=g,n[l]=[c[d-3],c[d-2],c[d-1]],++d,3===++l&&(l=0,h=this.normalize(this.subtract(n[1],n[0])),k=this.normalize(this.subtract(n[2],n[0])),g=this.normalize(this.cross(h,k)),h=32767*g[0]+32767,k=32767*g[1]+32767,g=32767*g[2]+32767,c[d]=h,c[d+1]=k,c[d+2]=g,c[d-8]=h,c[d+1-8]=k,c[d+
2-8]=g,c[d-16]=h,c[d+1-16]=k,c[d+2-16]=g),d+=4};
x3dom.RefinementJobWorker.prototype.addBits=function(a,c,b,d,e,f,g,h){var k,l,n,q=[],m,p=[],s,t=[],w=b.length,z=c/(8*h.BYTES_PER_ELEMENT),u;for(c=0;c<w;++c){l=b[c];u=d[c]/b[c];n=8*g.BYTES_PER_ELEMENT-e[c]-u*l;t[c]=8*h.BYTES_PER_ELEMENT-u-a*u;m=[];s=[];for(k=0;k<l;++k)s[k]=n+(l-k-1)*u,m[k]=0|Math.pow(2,u)-1,m[k]<<=s[k];q.push(m);p.push(s)}n=g.length;var v,r;for(a=0;a<w;++a)for(l=b[a],u=f[a]/(8*h.BYTES_PER_ELEMENT),m=q[a],s=p[a],e=t[a],c=0;c<n;++c){d=g[c];for(k=0;k<l;++k)r=d&m[k],r>>>=s[k],r<<=e,v=
u+k,h[v]|=r;u+=z}};x3dom.RefinementJobWorker.prototype.toBlob=function(){var a;a='postMessage = (typeof webkitPostMessage !== "undefined") ? webkitPostMessage : postMessage;\n';for(var c in this)this[c]!=x3dom.RefinementJobWorker.prototype.toBlob&&(a+=c+" = ",a=this[c]instanceof String?a+('"'+this[c]+'"'):this[c]instanceof Array?a+"[];\n":a+(this[c]+";\n"));a=new Blob([a]);return URL.createObjectURL(a)};x3dom.Properties=function(){this.properties={}};
x3dom.Properties.prototype.setProperty=function(a,c){x3dom.debug.logInfo("Properties: Setting property '"+a+"' to value '"+c+"'");this.properties[a]=c};x3dom.Properties.prototype.getProperty=function(a,c){return this.properties[a]?this.properties[a]:c};x3dom.Properties.prototype.merge=function(a){for(var c in a.properties)this.properties[c]=a.properties[c]};x3dom.Properties.prototype.toString=function(){var a="",c;for(c in this.properties)a+="Name: "+c+" Value: "+this.properties[c]+"\n";return a};
x3dom.DoublyLinkedList=function(){this.length=0;this.last=this.first=null};x3dom.DoublyLinkedList.ListNode=function(a,c,b,d,e){this.point=a;this.point_index=c;this.normals=b;this.colors=d;this.texCoords=e;this.prev=this.next=null};x3dom.DoublyLinkedList.prototype.appendNode=function(a){null===this.first?(a.prev=a,this.first=a.next=a):(a.prev=this.last,a.next=this.first,this.first.prev=a,this.last.next=a);this.last=a;this.length++};
x3dom.DoublyLinkedList.prototype.insertAfterNode=function(a,c){c.prev=a;c.next=a.next;a.next.prev=c;a.next=c;c.prev==this.last&&(this.last=c);this.length++};x3dom.DoublyLinkedList.prototype.deleteNode=function(a){1<this.length?(a.prev.next=a.next,a.next.prev=a.prev,a==this.first&&(this.first=a.next),a==this.last&&(this.last=a.prev)):this.last=this.first=null;a.prev=null;a.next=null;this.length--};
x3dom.DoublyLinkedList.prototype.getNode=function(a){var c=null;if(a>this.length)return c;for(var b=0;b<this.length;b++)if(c=0==b?this.first:c.next,b==a)return c;return null};x3dom.DoublyLinkedList.prototype.invert=function(){for(var a=null,c=this.first,b=0;b<this.length;b++)a=c.prev,c.prev=c.next,c.next=a,c=c.prev;a=this.first;this.first=this.last;this.last=a};
x3dom.EarClipping={reversePointDirection:function(a,c){var b,d,e=0;d=0;var f,g;if(3>a.length)return!1;for(var h=0;h<a.length;h++)b=(h+1)%a.length,d=(h+2)%a.length,f=a.getNode(h),b=a.getNode(b),g=a.getNode(d),"YZ"==c?(d=(b.point.y-f.point.y)*(g.point.z-b.point.z),d-=(b.point.z-f.point.z)*(g.point.y-b.point.y)):"XZ"==c?(d=(b.point.z-f.point.z)*(g.point.x-b.point.x),d-=(b.point.x-f.point.x)*(g.point.z-b.point.z)):(d=(b.point.x-f.point.x)*(g.point.y-b.point.y),d-=(b.point.y-f.point.y)*(g.point.x-b.point.x)),
0>d?e--:e++;return 0>e?(a.invert(),!0):!1},getIndexes:function(a){for(var c=a.first.next,b=this.identifyPlane(c.prev.point,c.point,c.next.point),d=this.reversePointDirection(a,b),e=[],c=a.first.next,f=null,g=0,h=!0;3<=a.length&&15>g;){for(var f=c.next,k=0;k<a.length;k++)this.isNotEar(a.getNode(k).point,c.prev.point,c.point,c.next.point,b)&&(h=!1);h&&(this.isKonvex(c.prev.point,c.point,c.next.point,b)?(e.push(c.prev.point_index,c.point_index,c.next.point_index),a.deleteNode(c)):g++);c=f;h=!0}return d?
e.reverse():e},getMultiIndexes:function(a){for(var c=a.first.next,b=this.identifyPlane(c.prev.point,c.point,c.next.point),d=this.reversePointDirection(a,b),e={indices:[],point:[],normals:[],colors:[],texCoords:[]},c=a.first.next,f=null,g=0,h=!0;3<=a.length&&15>g;){for(var f=c.next,k=0;k<a.length;k++)this.isNotEar(a.getNode(k).point,c.prev.point,c.point,c.next.point,b)&&(h=!1);h&&(this.isKonvex(c.prev.point,c.point,c.next.point,b)?(e.indices.push(c.prev.point_index,c.point_index,c.next.point_index),
e.point.push(c.prev.point,c.point,c.next.point),c.normals&&e.normals.push(c.prev.normals,c.normals,c.next.normals),c.colors&&e.colors.push(c.prev.colors,c.colors,c.next.colors),c.texCoords&&e.texCoords.push(c.prev.texCoords,c.texCoords,c.next.texCoords),a.deleteNode(c)):g++);c=f;h=!0}d&&(e.indices=e.indices.reverse(),e.point=e.point.reverse(),e.normals=e.normals.reverse(),e.colors=e.colors.reverse(),e.texCoords=e.texCoords.reverse());return e},isNotEar:function(a,c,b,d,e){var f,g,h,k;"YZ"==e?(e=a.y,
a=a.z,g=c.y,c=c.z,f=b.y,h=b.z,b=d.y,k=d.z):"XZ"==e?(e=a.z,a=a.x,g=c.z,c=c.x,f=b.z,h=b.x,b=d.z,k=d.x):(e=a.x,a=a.y,g=c.x,c=c.y,f=b.x,h=b.y,b=d.x,k=d.y);d=(f-g)*(k-c)-(b-g)*(h-c);return 0!=d?(f=((f-e)*(k-a)-(b-e)*(h-a))/d,e=((b-e)*(c-a)-(g-e)*(k-a))/d,0<f&&0<e&&0<1-f-e):!1},isKonvex:function(a,c,b,d){var e,f;"YZ"==d?(d=a.y,a=a.z,e=c.y,c=c.z,f=b.y,b=b.z):"XZ"==d?(d=a.z,a=a.x,e=c.z,c=c.x,f=b.z,b=b.x):(d=a.x,a=a.y,e=c.x,c=c.y,f=b.x,b=b.y);return 0<=(e-d)*(b-a)-(c-a)*(f-d)},identifyPlane:function(a,c,b){var d,
e,f,g;d=c.x-a.x;e=c.y-a.y;f=c.z-a.z;c=b.x-a.x;g=b.y-a.y;b=b.z-a.z;a=Math.abs(e*b-f*g);f=Math.abs(f*c-d*b);d=Math.abs(d*g-e*c);e=Math.max(a,f,d);return e==a?"YZ":e==f?"XZ":e==d?"XY":"XZ"}};x3dom.Utils={};x3dom.Utils.maxIndexableCoords=65535;x3dom.Utils.measurements=[];window.performance=window.performance||{};performance.now=function(){return performance.now||performance.mozNow||performance.msNow||performance.oNow||performance.webkitNow||function(){return(new Date).getTime()}}();
x3dom.Utils.startMeasure=function(a){a=a.toUpperCase();x3dom.Utils.measurements[a]||(x3dom.Utils.measurements[a]=performance&&performance.now?performance.now():(new Date).getTime())};x3dom.Utils.stopMeasure=function(a){a=a.toUpperCase();if(x3dom.Utils.measurements[a]){var c=x3dom.Utils.measurements[a];delete x3dom.Utils.measurements[a];return performance&&performance.now?performance.now()-c:(new Date).getTime()-c}return 0};x3dom.Utils.isNumber=function(a){return!isNaN(parseFloat(a))&&isFinite(a)};
x3dom.Utils.createTexture2D=function(a,c,b,d,e,f){var g=a.createTexture(),h=new Uint8Array([0,0,0,255,0,0,0,255,0,0,0,255,0,0,0,255]);a.bindTexture(a.TEXTURE_2D,g);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,2,2,0,a.RGBA,a.UNSIGNED_BYTE,h);a.bindTexture(a.TEXTURE_2D,null);g.ready=!1;if(null==b||""==b)return g;var k=new Image;k.crossOrigin=e?"use-credentials":"";k.src=b;c.downloadCount++;k.onload=function(){f&&(k=x3dom.Utils.scaleImage(k));!0==d&&a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0);a.bindTexture(a.TEXTURE_2D,
g);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,k);a.bindTexture(a.TEXTURE_2D,null);!0==d&&a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!1);g.width=k.width;g.height=k.height;g.ready=!0;c.downloadCount--;c.needRender=!0};k.onerror=function(){x3dom.debug.logError("[Utils|createTexture2D] Can't load Image: "+b);c.downloadCount--};return g};
x3dom.Utils.createTextureCube=function(a,c,b,d,e,f){var g=a.createTexture(),h;h=d?[a.TEXTURE_CUBE_MAP_POSITIVE_Z,a.TEXTURE_CUBE_MAP_NEGATIVE_Z,a.TEXTURE_CUBE_MAP_POSITIVE_Y,a.TEXTURE_CUBE_MAP_NEGATIVE_Y,a.TEXTURE_CUBE_MAP_POSITIVE_X,a.TEXTURE_CUBE_MAP_NEGATIVE_X]:[a.TEXTURE_CUBE_MAP_NEGATIVE_Z,a.TEXTURE_CUBE_MAP_POSITIVE_Z,a.TEXTURE_CUBE_MAP_NEGATIVE_Y,a.TEXTURE_CUBE_MAP_POSITIVE_Y,a.TEXTURE_CUBE_MAP_NEGATIVE_X,a.TEXTURE_CUBE_MAP_POSITIVE_X];g.ready=!1;g.pendingTextureLoads=-1;g.textureCubeReady=
!1;for(var k=0,l=0,n=0;n<h.length;n++){var q=h[n],m=new Image;m.crossOrigin=e?"use-credentials":"";g.pendingTextureLoads++;c.downloadCount++;m.onload=function(b,d,e,g){return function(){0==k&&0==l?(k=e.width,l=e.height):!f||k==e.width&&l==e.height||(x3dom.debug.logWarning("[Utils|createTextureCube] Rescaling CubeMap images, which are of different size!"),e=x3dom.Utils.rescaleImage(e,k,l));a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,g);a.bindTexture(a.TEXTURE_CUBE_MAP,b);a.texImage2D(d,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,
e);a.bindTexture(a.TEXTURE_CUBE_MAP,null);a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!1);b.pendingTextureLoads--;c.downloadCount--;0>b.pendingTextureLoads&&(b.textureCubeReady=!0,x3dom.debug.logInfo("[Utils|createTextureCube] Loading CubeMap finished..."),c.needRender=!0)}}(g,q,m,d);m.onerror=function(){c.downloadCount--;x3dom.debug.logError("[Utils|createTextureCube] Can't load CubeMap!")};m.src=b[n]}return g};
x3dom.Utils.getFileName=function(a){return-1<a.lastIndexOf("/")?a.substr(a.lastIndexOf("/")+1):-1<a.lastIndexOf("\\")?a.substr(a.lastIndexOf("\\")+1):a};x3dom.Utils.findTextureByName=function(a,c){for(var b=0;b<a.length;++b)if(c==a[b].samplerName)return a[b];return!1};x3dom.Utils.rescaleImage=function(a,c,b){var d=document.createElement("canvas");d.width=c;d.height=b;d.getContext("2d").drawImage(a,0,0,a.width,a.height,0,0,d.width,d.height);return d};
x3dom.Utils.scaleImage=function(a){if(!x3dom.Utils.isPowerOfTwo(a.width)||!x3dom.Utils.isPowerOfTwo(a.height)){var c=document.createElement("canvas");c.width=x3dom.Utils.nextHighestPowerOfTwo(a.width);c.height=x3dom.Utils.nextHighestPowerOfTwo(a.height);c.getContext("2d").drawImage(a,0,0,a.width,a.height,0,0,c.width,c.height);a=c}return a};x3dom.Utils.isPowerOfTwo=function(a){return 0===(a&a-1)};x3dom.Utils.nextHighestPowerOfTwo=function(a){--a;for(var c=1;32>c;c<<=1)a|=a>>c;return a+1};
x3dom.Utils.nextBestPowerOfTwo=function(a){a=Math.log(a)/0.693147180559945;return Math.pow(2,Math.round(a))};x3dom.Utils.getDataTypeSize=function(a){switch(a){case "Int8":case "Uint8":return 1;case "Int16":case "Uint16":return 2;case "Int32":case "Uint32":case "Float32":return 4;default:return 8}};x3dom.Utils.getOffsetMultiplier=function(a,c){switch(a){case c.UNSIGNED_SHORT:return 1;case c.UNSIGNED_INT:return 2;case c.UNSIGNED_BYTE:return 0.5;default:return 1}};
x3dom.Utils.getByteAwareOffset=function(a,c,b){switch(c){case b.UNSIGNED_SHORT:return 2*a;case b.UNSIGNED_INT:return 4*a;case b.UNSIGNED_BYTE:return a;default:return 2*a}};
x3dom.Utils.getVertexAttribType=function(a,c){var b=c.NONE;switch(a){case "Int8":b=c.BYTE;break;case "Uint8":b=c.UNSIGNED_BYTE;break;case "Int16":b=c.SHORT;break;case "Uint16":b=c.UNSIGNED_SHORT;break;case "Int32":b=c.INT;break;case "Uint32":b=c.UNSIGNED_INT;break;case "Float32":b=c.FLOAT;break;default:x3dom.debug.logError("Can't find this.gl data type for "+a+", getting FLOAT..."),b=c.FLOAT}return b};
x3dom.Utils.getArrayBufferView=function(a,c){var b=null;switch(a){case "Int8":b=new Int8Array(c);break;case "Uint8":b=new Uint8Array(c);break;case "Int16":b=new Int16Array(c);break;case "Uint16":b=new Uint16Array(c);break;case "Int32":b=new Int32Array(c);break;case "Uint32":b=new Uint32Array(c);break;case "Float32":b=new Float32Array(c);break;case "Float64":b=new Float64Array(c);break;default:x3dom.debug.logError("Can't create typed array view of type "+a+", trying Float32..."),b=new Float32Array(c)}return b};
x3dom.Utils.isUnsignedType=function(a){return"Uint8"==a||"Uint16"==a||"Uint16"==a||"Uint32"==a};x3dom.Utils.checkDirtyLighting=function(a){return a.getLights().length+a._scene.getNavigationInfo()._vf.headlight};
x3dom.Utils.minFilterDic=function(a,c){switch(c.toUpperCase()){case "NEAREST":return a.NEAREST;case "LINEAR":return a.LINEAR;case "NEAREST_MIPMAP_NEAREST":return a.NEAREST_MIPMAP_NEAREST;case "NEAREST_MIPMAP_LINEAR":return a.NEAREST_MIPMAP_LINEAR;case "LINEAR_MIPMAP_NEAREST":return a.LINEAR_MIPMAP_NEAREST;case "LINEAR_MIPMAP_LINEAR":return a.LINEAR_MIPMAP_LINEAR;case "AVG_PIXEL":return a.LINEAR;case "AVG_PIXEL_AVG_MIPMAP":return a.LINEAR_MIPMAP_LINEAR;case "AVG_PIXEL_NEAREST_MIPMAP":return a.LINEAR_MIPMAP_NEAREST;
case "DEFAULT":return a.LINEAR_MIPMAP_LINEAR;case "FASTEST":return a.NEAREST;case "NEAREST_PIXEL":return a.NEAREST;case "NEAREST_PIXEL_AVG_MIPMAP":return a.NEAREST_MIPMAP_LINEAR;case "NEAREST_PIXEL_NEAREST_MIPMAP":return a.NEAREST_MIPMAP_NEAREST;case "NICEST":return a.LINEAR_MIPMAP_LINEAR;default:return a.LINEAR}};
x3dom.Utils.magFilterDic=function(a,c){switch(c.toUpperCase()){case "NEAREST":return a.NEAREST;case "LINEAR":return a.LINEAR;case "AVG_PIXEL":return a.LINEAR;case "DEFAULT":return a.LINEAR;case "FASTEST":return a.NEAREST;case "NEAREST_PIXEL":return a.NEAREST;case "NICEST":return a.LINEAR;default:return a.LINEAR}};
x3dom.Utils.boundaryModesDic=function(a,c){switch(c.toUpperCase()){case "CLAMP":return a.CLAMP_TO_EDGE;case "CLAMP_TO_EDGE":return a.CLAMP_TO_EDGE;case "CLAMP_TO_BOUNDARY":return a.CLAMP_TO_EDGE;case "MIRRORED_REPEAT":return a.MIRRORED_REPEAT;case "REPEAT":return a.REPEAT;default:return a.REPEAT}};
x3dom.Utils.primTypeDic=function(a,c){switch(c.toUpperCase()){case "POINTS":return a.POINTS;case "LINES":return a.LINES;case "LINELOOP":return a.LINE_LOOP;case "LINESTRIP":return a.LINE_STRIP;case "TRIANGLES":return a.TRIANGLES;case "TRIANGLESTRIP":return a.TRIANGLE_STRIP;case "TRIANGLEFAN":return a.TRIANGLE_FAN;default:return a.TRIANGLES}};
x3dom.Utils.depthFunc=function(a,c){switch(c.toUpperCase()){case "NEVER":return a.NEVER;case "ALWAYS":return a.ALWAYS;case "LESS":return a.LESS;case "EQUAL":return a.EQUAL;case "LEQUAL":return a.LEQUAL;case "GREATER":return a.GREATER;case "GEQUAL":return a.GEQUAL;case "NOTEQUAL":return a.NOTEQUAL;default:return a.LEQUAL}};
x3dom.Utils.blendFunc=function(a,c){switch(c.toLowerCase()){case "zero":return a.ZERO;case "one":return a.ONE;case "dst_color":return a.DST_COLOR;case "dst_alpha":return a.DST_ALPHA;case "src_color":return a.SRC_COLOR;case "src_alpha":return a.SRC_ALPHA;case "one_minus_dst_color":return a.ONE_MINUS_DST_COLOR;case "one_minus_dst_alpha":return a.ONE_MINUS_DST_ALPHA;case "one_minus_src_color":return a.ONE_MINUS_SRC_COLOR;case "one_minus_src_alpha":return a.ONE_MINUS_SRC_ALPHA;case "src_alpha_saturate":return a.SRC_ALPHA_SATURATE;
case "constant_color":return a.CONSTANT_COLOR;case "constant_alpha":return a.CONSTANT_ALPHA;case "one_minus_constant_color":return a.ONE_MINUS_CONSTANT_COLOR;case "one_minus_constant_alpha":return a.ONE_MINUS_CONSTANT_ALPHA;default:return 0}};
x3dom.Utils.blendEquation=function(a,c){switch(c.toLowerCase()){case "func_add":return a.FUNC_ADD;case "func_subtract":return a.FUNC_SUBTRACT;case "func_reverse_subtract":return a.FUNC_REVERSE_SUBTRACT;case "min":return 0;case "max":return 0;case "logic_op":return 0;default:return 0}};
x3dom.Utils.generateProperties=function(a,c){var b={},d=c._cf.geometry.node,e=c._cf.appearance.node,f=e?e._cf.texture.node:null,g=e?e._cf.material.node:null;e&&e._shader&&x3dom.isa(e._shader,x3dom.nodeTypes.ComposedShader)?b.CSHADER=c._objectID:d&&(b.CSHADER=-1,b.SOLID=c.isSolid()?1:0,b.TEXT=x3dom.isa(d,x3dom.nodeTypes.Text)?1:0,b.POPGEOMETRY=x3dom.isa(d,x3dom.nodeTypes.PopGeometry)?1:0,b.BITLODGEOMETRY=x3dom.isa(d,x3dom.nodeTypes.BitLODGeometry)?1:0,b.IMAGEGEOMETRY=x3dom.isa(d,x3dom.nodeTypes.ImageGeometry)?
1:0,b.IG_PRECISION=b.IMAGEGEOMETRY?d.numCoordinateTextures():0,b.IG_INDEXED=b.IMAGEGEOMETRY&&null!=d.getIndexTexture()?1:0,b.POINTLINE2D=x3dom.isa(d,x3dom.nodeTypes.PointSet)||x3dom.isa(d,x3dom.nodeTypes.IndexedLineSet)||x3dom.isa(d,x3dom.nodeTypes.Polypoint2D)||x3dom.isa(d,x3dom.nodeTypes.Polyline2D)||x3dom.isa(d,x3dom.nodeTypes.Arc2D)||x3dom.isa(d,x3dom.nodeTypes.Circle2D)?1:0,b.APPMAT=e&&(g||b.CSSHADER)?1:0,b.SHADOW=a.getLightsShadow()?1:0,b.FOG=0<a._scene.getFog()._vf.visibilityRange?1:0,b.CSSHADER=
e&&e._shader&&x3dom.isa(e._shader,x3dom.nodeTypes.CommonSurfaceShader)?1:0,b.LIGHTS=!b.POINTLINE2D&&e&&(g||b.CSSHADER)?a.getLights().length+a._scene.getNavigationInfo()._vf.headlight:0,b.TEXTURED=f||b.TEXT?1:0,b.TEXTRAFO=e&&e._cf.textureTransform.node?1:0,b.DIFFUSEMAP=b.CSSHADER&&e._shader.getDiffuseMap()?1:0,b.NORMALMAP=b.CSSHADER&&e._shader.getNormalMap()?1:0,b.SPECMAP=b.CSSHADER&&e._shader.getSpecularMap()?1:0,b.DISPLACEMENTMAP=b.CSSHADER&&e._shader.getDisplacementMap()?1:0,b.DIFFPLACEMENTMAP=
b.CSSHADER&&e._shader.getDiffuseDisplacementMap()?1:0,b.CUBEMAP=f&&x3dom.isa(f,x3dom.nodeTypes.X3DEnvironmentTextureNode)?1:0,b.BLENDING=b.TEXT||b.CUBEMAP||f&&f._blending?1:0,b.REQUIREBBOX=void 0!==d._vf.coordType&&"Float32"!=d._vf.coordType?1:0,b.REQUIREBBOXNOR=void 0!==d._vf.normalType&&"Float32"!=d._vf.normalType?1:0,b.REQUIREBBOXCOL=void 0!==d._vf.colorType&&"Float32"!=d._vf.colorType?1:0,b.REQUIREBBOXTEX=void 0!==d._vf.texCoordType&&"Float32"!=d._vf.texCoordType?1:0,b.COLCOMPONENTS=d._mesh._numColComponents,
b.NORCOMPONENTS=d._mesh._numNormComponents,b.POSCOMPONENTS=d._mesh._numPosComponents,b.SPHEREMAPPING=void 0!==d._cf.texCoord&&null!==d._cf.texCoord.node&&d._cf.texCoord.node._vf.mode&&"sphere"==d._cf.texCoord.node._vf.mode.toLowerCase()?1:0,b.VERTEXCOLOR=0<d._mesh._colors[0].length||b.IMAGEGEOMETRY&&d.getColorTexture()||b.BITLODGEOMETRY&&d.hasColor()||b.POPGEOMETRY&&d.hasColor()||void 0!==d._vf.color&&0<d._vf.color.length?1:0);b.toIdentifier=function(){var a="",c;for(c in this)this[c]!=this.toIdentifier&&
this[c]!=this.toString&&(a+=this[c]);return this.id=a};b.toString=function(){var a="",c;for(c in this)this[c]!=this.toIdentifier&&this[c]!=this.toString&&(a+=c+": "+this[c]+", ");return a};b.toIdentifier();return b};
x3dom.Utils.wrapProgram=function(a,c,b){b={shaderID:b,program:c,bind:function(){a.useProgram(c)}};var d=null,e=null,f,g=a.getProgramParameter(c,a.ACTIVE_UNIFORMS);for(f=0;f<g;++f){try{e=a.getActiveUniform(c,f)}catch(h){if(!e)continue}(d=a.getError())&&x3dom.debug.logError("GL-Error (on searching uniforms): "+d);d=a.getUniformLocation(c,e.name);switch(e.type){case a.SAMPLER_2D:b.__defineSetter__(e.name,function(c){return function(b){a.uniform1i(c,b)}}(d));break;case a.SAMPLER_CUBE:b.__defineSetter__(e.name,
function(c){return function(b){a.uniform1i(c,b)}}(d));break;case a.BOOL:b.__defineSetter__(e.name,function(c){return function(b){a.uniform1i(c,b)}}(d));break;case a.FLOAT:-1!=e.name.indexOf("[0]")?b.__defineSetter__(e.name.substring(0,e.name.length-3),function(c){return function(b){a.uniform1fv(c,new Float32Array(b))}}(d)):b.__defineSetter__(e.name,function(c){return function(b){a.uniform1f(c,b)}}(d));break;case a.FLOAT_VEC2:b.__defineSetter__(e.name,function(c){return function(b){a.uniform2f(c,b[0],
b[1])}}(d));break;case a.FLOAT_VEC3:b.__defineSetter__(e.name,function(c){return function(b){a.uniform3f(c,b[0],b[1],b[2])}}(d));break;case a.FLOAT_VEC4:b.__defineSetter__(e.name,function(c){return function(b){a.uniform4f(c,b[0],b[1],b[2],b[3])}}(d));break;case a.FLOAT_MAT2:b.__defineSetter__(e.name,function(c){return function(b){a.uniformMatrix2fv(c,!1,new Float32Array(b))}}(d));break;case a.FLOAT_MAT3:b.__defineSetter__(e.name,function(c){return function(b){a.uniformMatrix3fv(c,!1,new Float32Array(b))}}(d));
break;case a.FLOAT_MAT4:b.__defineSetter__(e.name,function(c){return function(b){a.uniformMatrix4fv(c,!1,new Float32Array(b))}}(d));break;case a.INT:b.__defineSetter__(e.name,function(c){return function(b){a.uniform1i(c,b)}}(d));break;default:x3dom.debug.logWarning("GLSL program variable "+e.name+" has unknown type "+e.type)}}g=a.getProgramParameter(c,a.ACTIVE_ATTRIBUTES);for(f=0;f<g;++f){try{e=a.getActiveAttrib(c,f)}catch(k){if(!e)continue}(d=a.getError())&&x3dom.debug.logError("GL-Error (on searching attributes): "+
d);d=a.getAttribLocation(c,e.name);b[e.name]=d}return b};
x3dom.States=function(a){var c=this;this.active=!1;this.viewer=document.createElement("div");this.viewer.id="x3dom-state-viewer";var b=document.createElement("div");b.className="x3dom-states-head";var d=document.createElement("span");d.className="x3dom-states-head2";b.appendChild(d);this.measureList=document.createElement("ul");this.measureList.className="x3dom-states-list";this.infoList=document.createElement("ul");this.infoList.className="x3dom-states-list";this.viewer.appendChild(b);this.viewer.appendChild(this.measureList);
this.viewer.appendChild(this.infoList);this.disableContextMenu=function(a){a.preventDefault();a.stopPropagation();return a.returnValue=!1};this.thousandSeperator=function(a){return a.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")};this.toFixed=function(a){return a.toFixed(2)};this.update=function(){var c=a.runtime.states.infos,b=a.runtime.states.measurements;this.measureList.innerHTML="";for(var d in b)k=document.createElement("li"),k.className="x3dom-states-item",l=document.createElement("div"),
l.className="x3dom-states-item-title",l.appendChild(document.createTextNode(d)),n=document.createElement("div"),n.className="x3dom-states-item-value",n.appendChild(document.createTextNode(this.toFixed(b[d]))),k.appendChild(l),k.appendChild(n),this.measureList.appendChild(k);this.infoList.innerHTML="";for(var h in c){var k=document.createElement("li");k.className="x3dom-states-item";var l=document.createElement("div");l.className="x3dom-states-item-title";l.appendChild(document.createTextNode(h));
var n=document.createElement("div");n.className="x3dom-states-item-value";n.appendChild(document.createTextNode(this.thousandSeperator(c[h])));k.appendChild(l);k.appendChild(n);this.infoList.appendChild(k)}};window.setInterval(function(){c.update()},1E3);this.viewer.addEventListener("contextmenu",c.disableContextMenu)};x3dom.States.prototype.display=function(a){this.active=void 0!==a?a:!this.active;this.viewer.style.display=this.active?"block":"none"};
x3dom.StateManager=function(a){this.gl=a;this.states=[];this.initStates()};
x3dom.StateManager.prototype.initStates=function(){this.states.shaderID=null;this.states.colorMask={red:null,green:null,blue:null,alpha:null};this.states.depthMask=null;this.states.stencilMask=null;this.states.cullFace=null;this.states.frontFace=null;this.states.lineWidth=null;this.states.blendColor={red:null,green:null,blue:null,alpha:null};this.states.blendEquation=null;this.states.blendEquationSeparate={modeRGB:null,modeAlpha:null};this.states.blendFunc={sfactor:null,dfactor:null};this.states.blendFuncSeparate=
{srcRGB:null,dstRGB:null,srcAlpha:null,dstAlpha:null};this.states.depthFunc=null;this.states.viewport={x:null,y:null,width:null,height:null};this.states.depthRange={zNear:null,zFar:null}};x3dom.StateManager.prototype.useProgram=function(a){return this.states.shaderID!=a.shaderID?(this.gl.useProgram(a.program),this.states.shaderID=a.shaderID,!0):!1};x3dom.StateManager.prototype.unsetProgram=function(){this.states.shaderID=null};
x3dom.StateManager.prototype.enable=function(a){!0!==this.states[a]&&(this.gl.enable(a),this.states[a]=!0)};x3dom.StateManager.prototype.disable=function(a){!1!==this.states[a]&&(this.gl.disable(a),this.states[a]=!1)};
x3dom.StateManager.prototype.colorMask=function(a,c,b,d){if(this.states.colorMask.red!=a||this.states.colorMask.green!=c||this.states.colorMask.blue!=b||this.states.colorMask.alpha!=d)this.gl.colorMask(a,c,b,d),this.states.colorMask.red=a,this.states.colorMask.green=c,this.states.colorMask.blue=b,this.states.colorMask.alpha=d};x3dom.StateManager.prototype.depthMask=function(a){this.states.depthMask!=a&&(this.gl.depthMask(a),this.states.depthMask=a)};
x3dom.StateManager.prototype.stencilMask=function(a){this.states.stencilMask!=a&&(this.gl.stencilMask(a),this.states.stencilMask=a)};x3dom.StateManager.prototype.cullFace=function(a){this.states.cullFace!=a&&(this.gl.cullFace(a),this.states.cullFace=a)};x3dom.StateManager.prototype.frontFace=function(a){this.states.frontFace!=a&&(this.gl.frontFace(a),this.states.frontFace=a)};
x3dom.StateManager.prototype.lineWidth=function(a){a=1>=a?1:a;this.states.lineWidth!=a&&(this.gl.lineWidth(a),this.states.lineWidth=a)};x3dom.StateManager.prototype.blendColor=function(a,c,b,d){if(this.states.blendColor.red!=a||this.states.blendColor.green!=c||this.states.blendColor.blue!=b||this.states.blendColor.alpha!=d)this.gl.blendColor(a,c,b,d),this.states.blendColor.red=a,this.states.blendColor.green=c,this.states.blendColor.blue=b,this.states.blendColor.alpha=d};
x3dom.StateManager.prototype.blendEquation=function(a){a&&this.states.blendEquation!=a&&(this.gl.blendEquation(a),this.states.blendEquation=a)};x3dom.StateManager.prototype.blendEquationSeparate=function(a,c){if(this.states.blendEquationSeparate.modeRGB!=a||this.states.blendEquationSeparate.modeAlpha!=c)this.gl.blendEquationSeparate(a,c),this.states.blendEquationSeparate.modeRGB=a,this.states.blendEquationSeparate.modeAlpha=c};
x3dom.StateManager.prototype.blendFunc=function(a,c){if(this.states.blendFunc.sfactor!=a||this.states.blendFunc.dfactor!=c)this.gl.blendFunc(a,c),this.states.blendFunc.sfactor=a,this.states.blendFunc.dfactor=c};
x3dom.StateManager.prototype.blendFuncSeparate=function(a,c,b,d){if(this.states.blendFuncSeparate.srcRGB!=a||this.states.blendFuncSeparate.dstRGB!=c||this.states.blendFuncSeparate.srcAlpha!=b||this.states.blendFuncSeparate.dstAlpha!=d)this.gl.blendFuncSeparate(a,c,b,d),this.states.blendFuncSeparate.srcRGB=a,this.states.blendFuncSeparate.dstRGB=c,this.states.blendFuncSeparate.srcAlpha=b,this.states.blendFuncSeparate.dstAlpha=d};
x3dom.StateManager.prototype.depthFunc=function(a){this.states.depthFunc!=a&&(this.gl.depthFunc(a),this.states.depthFunc=a)};x3dom.StateManager.prototype.depthRange=function(a,c){0>a||0>c||a>c||(a=1<a?1:a,c=1<c?1:c,this.states.depthRange.zNear==a&&this.states.depthRange.zFar==c)||(this.gl.depthRange(a,c),this.states.depthRange.zNear=a,this.states.depthRange.zFar=c)};
x3dom.StateManager.prototype.viewport=function(a,c,b,d){if(this.states.viewport.x!=a||this.states.viewport.y!=c||this.states.viewport.width!=b||this.states.viewport.height!=d)this.gl.viewport(a,c,b,d),this.states.viewport.x=a,this.states.viewport.y=c,this.states.viewport.width=b,this.states.viewport.height=d};x3dom.StateManager.prototype.bindFramebuffer=function(a,c){this.gl.bindFramebuffer(a,c);this.initStates()};
x3dom.BinaryContainerLoader={outOfMemory:!1,checkError:function(a){var c=a.getError();c&&(c==a.OUT_OF_MEMORY?(this.outOfMemory=!0,x3dom.debug.logError("GL-Error "+c+" on loading binary geometry (out of memory)."),console.error("WebGL: OUT_OF_MEMORY")):x3dom.debug.logError("GL-Error "+c+" on loading binary geometry."))}};
x3dom.BinaryContainerLoader.setupBinGeo=function(a,c,b,d,e){if(!this.outOfMemory){var f=(new Date).getTime(),g=this,h=a._cf.geometry.node;a._webgl.binaryGeometry=-1;a._webgl.internalDownloadCount=(0<h._vf.index.length?1:0)+(h._hasStrideOffset&&0<h._vf.coord.length?1:0)+(!h._hasStrideOffset&&0<h._vf.coord.length?1:0)+(!h._hasStrideOffset&&0<h._vf.normal.length?1:0)+(!h._hasStrideOffset&&0<h._vf.texCoord.length?1:0)+(!h._hasStrideOffset&&0<h._vf.color.length?1:0);var k=!1==h._vf.normalPerVertex||0<
h._vf.index.length&&("Int32"==h._vf.indexType||"Uint32"==h._vf.indexType&&!x3dom.caps.INDEX_UINT);a._webgl.makeSeparateTris={index:null,coord:null,normal:null,texCoord:null,color:null,pushBuffer:function(c,b){this[c]=b;0==--a._webgl.internalDownloadCount&&(this.coord&&this.createMesh(),a._nameSpace.doc.needRender=!0);0==--a._nameSpace.doc.downloadCount&&(a._nameSpace.doc.needRender=!0)},createMesh:function(){if(h._hasStrideOffset)x3dom.debug.logError(h._vf.indexType+" index type and per-face normals not supported for interleaved arrays.");
else{for(var f=0;f<a._webgl.primType.length;f++)if(a._webgl.primType[f]==b.TRIANGLE_STRIP){x3dom.debug.logError("makeSeparateTris: triangle strips not yet supported for per-face normals.");return}a._webgl.coordType=x3dom.Utils.getVertexAttribType(h._vf.coordType,b);var k,l;a._webgl.coordType!=b.FLOAT?(4==h._mesh._numPosComponents&&x3dom.Utils.isUnsignedType(h._vf.coordType)?x3dom.fields.SFVec3f.copy(h.getMin()):x3dom.fields.SFVec3f.copy(h._vf.position),k=x3dom.fields.SFVec3f.copy(h._vf.size),l=h.getPrecisionMax("coordType")):
(new x3dom.fields.SFVec3f(0,0,0),k=new x3dom.fields.SFVec3f(1,1,1),l=1);f=a._coordStrideOffset[0]/x3dom.Utils.getDataTypeSize(h._vf.coordType);f=0==f?3:f;x3dom.debug.logWarning("makeSeparateTris.createMesh called with coord length "+f);this.color&&f!=a._colorStrideOffset[0]/x3dom.Utils.getDataTypeSize(h._vf.colorType)&&(this.color=null,x3dom.debug.logWarning("Color format not supported."));var m=this.texCoord?a._texCoordStrideOffset[0]/x3dom.Utils.getDataTypeSize(h._vf.texCoordType):0;h._vf.normalType=
"Float32";a._webgl.normalType=b.FLOAT;h._mesh._numNormComponents=3;a._normalStrideOffset=[0,0];var p=[],n=[],s=[],q=[],x,y,B=this.index?this.index.length-2:this.coord.length/3-2;for(x=0;x<B;x+=3){y=f*(this.index?this.index[x]:x);var C=new x3dom.fields.SFVec3f(k.x*this.coord[y]/l,k.y*this.coord[y+1]/l,k.z*this.coord[y+2]/l);p.push(this.coord[y]);p.push(this.coord[y+1]);p.push(this.coord[y+2]);3<f&&p.push(this.coord[y+3]);this.color&&(q.push(this.color[y]),q.push(this.color[y+1]),q.push(this.color[y+
2]),3<f&&q.push(this.color[y+3]));this.texCoord&&(y=m*(this.index?this.index[x]:x),s.push(this.texCoord[y]),s.push(this.texCoord[y+1]),3<m&&(s.push(this.texCoord[y+2]),s.push(this.texCoord[y+3])));y=f*(this.index?this.index[x+1]:x+1);var E=new x3dom.fields.SFVec3f(k.x*this.coord[y]/l,k.y*this.coord[y+1]/l,k.z*this.coord[y+2]/l);p.push(this.coord[y]);p.push(this.coord[y+1]);p.push(this.coord[y+2]);3<f&&p.push(this.coord[y+3]);this.color&&(q.push(this.color[y]),q.push(this.color[y+1]),q.push(this.color[y+
2]),3<f&&q.push(this.color[y+3]));this.texCoord&&(y=m*(this.index?this.index[x+1]:x+1),s.push(this.texCoord[y]),s.push(this.texCoord[y+1]),3<m&&(s.push(this.texCoord[y+2]),s.push(this.texCoord[y+3])));y=f*(this.index?this.index[x+2]:x+2);var F=new x3dom.fields.SFVec3f(k.x*this.coord[y]/l,k.y*this.coord[y+1]/l,k.z*this.coord[y+2]/l);p.push(this.coord[y]);p.push(this.coord[y+1]);p.push(this.coord[y+2]);3<f&&p.push(this.coord[y+3]);this.color&&(q.push(this.color[y]),q.push(this.color[y+1]),q.push(this.color[y+
2]),3<f&&q.push(this.color[y+3]));this.texCoord&&(y=m*(this.index?this.index[x+2]:x+2),s.push(this.texCoord[y]),s.push(this.texCoord[y+1]),3<m&&(s.push(this.texCoord[y+2]),s.push(this.texCoord[y+3])));y=C.subtract(E);E=E.subtract(F);E=y.cross(E).normalize();for(y=0;3>y;y++)n.push(E.x),n.push(E.y),n.push(E.z)}k=b.createBuffer();a._webgl.buffers[1]=k;b.bindBuffer(b.ARRAY_BUFFER,k);b.bufferData(b.ARRAY_BUFFER,x3dom.Utils.getArrayBufferView(h._vf.coordType,p),b.STATIC_DRAW);b.vertexAttribPointer(c.position,
h._mesh._numPosComponents,a._webgl.coordType,!1,a._coordStrideOffset[0],a._coordStrideOffset[1]);b.enableVertexAttribArray(c.position);k=b.createBuffer();a._webgl.buffers[2]=k;b.bindBuffer(b.ARRAY_BUFFER,k);b.bufferData(b.ARRAY_BUFFER,new Float32Array(n),b.STATIC_DRAW);b.vertexAttribPointer(c.normal,h._mesh._numNormComponents,a._webgl.normalType,!1,a._normalStrideOffset[0],a._normalStrideOffset[1]);b.enableVertexAttribArray(c.normal);this.texCoord&&(k=b.createBuffer(),a._webgl.buffers[3]=k,b.bindBuffer(b.ARRAY_BUFFER,
k),b.bufferData(b.ARRAY_BUFFER,x3dom.Utils.getArrayBufferView(h._vf.texCoordType,s),b.STATIC_DRAW),b.vertexAttribPointer(c.texcoord,h._mesh._numTexComponents,a._webgl.texCoordType,!1,a._texCoordStrideOffset[0],a._texCoordStrideOffset[1]),b.enableVertexAttribArray(c.texcoord));this.color&&(k=b.createBuffer(),a._webgl.buffers[4]=k,b.bindBuffer(b.ARRAY_BUFFER,k),b.bufferData(b.ARRAY_BUFFER,x3dom.Utils.getArrayBufferView(h._vf.colorType,q),b.STATIC_DRAW),b.vertexAttribPointer(c.color,h._mesh._numColComponents,
a._webgl.colorType,!1,a._colorStrideOffset[0],a._colorStrideOffset[1]),b.enableVertexAttribArray(c.color));h._vf.vertexCount=[];h._vf.vertexCount[0]=p.length/f;h._mesh._numCoords=h._vf.vertexCount[0];h._mesh._numFaces=h._vf.vertexCount[0]/3;a._webgl.primType=[];a._webgl.primType[0]=b.TRIANGLES;this.color=this.texCoord=this.normal=this.coord=this.index=null;g.checkError(b);delete a._webgl.shader;a._webgl.shader=e.cache.getDynamicShader(b,d,a)}}};if(0<h._vf.index.length){var l=new XMLHttpRequest;l.open("GET",
encodeURI(a._nameSpace.getURL(h._vf.index)),!0);l.responseType="arraybuffer";a._nameSpace.doc.downloadCount+=1;l.send(null);l.onload=function(){if(a._webgl){var c=h._vf.indexType,d=x3dom.Utils.getArrayBufferView(c,l.response);if(k)a._webgl.makeSeparateTris.pushBuffer("index",d);else{var e=b.createBuffer();a._webgl.buffers[0]=e;a._webgl.indexType=x3dom.caps.INDEX_UINT&&"Uint32"==c?b.UNSIGNED_INT:b.UNSIGNED_SHORT;b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,e);b.bufferData(b.ELEMENT_ARRAY_BUFFER,d,b.STATIC_DRAW);
a._webgl.binaryGeometry=1;0==h._vf.vertexCount[0]&&(h._vf.vertexCount[0]=d.length);for(c=h._mesh._numFaces=0;c<h._vf.vertexCount.length;c++)h._mesh._numFaces=a._webgl.primType[c]==b.TRIANGLE_STRIP?h._mesh._numFaces+(h._vf.vertexCount[c]-2):h._mesh._numFaces+h._vf.vertexCount[c]/3;a._nameSpace.doc.downloadCount-=1;a._webgl.internalDownloadCount-=1;0==a._webgl.internalDownloadCount&&(a._nameSpace.doc.needRender=!0);g.checkError(b);c=(new Date).getTime()-f;x3dom.debug.logInfo("XHR0/ index load time: "+
c+" ms")}}}}if(h._hasStrideOffset&&0<h._vf.coord.length){var n=new XMLHttpRequest;n.open("GET",encodeURI(a._nameSpace.getURL(h._vf.coord)),!0);n.responseType="arraybuffer";a._nameSpace.doc.downloadCount+=1;n.send(null);n.onload=function(){if(a._webgl){var d=n.response,e=h._vf.coordType;a._webgl.coordType=x3dom.Utils.getVertexAttribType(e,b);a._webgl.normalType=a._webgl.coordType;a._webgl.texCoordType=a._webgl.coordType;a._webgl.colorType=a._webgl.coordType;d=x3dom.Utils.getArrayBufferView(e,d);if(e=
a._coordStrideOffset[0]/x3dom.Utils.getDataTypeSize(e))h._mesh._numCoords=d.length/e;if(0==h._vf.index.length)for(e=0;e<h._vf.vertexCount.length;e++)h._mesh._numFaces=a._webgl.primType[e]==b.TRIANGLE_STRIP?h._mesh._numFaces+(h._vf.vertexCount[e]-2):h._mesh._numFaces+h._vf.vertexCount[e]/3;e=b.createBuffer();a._webgl.buffers[1]=e;b.bindBuffer(b.ARRAY_BUFFER,e);b.bufferData(b.ARRAY_BUFFER,d,b.STATIC_DRAW);b.vertexAttribPointer(c.position,h._mesh._numPosComponents,a._webgl.coordType,!1,a._coordStrideOffset[0],
a._coordStrideOffset[1]);b.enableVertexAttribArray(c.position);0<h._vf.normal.length&&(a._webgl.buffers[2]=e,b.bindBuffer(b.ARRAY_BUFFER,e),b.bufferData(b.ARRAY_BUFFER,d,b.STATIC_DRAW),b.vertexAttribPointer(c.normal,h._mesh._numNormComponents,a._webgl.normalType,!1,a._normalStrideOffset[0],a._normalStrideOffset[1]),b.enableVertexAttribArray(c.normal));0<h._vf.texCoord.length&&(a._webgl.buffers[3]=e,b.bindBuffer(b.ARRAY_BUFFER,e),b.bufferData(b.ARRAY_BUFFER,d,b.STATIC_DRAW),b.vertexAttribPointer(c.texcoord,
h._mesh._numTexComponents,a._webgl.texCoordType,!1,a._texCoordStrideOffset[0],a._texCoordStrideOffset[1]),b.enableVertexAttribArray(c.texcoord));0<h._vf.color.length&&(a._webgl.buffers[4]=e,b.bindBuffer(b.ARRAY_BUFFER,e),b.bufferData(b.ARRAY_BUFFER,d,b.STATIC_DRAW),b.vertexAttribPointer(c.color,h._mesh._numColComponents,a._webgl.colorType,!1,a._colorStrideOffset[0],a._colorStrideOffset[1]),b.enableVertexAttribArray(c.color));a._nameSpace.doc.downloadCount-=1;a._webgl.internalDownloadCount-=1;0==a._webgl.internalDownloadCount&&
(a._nameSpace.doc.needRender=!0);g.checkError(b);d=(new Date).getTime()-f;x3dom.debug.logInfo("XHR/ interleaved array load time: "+d+" ms")}}}if(!h._hasStrideOffset&&0<h._vf.coord.length){var q=new XMLHttpRequest;q.open("GET",encodeURI(a._nameSpace.getURL(h._vf.coord)),!0);q.responseType="arraybuffer";a._nameSpace.doc.downloadCount+=1;q.send(null);q.onload=function(){if(a._webgl){var d=q.response,e=0,l=h._vf.coordType;a._webgl.coordType=x3dom.Utils.getVertexAttribType(l,b);d=x3dom.Utils.getArrayBufferView(l,
d);if(k)a._webgl.makeSeparateTris.pushBuffer("coord",d);else{b.bindAttribLocation(c.program,0,"position");e=b.createBuffer();a._webgl.buffers[1]=e;b.bindBuffer(b.ARRAY_BUFFER,e);b.bufferData(b.ARRAY_BUFFER,d,b.STATIC_DRAW);b.bindBuffer(b.ARRAY_BUFFER,e);b.vertexAttribPointer(c.position,h._mesh._numPosComponents,a._webgl.coordType,!1,a._coordStrideOffset[0],a._coordStrideOffset[1]);b.enableVertexAttribArray(c.position);h._mesh._numCoords=d.length/h._mesh._numPosComponents;if(0==h._vf.index.length)for(e=
0;e<h._vf.vertexCount.length;e++)h._mesh._numFaces=a._webgl.primType[e]==b.TRIANGLE_STRIP?h._mesh._numFaces+(h._vf.vertexCount[e]-2):h._mesh._numFaces+h._vf.vertexCount[e]/3;if("Float32"==l&&(0>a._vf.bboxSize.x||0>a._vf.bboxSize.y||0>a._vf.bboxSize.z)){for(var l=new x3dom.fields.SFVec3f(d[0],d[1],d[2]),m=new x3dom.fields.SFVec3f(d[0],d[1],d[2]),e=3;e<d.length;e+=3)l.x>d[e+0]&&(l.x=d[e+0]),l.y>d[e+1]&&(l.y=d[e+1]),l.z>d[e+2]&&(l.z=d[e+2]),m.x<d[e+0]&&(m.x=d[e+0]),m.y<d[e+1]&&(m.y=d[e+1]),m.z<d[e+2]&&
(m.z=d[e+2]);a._vf.bboxCenter.setValues(l.add(m).multiply(0.5));a._vf.bboxSize.setValues(m.subtract(l))}a._nameSpace.doc.downloadCount-=1;a._webgl.internalDownloadCount-=1;0==a._webgl.internalDownloadCount&&(a._nameSpace.doc.needRender=!0);g.checkError(b);e=(new Date).getTime()-f;x3dom.debug.logInfo("XHR1/ coord load time: "+e+" ms")}}}}if(!h._hasStrideOffset&&0<h._vf.normal.length){var m=new XMLHttpRequest;m.open("GET",encodeURI(a._nameSpace.getURL(h._vf.normal)),!0);m.responseType="arraybuffer";
a._nameSpace.doc.downloadCount+=1;m.send(null);m.onload=function(){if(a._webgl){var d=m.response,e=h._vf.normalType;a._webgl.normalType=x3dom.Utils.getVertexAttribType(e,b);d=x3dom.Utils.getArrayBufferView(e,d);k?a._webgl.makeSeparateTris.pushBuffer("normal",d):(e=b.createBuffer(),a._webgl.buffers[2]=e,b.bindBuffer(b.ARRAY_BUFFER,e),b.bufferData(b.ARRAY_BUFFER,d,b.STATIC_DRAW),b.vertexAttribPointer(c.normal,h._mesh._numNormComponents,a._webgl.normalType,!1,a._normalStrideOffset[0],a._normalStrideOffset[1]),
b.enableVertexAttribArray(c.normal),a._nameSpace.doc.downloadCount-=1,a._webgl.internalDownloadCount-=1,0==a._webgl.internalDownloadCount&&(a._nameSpace.doc.needRender=!0),g.checkError(b),d=(new Date).getTime()-f,x3dom.debug.logInfo("XHR2/ normal load time: "+d+" ms"))}}}if(!h._hasStrideOffset&&0<h._vf.texCoord.length){var p=new XMLHttpRequest;p.open("GET",encodeURI(a._nameSpace.getURL(h._vf.texCoord)),!0);p.responseType="arraybuffer";a._nameSpace.doc.downloadCount+=1;p.send(null);p.onload=function(){if(a._webgl){var d=
p.response,e=h._vf.texCoordType;a._webgl.texCoordType=x3dom.Utils.getVertexAttribType(e,b);d=x3dom.Utils.getArrayBufferView(e,d);k?a._webgl.makeSeparateTris.pushBuffer("texCoord",d):(e=b.createBuffer(),a._webgl.buffers[3]=e,b.bindBuffer(b.ARRAY_BUFFER,e),b.bufferData(b.ARRAY_BUFFER,d,b.STATIC_DRAW),b.vertexAttribPointer(c.texcoord,h._mesh._numTexComponents,a._webgl.texCoordType,!1,a._texCoordStrideOffset[0],a._texCoordStrideOffset[1]),b.enableVertexAttribArray(c.texcoord),a._nameSpace.doc.downloadCount-=
1,a._webgl.internalDownloadCount-=1,0==a._webgl.internalDownloadCount&&(a._nameSpace.doc.needRender=!0),g.checkError(b),d=(new Date).getTime()-f,x3dom.debug.logInfo("XHR3/ texCoord load time: "+d+" ms"))}}}if(!h._hasStrideOffset&&0<h._vf.color.length){var s=new XMLHttpRequest;s.open("GET",encodeURI(a._nameSpace.getURL(h._vf.color)),!0);s.responseType="arraybuffer";a._nameSpace.doc.downloadCount+=1;s.send(null);s.onload=function(){if(a._webgl){var d=s.response,e=h._vf.colorType;a._webgl.colorType=
x3dom.Utils.getVertexAttribType(e,b);d=x3dom.Utils.getArrayBufferView(e,d);k?a._webgl.makeSeparateTris.pushBuffer("color",d):(e=b.createBuffer(),a._webgl.buffers[4]=e,b.bindBuffer(b.ARRAY_BUFFER,e),b.bufferData(b.ARRAY_BUFFER,d,b.STATIC_DRAW),b.vertexAttribPointer(c.color,h._mesh._numColComponents,a._webgl.colorType,!1,a._colorStrideOffset[0],a._colorStrideOffset[1]),b.enableVertexAttribArray(c.color),a._nameSpace.doc.downloadCount-=1,a._webgl.internalDownloadCount-=1,0==a._webgl.internalDownloadCount&&
(a._nameSpace.doc.needRender=!0),g.checkError(b),d=(new Date).getTime()-f,x3dom.debug.logInfo("XHR4/ color load time: "+d+" ms"))}}}}};
x3dom.BinaryContainerLoader.setupPopGeo=function(a,c,b,d,e){if(!this.outOfMemory){var f=a._cf.geometry.node;if(f.hasIndex()){a._webgl.popGeometry=1;a._webgl.buffers[0]=b.createBuffer();b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,a._webgl.buffers[0]);b.bufferData(b.ELEMENT_ARRAY_BUFFER,2*f.getTotalNumberOfIndices(),b.STATIC_DRAW);a._webgl.buffers[5]=b.createBuffer();var g=new Float32Array(f._vf.vertexBufferSize);(function(){for(var a=0;a<g.length;++a)g[a]=a})();b.bindBuffer(b.ARRAY_BUFFER,a._webgl.buffers[5]);
b.bufferData(b.ARRAY_BUFFER,g,b.STATIC_DRAW)}else a._webgl.popGeometry=-1;a._webgl.buffers[1]=b.createBuffer();b.bindBuffer(b.ARRAY_BUFFER,a._webgl.buffers[1]);b.bufferData(b.ARRAY_BUFFER,f._vf.attributeStride*f._vf.vertexBufferSize,b.STATIC_DRAW);d=f._vf.coordType;a._webgl.coordType=x3dom.Utils.getVertexAttribType(d,b);a._coordStrideOffset[0]=f.getAttributeStride();a._coordStrideOffset[1]=f.getPositionOffset();b.vertexAttribPointer(c.position,a._cf.geometry.node._mesh._numPosComponents,a._webgl.coordType,
!1,a._coordStrideOffset[0],a._coordStrideOffset[1]);b.enableVertexAttribArray(c.position);f.hasNormal()&&(d=f._vf.normalType,a._webgl.normalType=x3dom.Utils.getVertexAttribType(d,b),a._normalStrideOffset[0]=f.getAttributeStride(),a._normalStrideOffset[1]=f.getNormalOffset(),a._webgl.buffers[2]=a._webgl.buffers[1],b.vertexAttribPointer(c.normal,a._cf.geometry.node._mesh._numNormComponents,a._webgl.normalType,!1,a._normalStrideOffset[0],a._normalStrideOffset[1]),b.enableVertexAttribArray(c.normal));
f.hasTexCoord()&&(d=f._vf.texCoordType,a._webgl.texCoordType=x3dom.Utils.getVertexAttribType(d,b),a._webgl.buffers[3]=a._webgl.buffers[1],a._texCoordStrideOffset[0]=f.getAttributeStride(),a._texCoordStrideOffset[1]=f.getTexCoordOffset(),b.vertexAttribPointer(c.texcoord,a._cf.geometry.node._mesh._numTexComponents,a._webgl.texCoordType,!1,a._texCoordStrideOffset[0],a._texCoordStrideOffset[1]),b.enableVertexAttribArray(c.texcoord));f.hasColor()&&(d=f._vf.colorType,a._webgl.colorType=x3dom.Utils.getVertexAttribType(d,
b),a._webgl.buffers[4]=a._webgl.buffers[1],a._colorStrideOffset[0]=f.getAttributeStride(),a._colorStrideOffset[1]=f.getColorOffset(),b.vertexAttribPointer(c.color,a._cf.geometry.node._mesh._numColComponents,a._webgl.colorType,!1,a._colorStrideOffset[0],a._colorStrideOffset[1]),b.enableVertexAttribArray(c.color));a._webgl.currentNumIndices=0;a._webgl.currentNumVertices=0;a._webgl.numVerticesAtLevel=[];a._webgl.levelsAvailable=0;this.checkError(b);a._webgl.levelLoaded=[];(function(){for(var c=0;c<f.getNumLevels();++c)a._webgl.levelLoaded.push(!1)})();
var h=function(c,d){a._webgl.levelLoaded[d]=!0;a._webgl.numVerticesAtLevel[d]=0;if(c){var e=0,g=!1;if(f.hasIndex()&&(e=2*f.getNumIndicesByLevel(d),0<e)){var g=!0,h=new Uint8Array(c,0,e);b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,a._webgl.buffers[0]);(function(){for(var a=0,c=0;c<d;++c)a+=f.getNumIndicesByLevel(c);b.bufferSubData(b.ELEMENT_ARRAY_BUFFER,2*a,h)})()}var k=c.byteLength-e;0<k&&(g=!0,e=new Uint8Array(c,e,k),b.bindBuffer(b.ARRAY_BUFFER,a._webgl.buffers[1]),f.hasIndex()?b.bufferSubData(b.ARRAY_BUFFER,
f.getVertexDataBufferOffset(d)*f.getAttributeStride(),e):b.bufferSubData(b.ARRAY_BUFFER,a._webgl.currentNumVertices*f.getAttributeStride(),e),a._webgl.numVerticesAtLevel[d]=k/f.getAttributeStride(),a._webgl.currentNumVertices+=a._webgl.numVerticesAtLevel[d]);(function(){for(var c=0,b=a._webgl.levelsAvailable;b<f.getNumLevels()&&!1!==a._webgl.levelLoaded[b];++b)c+=f.getNumIndicesByLevel(b),++a._webgl.levelsAvailable;a._webgl.currentNumIndices=c})();f._mesh._numCoords=a._webgl.currentNumVertices;f._mesh._numFaces=
(f.hasIndex()?a._webgl.currentNumIndices:a._webgl.currentNumVertices)/3;f.adaptVertexCount(f.hasIndex()?3*f._mesh._numFaces:f._mesh._numCoords);g&&(a._nameSpace.doc.needRender=!0)}};c=f.getDataURLs();var k=[];d=[];a._webgl.downloadStartTimer=(new Date).getTime();for(e=0;e<c.length;++e)a._nameSpace.doc.downloadCount+=1,function(c){k.push(function(b){a._nameSpace.doc.downloadCount-=1;return h(b,c)})}(e),d.push(e);x3dom.DownloadManager.get(c,k,d)}};
x3dom.BinaryContainerLoader.setupBitLODGeo=function(a,c,b,d,e){if(!this.outOfMemory){a._webgl.bitLODGeometry=-1;var f=a._cf.geometry.node;if(!f._vf.normalPerVertex)for(h=a._webgl.bitLODtotalVertexCount=0;h<f._vf.vertexCount.length;h++)a._webgl.primType[h]==b.TRIANGLES?a._webgl.bitLODtotalVertexCount+=f._vf.vertexCount[h]:a._webgl.primType[h]==b.TRIANGLE_STRIP&&(a._webgl.bitLODtotalVertexCount+=3*(f._vf.vertexCount[h]-2));if(f.getNumComponents()){if(f.hasIndex()){a._webgl.generateTriangleBuffer=function(){if("undefined"!=
typeof a._webgl.dataBuffers[0]&&("undefined"!=typeof a._webgl.dataBuffers[1]||"undefined"!=typeof a._webgl.dataBuffers[3]||"undefined"!=typeof a._webgl.dataBuffers[4])){var d=a._webgl.dataBuffers[0],e,g,h,m=0,p=[new x3dom.fields.SFVec3f(0,0,0),new x3dom.fields.SFVec3f(0,0,0),new x3dom.fields.SFVec3f(0,0,0)];e=new x3dom.fields.SFVec3f(0,0,0);e=new x3dom.fields.SFVec3f(0,0,0);var s=new x3dom.fields.SFVec3f(0,0,0),t="undefined"!=typeof a._webgl.dataBuffers[1]&&0<a._webgl.dataBuffers[1].length,w="undefined"!=
typeof a._webgl.dataBuffers[3]&&0<a._webgl.dataBuffers[3].length,z="undefined"!=typeof a._webgl.dataBuffers[4]&&0<a._webgl.dataBuffers[4].length,u=2==a._cf.geometry.node._mesh._numNormComponents?6:8,v=u+(f.hasTexCoord()?2:0)+(f.hasColor()?4:0);"undefined"==typeof a._webgl.triangleBuffer&&(a._webgl.triangleBuffer=new Uint16Array(d.length*v));for(h=0;h<d.length;++h)g=h*v,t&&(e=6*d[h],a._webgl.triangleBuffer[g]=a._webgl.dataBuffers[1][e],a._webgl.triangleBuffer[g+1]=a._webgl.dataBuffers[1][e+1],a._webgl.triangleBuffer[g+
2]=a._webgl.dataBuffers[1][e+2],a._webgl.triangleBuffer[g+3]=0,f._vf.normalPerVertex?(a._webgl.triangleBuffer[g+4]=a._webgl.dataBuffers[1][e+4],a._webgl.triangleBuffer[g+5]=a._webgl.dataBuffers[1][e+5]):8===a._webgl.loadedLevels&&(p[m].x=a._webgl.dataBuffers[1][e],p[m].y=a._webgl.dataBuffers[1][e+1],p[m].z=a._webgl.dataBuffers[1][e+2],3===++m&&(e=p[1].subtract(p[0]),s=p[2].subtract(p[0]),e=e.cross(s),e=e.normalize(),e=e.add(new x3dom.fields.SFVec3f(1,1,1)),e=e.multiply(0.5),e=e.multiply(a._cf.geometry.node.getPrecisionMax("normalType")),
a._webgl.triangleBuffer[g+4-2*v]=e.x.toFixed(0),a._webgl.triangleBuffer[g+5-2*v]=e.y.toFixed(0),a._webgl.triangleBuffer[g+6-2*v]=e.z.toFixed(0),a._webgl.triangleBuffer[g+4-v]=e.x.toFixed(0),a._webgl.triangleBuffer[g+5-v]=e.y.toFixed(0),a._webgl.triangleBuffer[g+6-v]=e.z.toFixed(0),a._webgl.triangleBuffer[g+4]=e.x.toFixed(0),a._webgl.triangleBuffer[g+5]=e.y.toFixed(0),a._webgl.triangleBuffer[g+6]=e.z.toFixed(0),m=0))),g+=u,w&&(e=2*d[h],a._webgl.triangleBuffer[g]=a._webgl.dataBuffers[3][e],a._webgl.triangleBuffer[g+
1]=a._webgl.dataBuffers[3][e+1],g+=2),z&&(e=4*d[h],a._webgl.triangleBuffer[g]=a._webgl.dataBuffers[4][e],a._webgl.triangleBuffer[g+1]=a._webgl.dataBuffers[4][e+1],a._webgl.triangleBuffer[g+2]=a._webgl.dataBuffers[4][e+2],a._webgl.triangleBuffer[g+3]=0);d=b.createBuffer();b.bindBuffer(b.ARRAY_BUFFER,d);b.bufferData(b.ARRAY_BUFFER,a._webgl.triangleBuffer,b.STATIC_DRAW);a._webgl.coordType=x3dom.Utils.getVertexAttribType(f._vf.coordType,b);a._webgl.normalType=a._webgl.coordType;a._coordStrideOffset[0]=
a._normalStrideOffset[0]=2*v;a._coordStrideOffset[1]=0;a._normalStrideOffset[1]=8;a._webgl.buffers[1]=d;a._webgl.buffers[2]=d;b.vertexAttribPointer(c.position,a._cf.geometry.node._mesh._numPosComponents,a._webgl.coordType,!1,a._coordStrideOffset[0],a._coordStrideOffset[1]);b.enableVertexAttribArray(c.position);b.vertexAttribPointer(c.normal,a._cf.geometry.node._mesh._numNormComponents,a._webgl.normalType,!1,a._coordStrideOffset[0],a._coordStrideOffset[1]);b.enableVertexAttribArray(c.normal);f.hasTexCoord()&&
(a._webgl.texCoordType=a._webgl.coordType,a._webgl.buffers[3]=d,a._texCoordStrideOffset[0]=2*v,a._texCoordStrideOffset[1]=2*u,b.vertexAttribPointer(c.texcoord,a._cf.geometry.node._mesh._numTexComponents,a._webgl.texCoordType,!1,a._texCoordStrideOffset[0],a._texCoordStrideOffset[1]),b.enableVertexAttribArray(c.texcoord));f.hasColor()&&(a._webgl.colorType=a._webgl.coordType,a._webgl.buffers[4]=d,a._colorStrideOffset[0]=2*v,a._colorStrideOffset[1]=f.hasTexCoord()?2*(u+2):2*u,b.vertexAttribPointer(c.color,
a._cf.geometry.node._mesh._numColComponents,a._webgl.colorType,!1,a._colorStrideOffset[0],a._colorStrideOffset[1]),b.enableVertexAttribArray(c.color))}};a._webgl.bitLODGeometry=1;var g=new XMLHttpRequest;g.open("GET",encodeURI(a._nameSpace.getURL(f._vf.index)),!0);g.responseType="arraybuffer";a._nameSpace.doc.downloadCount+=1;g.send(null);g.onload=function(){var c=g.response,d;if(f.usesClientSideNormals()&&f.usesVLCIndices())(function(){"undefined"==typeof a._webgl.dataBuffers&&(a._webgl.dataBuffers=
[]);a._webgl.dataBuffers[0]=[];for(var d=x3dom.Utils.getArrayBufferView("Uint8",c),e=0,f,g,h,l=0,n=0,q=0,r=-1,A=-1;e<d.length;){n>=a._cf.geometry.node._vf.vertexCount[q]&&(++q,n=0);f=d[e++];g=0;for(h=128;128<=f;)g|=f-128,g<<=7,h<<=7,f=d[e++];g|=f;h/=2;g-=h;l+=g;a._webgl.primType[q]==b.TRIANGLE_STRIP?(3>n||(0==n%2?(a._webgl.dataBuffers[0].push(A),a._webgl.dataBuffers[0].push(r)):(a._webgl.dataBuffers[0].push(r),a._webgl.dataBuffers[0].push(A))),a._webgl.dataBuffers[0].push(l),A=r,r=l):a._webgl.dataBuffers[0].push(l);
++n}})(),a._webgl.bitLODGeometry=-1,a._webgl.generateTriangleBuffer(),f._mesh._numFaces=a._webgl.dataBuffers[0].length/3,f._mesh._numCoords=a._webgl.dataBuffers[0].length;else{var e=b.createBuffer();a._webgl.buffers[0]=e;if(f.usesVLCIndices()){var h=[];(function(){for(var b=x3dom.Utils.getArrayBufferView("Uint8",c),d=0,e,f,g,l=0,n=0,v=0;d<b.length;){n>=a._cf.geometry.node._vf.vertexCount[v]&&(++v,n=0);e=b[d++];f=0;for(g=128;128<=e;)f|=e-128,f<<=7,g<<=7,e=b[d++];f|=e;g/=2;f-=g;l+=f;h.push(l);++n}})();
d=new Uint16Array(h)}else d=x3dom.Utils.getArrayBufferView("Uint16",c);b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,e);b.bufferData(b.ELEMENT_ARRAY_BUFFER,d,b.STATIC_DRAW);0==f.getVertexCount(0)&&f.setVertexCount(0,d.length);for(d=f._mesh._numFaces=0;d<f.getNumPrimTypes();d++)f._mesh._numFaces=a._webgl.primType[d]==b.TRIANGLE_STRIP?f._mesh._numFaces+(f.getVertexCount(d)-2):f._mesh._numFaces+f.getVertexCount(d)/3}d=null;a._nameSpace.doc.downloadCount-=1;a._nameSpace.doc.needRender=!0}}d=function(d,e){"undefined"==
typeof a._webgl.loadedLevels&&(a._webgl.loadedLevels=0,f.loadedLevels=0);a._webgl.loadedLevels++;f.loadedLevels++;if(f.hasIndex()&&f.usesClientSideNormals())"undefined"==typeof a._webgl.dataBuffers&&(a._webgl.dataBuffers=[]),0===d?a._webgl.dataBuffers[1]=e:1===d?a._webgl.dataBuffers[3]=e:2===d&&(a._webgl.dataBuffers[4]=e),a._webgl.generateTriangleBuffer();else{var g=b.createBuffer();if(0===d){var h=f._vf.coordType;a._webgl.coordType=x3dom.Utils.getVertexAttribType(h,b);a._webgl.normalType=a._webgl.coordType;
(h=a._coordStrideOffset[0]/x3dom.Utils.getDataTypeSize(h))&&f._vf.normalPerVertex&&(f._mesh._numCoords=e.length/h);a._webgl.buffers[1]=g;b.bindBuffer(b.ARRAY_BUFFER,g);b.bufferData(b.ARRAY_BUFFER,e,b.STATIC_DRAW);b.vertexAttribPointer(c.position,a._cf.geometry.node._mesh._numPosComponents,a._webgl.coordType,!1,a._coordStrideOffset[0],a._coordStrideOffset[1]);b.enableVertexAttribArray(c.position);a._webgl.buffers[2]=g;b.bindBuffer(b.ARRAY_BUFFER,g);b.bufferData(b.ARRAY_BUFFER,e,b.STATIC_DRAW);b.vertexAttribPointer(c.normal,
a._cf.geometry.node._mesh._numNormComponents,a._webgl.normalType,!1,a._normalStrideOffset[0],a._normalStrideOffset[1]);b.enableVertexAttribArray(c.normal)}else 1===d?(a._webgl.texCoordType=a._webgl.coordType,a._webgl.buffers[3]=g,b.bindBuffer(b.ARRAY_BUFFER,g),b.bufferData(b.ARRAY_BUFFER,e,b.STATIC_DRAW),b.vertexAttribPointer(c.texcoord,a._cf.geometry.node._mesh._numTexComponents,a._webgl.texCoordType,!1,a._texCoordStrideOffset[0],a._texCoordStrideOffset[1]),b.enableVertexAttribArray(c.texcoord)):
2===d&&(a._webgl.colorType=a._webgl.coordType,a._webgl.buffers[4]=g,b.bindBuffer(b.ARRAY_BUFFER,g),b.bufferData(b.ARRAY_BUFFER,e,b.STATIC_DRAW),b.vertexAttribPointer(c.color,a._cf.geometry.node._mesh._numColComponents,a._webgl.colorType,!1,a._colorStrideOffset[0],a._colorStrideOffset[1]),b.enableVertexAttribArray(c.color))}a._nameSpace.doc.needRender=!0;a._webgl.refinementJobManager.continueProcessing(d)};a._webgl.refinementJobManager=new x3dom.RefinementJobManager;e=f.getNumVertices();h=new ArrayBuffer(12*
e);h=new Uint16Array(h);a._webgl.refinementJobManager.addResultBuffer(0,h);for(var h=0;h<f.getCoordNormalURLs().length;++h)a._webgl.refinementJobManager.addRefinementJob(0,h,f.getCoordNormalURLs()[h],h,d,96,[3,2],[6,2],[0,6],[0,64]);if(f.hasTexCoord())for(h=new ArrayBuffer(4*e),h=new Uint16Array(h),a._webgl.refinementJobManager.addResultBuffer(1,h),h=0;h<f.getTexCoordURLs().length;++h)a._webgl.refinementJobManager.addRefinementJob(1,h,f.getTexCoordURLs()[h],h,d,32,[2],[8],[0],[0]);if(f.hasColor())for(e=
new ArrayBuffer(6*e),e=new Uint16Array(e),a._webgl.refinementJobManager.addResultBuffer(2,e),h=0;h<f.getColorURLs().length;++h)a._webgl.refinementJobManager.addRefinementJob(2,h,f.getColorURLs()[h],h,d,48,[3],[6],[0],[0])}}};
x3dom.BinaryContainerLoader.setupImgGeo=function(a,c,b,d,e){if(!this.outOfMemory){d=a._cf.geometry.node;d.getIndexTexture()?a._webgl.imageGeometry=1:a._webgl.imageGeometry=-1;d.unsetGeoDirty();null==e.IG_PositionBuffer&&(e.IG_PositionBuffer=b.createBuffer());a._webgl.buffers[1]=e.IG_PositionBuffer;b.bindBuffer(b.ARRAY_BUFFER,e.IG_PositionBuffer);var f=new Float32Array(a._webgl.positions[0]);b.bufferData(b.ARRAY_BUFFER,f,b.STATIC_DRAW);b.bindBuffer(b.ARRAY_BUFFER,e.IG_PositionBuffer);b.vertexAttribPointer(c.position,
d._mesh._numPosComponents,a._webgl.coordType,!1,a._coordStrideOffset[0],a._coordStrideOffset[1]);b.enableVertexAttribArray(c.position);this.checkError(b)}};
x3dom.DrawableCollection=function(a){this.collection=[];this.viewMatrix=a.viewMatrix;this.projMatrix=a.projMatrix;this.sceneMatrix=a.sceneMatrix;this.viewarea=a.viewArea;var c=this.viewarea._scene,b=c.getEnvironment(),c=c.getViewpoint();this.near=c.getNear();this.pixelHeightAtDistOne=c.getImgPlaneHeightAtDistOne()/this.viewarea._height;this.context=a.context;this.gl=a.gl;this.viewFrustum=this.viewarea.getViewfrustum(this.sceneMatrix);this.worldVol=new x3dom.fields.BoxVolume;this.frustumCulling=a.frustumCulling&&
null!=this.viewFrustum;this.smallFeatureThreshold=a.smallFeatureThreshold;this.sortOpaque=0<this.smallFeatureThreshold&&1>b._lowPriorityThreshold;this.sortTrans=a.sortTrans;this.prioLevels=10;this.maxTreshold=100;this.sortByPriority=this.sortBySortKey=!1;this.length=this.numberOfNodes=0};
x3dom.DrawableCollection.prototype.cull=function(a,c,b,d){var e=c.boundedNode;if(!e||!e._vf.render)return 0;var f=e.getVolume();if(this.frustumCulling){var g;b&&!c.worldVolume.isValid()?(c.worldVolume.transformFrom(a,f),g=c.worldVolume):63>d&&(this.worldVol.transformFrom(a,f),g=this.worldVol);63>d&&(d=this.viewFrustum.intersect(g,d));if(0>=d)return-1}else d=63;c.coverage=-1;if(0<this.smallFeatureThreshold||e.forceUpdateCoverage())if(a=this.viewMatrix.mult(a),c.center=a.multMatrixPnt(f.getCenter()),
f=a.multMatrixVec(f.getRadialVec()).length(),a=Math.max(-c.center.z-f,this.near)*this.pixelHeightAtDistOne,c.coverage=2*f/a,0<this.smallFeatureThreshold&&c.coverage<this.smallFeatureThreshold)return 0;this.numberOfNodes++;return d};
x3dom.DrawableCollection.prototype.addShape=function(a,c,b){var d={};d.shape=a;d.transform=c;d.localTransform=b.localMatrix;d.localVolume=b.volume;d.worldVolume=x3dom.fields.BoxVolume.copy(b.worldVolume);d.priority=Math.max(0,b.coverage);d.shaderID=a.getShaderProperties(this.viewarea).id;var e=a._cf.appearance.node;d.sortType=e?e._vf.sortType.toLowerCase():"opaque";d.sortKey=e?e._vf.sortKey:0;"transparent"==d.sortType&&(0<this.smallFeatureThreshold?d.zPos=b.center.z:(a=c.multMatrixPnt(a.getCenter()),
a=this.viewMatrix.multMatrixPnt(a),d.zPos=a.z));this.sortBySortKey||0==d.sortKey||(this.sortBySortKey=!0);void 0===this.collection[d.sortType]&&(this.collection[d.sortType]=[]);this.collection[d.sortType].push(d);this.length++;this.context&&this.gl&&this.context.setupShape(this.gl,d,this.viewarea)};
x3dom.DrawableCollection.prototype.addDrawable=function(a){a.shaderID=a.shape.getShaderProperties(this.viewarea).id;var c=a.shape._cf.appearance.node;a.sortType=c?c._vf.sortType.toLowerCase():"opaque";a.sortKey=c?c._vf.sortKey:0;"transparent"==a.sortType&&(c=a.transform.multMatrixPnt(a.shape.getCenter()),c=this.viewMatrix.multMatrixPnt(c),a.zPos=c.z);this.sortBySortKey||0==a.sortKey||(this.sortBySortKey=!0);void 0===this.collection[a.sortType]&&(this.collection[a.sortType]=[]);this.collection[a.sortType].push(a);
this.length++;this.context&&this.gl&&this.context.setupShape(this.gl,a,this.viewarea)};x3dom.DrawableCollection.prototype.calculatePriority=function(a){a=Math.max(0,a.coverage);var c=this.prioLevels-1;return a=Math.min(Math.round(a/(this.maxTreshold/c)),c)};x3dom.DrawableCollection.prototype.concat=function(){this.collection=(void 0!==this.collection.opaque?this.collection.opaque:[]).concat(void 0!==this.collection.transparent?this.collection.transparent:[])};
x3dom.DrawableCollection.prototype.get=function(a){return this.collection[a]};
x3dom.DrawableCollection.prototype.sort=function(){var a=[],c=[];void 0!==this.collection.opaque&&(this.sortOpaque&&this.collection.opaque.sort(function(a,c){return a.sortKey!=c.sortKey&&this.sortBySortKey?a.sortKey-c.sortKey:c.priority-a.priority}),a=this.collection.opaque);void 0!==this.collection.transparent&&(this.sortTrans&&this.collection.transparent.sort(function(a,c){return a.sortKey!=c.sortKey&&this.sortBySortKey?a.sortKey-c.sortKey:a.priority!=c.priority&&this.sortByPriority?c.priority-
a.priority:a.zPos-c.zPos}),c=this.collection.transparent);this.collection=a.concat(c)};
x3dom.DrawableCollection.prototype.forEach=function(a,c){c="undefined"!==typeof c?Math.min(c,this.prioLevels):this.prioLevels;var b,d,e,f;for(b=0;b<this.collection.opaque.length;++b)if(void 0!==this.collection.opaque[sortkey])for(d=this.collection.opaque[b].length;0<d;--d)if(void 0!==this.collection.opaque[b][d])for(e in this.collection.opaque[b][d])for(f=0;f<this.collection.opaque[b][d][e].lenght;++f)a(this.collection.opaque[b][d][e][f]);for(b=0;b<this.collection.transparent.length;++b)if(void 0!==
this.collection.transparent[sortkey])for(d=this.collection.transparent[b].length;0<d;--d)if(void 0!==this.collection.transparent[b][d])for(var g in this.collection.transparent[b][d])for(this.collection.transparent[b][d][g].sort(function(a,c){return a.zPos-c.zPos}),f=0;f<this.collection.transparent[b][d][g].lenght;++f)a(this.collection.transparent[b][d][g][f])};x3dom.bvh={};
x3dom.bvh.Settings=defineClass(null,function(a,c,b,d,e,f){this.debug=a;this.showDebugBoxVolumes=c;this.bvhType=b;this.maxObjectsPerNode=d;this.maxDepth=e;this.minRelativeBBoxSize="undefined"!==f?f:0.01;this.MASK_SET=63});x3dom.bvh.DataNode=defineClass(null,function(a){this.drawable=a;this.bbox=new x3dom.fields.BoxVolume;this.bbox.transformFrom(a.transform,a.shape.getVolume());a.worldVolume=x3dom.fields.BoxVolume.copy(this.bbox)});
x3dom.bvh.Base=defineClass(null,function(a){this.dataNodes=[];this.coveredBoxVolume=this.drawableCollection=null;this.settings=a},{addDrawable:function(a){this.dataNodes.push(new x3dom.bvh.DataNode(a))},getHierarchyNodeBoxVolume:function(a){return this.dataNodes.length>a?this.dataNodes[a].bbox:null},build:function(){},collectDrawables:function(a){},getLongestAxisForBox:function(a){var c=new x3dom.fields.SFVec3f,b=new x3dom.fields.SFVec3f;a.getBounds(c,b);a=Math.abs(b.x-c.x);var d=Math.abs(b.y-c.y),
c=Math.abs(b.z-c.z),b="x";d>a&&(a=d,b="y");return c>a?"z":b},calculateBBoxForDataNodes:function(){var a=x3dom.fields.BoxVolume.copy(this.dataNodes[0].bbox),c=new x3dom.fields.SFVec3f,b=new x3dom.fields.SFVec3f,d=new x3dom.fields.SFVec3f,e=new x3dom.fields.SFVec3f;a.getBounds(c,b);for(var f=1,g=this.dataNodes.length;f<g;++f)this.dataNodes[f].bbox.getBounds(d,e),d.x<c.x&&(c.x=d.x),e.x>b.x&&(b.x=e.x),d.y<c.y&&(c.y=d.y),e.y>b.y&&(b.y=e.y),d.z<c.z&&(c.z=d.z),e.z>b.z&&(b.z=e.z);a.setBounds(c,b);return a},
splitBoxVolume:function(a,c,b,d){var e=new x3dom.fields.SFVec3f,f=new x3dom.fields.SFVec3f;a.getBounds(e,f);a=x3dom.fields.SFVec3f.copy(e);var g=x3dom.fields.SFVec3f.copy(f),e=x3dom.fields.SFVec3f.copy(e),f=x3dom.fields.SFVec3f.copy(f);g[c]=b;e[c]=d;return[new x3dom.fields.BoxVolume(a,g),new x3dom.fields.BoxVolume(e,f)]},calculateCoverage:function(a){var c=this.drawableCollection.viewMatrix,b=c.multMatrixPnt(a.getCenter());a=c.multMatrixVec(a.getRadialVec()).length();b=Math.max(-b.z-a,this.drawableCollection.near)*
this.drawableCollection.pixelHeightAtDistOne;return 2*a/b}});
x3dom.bvh.DebugDecorator=defineClass(null,function(a,c,b){this.bvh=a;this.scene=c;this.debugShape=null;this.renderedDrawablesCount=0},{addDrawable:function(a){this.bvh.addDrawable(a)},compile:function(){this.bvh.settings.showDebugBoxVolumes&&null!=this.scene&&this.createDebugShape();"jsBIH"==this.bvh.settings.bvhType&&x3dom.Utils.startMeasure("buildBVH");this.bvh.compile();this.bvh.settings.debug&&"jsBIH"==this.bvh.settings.bvhType&&(console.log("Compile time: "+x3dom.Utils.stopMeasure("buildBVH")),
console.log("BVH : %o",this.bvh));this.bvh.settings.showDebugBoxVolumes&&("jsBIH"==this.bvh.settings.bvhType&&this.addHierarchyBoxVolumes(),this.createLineRenderersFromBoxVolumes())},showCompileStats:function(){this.bvh.showCompileStats()},collectDrawables:function(a){this.renderedDrawablesCount=a.length;this.bvh.collectDrawables(a);this.renderedDrawablesCount=a.length-this.renderedDrawablesCount},createDebugShape:function(){this.debugShape=new x3dom.nodeTypes.Shape;this.debugShape._nameSpace=this.scene._nameSpace;
this.bvh.geo=null;this.bvh.coords=null;if(!this.debugShape._cf.appearance.node){var a=x3dom.nodeTypes.Appearance.defaultNode(),c=x3dom.nodeTypes.Material.defaultNode();c._vf.diffuseColor=new x3dom.fields.SFColor(1,0,0);c._vf.specularColor=new x3dom.fields.SFColor(1,0,0);c._vf.emissiveColor=new x3dom.fields.SFColor(1,0,0);a.addChild(c);this.debugShape.addChild(a)}this.debugShape._cf.geometry.node||(this.bvh.geo=new x3dom.nodeTypes.IndexedLineSet,this.bvh.coords=new x3dom.nodeTypes.Coordinate)},addHierarchyBoxVolumes:function(){for(var a=
0,c;null!=(c=this.bvh.getHierarchyNodeBoxVolume(a));)this.addBoxVolumeToGeometry(c,this.bvh.geo),a++},createLineRenderersFromBoxVolumes:function(){for(var a=0,c=this.bvh.geo._mesh._positions[0].length;a<c;++a)this.bvh.coords._vf.point.push(this.bvh.geo._mesh._positions[0][a]);a=0;for(c=this.bvh.geo._mesh._indices[0].length;a<c;++a)this.bvh.geo._vf.coordIndex.push(this.bvh.geo._mesh._indices[0][a]),this.bvh.geo._vf.colorIndex.push(0);this.bvh.geo.addChild(this.bvh.coords);this.debugShape.addChild(this.bvh.geo);
this.bvh.geo.nodeChanged();this.scene.addChild(this.debugShape);this.debugShape.nodeChanged();this.scene.nodeChanged()},addBoxVolumeToGeometry:function(a,c){var b=new x3dom.fields.SFVec3f,d=new x3dom.fields.SFVec3f;a.getBounds(b,d);var e=c._mesh._positions[0].length;c._mesh._positions[0].push(new x3dom.fields.SFVec3f(b.x,b.y,b.z),new x3dom.fields.SFVec3f(b.x,b.y,d.z),new x3dom.fields.SFVec3f(b.x,d.y,b.z),new x3dom.fields.SFVec3f(b.x,d.y,d.z),new x3dom.fields.SFVec3f(d.x,b.y,b.z),new x3dom.fields.SFVec3f(d.x,
b.y,d.z),new x3dom.fields.SFVec3f(d.x,d.y,b.z),new x3dom.fields.SFVec3f(d.x,d.y,d.z));c._mesh._indices[0].push(e,e+1,-1,e,e+2,-1,e,e+4,-1,e+1,e+3,-1,e+1,e+5,-1,e+2,e+3,-1,e+2,e+6,-1,e+4,e+5,-1,e+4,e+6,-1,e+7,e+3,-1,e+7,e+5,-1,e+7,e+6,-1)},showTraverseStats:function(a){this.bvh.showTraverseStats(a)}});x3dom.bvh.BihNode=defineClass(null,function(){this.leftChild=this.rightChild=null;this.split_axis=-1;this.clip=[0,0];this.bbox=null;this.dataIndex=[0,0]});
x3dom.bvh.BIH=defineClass(x3dom.bvh.Base,function(a,c){x3dom.bvh.BIH.superClass.call(this,c);this.bihNodes=[];this.index=[];this.env=a.getEnvironment()},{getNodeForIndex:function(a){for(;this.bihNodes.length<=a;)this.bihNodes.push(new x3dom.bvh.BihNode);return this.bihNodes[a]},bucketSort:function(a,c,b,d){for(var e=0,f,g=0;g<c;++g)f=this.dataNodes[this.index[a+g]].bbox.getCenter(),f[d]<b&&(f=this.index[a+g],this.index[a+g]=this.index[a+e],this.index[a+e]=f,e+=1);return e},processNode:function(a,
c,b,d,e){a=this.getNodeForIndex(a);a.bbox=d;a.split_axis=this.getLongestAxisForBox(d);var f=d.getCenter()[a.split_axis],f=this.bucketSort(c,b,f,a.split_axis),g=b-f;a.clip[0]=d.min[a.split_axis];a.clip[1]=d.max[a.split_axis];for(var h=c+f,k=0,l=0,k=c;k<h;++k)l=this.dataNodes[this.index[k]].bbox.max[a.split_axis],l>a.clip[0]&&(a.clip[0]=l);for(k=h;k<c+b;++k)l=this.dataNodes[this.index[k]].bbox.min[a.split_axis],l<a.clip[1]&&(a.clip[1]=l);b=d.getDiameter()/this.coveredBoxVolume.getDiameter()<=this.settings.minRelativeBBoxSize;
d=this.splitBoxVolume(d,a.split_axis,a.clip[0],a.clip[1]);f>this.settings.maxObjectsPerNode&&e<this.settings.maxDepth&&!b?a.leftChild=this.processNode(this.bihNodes.length,c,f,d[0],e+1):(a.leftChild=this.getNodeForIndex(this.bihNodes.length),a.leftChild.bbox=1==f?this.dataNodes[this.index[c]].bbox:d[0],a.leftChild.dataIndex[0]=c,a.leftChild.dataIndex[1]=f);g>this.settings.maxObjectsPerNode&&e<this.settings.maxDepth&&!b?a.rightChild=this.processNode(this.bihNodes.length,c+f,g,d[1],e+1):(a.rightChild=
this.getNodeForIndex(this.bihNodes.length),a.rightChild.bbox=1==g?this.dataNodes[this.index[c+f]].bbox:d[1],a.rightChild.dataIndex[0]=c+f,a.rightChild.dataIndex[1]=g);return a},getHierarchyNodeBoxVolume:function(a){return this.bihNodes.length>a?this.bihNodes[a].bbox:null},compile:function(){if(0!=this.dataNodes.length){this.coveredBoxVolume=this.calculateBBoxForDataNodes();for(var a=0,c=this.dataNodes.length;a<c;++a)this.index.push(a);this.processNode(0,0,this.dataNodes.length,this.coveredBoxVolume,
0)}},showCompileStats:function(){},collectDrawables:function(a){this.drawableCollection=a;0<this.bihNodes.length&&this.intersect(this.bihNodes[0],0)},calculateCoverage:function(a){var c=this.drawableCollection.viewMatrix,b=c.multMatrixPnt(a.getCenter());a=c.multMatrixVec(a.getRadialVec()).length();b=Math.max(-b.z-a,this.drawableCollection.near)*this.drawableCollection.pixelHeightAtDistOne;return 2*a/b},intersect:function(a,c){c<this.settings.MASK_SET&&(c=this.drawableCollection.viewFrustum.intersect(a.bbox,
c));if(0<=c)if(-1==a.split_axis)for(var b=0,d=a.dataIndex[1];b<d;++b){var e=this.dataNodes[this.index[a.dataIndex[0]+b]],f=this.calculateCoverage(e.bbox);f>=this.env._vf.smallFeatureThreshold&&(e.drawable.priority=f,this.drawableCollection.addDrawable(e.drawable))}else f=this.calculateCoverage(a.bbox),f>=this.env._vf.smallFeatureThreshold&&(this.intersect(a.leftChild,c),this.intersect(a.rightChild,c))},showTraverseStats:function(a){}});
x3dom.bvh.Culler=defineClass(null,function(a,c,b){this.drawableCollection=a;this.scene=c;this.settings=b;this.frameId=0;this.compileSetup=new Module.CompileSetup;this.compileSetup.poolSize=this.drawableCollection.length;this.compileSetup.debug=this.settings.debug;this.compileSetup.showDebugBoxVolumes=this.settings.showDebugBoxVolumes;this.compileSetup.dataStructureType="OCTREE"==this.settings.bvhType?Module.DataStructureType.OCTREE:Module.DataStructureType.BIH;this.compileSetup.maxObjectsPerNode=
this.settings.maxObjectsPerNode;this.compileSetup.maxDepth=this.settings.maxDepth;var d=this;this.compileSetup.setJsCallbacks(Module.JsCallbacks.implement({addStructureBoxVolume:function(a,c){var b=c.min,h=c.max,b=new x3dom.fields.SFVec3f(b.x,b.y,b.z),h=new x3dom.fields.SFVec3f(h.x,h.y,h.z),k=d.geo._mesh._positions[0].length;d.geo._mesh._positions[0].push(new x3dom.fields.SFVec3f(b.x,b.y,b.z),new x3dom.fields.SFVec3f(b.x,b.y,h.z),new x3dom.fields.SFVec3f(b.x,h.y,b.z),new x3dom.fields.SFVec3f(b.x,
h.y,h.z),new x3dom.fields.SFVec3f(h.x,b.y,b.z),new x3dom.fields.SFVec3f(h.x,b.y,h.z),new x3dom.fields.SFVec3f(h.x,h.y,b.z),new x3dom.fields.SFVec3f(h.x,h.y,h.z));d.geo._mesh._indices[0].push(k,k+1,-1,k,k+2,-1,k,k+4,-1,k+1,k+3,-1,k+1,k+5,-1,k+2,k+3,-1,k+2,k+6,-1,k+4,k+5,-1,k+4,k+6,-1,k+7,k+3,-1,k+7,k+5,-1,k+7,k+6,-1)},timeNow:function(){return performance.now()}}));this.culler=new Module.Culler(this.compileSetup);this.traverseSetup=new Module.TraverseSetup},{addDrawable:function(a){var c=this;a=new Module.DrawableContainer.implement({drawable:a,
addDrawableToCollection:function(a){this.drawable.priority=a;c.drawableCollection.addDrawable(this.drawable)},createBoxVolume:function(){var a=new x3dom.fields.BoxVolume;a.transformFrom(this.drawable.transform,this.drawable.shape.getVolume());this.drawable.worldVolume=x3dom.fields.BoxVolume.copy(a);var c=new x3dom.fields.SFVec3f,e=new x3dom.fields.SFVec3f;a.getBounds(c,e);return new Module.BoxVolume(new Module.SFVec3f(c.x,c.y,c.z),new Module.SFVec3f(e.x,e.y,e.z))}});this.culler.addDrawable(a)},compile:function(){this.culler.compile()},
showCompileStats:function(){console.log(this.culler.stats())},collectDrawables:function(a){this.drawableCollection=a;var c=this.drawableCollection.viewFrustum;a=this.drawableCollection.viewMatrix;a=new Module.SFMatrix4f(a._00,a._01,a._02,a._03,a._10,a._11,a._12,a._13,a._20,a._21,a._22,a._23,a._30,a._31,a._32,a._33);this.traverseSetup.setModelViewMatrix(a);c=new Module.FrustumVolume(c.planeNormals[0].x,c.planeNormals[0].y,c.planeNormals[0].z,c.planeDistances[0],c.planeNormals[1].x,c.planeNormals[1].y,
c.planeNormals[1].z,c.planeDistances[1],c.planeNormals[2].x,c.planeNormals[2].y,c.planeNormals[2].z,c.planeDistances[2],c.planeNormals[3].x,c.planeNormals[3].y,c.planeNormals[3].z,c.planeDistances[3],c.planeNormals[4].x,c.planeNormals[4].y,c.planeNormals[4].z,c.planeDistances[4],c.planeNormals[5].x,c.planeNormals[5].y,c.planeNormals[5].z,c.planeDistances[5]);this.traverseSetup.setViewFrustum(c);this.traverseSetup.pixelHeightAtDistOne=this.drawableCollection.pixelHeightAtDistOne;this.traverseSetup.nearClippingPlane=
this.drawableCollection.near;var b=this.scene.getEnvironment();this.traverseSetup.viewFrustumCulling=b._vf.frustumCulling;this.traverseSetup.smallFeatureCulling=b._vf.smallFeatureCulling;this.traverseSetup.occlusionCulling=b._vf.occlusionCulling;this.traverseSetup.smallFeatureThreshold=b._vf.smallFeatureThreshold;this.traverseSetup.useRenderQueue=!1;this.traverseSetup.frameId=this.frameId++;this.traverseSetup.traverserType=Module.TraverserType.DistanceQueue;this.culler.cull(this.traverseSetup);a["delete"]();
c["delete"]()},showTraverseStats:function(a){var c=this.culler.stats().culling;a.addInfo("#CNodes Visited",c.nodesVisited);a.addInfo("#Cull Frustum",c.nodesViewFrustumCulled);a.addInfo("#Cull SFeature",c.nodesSmallFeatureCulled);a.addInfo("#Cull OCC",c.nodesOcclusionCulled);a.addInfo("#Drawables SF",c.drawablesSmallFeatureCulled)}});
x3dom.X3DCanvas=function(a,c){var b=this;this.canvasIdx=c;this.initContext=function(c,b,d,e,f){x3dom.debug.logInfo("Initializing X3DCanvas for ["+c.id+"]");b=x3dom.gfx_webgl(c,b,d,e,a);return b?1>parseFloat(x3dom.caps.VERSION.match(/\d+\.\d+/)[0])&&!f?(x3dom.debug.logError("No valid 3D context found..."),this.x3dElem.removeChild(c),null):b:(x3dom.debug.logError("No 3D context found..."),this.x3dElem.removeChild(c),null)};this.initFlashContext=function(a,c){x3dom.debug.logInfo("Initializing X3DObject for ["+
a.id+"]");return x3dom.gfx_flash(a,c)};this.appendParam=function(a,c,b){var d=document.createElement("param");d.setAttribute("name",c);d.setAttribute("value",b);a.appendChild(d)};this.fileExists=function(a){var c=new XMLHttpRequest;try{return c.open("HEAD",a,!1),c.send(null),404!=c.status}catch(b){return!0}};this.detectFlash=function(a,c){var b=0;if("object"==typeof navigator.plugins["Shockwave Flash"])b=navigator.plugins["Shockwave Flash"].description,b=b.substr(16,b.indexOf(".",16)-16);else if("function"==
typeof ActiveXObject)for(var d=10;d<c+1;d++)try{"object"==typeof new ActiveXObject("ShockwaveFlash.ShockwaveFlash."+d)&&(b=d+1)}catch(e){}return[b,a]};this.createInitFailedDiv=function(a){var c=document.createElement("div");c.setAttribute("id","x3dom-create-init-failed");c.style.width=a.getAttribute("width");c.style.height=a.getAttribute("height");c.style.backgroundColor="#C00";c.style.color="#FFF";c.style.fontSize="20px";c.style.fontWidth="bold";c.style.padding="10px 10px 10px 10px";c.style.display=
"inline-block";c.style.fontFamily="Helvetica";c.style.textAlign="center";c.appendChild(document.createTextNode("Your Browser does not support X3DOM"));c.appendChild(document.createElement("br"));c.appendChild(document.createTextNode("Read more about Browser support on:"));c.appendChild(document.createElement("br"));var b=document.createElement("a");b.setAttribute("href","http://www.x3dom.org/?page_id=9");b.appendChild(document.createTextNode("X3DOM | Browser Support"));c.appendChild(b);if(b=a.getAttribute("altImg")||
null)(new Image).src=b,c.style.backgroundImage="url("+b+")",c.style.backgroundRepeat="no-repeat",c.style.backgroundPosition="50% 50%";a.appendChild(c);x3dom.debug.logError("Your Browser does not support X3DOM!")};this.createFlashObject=function(a){var c=this.detectFlash(11,11);if(!c[0]||c[0]<c[1])return null;x3dom.debug.logInfo("Creating FlashObject for (X)3D element...");var c=a.getAttribute("id"),c=null!==c?"x3dom-"+c+"-object":"x3dom-"+(new Date).getTime()+"-object",b=a.getAttribute("swfpath");
null===b&&(b="x3dom.swf");if(!this.fileExists(b)){var d;d=void 0===x3dom.versionInfo||-1!=x3dom.versionInfo.version.indexOf("dev")?"dev":x3dom.versionInfo.version.substr(3);b="http://www.x3dom.org/download/"+d+"/x3dom.swf";x3dom.debug.logWarning("Can't find local x3dom.swf ("+d+"). X3DOM now using the online version from x3dom.org.The online version needs a <a href='http://examples.x3dom.org/crossdomain.xml'>crossdomain.xml</a> file in the root directory of your domain to access textures")}d=a.getAttribute("width");
var e=-1;null==d?d=550:(e=d.indexOf("px"),-1!=e&&(d=d.substr(0,e)));var f=a.getAttribute("height");null==f?f=400:(e=f.indexOf("px"),-1!=e&&(f=f.substr(0,e)));null==a.getAttribute("flashrenderer")?this.flash_renderType="forward":this.flash_renderType="deferred";e=document.createElement("object");e.setAttribute("width","100%");e.setAttribute("height","100%");e.setAttribute("id",c);!document.doctype||document.doctype&&-1!=document.doctype.publicId.search(/DTD XHTML/i)?(x3dom.debug.logWarning("Flash backend doesn't like XHTML, please use HTML5!"),
e.setAttribute("style","width:"+d+"px; height:"+f+"px;")):null==a.getAttribute("style")&&a.setAttribute("style","width:"+d+"px; height:"+f+"px;");this.appendParam(e,"menu","false");this.appendParam(e,"quality","high");this.appendParam(e,"wmode","direct");this.appendParam(e,"allowScriptAccess","always");this.appendParam(e,"flashvars","canvasIdx="+this.canvasIdx+"&renderType="+this.flash_renderType);this.appendParam(e,"movie",b);"Microsoft Internet Explorer"==navigator.appName?(a.appendChild(e),e.setAttribute("classid",
"clsid:d27cdb6e-ae6d-11cf-96b8-444553540000")):(e.setAttribute("type","application/x-shockwave-flash"),e.setAttribute("data",b),a.appendChild(e));return e};this.createHTMLCanvas=function(a){x3dom.debug.logInfo("Creating canvas for (X)3D element...");var c=document.createElement("canvas");c.setAttribute("class","x3dom-canvas");a.getAttribute("style")&&x3dom.debug.logInfo("Inline X3D styles detected");for(var d="onmousedown onmousemove onmouseout onmouseover onmouseup onclick ondblclick onkeydown onkeypress onkeyup ontouchstart ontouchmove ontouchend ontouchcancel ontouchleave ontouchenter onMozTouchDown onMozTouchMove onMozTouchUp ondragstart ondrop ondragover".split(" "),
e=0;e<d.length;e++){var f=d[e],g=a.getAttribute(f);g&&(x3dom.debug.logInfo(f+", "+g),c.setAttribute(f,g))}if(e=a.getAttribute("draggable"))x3dom.debug.logInfo("draggable="+e),c.setAttribute("draggable",e);a.__addEventListener||a.__removeEventListener||(a.__addEventListener=a.addEventListener,a.__removeEventListener=a.removeEventListener,a.addEventListener=function(a,c,e){var f,g=!1;for(f=0;f<d.length&&!g;f++)d[f]===a&&(g=!0);g?(x3dom.debug.logInfo("addEventListener for div.on"+a),b.canvas.addEventListener(a,
c,e)):(x3dom.debug.logInfo("addEventListener for X3D.on"+a),this.__addEventListener(a,c,e))},a.removeEventListener=function(a,c,e){var f,g=!1;for(f=0;f<d.length&&!g;f++)d[f]===a&&(g=!0);g?(x3dom.debug.logInfo("removeEventListener for div.on"+a),b.canvas.removeEventListener(a,c,e)):(x3dom.debug.logInfo("removeEventListener for X3D.on"+a),this.__removeEventListener(a,c,e))});a.appendChild(c);e=a.getAttribute("id");null===e&&(e=(new Date).getTime());c.id="x3dom-"+e+"-canvas";null!==(e=a.getAttribute("width"))&&
(0<=e.indexOf("%")&&x3dom.debug.logWarning("The width attribute is to be specified in pixels not in percent."),c.style.width=e,c.setAttribute("width",e));null!==(a=a.getAttribute("height"))&&(0<=a.indexOf("%")&&x3dom.debug.logWarning("The height attribute is to be specified in pixels not in percent."),c.style.height=a,c.setAttribute("height",a));c.setAttribute("tabindex","0");return c};var d=[0,0];this.watchForResize=function(){var a=[parseInt(x3dom.getStyle(b.canvas,"width")),parseInt(x3dom.getStyle(b.canvas,
"height"))];if(d[0]!=a[0]||d[1]!=a[1])d=a,b.x3dElem.setAttribute("width",a[0]+"px"),b.x3dElem.setAttribute("height",a[1]+"px")};this.createProgressDiv=function(){var a=document.createElement("div");a.setAttribute("class","x3dom-progress");var c=document.createElement("strong");c.appendChild(document.createTextNode("Loading..."));a.appendChild(c);c=document.createElement("span");c.setAttribute("style","width: 25%;");c.appendChild(document.createTextNode(" "));a.appendChild(c);a.oncontextmenu=a.onmousedown=
function(a){a.preventDefault();a.stopPropagation();return a.returnValue=!1};return a};this.isFlashReady=!1;this.x3dElem=a;x3dom.caps.MOBILE=-1<navigator.appVersion.indexOf("Mobile");this.backend=(this.backend=this.x3dElem.getAttribute("backend"))?this.backend.toLowerCase():"none";if("flash"==this.backend)if(this.backend="flash",this.canvas=this.createFlashObject(a),null!=this.canvas)this.canvas.parent=this,this.gl=this.initFlashContext(this.canvas,this.flash_renderType);else{this.createInitFailedDiv(a);
return}else if(this.canvas=this.createHTMLCanvas(a),this.canvas.parent=this,this.gl=this.initContext(this.canvas,0<=this.backend.search("desktop"),0<=this.backend.search("mobile"),0<=this.backend.search("webgl2"),0<=this.backend.search("ie11")),this.backend="webgl",null==this.gl)if(x3dom.debug.logInfo("Fallback to Flash Renderer"),this.backend="flash",this.canvas=this.createFlashObject(a),null!=this.canvas)this.canvas.parent=this,this.gl=this.initFlashContext(this.canvas,this.flash_renderType);else{this.createInitFailedDiv(a);
return}x3dom.caps.BACKEND=this.backend;this.fps_t0=(new Date).getTime();this.framesSinceLastTime=this.lastTimeFPSWasTaken=0;this.doc=null;a.__setAttribute=a.setAttribute;a.setAttribute=function(a,c){this.__setAttribute(a,c);switch(a){case "width":b.canvas.setAttribute("width",c);b.doc._viewarea&&(b.doc._viewarea._width=parseInt(b.canvas.getAttribute("width"),0));break;case "height":b.canvas.setAttribute("height",c),b.doc._viewarea&&(b.doc._viewarea._height=parseInt(b.canvas.getAttribute("height"),
0))}b.doc.needRender=!0};var e=a.getAttribute("runtimeEnabled");this.hasRuntime=null!==e?"true"==e.toLowerCase():a.hasRuntime;null===this.gl&&(this.hasRuntime=!1);"flash"!=this.backend&&(this.showStat=a.getAttribute("showStat"),this.stateViewer=new x3dom.States(a),null!==this.showStat&&"true"==this.showStat&&this.stateViewer.display(!0),this.x3dElem.appendChild(this.stateViewer.viewer));this.showProgress=a.getAttribute("showProgress");this.progressDiv=this.createProgressDiv();this.progressDiv.style.display=
null!==this.showProgress&&"true"==this.showProgress?"inline":"none";this.x3dElem.appendChild(this.progressDiv);this.showTouchpoints=(this.showTouchpoints=a.getAttribute("showTouchpoints"))?"false"!=this.showTouchpoints.toLowerCase():!0;this.disableTouch=(this.disableTouch=a.getAttribute("disableTouch"))?"true"==this.disableTouch.toLowerCase():!1;if(null!==this.canvas&&null!==this.gl&&this.hasRuntime&&"flash"!==this.backend){this.canvas.mouse_dragging=!1;this.canvas.mouse_button=0;this.canvas.mouse_drag_x=
0;this.canvas.mouse_drag_y=0;this.canvas.isMulti=!1;this.canvas.oncontextmenu=function(a){a.preventDefault();a.stopPropagation();return a.returnValue=!1};this.canvas.addEventListener("webglcontextlost",function(a){x3dom.debug.logError("WebGL context lost");a.preventDefault()},!1);this.canvas.addEventListener("webglcontextrestored",function(a){x3dom.debug.logError("recover WebGL state and resources on context lost NYI");a.preventDefault()},!1);this.canvas.addEventListener("mousedown",function(a){if(!this.isMulti){this.focus();
switch(a.button){case 0:this.mouse_button=1;break;case 1:this.mouse_button=4;break;case 2:this.mouse_button=2;break;default:this.mouse_button=0}a.shiftKey&&(this.mouse_button=1);a.ctrlKey&&(this.mouse_button=4);a.altKey&&(this.mouse_button=2);var c=this.parent.mousePosition(a);this.mouse_drag_x=c.x;this.mouse_drag_y=c.y;this.mouse_dragging=!0;this.parent.doc.onMousePress(b.gl,this.mouse_drag_x,this.mouse_drag_y,this.mouse_button);this.parent.doc.needRender=!0;a.returnValue=!0}},!1);this.canvas.addEventListener("mouseup",
function(a){if(!this.isMulti){var c=this.mouse_button;this.mouse_button=0;this.mouse_dragging=!1;this.parent.doc.onMouseRelease(b.gl,this.mouse_drag_x,this.mouse_drag_y,this.mouse_button,c);this.parent.doc.needRender=!0;a.returnValue=!0}},!1);this.canvas.addEventListener("mouseover",function(a){this.isMulti||(this.mouse_button=0,this.mouse_dragging=!1,this.parent.doc.onMouseOver(b.gl,this.mouse_drag_x,this.mouse_drag_y,this.mouse_button),this.parent.doc.needRender=!0,a.returnValue=!0)},!1);this.canvas.addEventListener("mouseout",
function(a){this.isMulti||(this.mouse_button=0,this.mouse_dragging=!1,this.parent.doc.onMouseOut(b.gl,this.mouse_drag_x,this.mouse_drag_y,this.mouse_button),this.parent.doc.needRender=!0,a.returnValue=!0)},!1);this.canvas.addEventListener("dblclick",function(a){if(!this.isMulti){this.mouse_button=0;var c=this.parent.mousePosition(a);this.mouse_drag_x=c.x;this.mouse_drag_y=c.y;this.mouse_dragging=!1;this.parent.doc.onDoubleClick(b.gl,this.mouse_drag_x,this.mouse_drag_y);this.parent.doc.needRender=
!0;a.returnValue=!0}},!1);this.canvas.addEventListener("mousemove",function(a){if(!this.isMulti){a.shiftKey&&(this.mouse_button=1);a.ctrlKey&&(this.mouse_button=4);a.altKey&&(this.mouse_button=2);var c=this.parent.mousePosition(a);this.mouse_drag_x=c.x;this.mouse_drag_y=c.y;if(this.mouse_dragging)this.parent.doc.onDrag(b.gl,this.mouse_drag_x,this.mouse_drag_y,this.mouse_button);else this.parent.doc.onMove(b.gl,this.mouse_drag_x,this.mouse_drag_y,this.mouse_button);this.parent.doc.needRender=!0;a.preventDefault();
a.stopPropagation();a.returnValue=!1}},!1);this.canvas.addEventListener("DOMMouseScroll",function(a){this.isMulti||(this.focus(),this.mouse_drag_y+=2*a.detail,this.parent.doc.onDrag(b.gl,this.mouse_drag_x,this.mouse_drag_y,2),this.parent.doc.needRender=!0,a.preventDefault(),a.stopPropagation(),a.returnValue=!1)},!1);this.canvas.addEventListener("mousewheel",function(a){this.isMulti||(this.focus(),this.mouse_drag_y-=0.1*a.wheelDeltaY,this.parent.doc.onDrag(b.gl,this.mouse_drag_x,this.mouse_drag_y,
2),this.parent.doc.needRender=!0,a.preventDefault(),a.stopPropagation(),a.returnValue=!1)},!1);this.canvas.addEventListener("keypress",function(a){var c=this.parent.x3dElem.getAttribute("keysEnabled");if(!c||"true"==c.toLowerCase())this.parent.doc.onKeyPress(a.charCode);this.parent.doc.needRender=!0;a.returnValue=!0},!0);this.canvas.addEventListener("keyup",function(a){var c=this.parent.x3dElem.getAttribute("keysEnabled");if(!c||"true"==c.toLowerCase())this.parent.doc.onKeyUp(a.keyCode);this.parent.doc.needRender=
!0;a.returnValue=!0},!0);this.canvas.addEventListener("keydown",function(a){var c=this.parent.x3dElem.getAttribute("keysEnabled");if(!c||"true"==c.toLowerCase())this.parent.doc.onKeyDown(a.keyCode);this.parent.doc.needRender=!0;a.returnValue=!0},!0);var f={numTouches:0,firstTouchTime:(new Date).getTime(),firstTouchPoint:new x3dom.fields.SFVec2f(0,0),lastDrag:new x3dom.fields.SFVec2f,lastMiddle:new x3dom.fields.SFVec2f,lastDistance:new x3dom.fields.SFVec2f,lastSquareDistance:0,lastAngle:0,lastLayer:[],
examineNavType:!0,calcAngle:function(a){var c=a.normalize().dot(new x3dom.fields.SFVec2f(1,0)),c=Math.acos(c);0>a.y&&(c=Math.PI+(Math.PI-c));return c},disableTouch:this.disableTouch,visMarker:this.showTouchpoints,visMarkerBag:[],visualizeTouches:function(a){if(this.visMarker){for(var c=[],b=null,d=0;d<a.touches.length;d++){var e=a.touches[d].identifier||a.touches[d].streamId;e||(e=0);b=this.visMarkerBag.indexOf(e);0<=b?(b=document.getElementById("visMarker"+e),b.style.left=a.touches[d].pageX+"px",
b.style.top=a.touches[d].pageY+"px"):(b=document.createElement("div"),b.appendChild(document.createTextNode("#"+e)),b.id="visMarker"+e,b.className="x3dom-touch-marker",document.body.appendChild(b),b=this.visMarkerBag.length,this.visMarkerBag[b]=e);c.push(e)}for(a=this.visMarkerBag.length-1;0<=a;a--)b=this.visMarkerBag[a],0>c.indexOf(b)&&(this.visMarkerBag.splice(a,1),b=document.getElementById("visMarker"+b),document.body.removeChild(b))}}},g=[],h={touches:[],preventDefault:function(){}},k=function(a,
c){this.isMulti=!0;a.preventDefault();f.visualizeTouches(a);this.focus();null==c&&(c=this.parent.doc);var d=c._scene.getNavigationInfo();f.examineNavType="examine"==d.getType();f.lastLayer=[];for(var e,d=0;d<a.touches.length;d++)e=this.parent.mousePosition(a.touches[d]),f.lastLayer.push([a.touches[d].identifier,new x3dom.fields.SFVec2f(e.x,e.y)]);if(1>f.numTouches&&1==a.touches.length)f.numTouches=1,f.lastDrag=new x3dom.fields.SFVec2f(a.touches[0].screenX,a.touches[0].screenY);else if(2>f.numTouches&&
2<=a.touches.length){f.numTouches=2;e=new x3dom.fields.SFVec2f(a.touches[0].screenX,a.touches[0].screenY);d=(new x3dom.fields.SFVec2f(a.touches[1].screenX,a.touches[1].screenY)).subtract(e);e=d.multiply(0.5).add(e);var g=d.dot(d);f.lastDistance=d;f.lastMiddle=e;f.lastSquareDistance=g;f.lastAngle=f.calcAngle(d)}c._scene.updateVolume();if(f.examineNavType)for(d=0;d<a.touches.length;d++)e=this.parent.mousePosition(a.touches[d]),c.onPick(b.gl,e.x,e.y),c._viewarea.prepareEvents(e.x,e.y,1,"onmousedown"),
c._viewarea._pickingInfo.lastClickObj=c._viewarea._pickingInfo.pickObj;else a.touches.length&&(e=this.parent.mousePosition(a.touches[0]),c.onMousePress(b.gl,e.x,e.y,1));c.needRender=!0},e=function(a){this.isMulti=!0;a.preventDefault();for(var c=!0,b=0;b<g.length;++b)g[b]==a.streamId&&(c=!1);!0==c&&(a.identifier=a.streamId,g.push(a.streamId),h.touches.push(a));k(h,this.parent.doc)},l=function(a,c){a.preventDefault();f.visualizeTouches(a);null==c&&(c=this.parent.doc);var d=null,e=null;if(f.examineNavType)if(1==
a.touches.length){var g=new x3dom.fields.SFVec2f(a.touches[0].screenX,a.touches[0].screenY),d=g.subtract(f.lastDrag);f.lastDrag=g;g=x3dom.fields.SFMatrix4f.rotationY(d.x/100);d=x3dom.fields.SFMatrix4f.rotationX(d.y/100);e=g.mult(d);c.onMoveView(b.gl,null,e)}else{if(2<=a.touches.length){var g=new x3dom.fields.SFVec2f(a.touches[0].screenX,a.touches[0].screenY),d=(new x3dom.fields.SFVec2f(a.touches[1].screenX,a.touches[1].screenY)).subtract(g),g=d.multiply(0.5).add(g),h=d.dot(d),k=g.subtract(f.lastMiddle),
k=new x3dom.fields.SFVec3f(k.x/screen.width,-k.y/screen.height,(h-f.lastSquareDistance)/(screen.width*screen.height*0.2)),e=f.calcAngle(d),l=f.lastAngle-e;f.lastAngle=e;e=x3dom.fields.SFMatrix4f.rotationZ(l);f.lastMiddle=g;f.lastDistance=d;f.lastSquareDistance=h;c.onMoveView(b.gl,k,e)}}else a.touches.length&&(d=this.parent.mousePosition(a.touches[0]),c.onDrag(b.gl,d.x,d.y,1));c.needRender=!0},n=function(a){a.preventDefault();for(var c=0;c<g.length;++c)g[c]==a.streamId&&(h.touches[c]=a);l(h,this.parent.doc)},
q=function(a,c){this.isMulti=!1;a.preventDefault();f.visualizeTouches(a);null==c&&(c=this.parent.doc);c._viewarea._isMoving=!1;2==f.numTouches&&1==a.touches.length&&(f.lastDrag=new x3dom.fields.SFVec2f(a.touches[0].screenX,a.touches[0].screenY));var d=!1;2>a.touches.length&&(1==f.numTouches&&(d=!0),f.numTouches=a.touches.length);if(f.examineNavType){for(var e=0;e<f.lastLayer.length;e++){var g=f.lastLayer[e][1];c.onPick(b.gl,g.x,g.y);if("box"!==c._scene._vf.pickMode.toLowerCase())c._viewarea.prepareEvents(g.x,
g.y,1,"onmouseup"),(c._viewarea._pickingInfo.lastClickObj=c._viewarea._pickingInfo.pickObj)&&c._viewarea._pickingInfo.pickObj===c._viewarea._pickingInfo.lastClickObj&&c._viewarea.prepareEvents(g.x,g.y,1,"onclick");else{var h=c._viewarea.calcViewRay(g.x,g.y),k=c._scene.doIntersect(h),l=h.hitObject;k&&l&&(c._viewarea._pick.setValues(h.hitPoint),c._viewarea.checkEvents(l,g.x,g.y,1,"onclick"),x3dom.debug.logInfo("Hit '"+l._xmlNode.localName+"/ "+l._DEF+"' at pos "+c._viewarea._pick))}}if(d){d=(new Date).getTime();
if(18>f.firstTouchPoint.subtract(f.lastDrag).length()&&180>d-f.firstTouchTime)c.onDoubleClick(b.gl,0,0);f.firstTouchTime=d;f.firstTouchPoint=f.lastDrag}}else f.lastLayer.length&&(g=f.lastLayer[0][1],c.onMouseRelease(b.gl,g.x,g.y,0,1));c.needRender=!0},m=function(a){this.isMulti=!1;a.preventDefault();for(var c=-1,b=0;b<g.length;++b)g[b]==a.streamId&&(c=b);-1!=c&&(g.splice(c,1),h.touches.splice(c,1));q(h,this.parent.doc)};this.disableTouch||(this.canvas.addEventListener("MozTouchDown",e,!0),this.canvas.addEventListener("MozTouchMove",
n,!0),this.canvas.addEventListener("MozTouchUp",m,!0),this.canvas.addEventListener("touchstart",k,!0),this.canvas.addEventListener("touchmove",l,!0),this.canvas.addEventListener("touchend",q,!0))}this.mousePosition=function(a){var c=window.webkitConvertPointFromNodeToPage,b=0,d=0;if("getBoundingClientRect"in document.documentElement)var e=a.target.offsetParent,c=e.getBoundingClientRect(),b=window.pageXOffset||document.body.scrollLeft,d=window.pageYOffset||document.body.scrollTop,f=document.defaultView.getComputedStyle(e,
null),g=parseFloat(f.getPropertyValue("padding-left")),h=parseFloat(f.getPropertyValue("border-left-width")),e=parseFloat(f.getPropertyValue("padding-top")),f=parseFloat(f.getPropertyValue("border-top-width")),b=Math.round(a.pageX-(c.left+g+h+b)),d=Math.round(a.pageY-(c.top+e+f+d));else c?(a=c(a.target,new WebKitPoint(0,0)),b=Math.round(a.x),d=Math.round(a.y)):x3dom.debug.logError("NO getBoundingClientRect, NO webkitConvertPointFromNodeToPage");return new x3dom.fields.SFVec2f(b,d)}};
x3dom.X3DCanvas.prototype.tick=function(){try{var a=this.x3dElem.runtime,c=(new Date).getTime(),b=c-this.lastTimeFPSWasTaken,d=1E3/(c-this.fps_t0);this.fps_t0=c;this.doc.advanceTime(c/1E3);var e=(new Date).getTime()-c;this.doc.needRender&&(1E3<=b&&(a.fps=this.framesSinceLastTime/(b/1E3),a.addMeasurement("FPS",a.fps),this.framesSinceLastTime=0,this.lastTimeFPSWasTaken=c),this.framesSinceLastTime++,a.addMeasurement("ANIM",e),!1==a.isReady&&(a.ready(),a.isReady=!0),a.enterFrame(),"flash"==this.backend?
this.isFlashReady&&(this.canvas.setFPS({fps:d}),this.doc.needRender=!1,this.doc.render(this.gl)):(this.doc.needRender=!1,this.doc.render(this.gl),this.doc._scene._vf.doPickPass||a.removeMeasurement("PICKING")),a.exitFrame());this.progressDiv&&(0<this.doc.downloadCount?a.addInfo("#LOADS:",this.doc.downloadCount):a.removeInfo("#LOADS:"),"false"!==this.doc.properties.getProperty("showProgress")?this.progressDiv&&(this.progressDiv.childNodes[0].textContent="Loading: "+ +this.doc.downloadCount,this.progressDiv.style.display=
0<this.doc.downloadCount?"inline":"none"):this.progressDiv.style.display="none")}catch(f){throw x3dom.debug.logException(f),f;}};
x3dom.X3DCanvas.prototype.load=function(a,c,b){this.doc=new x3dom.X3DDocument(this.canvas,this.gl,b);var d=this;this.doc.onload=function(){d.hasRuntime?function f(){d.watchForResize();d.tick();window.requestAnimFrame(f,d)}():d.tick()};this.x3dElem.render=function(){d.hasRuntime?d.doc.needRender=!0:d.doc.render(d.gl)};this.x3dElem.context=d.gl.ctx3d;this.doc.onerror=function(){alert("Failed to load X3D document")};this.doc.load(a,c)};x3dom.runtime={};
x3dom.Runtime=function(a,c){this.doc=a;this.canvas=c;this.config={};this.isReady=!1;this.fps=0;this.states={measurements:[],infos:[]}};x3dom.Runtime.prototype.addMeasurement=function(a,c){this.states.measurements[a]=c};x3dom.Runtime.prototype.removeMeasurement=function(a){this.states.measurements[a]&&delete this.states.measurements[a]};x3dom.Runtime.prototype.addInfo=function(a,c){this.states.infos[a]=c};x3dom.Runtime.prototype.removeInfo=function(a){delete this.states.infos[a]};
x3dom.Runtime.prototype.initialize=function(a,c){this.doc=a;this.canvas=c;this.config={};this.isReady=!1;this.fps=0};x3dom.Runtime.prototype.noBackendFound=function(){x3dom.debug.logInfo("No backend found. Unable to render.")};x3dom.Runtime.prototype.ready=function(){x3dom.debug.logInfo("System ready.")};x3dom.Runtime.prototype.enterFrame=function(){};x3dom.Runtime.prototype.exitFrame=function(){};x3dom.Runtime.prototype.triggerRedraw=function(){this.canvas.doc.needRender=!0};
x3dom.Runtime.prototype.getActiveBindable=function(a){var c,b,d,e;c=this.canvas.doc._bindableBag._stacks;d=[];e=x3dom.nodeTypesLC[a.toLowerCase()];if(!e)return x3dom.debug.logError('No node of type "'+a+'" found.'),null;for(a=0;a<c.length;a++)b=c[a].getActive(),void 0!==b._xmlNode&&x3dom.isa(b,e)&&d.push(b);return d[0]?d[0]._xmlNode:null};x3dom.Runtime.prototype.nextView=function(){var a=this.canvas.doc._scene.getViewpoint()._stack;a?a.switchTo("next"):x3dom.debug.logError("No valid ViewBindable stack.")};
x3dom.Runtime.prototype.prevView=function(){var a=this.canvas.doc._scene.getViewpoint()._stack;a?a.switchTo("prev"):x3dom.debug.logError("No valid ViewBindable stack.")};x3dom.Runtime.prototype.viewpoint=function(){return this.canvas.doc._scene.getViewpoint()};x3dom.Runtime.prototype.viewMatrix=function(){return this.canvas.doc._viewarea.getViewMatrix()};x3dom.Runtime.prototype.projectionMatrix=function(){return this.canvas.doc._viewarea.getProjectionMatrix()};
x3dom.Runtime.prototype.getWorldToCameraCoordinatesMatrix=function(){return this.canvas.doc._viewarea.getWCtoCCMatrix()};x3dom.Runtime.prototype.getCameraToWorldCoordinatesMatrix=function(){return this.canvas.doc._viewarea.getCCtoWCMatrix()};x3dom.Runtime.prototype.getViewingRay=function(a,c){return this.canvas.doc._viewarea.calcViewRay(a,c)};
x3dom.Runtime.prototype.shootRay=function(a,c){var b=this.canvas.doc,d=b._viewarea._pickingInfo;b.onPick(this.canvas.gl,a,c);return{pickPosition:d.pickObj?d.pickPos:null,pickNormal:d.pickObj?d.pickNorm:null,pickObject:d.pickObj?d.pickObj._xmlNode:null}};x3dom.Runtime.prototype.getWidth=function(){return this.canvas.doc._viewarea._width};x3dom.Runtime.prototype.getHeight=function(){return this.canvas.doc._viewarea._height};
x3dom.Runtime.prototype.mousePosition=function(a){a=this.canvas.mousePosition(a);return[a.x,a.y]};x3dom.Runtime.prototype.calcCanvasPos=function(a,c,b){a=new x3dom.fields.SFVec3f(a,c,b);c=this.canvas.doc._viewarea.getWCtoCCMatrix().multFullMatrixPnt(a);b=this.canvas.doc._viewarea._height;a=Math.round((c.x+1)*(this.canvas.doc._viewarea._width-1)/2);c=Math.round((b-1)*(1-c.y)/2);return[a,c]};
x3dom.Runtime.prototype.calcPagePos=function(a,c,b){var d=this.canvas.canvas.offsetParent;if(!d)return x3dom.debug.logError("Can't calc page pos without offsetParent."),[0,0];var e=d.getBoundingClientRect();a=this.calcCanvasPos(a,c,b);c=window.pageXOffset||document.body.scrollLeft;b=window.pageYOffset||document.body.scrollTop;var f=document.defaultView.getComputedStyle(d,null),d=parseFloat(f.getPropertyValue("padding-left")),g=parseFloat(f.getPropertyValue("border-left-width")),h=parseFloat(f.getPropertyValue("padding-top")),
f=parseFloat(f.getPropertyValue("border-top-width"));return[e.left+d+g+c+a[0],e.top+h+f+b+a[1]]};
x3dom.Runtime.prototype.calcClientPos=function(a,c,b){var d=this.canvas.canvas.offsetParent;if(!d)return x3dom.debug.logError("Can't calc client pos without offsetParent."),[0,0];var e=d.getBoundingClientRect();a=this.calcCanvasPos(a,c,b);var f=document.defaultView.getComputedStyle(d,null),d=parseFloat(f.getPropertyValue("padding-left"));c=parseFloat(f.getPropertyValue("border-left-width"));b=parseFloat(f.getPropertyValue("padding-top"));f=parseFloat(f.getPropertyValue("border-top-width"));return[e.left+
d+c+a[0],e.top+b+f+a[1]]};x3dom.Runtime.prototype.getScreenshot=function(){var a="",c=this.canvas.backend,b=this.canvas.canvas;b&&("flash"==c?a=b.getScreenshot():(a=document.createElement("canvas"),a.width=b.width,a.height=b.height,c=a.getContext("2d"),c.drawImage(b,0,0,b.width,b.height),c.scale(1,-1),c.translate(0,-b.height),a=a.toDataURL()));return a};x3dom.Runtime.prototype.getCanvas=function(){return this.canvas.canvas};x3dom.Runtime.prototype.lightMatrix=function(){this.canvas.doc._viewarea.getLightMatrix()};
x3dom.Runtime.prototype.resetView=function(){this.canvas.doc._viewarea.resetView()};x3dom.Runtime.prototype.lightView=function(){if(0<this.canvas.doc._nodeBag.lights.length)return this.canvas.doc._viewarea.animateTo(this.canvas.doc._viewarea.getLightMatrix()[0],this.canvas.doc._scene.getViewpoint()),!0;x3dom.debug.logInfo("No lights to navigate to.");return!1};x3dom.Runtime.prototype.uprightView=function(){this.canvas.doc._viewarea.uprightView()};x3dom.Runtime.prototype.showAll=function(a){this.canvas.doc._viewarea.showAll(a)};
x3dom.Runtime.prototype.showObject=function(a){if(a&&a._x3domNode){var c=x3dom.fields.SFVec3f.MAX(),b=x3dom.fields.SFVec3f.MIN();a._x3domNode.getVolume().getBounds(c,b);var d=a._x3domNode.getCurrentTransform(),c=d.multMatrixPnt(c),b=d.multMatrixPnt(b);a=this.canvas.doc._viewarea;var e=a._width<a._height?a._width:a._height,f=new x3dom.fields.SFVec3f(0,0,1),g=this.canvas.doc._scene.getViewpoint(),h=g.getFieldOfView()/2,h=Math.tan(h);Math.abs(h)>x3dom.fields.Eps&&(e/=h);var k=a._width-1,l=a._height-
1,n=0.25,h=new x3dom.fields.SFVec2f(n*k,n*l),n=0.75,k=new x3dom.fields.SFVec2f(n*k,n*l),l=b.subtract(c).multiply(0.5),b=l.length(),c=c.add(l),k=k.subtract(h).multiply(0.5),l=1.5*k.length(),k=k.add(h),h=1;l>x3dom.fields.Eps&&(h=b/l*Math.sqrt(k.x*k.x+k.y*k.y+e*e));f=d.multMatrixVec(f).normalize();f=f.multiply(h);d=c.add(f);f=x3dom.fields.Quaternion.rotateFromTo(new x3dom.fields.SFVec3f(0,0,1),f).toMatrix();e=x3dom.fields.SFMatrix4f.translation(d.negate());d=x3dom.fields.SFMatrix4f.translation(d);d=
d.mult(f).mult(e).mult(d);f=d.inverse();a.animateTo(f,g)}};x3dom.Runtime.prototype.getCenter=function(a){return a&&a._x3domNode&&(this.isA(a,"X3DShapeNode")||this.isA(a,"X3DGeometryNode"))?a._x3domNode.getCenter():null};x3dom.Runtime.prototype.getCurrentTransform=function(a){return a&&a._x3domNode?a._x3domNode.getCurrentTransform():null};
x3dom.Runtime.prototype.getBBox=function(a){return a&&a._x3domNode&&this.isA(a,"X3DBoundedNode")?(a=a._x3domNode.getVolume(),{min:x3dom.fields.SFVec3f.copy(a.min),max:x3dom.fields.SFVec3f.copy(a.max)}):null};x3dom.Runtime.prototype.getSceneBBox=function(){var a=this.canvas.doc._scene;a.updateVolume();return{min:x3dom.fields.SFVec3f.copy(a._lastMin),max:x3dom.fields.SFVec3f.copy(a._lastMax)}};
x3dom.Runtime.prototype.debug=function(a){var c=this.canvas.doc;void 0===c._viewarea._visDbgBuf&&(c._viewarea._visDbgBuf="true"===c._x3dElem.getAttribute("showLog"));0<arguments.length?!0===a?(c._viewarea._visDbgBuf=!0,x3dom.debug.logContainer.style.display="block"):(c._viewarea._visDbgBuf=!1,x3dom.debug.logContainer.style.display="none"):(c._viewarea._visDbgBuf=!c._viewarea._visDbgBuf,x3dom.debug.logContainer.style.display=!0==c._viewarea._visDbgBuf?"block":"none");c.needRender=!0;return c._viewarea._visDbgBuf};
x3dom.Runtime.prototype.navigationType=function(){return this.canvas.doc._scene.getNavigationInfo().getType()};x3dom.Runtime.prototype.noNav=function(){this.canvas.doc._scene.getNavigationInfo().setType("none")};x3dom.Runtime.prototype.examine=function(){this.canvas.doc._scene.getNavigationInfo().setType("examine")};x3dom.Runtime.prototype.turnTable=function(){this.canvas.doc._scene.getNavigationInfo().setType("turntable")};x3dom.Runtime.prototype.fly=function(){this.canvas.doc._scene.getNavigationInfo().setType("fly")};
x3dom.Runtime.prototype.freeFly=function(){this.canvas.doc._scene.getNavigationInfo().setType("freefly")};x3dom.Runtime.prototype.lookAt=function(){this.canvas.doc._scene.getNavigationInfo().setType("lookat")};x3dom.Runtime.prototype.lookAround=function(){this.canvas.doc._scene.getNavigationInfo().setType("lookaround")};x3dom.Runtime.prototype.walk=function(){this.canvas.doc._scene.getNavigationInfo().setType("walk")};x3dom.Runtime.prototype.game=function(){this.canvas.doc._scene.getNavigationInfo().setType("game")};
x3dom.Runtime.prototype.helicopter=function(){this.canvas.doc._scene.getNavigationInfo().setType("helicopter")};x3dom.Runtime.prototype.resetExamin=function(){var a=this.canvas.doc._viewarea;a._rotMat=x3dom.fields.SFMatrix4f.identity();a._transMat=x3dom.fields.SFMatrix4f.identity();a._movement=new x3dom.fields.SFVec3f(0,0,0);a._needNavigationMatrixUpdate=!0;this.canvas.doc.needRender=!0};
x3dom.Runtime.prototype.togglePoints=function(a){var c=this.canvas.doc;c._viewarea._points=++c._viewarea._points%(!0===a?3:2);c.needRender=!0;return c._viewarea._points};x3dom.Runtime.prototype.pickRect=function(a,c,b,d){return this.canvas.doc.onPickRect(this.canvas.gl,a,c,b,d)};x3dom.Runtime.prototype.pickMode=function(a){return a&&!0===a.internal?this.canvas.doc._scene._vf.pickMode:this.canvas.doc._scene._vf.pickMode.toLowerCase()};
x3dom.Runtime.prototype.changePickMode=function(a){a=a.toLowerCase();switch(a){case "idbuf":a="idBuf";break;case "idbuf24":a="idBuf24";break;case "idbufid":a="idBufId";break;case "texcoord":a="texCoord";break;case "color":a="color";break;case "box":a="box";break;default:x3dom.debug.logWarning("Switch pickMode to "+a+" unknown intersect type"),a=void 0}return void 0!==a?(this.canvas.doc._scene._vf.pickMode=a,x3dom.debug.logInfo("Switched pickMode to '"+a+"'."),!0):!1};
x3dom.Runtime.prototype.speed=function(a){var c=this.canvas.doc._scene.getNavigationInfo();a&&(c._vf.speed=a,x3dom.debug.logInfo("Changed navigation speed to "+c._vf.speed));return c._vf.speed};x3dom.Runtime.prototype.statistics=function(a){var c=this.canvas.stateViewer;if(c){this.canvas.doc.needRender=!0;if(!0===a)return c.display(a),!0;if(!1===a)c.display(a);else return c.display(!c.active),c.active}return!1};
x3dom.Runtime.prototype.processIndicator=function(a){var c=this.canvas.progressDiv;return c?!0===a?(c.style.display="inline",!0):!1===a?(c.style.display="none",!1):"none"!=c.style.display:!1};x3dom.Runtime.prototype.properties=function(){return this.canvas.doc.properties};x3dom.Runtime.prototype.backendName=function(){return this.canvas.backend};x3dom.Runtime.prototype.getFPS=function(){return this.fps};
x3dom.Runtime.prototype.isA=function(a,c){var b=!1;c&&a&&a._x3domNode&&(""===c&&(c="X3DNode"),b=x3dom.isa(a._x3domNode,x3dom.nodeTypesLC[c.toLowerCase()]));return b};x3dom.detectActiveX=function(){var a=!1;if(window.ActiveXObject){var c=null;try{c=new ActiveXObject("AVALONATX.InstantPluginATXCtrl.1")}catch(b){}c&&(a=!0)}return a};
x3dom.rerouteSetAttribute=function(a,c){a._setAttribute=a.setAttribute;a.setAttribute=function(b,e){var f=a.getAttribute("_x3domNode");return(f=c.findNode(f))?f.parseField(b,e):0};for(var b=0;b<a.childNodes.length;b++)x3dom.rerouteSetAttribute(a.childNodes[b],c)};
x3dom.insertActiveX=function(a){"undefined"==typeof x3dom.atxCtrlCounter&&(x3dom.atxCtrlCounter=0);var c=a.getAttribute("height"),b=a.getAttribute("width"),d=a.parentNode,e=document.createElement("div");e.setAttribute("id","x3dplaceholder");var e=d.insertBefore(e,a),f=document.createElement("div");f.style.display="none";d.appendChild(f);d.removeChild(a);f.appendChild(a);d=document.createElement("object");f="Avalon"+x3dom.atxCtrlCounter;x3dom.atxCtrlCounter++;d.setAttribute("id",f);d.setAttribute("classid",
"CLSID:F3254BA0-99FF-4D14-BD81-EDA9873A471E");d.setAttribute("width",b?b:"500");d.setAttribute("height",c?c:"500");e.appendChild(d);var g=document.getElementById(f),c=g.getBrowser(),b=c.importDocument(a);c.replaceWorld(b);a.getBrowser=function(){return g.getBrowser()};x3dom.rerouteSetAttribute(a,c)};x3dom.userAgentFeature={supportsDOMAttrModified:!1};
(function(){var a=function(){var a,c,e=document.getElementsByTagName("X3D"),f=document.getElementsByTagName("webSG"),g,h=new x3dom.Properties,k=array_to_object("showLog showStat showProgress PrimitiveQuality components loadpath disableDoubleClick backend altImg flashrenderer swfpath runtimeEnabled keysEnabled showTouchpoints disableTouch maxActiveDownloads".split(" ")),l,n=!1;for(a=0;a<e.length;a++){h.setProperty("showLog",e[a].getAttribute("showLog")||"false");h.setProperty("showStat",e[a].getAttribute("showStat")||
"false");h.setProperty("showProgress",e[a].getAttribute("showProgress")||"true");h.setProperty("PrimitiveQuality",e[a].getAttribute("PrimitiveQuality")||"High");g=e[a].getElementsByTagName("PARAM");for(c=0;c<g.length;c++)g[c].getAttribute("name")in k&&h.setProperty(g[c].getAttribute("name"),g[c].getAttribute("value"));"true"===h.getProperty("showLog")&&(n=!0);if("undefined"!=typeof X3DOM_SECURITY_OFF&&!0===X3DOM_SECURITY_OFF&&(g=h.getProperty("components",e[a].getAttribute("components"))))for(l=h.getProperty("loadpath",
e[a].getAttribute("loadpath")),g=g.trim().split(","),c=0;c<g.length;c++)x3dom.loadJS(g[c]+".js",l);"undefined"!=typeof X3DOM_SECURITY_OFF&&!0===X3DOM_SECURITY_OFF&&e[a].getAttribute("src")&&(c=document.createElement("scene"),g=document.createElement("Inline"),g.setAttribute("url",e[a].getAttribute("src")),c.appendChild(g),e[a].appendChild(c))}!0==n?x3dom.debug.activate(!0):x3dom.debug.activate(!1);e=Array.map(e,function(a){a.hasRuntime=!0;return a});f=Array.map(f,function(a){a.hasRuntime=!1;return a});
for(a=0;a<f.length;a++)e.push(f[a]);void 0!==x3dom.versionInfo&&x3dom.debug.logInfo("X3DOM version "+x3dom.versionInfo.version+", Revison <a href='https://github.com/x3dom/x3dom/tree/"+x3dom.versionInfo.revision+"'>"+x3dom.versionInfo.revision+"</a>, Date "+x3dom.versionInfo.date);x3dom.debug.logInfo("Found "+(e.length-f.length)+" X3D and "+f.length+" (experimental) WebSG nodes...");for(a=0;a<e.length;a++)k=e[a],x3dom.detectActiveX()?x3dom.insertActiveX(k):(f=new x3dom.X3DCanvas(k,a),null===f.gl?
(n=document.createElement("div"),n.setAttribute("class","x3dom-nox3d"),n.setAttribute("id","x3dom-nox3d"),c=document.createElement("p"),c.appendChild(document.createTextNode("WebGL is not yet supported in your browser. ")),g=document.createElement("a"),g.setAttribute("href","http://www.x3dom.org/?page_id=9"),g.appendChild(document.createTextNode("Follow link for a list of supported browsers... ")),n.appendChild(c),n.appendChild(g),f.x3dElem.appendChild(n),f.stateViewer&&k.removeChild(f.stateViewer.viewer)):
(k=(new Date).getTime(),e[a].runtime=new x3dom.Runtime(e[a],f),e[a].runtime.initialize(e[a],f),x3dom.runtime.ready&&(e[a].runtime.ready=x3dom.runtime.ready),""==f.backend&&x3dom.runtime.noBackendFound(),f.load(e[a],a,h),"true"===h.getProperty("showStat")?e[a].runtime.statistics(!0):e[a].runtime.statistics(!1),"true"===h.getProperty("showProgress")?("bar"===h.getProperty("showProgress")&&f.progressDiv.setAttribute("class","x3dom-progress bar"),e[a].runtime.processIndicator(!0)):e[a].runtime.processIndicator(!1),
x3dom.canvases.push(f),f=(new Date).getTime()-k,x3dom.debug.logInfo("Time for setup and init of GL element no. "+a+": "+f+" ms.")));(function(a){var c=null;document.createEvent?(c=document.createEvent("Events"),c.initEvent(a,!0,!0),document.dispatchEvent(c)):document.createEventObject&&(c=document.createEventObject(),document.body.fireEvent("on"+a,c))})("load")},c=function(){if(x3dom.canvases){for(var a=0;a<x3dom.canvases.length;a++)x3dom.canvases[a].doc.shutdown(x3dom.canvases[a].gl);x3dom.canvases=
[]}};x3dom.reload=function(){c();a()};-1!=navigator.userAgent.indexOf("Chrome")?(document.__getElementsByTagName=document.getElementsByTagName,document.getElementsByTagName=function(a){var c=[],e=this.__getElementsByTagName("*");if("*"==a)c=e;else{a=a.toUpperCase();for(var f=0;f<e.length;f++)e[f].tagName.toUpperCase()===a&&c.push(e[f])}return c},document.__getElementById=document.getElementById,document.getElementById=function(a){var c=this.__getElementById(a);if(!c)for(var e=this.__getElementsByTagName("*"),
f=0;f<e.length&&!c;f++)e[f].getAttribute("id")===a&&(c=e[f]);return c}):(document.__getElementById=document.getElementById,document.getElementById=function(a){var c=this.__getElementById(a);if(!c)for(var e=this.getElementsByTagName("*"),f=0;f<e.length&&!c;f++)e[f].getAttribute("id")===a&&(c=e[f]);return c});window.addEventListener?(window.addEventListener("load",a,!1),window.addEventListener("unload",c,!1),window.addEventListener("reload",c,!1)):window.attachEvent&&(window.attachEvent("onload",a),
window.attachEvent("onunload",c),window.attachEvent("onreload",c));"complete"===document.readyState&&window.setTimeout(function(){a()},20)})();x3dom.Cache=function(){this.textures=[];this.shaders=[]};x3dom.Cache.prototype.getTexture2D=function(a,c,b,d,e,f){void 0===this.textures[b]&&(this.textures[b]=x3dom.Utils.createTexture2D(a,c,b,d,e,f));return this.textures[b]};
x3dom.Cache.prototype.getTextureCube=function(a,c,b,d,e,f){for(var g="",h=0;h<b.length;++h)g+=b[h]+"|";void 0===this.textures[g]&&(this.textures[g]=x3dom.Utils.createTextureCube(a,c,b,d,e,f));return this.textures[g]};
x3dom.Cache.prototype.getShader=function(a,c){var b=null;if(void 0===this.shaders[c]){switch(c){case x3dom.shader.PICKING:b=new x3dom.shader.PickingShader(a);break;case x3dom.shader.PICKING_24:b=new x3dom.shader.Picking24Shader(a);break;case x3dom.shader.PICKING_ID:b=new x3dom.shader.PickingIdShader(a);break;case x3dom.shader.PICKING_COLOR:b=new x3dom.shader.PickingColorShader(a);break;case x3dom.shader.PICKING_TEXCOORD:b=new x3dom.shader.PickingTexcoordShader(a);break;case x3dom.shader.FRONTGROUND_TEXTURE:b=
new x3dom.shader.FrontgroundTextureShader(a);break;case x3dom.shader.BACKGROUND_TEXTURE:b=new x3dom.shader.BackgroundTextureShader(a);break;case x3dom.shader.BACKGROUND_SKYTEXTURE:b=new x3dom.shader.BackgroundSkyTextureShader(a);break;case x3dom.shader.BACKGROUND_CUBETEXTURE:b=new x3dom.shader.BackgroundCubeTextureShader(a);break;case x3dom.shader.SHADOW:b=new x3dom.shader.ShadowShader(a);break;case x3dom.shader.BLUR:b=new x3dom.shader.BlurShader(a);break;case x3dom.shader.NORMAL:b=new x3dom.shader.NormalShader(a)}b?
this.shaders[c]=x3dom.Utils.wrapProgram(a,b,c):x3dom.debug.logError("Couldn't create shader: "+c)}return this.shaders[c]};x3dom.Cache.prototype.getDynamicShader=function(a,c,b){var d=x3dom.Utils.generateProperties(c,b);c=d.id;void 0===this.shaders[c]&&(b=0<=d.CSHADER?new x3dom.shader.ComposedShader(a,b):x3dom.caps.MOBILE&&!d.CSSHADER?new x3dom.shader.DynamicMobileShader(a,d):new x3dom.shader.DynamicShader(a,d),this.shaders[c]=x3dom.Utils.wrapProgram(a,b,c));return this.shaders[c]};
x3dom.Cache.prototype.getShaderByProperties=function(a,c,b){var d=b.id;void 0===this.shaders[d]&&(c=0<=b.CSHADER?new x3dom.shader.ComposedShader(a,c):x3dom.caps.MOBILE&&!b.CSSHADER?new x3dom.shader.DynamicMobileShader(a,b):new x3dom.shader.DynamicShader(a,b),this.shaders[d]=x3dom.Utils.wrapProgram(a,c,d));return this.shaders[d]};
x3dom.Cache.prototype.getShadowRenderingShader=function(a,c){for(var b="shadow",d=0;d<c.length;d++)b=x3dom.isa(c[d],x3dom.nodeTypes.SpotLight)?b+"S":x3dom.isa(c[d],x3dom.nodeTypes.PointLight)?b+"P":b+"D";void 0===this.shaders[b]&&(d=new x3dom.shader.ShadowRenderingShader(a,c),this.shaders[b]=x3dom.Utils.wrapProgram(a,d,b));return this.shaders[b]};
x3dom.Cache.prototype.Release=function(a){for(var c in this.textures)a.deleteTexture(this.textures[c]);this.textures=[];for(var b in this.shaders){c=this.shaders[b];for(var d=a.getAttachedShaders(c.program),e=0;e<d.length;++e)a.detachShader(c.program,d[e]),a.deleteShader(d[e]);a.deleteProgram(c.program)}this.shaders=[]};
x3dom.Texture=function(a,c,b,d){this.gl=a;this.doc=c;this.cache=b;this.node=d;this.samplerName="diffuseMap";this.type=a.TEXTURE_2D;this.format=a.RGBA;this.minFilter=this.magFilter=a.LINEAR;this.wrapT=this.wrapS=a.REPEAT;this.genMipMaps=!1;this.texture=null;this.ready=!1;this.update()};x3dom.Texture.prototype.update=function(){x3dom.isa(this.node,x3dom.nodeTypes.Text)?this.updateText():this.updateTexture()};
x3dom.Texture.prototype.updateTexture=function(){var a=this.gl,c=this.doc,b=this.node;this.samplerName=b._type;x3dom.isa(b,x3dom.nodeTypes.X3DEnvironmentTextureNode)?this.type=a.TEXTURE_CUBE_MAP:this.type=a.TEXTURE_2D;if(x3dom.isa(b,x3dom.nodeTypes.PixelTexture))switch(b._vf.image.comp){case 1:this.format=a.LUMINANCE;break;case 2:this.format=a.LUMINANCE_ALPHA;break;case 3:this.format=a.RGB;break;case 4:this.format=a.RGBA}else this.format=a.RGBA;var d=void 0!==b._video&&null!==b._video&&void 0!==b._needPerFrameUpdate&&
!0===b._needPerFrameUpdate;if(null!==b._cf.textureProperties.node){var e=b._cf.textureProperties.node;this.wrapS=x3dom.Utils.boundaryModesDic(a,e._vf.boundaryModeS);this.wrapT=x3dom.Utils.boundaryModesDic(a,e._vf.boundaryModeT);this.minFilter=x3dom.Utils.minFilterDic(a,e._vf.minificationFilter);this.magFilter=x3dom.Utils.magFilterDic(a,e._vf.magnificationFilter);if(!0===e._vf.generateMipMaps)this.genMipMaps=!0,this.minFilter==a.NEAREST?this.minFilter=a.NEAREST_MIPMAP_NEAREST:this.minFilter==a.LINEAR&&
(this.minFilter=a.LINEAR_MIPMAP_LINEAR);else if(this.genMipMaps=!1,this.minFilter==a.LINEAR_MIPMAP_LINEAR||this.minFilter==a.LINEAR_MIPMAP_NEAREST)this.minFilter=a.LINEAR;else if(this.minFilter==a.NEAREST_MIPMAP_LINEAR||this.minFilter==a.NEAREST_MIPMAP_NEAREST)this.minFilter=a.NEAREST}else{if(!1==b._vf.repeatS||"displacementMap"==this.samplerName)this.wrapS=a.CLAMP_TO_EDGE;if(!1==b._vf.repeatT||"displacementMap"==this.samplerName)this.wrapT=a.CLAMP_TO_EDGE}if(b._isCanvas&&b._canvas)null==this.texture&&
(this.texture=a.createTexture()),a.bindTexture(this.type,this.texture),a.texImage2D(this.type,0,this.format,this.format,a.UNSIGNED_BYTE,b._canvas),a.bindTexture(this.type,null);else if(x3dom.isa(b,x3dom.nodeTypes.RenderedTexture))b._webgl&&b._webgl.fbo?this.texture=b._webgl.fbo.tex:(this.texture=null,x3dom.debug.logError("Try updating RenderedTexture without FBO initialized!"));else if(x3dom.isa(b,x3dom.nodeTypes.PixelTexture)){null==this.texture&&(this.texture=a.createTexture());d=b._vf.image.toGL();
for(e=b._vf.image.width*b._vf.image.height*b._vf.image.comp;d.length<e;)d.push(0);d=new Uint8Array(d);a.bindTexture(this.type,this.texture);a.pixelStorei(a.UNPACK_ALIGNMENT,1);a.texImage2D(this.type,0,this.format,b._vf.image.width,b._vf.image.height,0,this.format,a.UNSIGNED_BYTE,d);a.bindTexture(this.type,null)}else if(x3dom.isa(b,x3dom.nodeTypes.MovieTexture)||d){var f=this;null==this.texture&&(this.texture=a.createTexture());this.childTex||(b._video=document.createElement("video"),b._video.setAttribute("autobuffer",
"true"),document.getElementsByTagName("body")[0].appendChild(b._video),b._video.style.visibility="hidden");for(d=0;d<b._vf.url.length;d++){e=b._nameSpace.getURL(b._vf.url[d]);x3dom.debug.logInfo("Adding video file: "+e);var g=document.createElement("source");g.setAttribute("src",e);b._video.appendChild(g)}var h=function(){a.bindTexture(f.type,f.texture);a.texImage2D(f.type,0,f.format,f.format,a.UNSIGNED_BYTE,b._video);a.bindTexture(f.type,null);c.needRender=!0};b._video.addEventListener("canplaythrough",
function(){b._video.play();b._intervalID=setInterval(h,16)},!0);b._video.addEventListener("ended",function(){clearInterval(b._intervalID);!0===b._vf.loop&&(b._video.play(),b._intervalID=setInterval(h,16))},!0)}else x3dom.isa(b,x3dom.nodeTypes.X3DEnvironmentTextureNode)?this.texture=this.cache.getTextureCube(a,c,b.getTexUrl(),!1,b._vf.withCredentials,b._vf.scale):this.texture=this.cache.getTexture2D(a,c,b._nameSpace.getURL(b._vf.url[0]),!1,b._vf.withCredentials,b._vf.scale)};
x3dom.Texture.prototype.updateText=function(){var a=this.gl;this.wrapT=this.wrapS=a.CLAMP_TO_EDGE;var c=this.node._cf.fontStyle.node,b="serif",d="normal",e="left",f=1;if(null!==c){b=c._vf.family.toString();b=b.trim().replace(/\'/g,"").replace(/\,/," ");b=b.split(" ");b=Array.map(b,function(a){return"SANS"==a?"sans-serif":"SERIF"==a?"serif":"TYPEWRITER"==a?"monospace":""+a+""}).join(",");d=c._vf.style.toString().replace(/\'/g,"");switch(d.toUpperCase()){case "PLAIN":d="normal";break;case "BOLD":d=
"bold";break;case "ITALIC":d="italic";break;case "BOLDITALIC":d="italic bold";break;default:d="normal"}var g=c._vf.leftToRight?"ltr":"rtl",e=c._vf.justify[0].toString().replace(/\'/g,"");switch(e.toUpperCase()){case "BEGIN":e="left";break;case "END":e="right";break;case "FIRST":e="left";break;case "MIDDLE":e="center";break;default:e="left"}f=c._vf.size;0.1>f&&(f=0.1);2.3<f&&(f=2.3)}var h,c=this.node._vf.string,k=document.createElement("canvas");k.dir=g;var f=42*f,l=e;document.body.appendChild(k);
e=k.getContext("2d");e.font=d+" "+f+"px "+b;for(var n=e.measureText(c[0]).width,g=1;g<c.length;g++)e.measureText(c[g]).width>n&&(n=e.measureText(c[g]).width);k.width=n;k.height=f*c.length;switch(l){case "left":h=0;break;case "center":h=k.width/2;break;case "right":h=k.width}var q=k.width,n=k.height;e.fillStyle="rgba(0,0,0,0)";e.fillRect(0,0,e.canvas.width,e.canvas.height);e.fillStyle="white";e.lineWidth=2.5;e.strokeStyle="grey";e.textBaseline="top";e.font=d+" "+f+"px "+b;e.textAlign=l;for(g=0;g<c.length;g++)b=
g*f,e.fillText(c[g],h,b);null===this.texture&&(this.texture=a.createTexture());a.bindTexture(this.type,this.texture);a.texImage2D(this.type,0,this.format,this.format,a.UNSIGNED_BYTE,k);a.bindTexture(this.type,null);document.body.removeChild(k);a=q/100;h=n/100;this.node._mesh._positions[0]=[-a,-h+0.4,0,a,-h+0.4,0,a,h+0.4,0,-a,h+0.4,0];this.node.invalidateVolume();Array.forEach(this.node._parentNodes,function(a){a.setAllDirty()})};x3dom.shader={};x3dom.shader.PICKING="picking";
x3dom.shader.PICKING_24="picking24";x3dom.shader.PICKING_ID="pickingId";x3dom.shader.PICKING_COLOR="pickingColor";x3dom.shader.PICKING_TEXCOORD="pickingTexCoord";x3dom.shader.FRONTGROUND_TEXTURE="frontgroundTexture";x3dom.shader.BACKGROUND_TEXTURE="backgroundTexture";x3dom.shader.BACKGROUND_SKYTEXTURE="backgroundSkyTexture";x3dom.shader.BACKGROUND_CUBETEXTURE="backgroundCubeTexture";x3dom.shader.SHADOW="shadow";x3dom.shader.BLUR="blur";x3dom.shader.DEPTH="depth";x3dom.shader.NORMAL="normal";
x3dom.shader.material=function(){return"uniform vec3  diffuseColor;\nuniform vec3  specularColor;\nuniform vec3  emissiveColor;\nuniform float shininess;\nuniform float transparency;\nuniform float ambientIntensity;\n"};x3dom.shader.fog=function(){return"uniform vec3  fogColor;\nuniform float fogType;\nuniform float fogRange;\nvarying vec3 fragEyePosition;\nfloat calcFog(in vec3 eye) {\n   float f0 = 0.0;\n   if(fogType == 0.0) {\n       if(length(eye) < fogRange){\n           f0 = (fogRange-length(eye)) / fogRange;\n       }\n   }else{\n       if(length(eye) < fogRange){\n           f0 = exp(-length(eye) / (fogRange-length(eye) ) );\n       }\n   }\n   f0 = clamp(f0, 0.0, 1.0);\n   return f0;\n}\n"};
x3dom.shader.rgbaPacking=function(){var a;return a="vec4 packDepth(float depth){\n depth = (depth + 1.0)*0.5;\n vec4 outVal = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\n outVal = fract(outVal);\n   outVal -= outVal.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n   return outVal;\n}\nfloat unpackDepth(vec4 color){\n float depth = dot(color, vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0));\n return (2.0*depth - 1.0);\n}\n"};
x3dom.shader.shadowRendering=function(){var a;a="float getLightInfluence(float lType, float lShadowIntensity, float lOn, vec3 lLocation, vec3 lDirection, float lCutOffAngle, float lBeamWidth, vec3 lAttenuation, float lRadius, vec3 eyeCoords) {\n if (lOn == 0.0 || lShadowIntensity == 0.0){ return 0.0;\n } else if (lType == 0.0) {\n  return 1.0;\n } else {\n    float attenuation = 0.0;\n    vec3 lightVec = (lLocation - (eyeCoords));\n    float distance = length(lightVec);\n  lightVec = normalize(lightVec);\n  eyeCoords = normalize(-eyeCoords);\n    if(lRadius == 0.0 || distance <= lRadius) {\n        attenuation = 1.0 / max(lAttenuation.x + lAttenuation.y * distance + lAttenuation.z * (distance * distance), 1.0);\n  }\n   if (lType == 1.0) return attenuation;\n    float spotAngle = acos(max(0.0, dot(-lightVec, normalize(lDirection))));\n    if(spotAngle >= lCutOffAngle) return 0.0;\n    else if(spotAngle <= lBeamWidth) return attenuation;\n    else return attenuation * (spotAngle - lCutOffAngle) / (lBeamWidth - lCutOffAngle);\n }\n}\nvoid getShadowValues(inout vec4 shadowMapValues, inout float viewSampleDepth, in mat4 lightMatrix, in vec4 worldCoords, in sampler2D shadowMap){\n vec4 lightSpaceCoords = lightMatrix*worldCoords;\n vec3 lightSpaceCoordsCart = lightSpaceCoords.xyz / lightSpaceCoords.w;\n vec2 textureCoords = (lightSpaceCoordsCart.xy + 1.0)*0.5;\n viewSampleDepth = lightSpaceCoordsCart.z;\n shadowMapValues = texture2D(shadowMap, textureCoords);\n";if(!x3dom.caps.FP_TEXTURES||
x3dom.caps.MOBILE)a+=" shadowMapValues = vec4(1.0,1.0,unpackDepth(shadowMapValues),1.0);\n";a+="}\n";a+="void getShadowValuesPointLight(inout vec4 shadowMapValues, inout float viewSampleDepth, in vec3 lLocation, in vec4 worldCoords, in mat4 lightViewMatrix,in mat4 lMatrix_0, in mat4 lMatrix_1, in mat4 lMatrix_2, in mat4 lMatrix_3, in mat4 lMatrix_4, in mat4 lMatrix_5,in sampler2D shadowMap_0, in sampler2D shadowMap_1, in sampler2D shadowMap_2, in sampler2D shadowMap_3,in sampler2D shadowMap_4, in sampler2D shadowMap_5){\n vec4 transformed = lightViewMatrix * worldCoords;\n vec3 lightVec = normalize(transformed.xyz/transformed.w);\n vec3 lightVecAbs = abs(lightVec);\n float maximum = max(max(lightVecAbs.x, lightVecAbs.y),lightVecAbs.z);\n if (lightVecAbs.x == maximum) {\n  if (lightVec.x < 0.0) getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_3,worldCoords,shadowMap_3);\n  else getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_1,worldCoords,shadowMap_1);\n }\n else if (lightVecAbs.y == maximum) {\n  if (lightVec.y < 0.0) getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_4,worldCoords,shadowMap_4);\n  else getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_5,worldCoords,shadowMap_5);\n }\n else if (lightVec.z < 0.0) getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_0,worldCoords,shadowMap_0);\n else getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_2,worldCoords,shadowMap_2);\n}\n";
a+="void getShadowValuesCascaded(inout vec4 shadowMapValues, inout float viewSampleDepth, in vec4 worldCoords, in float eyeDepth, in mat4 lMatrix_0, in mat4 lMatrix_1, in mat4 lMatrix_2,in mat4 lMatrix_3, in mat4 lMatrix_4, in mat4 lMatrix_5, in sampler2D shadowMap_0, in sampler2D shadowMap_1, in sampler2D shadowMap_2,in sampler2D shadowMap_3, in sampler2D shadowMap_4, in sampler2D shadowMap_5, in float split_0, in float split_1, in float split_2, in float split_3, in float split_4){\n if (eyeDepth < split_0) getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_0, worldCoords, shadowMap_0);\n else if (eyeDepth < split_1) getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_1, worldCoords, shadowMap_1);\n else if (eyeDepth < split_2) getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_2, worldCoords, shadowMap_2);\n else if (eyeDepth < split_3) getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_3, worldCoords, shadowMap_3);\n else if (eyeDepth < split_4) getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_4, worldCoords, shadowMap_4);\n else getShadowValues(shadowMapValues, viewSampleDepth, lMatrix_5, worldCoords, shadowMap_5);\n}\n";
a+="float ESM(float shadowMapDepth, float viewSampleDepth, float offset){\n";a=!x3dom.caps.FP_TEXTURES||x3dom.caps.MOBILE?a+" return exp(-80.0*(1.0-offset)*(viewSampleDepth - shadowMapDepth));\n":a+" return shadowMapDepth * exp(-80.0*(1.0-offset)*viewSampleDepth);\n";a+="}\n";return a+="float VSM(vec2 moments, float viewSampleDepth, float offset){\n viewSampleDepth = (viewSampleDepth + 1.0) * 0.5;\n if (viewSampleDepth <= moments.x) return 1.0;\n float variance = moments.y - moments.x * moments.x;\n variance = max(variance, 0.00002 + offset*0.01);\n float d = viewSampleDepth - moments.x;\n return variance/(variance + d*d);\n}\n"};
x3dom.shader.light=function(a){for(var c="",b=0;b<a;b++)c+="uniform float light"+b+"_On;\nuniform float light"+b+"_Type;\nuniform vec3  light"+b+"_Location;\nuniform vec3  light"+b+"_Direction;\nuniform vec3  light"+b+"_Color;\nuniform vec3  light"+b+"_Attenuation;\nuniform float light"+b+"_Radius;\nuniform float light"+b+"_Intensity;\nuniform float light"+b+"_AmbientIntensity;\nuniform float light"+b+"_BeamWidth;\nuniform float light"+b+"_CutOffAngle;\nuniform float light"+b+"_ShadowIntensity;\n";
return c+"void lighting(in float lType, in vec3 lLocation, in vec3 lDirection, in vec3 lColor, in vec3 lAttenuation, in float lRadius, in float lIntensity, in float lAmbientIntensity, in float lBeamWidth, in float lCutOffAngle, in vec3 N, in vec3 V, inout vec3 ambient, inout vec3 diffuse, inout vec3 specular)\n{\n   vec3 L;\n   float spot = 1.0, attentuation = 0.0;\n   if(lType == 0.0) {\n       L = -normalize(lDirection);\n  V = normalize(V);\n  attentuation = 1.0;\n   } else{\n       L = (lLocation - (-V));\n       float d = length(L);\n  L = normalize(L);\n  V = normalize(V);\n       if(lRadius == 0.0 || d <= lRadius) {\n        attentuation = 1.0 / max(lAttenuation.x + lAttenuation.y * d + lAttenuation.z * (d * d), 1.0);\n  }\n       if(lType == 2.0) {\n           float spotAngle = acos(max(0.0, dot(-L, normalize(lDirection))));\n           if(spotAngle >= lCutOffAngle) spot = 0.0;\n           else if(spotAngle <= lBeamWidth) spot = 1.0;\n           else spot = (spotAngle - lCutOffAngle ) / (lBeamWidth - lCutOffAngle);\n       }\n   }\n   vec3  H = normalize( L + V );\n   float NdotL = max(0.0, dot(L, N));\n   float NdotH = max(0.0, dot(H, N));\n   float ambientFactor  = lAmbientIntensity * ambientIntensity;\n   float diffuseFactor  = lIntensity * NdotL;\n   float specularFactor = lIntensity * pow(NdotH, shininess*128.0);\n   ambient  += lColor * ambientFactor * attentuation * spot;\n   diffuse  += lColor * diffuseFactor * attentuation * spot;\n   specular += lColor * specularFactor * attentuation * spot;\n}\n"};
x3dom.shader.TBNCalculation=function(){var a;return a="mat3 cotangent_frame(vec3 N, vec3 p, vec2 uv)\n{\n    // get edge vectors of the pixel triangle\n    vec3 dp1 = dFdx( p );\n    vec3 dp2 = dFdy( p );\n    vec2 duv1 = dFdx( uv );\n    vec2 duv2 = dFdy( uv );\n\n    // solve the linear system\n    vec3 dp2perp = cross( dp2, N );\n    vec3 dp1perp = cross( N, dp1 );\n    vec3 T = dp2perp * duv1.x + dp1perp * duv2.x;\n    vec3 B = dp2perp * duv1.y + dp1perp * duv2.y;\n\n    // construct a scale-invariant frame\n    float invmax = inversesqrt( max( dot(T,T), dot(B,B) ) );\n    return mat3( T * invmax, B * invmax, N );\n}\n\nvec3 perturb_normal( vec3 N, vec3 V, vec2 texcoord )\n{\n    // assume N, the interpolated vertex normal and\n    // V, the view vector (vertex to eye)\n    vec3 map = texture2D(normalMap, texcoord ).xyz;\n    map = map * 255./127. - 128./127.;\n    mat3 TBN = cotangent_frame(N, -V, texcoord);\n    return normalize(TBN * map);\n}\n\n"};
x3dom.shader.DynamicShader=function(a,c){this.program=a.createProgram();var b=this.generateVertexShader(a,c),d=this.generateFragmentShader(a,c);a.attachShader(this.program,b);a.attachShader(this.program,d);a.bindAttribLocation(this.program,0,"position");a.linkProgram(this.program);return this.program};
x3dom.shader.DynamicShader.prototype.generateVertexShader=function(a,c){var b;b="uniform mat4 modelViewMatrix;\nuniform mat4 modelViewProjectionMatrix;\n";3==c.POSCOMPONENTS?b+="attribute vec3 position;\n":4==c.POSCOMPONENTS&&(b+="attribute vec4 position;\n");if(c.IMAGEGEOMETRY){b+="uniform vec3 IG_bboxMin;\n";b+="uniform vec3 IG_bboxMax;\n";b+="uniform float IG_coordTextureWidth;\n";b+="uniform float IG_coordTextureHeight;\n";b+="uniform vec2 IG_implicitMeshSize;\n";for(var d=0;d<c.IG_PRECISION;d++)b+=
"uniform sampler2D IG_coords"+d+"\n;";c.IG_INDEXED&&(b+="uniform sampler2D IG_index;\n",b+="uniform float IG_indexTextureWidth;\n",b+="uniform float IG_indexTextureHeight;\n")}c.POPGEOMETRY&&(b+="uniform float PG_precisionLevel;\n",b+="uniform float PG_powPrecision;\n",b+="uniform vec3 PG_maxBBSize;\n",b+="uniform vec3 PG_bbMin;\n",b+="uniform vec3 PG_bbMaxModF;\n",b+="uniform vec3 PG_bboxShiftVec;\n",b+="uniform float PG_numAnchorVertices;\n",b+="attribute float PG_vertexID;\n");c.LIGHTS&&(b+="varying vec3 fragNormal;\n",
b+="uniform mat4 normalMatrix;\n",c.IMAGEGEOMETRY?b+="uniform sampler2D IG_normals;\n":2==c.NORCOMPONENTS?4!=c.POSCOMPONENTS&&(b+="attribute vec2 normal;\n"):3==c.NORCOMPONENTS&&(b+="attribute vec3 normal;\n"));c.VERTEXCOLOR&&(c.IMAGEGEOMETRY?(b+="uniform sampler2D IG_colors;\n",3==c.COLCOMPONENTS?b+="varying vec3 fragColor;\n":4==c.COLCOMPONENTS&&(b+="varying vec4 fragColor;\n")):3==c.COLCOMPONENTS?(b+="attribute vec3 color;\n",b+="varying vec3 fragColor;\n"):4==c.COLCOMPONENTS&&(b+="attribute vec4 color;\n",
b+="varying vec4 fragColor;\n"));if(c.TEXTURED||c.CSSHADER)b+="varying vec2 fragTexcoord;\n",c.SPHEREMAPPING||(b=c.IMAGEGEOMETRY?b+"uniform sampler2D IG_texCoords;\n":b+"attribute vec2 texcoord;\n"),c.TEXTRAFO&&(b+="uniform mat4 texTrafoMatrix;\n"),c.NORMALMAP&&!x3dom.caps.STD_DERIVATIVES&&(x3dom.debug.logWarning("Your System doesn't support the 'OES_STANDARD_DERIVATIVES' Extension. You must set tangents and binormals manually via the FloatVertexAttribute-Node to use normal maps"),b+="attribute vec3 tangent;\n",
b+="attribute vec3 binormal;\n",b+="varying vec3 fragTangent;\n",b+="varying vec3 fragBinormal;\n"),c.CUBEMAP&&(b+="varying vec3 fragViewDir;\n",b+="uniform mat4 viewMatrix;\n"),c.DISPLACEMENTMAP&&(b+="uniform sampler2D displacementMap;\n",b+="uniform float displacementFactor;\n",b+="uniform float displacementWidth;\n",b+="uniform float displacementHeight;\n",b+="uniform float displacementAxis;\n"),c.DIFFPLACEMENTMAP&&(b+="uniform sampler2D diffuseDisplacementMap;\n",b+="uniform float displacementFactor;\n",
b+="uniform float displacementWidth;\n",b+="uniform float displacementHeight;\n",b+="uniform float displacementAxis;\n");if(c.LIGHTS||c.FOG)b+="uniform vec3 eyePosition;\n",b+="varying vec3 fragPosition;\n",c.FOG&&(b+="varying vec3 fragEyePosition;\n");c.REQUIREBBOX&&(b+="uniform vec3 bgCenter;\n",b+="uniform vec3 bgSize;\n",b+="uniform float bgPrecisionMax;\n");c.REQUIREBBOXNOR&&(b+="uniform float bgPrecisionNorMax;\n");c.REQUIREBBOXCOL&&(b+="uniform float bgPrecisionColMax;\n");c.REQUIREBBOXTEX&&
(b+="uniform float bgPrecisionTexMax;\n");b+="void main(void) {\n";b+="gl_PointSize = 2.0;\n";if(c.IMAGEGEOMETRY){c.IG_INDEXED?(b+="vec2 halfPixel = vec2(0.5/IG_indexTextureWidth,0.5/IG_indexTextureHeight);\n",b+="vec2 IG_texCoord = vec2(position.x*(IG_implicitMeshSize.x/IG_indexTextureWidth), position.y*(IG_implicitMeshSize.y/IG_indexTextureHeight)) + halfPixel;\n",b+="vec2 IG_indices = texture2D( IG_index, IG_texCoord ).rg;\n",b+="halfPixel = vec2(0.5/IG_coordTextureWidth,0.5/IG_coordTextureHeight);\n",
b+="IG_texCoord = (IG_indices * 0.996108948) + halfPixel;\n"):(b+="vec2 halfPixel = vec2(0.5/IG_coordTextureWidth, 0.5/IG_coordTextureHeight);\n",b+="vec2 IG_texCoord = vec2(position.x*(IG_implicitMeshSize.x/IG_coordTextureWidth), position.y*(IG_implicitMeshSize.y/IG_coordTextureHeight)) + halfPixel;\n");b+="vec3 temp = vec3(0.0, 0.0, 0.0);\n";b+="vec3 vertPosition = vec3(0.0, 0.0, 0.0);\n";for(d=0;d<c.IG_PRECISION;d++)b+="temp = 255.0 * texture2D( IG_coords"+d+", IG_texCoord ).rgb;\n",b+="vertPosition *= 256.0;\n",
b+="vertPosition += temp;\n";b+="vertPosition /= (pow(2.0, 8.0 * "+c.IG_PRECISION+".0) - 1.0);\n";b+="vertPosition = vertPosition * (IG_bboxMax - IG_bboxMin) + IG_bboxMin;\n";c.LIGHTS&&(b+="vec3 vertNormal = texture2D( IG_normals, IG_texCoord ).rgb;\n",b+="vertNormal = vertNormal * 2.0 - 1.0;\n");c.VERTEXCOLOR&&(3==c.COLCOMPONENTS?b+="fragColor = texture2D( IG_colors, IG_texCoord ).rgb;\n":4==c.COLCOMPONENTS&&(b+="fragColor = texture2D( IG_colors, IG_texCoord ).rgba;\n"));if(c.TEXTURED||c.CSSHADER)b+=
"vec4 IG_doubleTexCoords = texture2D( IG_texCoords, IG_texCoord );\n",b+="vec2 vertTexCoord;",b+="vertTexCoord.r = (IG_doubleTexCoords.r * 0.996108948) + (IG_doubleTexCoords.b * 0.003891051);\n",b+="vertTexCoord.g = (IG_doubleTexCoords.g * 0.996108948) + (IG_doubleTexCoords.a * 0.003891051);\n"}else{b+="vec3 vertPosition = position.xyz;\n";c.POPGEOMETRY?(b+="vec3 offsetVec = step(vertPosition / bgPrecisionMax, PG_bbMaxModF) * PG_bboxShiftVec;\n",b+="if ((PG_precisionLevel <= 2.0) || PG_vertexID >= PG_numAnchorVertices) {\n",
b+="   vertPosition = floor(vertPosition / PG_powPrecision) * PG_powPrecision;\n",b+="   vertPosition /= (65536.0 - PG_powPrecision);\n",b+="}\n",b+="else {\n",b+="   vertPosition /= bgPrecisionMax;\n",b+="}\n",b+="vertPosition = (vertPosition + offsetVec + PG_bbMin) * PG_maxBBSize;\n"):c.REQUIREBBOX&&(b+="vertPosition = bgCenter + bgSize * vertPosition / bgPrecisionMax;\n");if(c.LIGHTS)if(2==c.NORCOMPONENTS)4==c.POSCOMPONENTS?(b+="vec3 vertNormal = vec3(position.w / 256.0); \n",b+="vertNormal.x = floor(vertNormal.x) / 255.0; \n",
b+="vertNormal.y = fract(vertNormal.y) * 1.00392156862745; \n"):c.REQUIREBBOXNOR&&(b+="vec3 vertNormal = vec3(normal.xy, 0.0) / bgPrecisionNorMax;\n"),b+="vec2 thetaPhi = 3.14159265358979 * vec2(vertNormal.x, vertNormal.y*2.0-1.0); \n",b+="vec4 sinCosThetaPhi = sin( vec4(thetaPhi, thetaPhi + 1.5707963267949) ); \n",b+="vertNormal.x = sinCosThetaPhi.x * sinCosThetaPhi.w; \n",b+="vertNormal.y = sinCosThetaPhi.x * sinCosThetaPhi.y; \n",b+="vertNormal.z = sinCosThetaPhi.z; \n";else if(b+="vec3 vertNormal = normal;\n",
c.REQUIREBBOXNOR&&(b+="vertNormal = vertNormal / bgPrecisionNorMax;\n"),c.BITLODGEOMETRY||c.POPGEOMETRY)b+="vertNormal = 2.0*vertNormal - 1.0;\n";c.VERTEXCOLOR&&(b+="fragColor = color;\n",c.REQUIREBBOXCOL&&(b+="fragColor = fragColor / bgPrecisionColMax;\n"));!c.TEXTURED&&!c.CSSHADER||c.SPHEREMAPPING||(b+="vec2 vertTexCoord = texcoord;\n",c.REQUIREBBOXTEX&&(b+="vertTexCoord = vertTexCoord / bgPrecisionTexMax;\n"))}c.LIGHTS&&(c.DISPLACEMENTMAP||c.DIFFPLACEMENTMAP&&!c.NORMALMAP?(b+="float dx = 1.0 / displacementWidth;\n",
b+="float dy = 1.0 / displacementHeight;\n",c.DISPLACEMENTMAP?(b+="float s1 = texture2D(displacementMap, vec2(vertTexCoord.x - dx, 1.0 - vertTexCoord.y)).r;\n",b+="float s2 = texture2D(displacementMap, vec2(vertTexCoord.x, 1.0 - vertTexCoord.y - dy)).r;\n",b+="float s3 = texture2D(displacementMap, vec2(vertTexCoord.x + dx, 1.0 - vertTexCoord.y)).r;\n",b+="float s4 = texture2D(displacementMap, vec2(vertTexCoord.x, 1.0 - vertTexCoord.y + dy)).r;\n"):c.DIFFPLACEMENTMAP&&(b+="float s1 = texture2D(diffuseDisplacementMap, vec2(vertTexCoord.x - dx, 1.0 - vertTexCoord.y)).a;\n",
b+="float s2 = texture2D(diffuseDisplacementMap, vec2(vertTexCoord.x, 1.0 - vertTexCoord.y - dy)).a;\n",b+="float s3 = texture2D(diffuseDisplacementMap, vec2(vertTexCoord.x + dx, 1.0 - vertTexCoord.y)).a;\n",b+="float s4 = texture2D(diffuseDisplacementMap, vec2(vertTexCoord.x, 1.0 - vertTexCoord.y + dy)).a;\n"),b+="float coef = displacementFactor;\n",b+="vec3 calcNormal;\n",b+="if (displacementAxis == 0.0) {\n",b+="calcNormal = vec3((s1 - s3) * coef, -5.0, (s2 - s4) * coef);\n",b+="} else if(displacementAxis == 1.0) {\n",
b+="calcNormal = vec3((s1 - s3) * coef, -5.0, (s2 - s4) * coef);\n",b+="} else {\n",b+="calcNormal = vec3((s1 - s3) * coef, -(s2 - s4) * coef, 5.0);\n",b+="}\n",b+="calcNormal = normalize(calcNormal);\n",b+="fragNormal = (normalMatrix * vec4(calcNormal, 0.0)).xyz;\n"):b+="fragNormal = (normalMatrix * vec4(vertNormal, 0.0)).xyz;\n");if(c.TEXTURED||c.CSSHADER)c.CUBEMAP?b+="fragViewDir = (viewMatrix[3].xyz);\n":c.SPHEREMAPPING?b+=" fragTexcoord = 0.5 + fragNormal.xy / 2.0;\n":c.TEXTRAFO?b+=" fragTexcoord = (texTrafoMatrix * vec4(vertTexCoord, 1.0, 1.0)).xy;\n":
(b+=" fragTexcoord = vertTexCoord;\n",c.POPGEOMETRY&&!0===x3dom.debug.usePrecisionLevelAsTexCoord&&(b+="fragTexcoord = vec2(0.03125 + 0.9375 * (PG_precisionLevel / 16.0), 1.0);")),c.NORMALMAP&&!x3dom.caps.STD_DERIVATIVES&&(b+="fragTangent  = (normalMatrix * vec4(tangent, 0.0)).xyz;\n",b+="fragBinormal = (normalMatrix * vec4(binormal, 0.0)).xyz;\n");if(c.LIGHTS||c.FOG)b+="fragPosition = (modelViewMatrix * vec4(vertPosition, 1.0)).xyz;\n",c.FOG&&(b+="fragEyePosition = eyePosition - fragPosition;\n");
c.DISPLACEMENTMAP?b+="vertPosition += normalize(vertNormal) * texture2D(displacementMap, vec2(fragTexcoord.x, 1.0-fragTexcoord.y)).r * displacementFactor;\n":c.DIFFPLACEMENTMAP&&(b+="vertPosition += normalize(vertNormal) * texture2D(diffuseDisplacementMap, vec2(fragTexcoord.x, 1.0-fragTexcoord.y)).a * displacementFactor;\n");b+="gl_Position = modelViewProjectionMatrix * vec4(vertPosition, 1.0);\n";b+="}\n";d=a.createShader(a.VERTEX_SHADER);a.shaderSource(d,b);a.compileShader(d);a.getShaderParameter(d,
a.COMPILE_STATUS)||x3dom.debug.logError("VertexShader "+a.getShaderInfoLog(d));return d};
x3dom.shader.DynamicShader.prototype.generateFragmentShader=function(a,c){var b;b="#ifdef GL_FRAGMENT_PRECISION_HIGH\nprecision highp float;\n#else\n";b+=" precision mediump float;\n";b+="#endif\n\n";b+="uniform mat4 modelMatrix;\n";b+="uniform mat4 modelViewMatrix;\n";b+=x3dom.shader.material();c.VERTEXCOLOR&&(3==c.COLCOMPONENTS?b+="varying vec3 fragColor;  \n":4==c.COLCOMPONENTS&&(b+="varying vec4 fragColor;  \n"));if(c.TEXTURED||c.CSSHADER)b+="varying vec2 fragTexcoord;\n",!c.TEXTURED&&!c.DIFFUSEMAP||
c.CUBEMAP?c.CUBEMAP&&(b+="uniform samplerCube cubeMap;\n",b+="varying vec3 fragViewDir;\n",b+="uniform mat4 modelViewMatrixInverse;\n"):b+="uniform sampler2D diffuseMap;\n",c.SPECMAP&&(b+="uniform sampler2D specularMap;\n"),c.DISPLACEMENTMAP&&(b+="uniform sampler2D displacementMap;\n",b+="uniform float displacementWidth;\n",b+="uniform float displacementHeight;\n"),c.DIFFPLACEMENTMAP&&(b+="uniform sampler2D diffuseDisplacementMap;\n",b+="uniform float displacementWidth;\n",b+="uniform float displacementHeight;\n"),
c.NORMALMAP&&(b+="uniform sampler2D normalMap;\n",x3dom.caps.STD_DERIVATIVES?(b+="#extension GL_OES_standard_derivatives:enable\n",b+=x3dom.shader.TBNCalculation()):(b+="varying vec3 fragTangent;\n",b+="varying vec3 fragBinormal;\n"));c.FOG&&(b+=x3dom.shader.fog());c.LIGHTS&&(b+="varying vec3 fragNormal;\n",b+="varying vec3 fragPosition;\n",b+=x3dom.shader.light(c.LIGHTS));b+="void main(void) {\n";b+="vec4 color;\n";b+="color.rgb = diffuseColor;\n";b+="color.a = 1.0 - transparency;\n";c.VERTEXCOLOR&&
(3==c.COLCOMPONENTS?b+="color.rgb = fragColor;\n":4==c.COLCOMPONENTS&&(b+="color = fragColor;\n"));if(c.LIGHTS){b+="vec3 ambient   = vec3(0.07, 0.07, 0.07);\n";b+="vec3 diffuse   = vec3(0.0, 0.0, 0.0);\n";b+="vec3 specular  = vec3(0.0, 0.0, 0.0);\n";b+="vec3 normal    = normalize(fragNormal);\n";b+="vec3 eye    = -fragPosition;\n";c.NORMALMAP&&(b+="vec3 n = normalize( fragNormal );\n",x3dom.caps.STD_DERIVATIVES?b+="normal = perturb_normal( n, fragPosition, vec2(fragTexcoord.x, 1.0-fragTexcoord.y) );\n":
(b+="vec3 t = normalize( fragTangent );\n",b+="vec3 b = normalize( fragBinormal );\n",b+="mat3 tangentToWorld = mat3(t, b, n);\n",b+="normal = texture2D( normalMap, vec2(fragTexcoord.x, 1.0-fragTexcoord.y) ).rgb;\n",b+="normal = 2.0 * normal - 1.0;\n",b+="normal = normalize( normal * tangentToWorld );\n",b+="normal.y = -normal.y;\n",b+="normal.x = -normal.x;\n"));c.SOLID||(b+="if (dot(normal, eye) < 0.0) {\n",b+="  normal *= -1.0;\n",b+="}\n");for(var d=0;d<c.LIGHTS;d++)b+=" lighting(light"+d+"_Type, light"+
d+"_Location, light"+d+"_Direction, light"+d+"_Color, light"+d+"_Attenuation, light"+d+"_Radius, light"+d+"_Intensity, light"+d+"_AmbientIntensity, light"+d+"_BeamWidth, light"+d+"_CutOffAngle, normal, eye, ambient, diffuse, specular);\n";c.SPECMAP&&(b+="specular *= texture2D(specularMap, vec2(fragTexcoord.x, 1.0-fragTexcoord.y)).rgb;\n");c.TEXTURED||c.DIFFUSEMAP||c.DIFFPLACEMENTMAP?(c.CUBEMAP?(b+="vec3 viewDir = normalize(fragViewDir);\n",b+="vec3 reflected = reflect(viewDir, normal);\n",b+="reflected = (modelViewMatrixInverse * vec4(reflected,0.0)).xyz;\n",
b+="vec4 texColor = textureCube(cubeMap, reflected);\n",b+="color.a *= texColor.a;\n"):c.DIFFPLACEMENTMAP?(b+="vec2 texCoord = vec2(fragTexcoord.x, 1.0-fragTexcoord.y);\n",b+="vec4 texColor = texture2D(diffuseDisplacementMap, texCoord);\n"):(b+="vec2 texCoord = vec2(fragTexcoord.x, 1.0-fragTexcoord.y);\n",b+="vec4 texColor = texture2D(diffuseMap, texCoord);\n",b+="color.a *= texColor.a;\n"),c.BLENDING?(b+="color.rgb = (emissiveColor + ambient*color.rgb + diffuse*color.rgb + specular*specularColor);\n",
b=c.CUBEMAP?b+"color.rgb = mix(color.rgb, texColor.rgb, vec3(0.75));\n":b+"color.rgb *= texColor.rgb;\n"):b+="color.rgb = (emissiveColor + ambient*texColor.rgb + diffuse*texColor.rgb + specular*specularColor);\n"):b+="color.rgb = (emissiveColor + ambient*color.rgb + diffuse*color.rgb + specular*specularColor);\n"}else c.APPMAT&&!c.VERTEXCOLOR&&(b+="color = vec4(0.0, 0.0, 0.0, 1.0);\n"),c.TEXTURED||c.DIFFUSEMAP?(b+="vec2 texCoord = vec2(fragTexcoord.x, 1.0-fragTexcoord.y);\n",b+="vec4 texColor = texture2D(diffuseMap, texCoord);\n",
b+="color.a = texColor.a;\n",c.BLENDING?(b+="color.rgb += emissiveColor.rgb;\n",b+="color.rgb *= texColor.rgb;\n"):b+="color = texColor;\n"):c.VERTEXCOLOR||c.POINTLINE2D?!c.VERTEXCOLOR&&c.POINTLINE2D&&(b+="color.rgb = emissiveColor;\n"):b+="color.rgb += emissiveColor;\n";c.FOG&&(b+="float f0 = calcFog(fragEyePosition);\n",b+="color.rgb = fogColor * (1.0-f0) + f0 * (color.rgb);\n");b=c.TEXT?b+"if (color.a <= 0.5) discard;\n":b+"if (color.a <= 0.1) discard;\n";b+="gl_FragColor = color;\n";b+="}\n";
d=a.createShader(a.FRAGMENT_SHADER);a.shaderSource(d,b);a.compileShader(d);a.getShaderParameter(d,a.COMPILE_STATUS)||x3dom.debug.logError("FragmentShader "+a.getShaderInfoLog(d));return d};x3dom.shader.DynamicMobileShader=function(a,c){this.program=a.createProgram();var b=this.generateVertexShader(a,c),d=this.generateFragmentShader(a,c);a.attachShader(this.program,b);a.attachShader(this.program,d);a.bindAttribLocation(this.program,0,"position");a.linkProgram(this.program);return this.program};
x3dom.shader.DynamicMobileShader.prototype.generateVertexShader=function(a,c){var b;b=""+x3dom.shader.material();b+="uniform mat4 normalMatrix;\nuniform mat4 modelViewMatrix;\n";b+="uniform mat4 modelViewProjectionMatrix;\n";3==c.POSCOMPONENTS?b+="attribute vec3 position;\n":4==c.POSCOMPONENTS&&(b+="attribute vec4 position;\n");if(c.IMAGEGEOMETRY){b+="uniform vec3 IG_bboxMin;\n";b+="uniform vec3 IG_bboxMax;\n";b+="uniform float IG_coordTextureWidth;\n";b+="uniform float IG_coordTextureHeight;\n";
b+="uniform vec2 IG_implicitMeshSize;\n";for(var d=0;d<c.IG_PRECISION;d++)b+="uniform sampler2D IG_coords"+d+"\n;";c.IG_INDEXED&&(b+="uniform sampler2D IG_index;\n",b+="uniform float IG_indexTextureWidth;\n",b+="uniform float IG_indexTextureHeight;\n")}c.POPGEOMETRY&&(b+="uniform float PG_precisionLevel;\n",b+="uniform float PG_powPrecision;\n",b+="uniform vec3 PG_maxBBSize;\n",b+="uniform vec3 PG_bbMin;\n",b+="uniform vec3 PG_bbMaxModF;\n",b+="uniform vec3 PG_bboxShiftVec;\n",b+="uniform float PG_numAnchorVertices;\n",
b+="attribute float PG_vertexID;\n");c.POINTLINE2D||(c.IMAGEGEOMETRY?b+="uniform sampler2D IG_normals;\n":2==c.NORCOMPONENTS?4!=c.POSCOMPONENTS&&(b+="attribute vec2 normal;\n"):3==c.NORCOMPONENTS&&(b+="attribute vec3 normal;\n"));b+="varying vec4 fragColor;\n";c.VERTEXCOLOR&&(c.IMAGEGEOMETRY?b+="uniform sampler2D IG_colors;":3==c.COLCOMPONENTS?b+="attribute vec3 color;":4==c.COLCOMPONENTS&&(b+="attribute vec4 color;"));c.TEXTURED&&(b+="varying vec2 fragTexcoord;\n",b=c.IMAGEGEOMETRY?b+"uniform sampler2D IG_texCoords;":
b+"attribute vec2 texcoord;\n",c.TEXTRAFO&&(b+="uniform mat4 texTrafoMatrix;\n"),c.BLENDING||(b+="varying vec3 fragAmbient;\n",b+="varying vec3 fragDiffuse;\n"),c.CUBEMAP&&(b+="varying vec3 fragViewDir;\n",b+="varying vec3 fragNormal;\n",b+="uniform mat4 viewMatrix;\n"));c.FOG&&(b+=x3dom.shader.fog());c.LIGHTS&&(b+=x3dom.shader.light(c.LIGHTS));c.REQUIREBBOX&&(b+="uniform vec3 bgCenter;\n",b+="uniform vec3 bgSize;\n",b+="uniform float bgPrecisionMax;\n");c.REQUIREBBOXNOR&&(b+="uniform float bgPrecisionNorMax;\n");
c.REQUIREBBOXCOL&&(b+="uniform float bgPrecisionColMax;\n");c.REQUIREBBOXTEX&&(b+="uniform float bgPrecisionTexMax;\n");b+="void main(void) {\n";b+="gl_PointSize = 2.0;\n";if(c.IMAGEGEOMETRY){c.IG_INDEXED?(b+="vec2 halfPixel = vec2(0.5/IG_indexTextureWidth,0.5/IG_indexTextureHeight);\n",b+="vec2 IG_texCoord = vec2(position.x*(IG_implicitMeshSize.x/IG_indexTextureWidth), position.y*(IG_implicitMeshSize.y/IG_indexTextureHeight)) + halfPixel;\n",b+="vec2 IG_indices = texture2D( IG_index, IG_texCoord ).rg;\n",
b+="halfPixel = vec2(0.5/IG_coordTextureWidth,0.5/IG_coordTextureHeight);\n",b+="IG_texCoord = (IG_indices * 0.996108948) + halfPixel;\n"):(b+="vec2 halfPixel = vec2(0.5/IG_coordTextureWidth, 0.5/IG_coordTextureHeight);\n",b+="vec2 IG_texCoord = vec2(position.x*(IG_implicitMeshSize.x/IG_coordTextureWidth), position.y*(IG_implicitMeshSize.y/IG_coordTextureHeight)) + halfPixel;\n");b+="vec3 temp = vec3(0.0, 0.0, 0.0);\n";b+="vec3 vertPosition = vec3(0.0, 0.0, 0.0);\n";for(d=0;d<c.IG_PRECISION;d++)b+=
"temp = 255.0 * texture2D( IG_coords"+d+", IG_texCoord ).rgb;\n",b+="vertPosition *= 256.0;\n",b+="vertPosition += temp;\n";b+="vertPosition /= (pow(2.0, 8.0 * "+c.IG_PRECISION+".0) - 1.0);\n";b+="vertPosition = vertPosition * (IG_bboxMax - IG_bboxMin) + IG_bboxMin;\n";c.POINTLINE2D||(b+="vec3 vertNormal = texture2D( IG_normals, IG_texCoord ).rgb;\n",b+="vertNormal = vertNormal * 2.0 - 1.0;\n");c.VERTEXCOLOR&&(3==c.COLCOMPONENTS?b+="vec3 vertColor = texture2D( IG_colors, IG_texCoord ).rgb;":4==c.COLCOMPONENTS&&
(b+="vec4 vertColor = texture2D( IG_colors, IG_texCoord ).rgba;"));c.TEXTURED&&(b+="vec4 IG_doubleTexCoords = texture2D( IG_texCoords, IG_texCoord );\n",b+="vec2 vertTexCoord;",b+="vertTexCoord.r = (IG_doubleTexCoords.r * 0.996108948) + (IG_doubleTexCoords.b * 0.003891051);\n",b+="vertTexCoord.g = (IG_doubleTexCoords.g * 0.996108948) + (IG_doubleTexCoords.a * 0.003891051);\n")}else{b+="vec3 vertPosition = position.xyz;\n";if(c.POPGEOMETRY)b+="vec3 offsetVec = step(vertPosition / bgPrecisionMax, PG_bbMaxModF) * PG_bboxShiftVec;\n",
b+="if ((PG_precisionLevel <= 2.0) || PG_vertexID >= PG_numAnchorVertices) {\n",b+="   vertPosition = floor(vertPosition / PG_powPrecision) * PG_powPrecision;\n",b+="   vertPosition /= (65536.0 - PG_powPrecision);\n",b+="}\n",b+="else {\n",b+="   vertPosition /= bgPrecisionMax;\n",b+="}\n",b+="vertPosition = (vertPosition + offsetVec + PG_bbMin) * PG_maxBBSize;\n";else if(c.REQUIREBBOX||c.BITLODGEOMETRY)b+="vertPosition = bgCenter + bgSize * vertPosition / bgPrecisionMax;\n";if(!c.POINTLINE2D)if(2==
c.NORCOMPONENTS)4==c.POSCOMPONENTS?(b+="vec3 vertNormal = vec3(position.w / 256.0); \n",b+="vertNormal.x = floor(vertNormal.x) / 255.0; \n",b+="vertNormal.y = fract(vertNormal.y) * 1.00392156862745; \n"):b=c.REQUIREBBOXNOR&&!c.BITLODGEOMETRY?b+"vec3 vertNormal = vec3(normal.xy, 0.0) / bgPrecisionNorMax;\n":b+"vec3 vertNormal = vec3(normal.xy, 0.0);\n",b+="vec2 thetaPhi = 3.14159265358979 * vec2(vertNormal.x, vertNormal.y*2.0-1.0); \n",b+="vec4 sinCosThetaPhi = vec4(thetaPhi, thetaPhi + 1.5707963267949); \n",
b+="vec4 thetaPhiPow2 = sinCosThetaPhi * sinCosThetaPhi; \n",b+="vec4 thetaPhiPow3 =  thetaPhiPow2  * sinCosThetaPhi; \n",b+="vec4 thetaPhiPow5 =  thetaPhiPow3  * thetaPhiPow2; \n",b+="vec4 thetaPhiPow7 =  thetaPhiPow5  * thetaPhiPow2; \n",b+="vec4 thetaPhiPow9 =  thetaPhiPow7  * thetaPhiPow2; \n",b+="sinCosThetaPhi +=  -0.16666666667   * thetaPhiPow3; \n",b+="sinCosThetaPhi +=   0.00833333333   * thetaPhiPow5; \n",b+="sinCosThetaPhi +=  -0.000198412698  * thetaPhiPow7; \n",b+="sinCosThetaPhi +=   0.0000027557319 * thetaPhiPow9; \n",
b+="vertNormal.x = sinCosThetaPhi.x * sinCosThetaPhi.w; \n",b+="vertNormal.y = sinCosThetaPhi.x * sinCosThetaPhi.y; \n",b+="vertNormal.z = sinCosThetaPhi.z; \n";else if(b+="vec3 vertNormal = normal;\n",c.REQUIREBBOXNOR&&(b+="vertNormal = vertNormal / bgPrecisionNorMax;\n"),c.BITLODGEOMETRY||c.POPGEOMETRY)b+="vertNormal = 2.0*vertNormal - 1.0;\n";c.VERTEXCOLOR&&(3==c.COLCOMPONENTS?b+="vec3 vertColor = color;":4==c.COLCOMPONENTS&&(b+="vec4 vertColor = color;"),c.REQUIREBBOXNOR&&(b+="vertColor = vertColor / bgPrecisionColMax;\n"));
c.TEXTURED&&(b+="vec2 vertTexCoord = texcoord;\n",c.REQUIREBBOXTEX&&(b+="vertTexCoord = vertTexCoord / bgPrecisionTexMax;\n"))}b+="vec3 positionMV = (modelViewMatrix * vec4(vertPosition, 1.0)).xyz;\n";c.POINTLINE2D||(b+="vec3 normalMV = normalize( (normalMatrix * vec4(vertNormal, 0.0)).xyz );\n");b+="vec3 eye = -positionMV;\n";c.VERTEXCOLOR?(b+="vec3 rgb = vertColor.rgb;\n",4==c.COLCOMPONENTS?b+="float alpha = vertColor.a;\n":3==c.COLCOMPONENTS&&(b+="float alpha = 1.0 - transparency;\n")):(b+="vec3 rgb = diffuseColor;\n",
b+="float alpha = 1.0 - transparency;\n");c.TEXTURED&&(c.CUBEMAP?(b+="fragViewDir = viewMatrix[3].xyz;\n",b+="fragNormal = normalMV;\n"):c.SPHEREMAPPING?b+=" fragTexcoord = 0.5 + normalMV.xy / 2.0;\n":c.TEXTRAFO?b+=" fragTexcoord = (texTrafoMatrix * vec4(vertTexCoord, 1.0, 1.0)).xy;\n":(b+=" fragTexcoord = vertTexCoord;\n",c.POPGEOMETRY&&!0===x3dom.debug.usePrecisionLevelAsTexCoord&&(b+="fragTexcoord = vec2(0.03125 + 0.9375 * (PG_precisionLevel / 16.0), 1.0);")));if(c.LIGHTS){b+="vec3 ambient   = vec3(0.07, 0.07, 0.07);\n";
b+="vec3 diffuse   = vec3(0.0, 0.0, 0.0);\n";b+="vec3 specular  = vec3(0.0, 0.0, 0.0);\n";c.SOLID||(b+="if (dot(normalMV, eye) < 0.0) {\n",b+="  normalMV *= -1.0;\n",b+="}\n");for(d=0;d<c.LIGHTS;d++)b+=" lighting(light"+d+"_Type,light"+d+"_Location,light"+d+"_Direction,light"+d+"_Color,light"+d+"_Attenuation,light"+d+"_Radius,light"+d+"_Intensity,light"+d+"_AmbientIntensity,light"+d+"_BeamWidth,light"+d+"_CutOffAngle,normalMV, eye, ambient, diffuse, specular);\n";c.TEXTURED&&!c.BLENDING?(b+="fragAmbient = ambient;\n",
b+="fragDiffuse = diffuse;\n",b+="fragColor.rgb = (emissiveColor + specular*specularColor);\n"):b+="fragColor.rgb = (emissiveColor + ambient*rgb + diffuse*rgb + specular*specularColor);\n"}else c.APPMAT&&!c.VERTEXCOLOR&&(b+="rgb = vec3(0.0, 0.0, 0.0);\n"),c.TEXTURED&&!c.BLENDING?(b+="fragAmbient = vec3(1.0);\n",b+="fragDiffuse = vec3(1.0);\n",b+="fragColor.rgb = vec3(0.0);\n"):b=!c.VERTEXCOLOR&&c.POINTLINE2D?b+"fragColor.rgb = emissiveColor;\n":b+"fragColor.rgb = rgb + emissiveColor;\n;\n";b+="fragColor.a = alpha;\n";
c.FOG&&(b+="float f0 = calcFog(-positionMV);\n",b+="fragColor.rgb = fogColor * (1.0-f0) + f0 * (fragColor.rgb);\n");b+="gl_Position = modelViewProjectionMatrix * vec4(vertPosition, 1.0);\n";b+="}\n";d=a.createShader(a.VERTEX_SHADER);a.shaderSource(d,b);a.compileShader(d);a.getShaderParameter(d,a.COMPILE_STATUS)||x3dom.debug.logError("[DynamicMobileShader] VertexShader "+a.getShaderInfoLog(d));return d};
x3dom.shader.DynamicMobileShader.prototype.generateFragmentShader=function(a,c){var b;b="#ifdef GL_FRAGMENT_PRECISION_HIGH\nprecision highp float;\n#else\n";b+=" precision mediump float;\n";b+="#endif\n\n";b+="varying vec4 fragColor;\n";c.TEXTURED&&(c.CUBEMAP?(b+="uniform samplerCube cubeMap;\n",b+="varying vec3 fragViewDir;\n",b+="varying vec3 fragNormal;\n",b+="uniform mat4 modelViewMatrixInverse;\n"):(b+="uniform sampler2D diffuseMap;           \n",b+="varying vec2 fragTexcoord;       \n"),c.BLENDING||
(b+="varying vec3 fragAmbient;\n",b+="varying vec3 fragDiffuse;\n"));b+="void main(void) {\n";b+="vec4 color = fragColor;\n";c.TEXTURED&&(c.CUBEMAP?(b+="vec3 normal = normalize(fragNormal);\n",b+="vec3 viewDir = normalize(fragViewDir);\n",b+="vec3 reflected = reflect(viewDir, normal);\n",b+="reflected = (modelViewMatrixInverse * vec4(reflected,0.0)).xyz;\n",b+="vec4 texColor = textureCube(cubeMap, reflected);\n"):b+="vec4 texColor = texture2D(diffuseMap, vec2(fragTexcoord.s, 1.0-fragTexcoord.t));\n",
c.BLENDING?c.CUBEMAP?(b+="color.rgb = mix(color.rgb, texColor.rgb, vec3(0.75));\n",b+="color.a = texColor.a;\n"):(b+="color.rgb *= texColor.rgb;\n",b+="color.a *= texColor.a;\n"):(b+="color.rgb += fragAmbient*texColor.rgb + fragDiffuse*texColor.rgb;\n",b+="color.a *= texColor.a;\n"));b=c.TEXT?b+"if (color.a <= 0.5) discard;\n":b+"if (color.a <= 0.1) discard;\n";b+="gl_FragColor = color;\n";b+="}\n";var d=a.createShader(a.FRAGMENT_SHADER);a.shaderSource(d,b);a.compileShader(d);a.getShaderParameter(d,
a.COMPILE_STATUS)||x3dom.debug.logError("[DynamicMobileShader] FragmentShader "+a.getShaderInfoLog(d));return d};x3dom.shader.ComposedShader=function(a,c){this.program=a.createProgram();var b=this.generateVertexShader(a,c),d=this.generateFragmentShader(a,c);a.attachShader(this.program,b);a.attachShader(this.program,d);a.bindAttribLocation(this.program,0,"position");a.linkProgram(this.program);return this.program};
x3dom.shader.ComposedShader.prototype.generateVertexShader=function(a,c){var b=c._cf.appearance.node._shader._vertex._vf.url[0],d=a.createShader(a.VERTEX_SHADER);a.shaderSource(d,b);a.compileShader(d);a.getShaderParameter(d,a.COMPILE_STATUS)||x3dom.debug.logError("[ComposedShader] VertexShader "+a.getShaderInfoLog(d));return d};
x3dom.shader.ComposedShader.prototype.generateFragmentShader=function(a,c){var b=c._cf.appearance.node._shader._fragment._vf.url[0],d=a.createShader(a.FRAGMENT_SHADER);a.shaderSource(d,b);a.compileShader(d);a.getShaderParameter(d,a.COMPILE_STATUS)||x3dom.debug.logError("[ComposedShader] FragmentShader "+a.getShaderInfoLog(d));return d};
x3dom.shader.NormalShader=function(a){this.program=a.createProgram();var c=this.generateVertexShader(a),b=this.generateFragmentShader(a);a.attachShader(this.program,c);a.attachShader(this.program,b);a.bindAttribLocation(this.program,0,"position");a.linkProgram(this.program);return this.program};
x3dom.shader.NormalShader.prototype.generateVertexShader=function(a){var c=a.createShader(a.VERTEX_SHADER);a.shaderSource(c,"attribute vec3 position;\nattribute vec3 normal;\nuniform vec3 bgCenter;\nuniform vec3 bgSize;\nuniform float bgPrecisionMax;\nuniform float bgPrecisionNorMax;\nuniform mat4 normalMatrix;\nuniform mat4 modelViewProjectionMatrix;\nvarying vec3 fragNormal;\nvoid main(void) {\n    vec3 pos = bgCenter + bgSize * position / bgPrecisionMax;\n    fragNormal = (normalMatrix * vec4(normal / bgPrecisionNorMax, 0.0)).xyz;\n    gl_Position = modelViewProjectionMatrix * vec4(pos, 1.0);\n}\n");a.compileShader(c);
a.getShaderParameter(c,a.COMPILE_STATUS)||x3dom.debug.logError("[NormalShader] VertexShader "+a.getShaderInfoLog(c));return c};
x3dom.shader.NormalShader.prototype.generateFragmentShader=function(a){var c;c="#ifdef GL_FRAGMENT_PRECISION_HIGH\nprecision highp float;\n#else\n";c+=" precision mediump float;\n";c+="#endif\n\n";c+="varying vec3 fragNormal;\nvoid main(void) {\n    gl_FragColor = vec4(normalize(fragNormal) / 2.0 + 0.5, 1.0);\n}\n";var b=a.createShader(a.FRAGMENT_SHADER);a.shaderSource(b,c);a.compileShader(b);a.getShaderParameter(b,a.COMPILE_STATUS)||x3dom.debug.logError("[NormalShader] FragmentShader "+a.getShaderInfoLog(b));
return b};x3dom.shader.PickingShader=function(a){this.program=a.createProgram();var c=this.generateVertexShader(a),b=this.generateFragmentShader(a);a.attachShader(this.program,c);a.attachShader(this.program,b);a.bindAttribLocation(this.program,0,"position");a.linkProgram(this.program);return this.program};
x3dom.shader.PickingShader.prototype.generateVertexShader=function(a){var c="",b,c="uniform float popGeometry;\nuniform float PG_precisionLevel;\nuniform float PG_powPrecision;\nuniform vec3 PG_maxBBSize;\nuniform vec3 PG_bbMin;\nuniform vec3 PG_bbMaxModF;\nuniform vec3 PG_bboxShiftVec;\n";b="   else if (popGeometry != 0.0) {\n  vec3 offsetVec = step(pos / bgPrecisionMax, PG_bbMaxModF) * PG_bboxShiftVec;\n  if (PG_precisionLevel <= 2.0) {\n     pos = floor(pos / PG_powPrecision) * PG_powPrecision;\n     pos /= (65536.0 - PG_powPrecision);\n  }\n  else {\n     pos /= bgPrecisionMax;\n  }\n  pos = (pos + offsetVec + PG_bbMin) * PG_maxBBSize;\n }\n   else\n";
c=x3dom.caps.MOBILE?"attribute vec3 position;\nattribute vec2 texcoord;\nuniform vec3 bgCenter;\nuniform vec3 bgSize;\nuniform float bgPrecisionMax;\nuniform float writeShadowIDs;\nuniform mat4 modelMatrix;\nuniform mat4 modelViewProjectionMatrix;\nuniform vec3 from;\nvarying vec3 worldCoord;\nvarying vec2 idCoord;\n"+c+"void main(void) {\n    gl_PointSize = 2.0;\n    vec3 pos = position;\n    if (writeShadowIDs > 0.0) {\n     idCoord = vec2((texcoord.x + writeShadowIDs) / 256.0);\n       idCoord.x = floor(idCoord.x) / 255.0;\n       idCoord.y = fract(idCoord.y) * 1.00392156862745;\n  }\n"+
b+"  {\n       pos = bgCenter + bgSize * pos / bgPrecisionMax;\n  }\n    worldCoord = (modelMatrix * vec4(pos, 1.0)).xyz - from;\n    gl_Position = modelViewProjectionMatrix * vec4(pos, 1.0);\n}\n":"attribute vec3 position;\nattribute vec2 texcoord;\nuniform vec3 bgCenter;\nuniform vec3 bgSize;\nuniform float bgPrecisionMax;\nuniform mat4 modelMatrix;\nuniform mat4 modelViewProjectionMatrix;\nuniform vec3 from;\nvarying vec3 worldCoord;\nvarying vec2 idCoord;\nuniform float writeShadowIDs;\nuniform float imageGeometry;\nuniform vec3 IG_bboxMin;\nuniform vec3 IG_bboxMax;\nuniform float IG_coordTextureWidth;\nuniform float IG_coordTextureHeight;\nuniform float IG_indexTextureWidth;\nuniform float IG_indexTextureHeight;\nuniform sampler2D IG_indexTexture;\nuniform sampler2D IG_coordinateTexture;\nuniform vec2 IG_implicitMeshSize;\n"+
c+"void main(void) {\n   gl_PointSize = 2.0;\n   vec3 pos = position;\n   if (writeShadowIDs > 0.0) {\n     idCoord = vec2((texcoord.x + writeShadowIDs) / 256.0);\n       idCoord.x = floor(idCoord.x) / 255.0;\n       idCoord.y = fract(idCoord.y) * 1.00392156862745;\n }\n if (imageGeometry != 0.0) {\n  vec2 IG_texCoord;\n  if(imageGeometry == 1.0) {\n   vec2 halfPixel = vec2(0.5/IG_indexTextureWidth,0.5/IG_indexTextureHeight);\n   IG_texCoord = vec2(position.x*(IG_implicitMeshSize.x/IG_indexTextureWidth), position.y*(IG_implicitMeshSize.y/IG_indexTextureHeight)) + halfPixel;\n   vec2 IG_index = texture2D( IG_indexTexture, IG_texCoord ).rg;\n   IG_texCoord = IG_index * 0.996108948;\n  } else {\n   vec2 halfPixel = vec2(0.5/IG_coordTextureWidth, 0.5/IG_coordTextureHeight);\n   IG_texCoord = vec2(position.x*(IG_implicitMeshSize.x/IG_coordTextureWidth), position.y*(IG_implicitMeshSize.y/IG_coordTextureHeight)) + halfPixel;\n  }\n  pos = texture2D( IG_coordinateTexture, IG_texCoord ).rgb;\n   pos = pos * (IG_bboxMax - IG_bboxMin) + IG_bboxMin;\n } \n"+
b+"   {\n  pos = bgCenter + bgSize * pos / bgPrecisionMax;\n }\n worldCoord = (modelMatrix * vec4(pos, 1.0)).xyz - from;\n gl_Position = modelViewProjectionMatrix * vec4(pos, 1.0);\n}\n";b=a.createShader(a.VERTEX_SHADER);a.shaderSource(b,c);a.compileShader(b);a.getShaderParameter(b,a.COMPILE_STATUS)||x3dom.debug.logError("[PickingShader] VertexShader "+a.getShaderInfoLog(b));return b};
x3dom.shader.PickingShader.prototype.generateFragmentShader=function(a){var c;c="#ifdef GL_FRAGMENT_PRECISION_HIGH\n precision highp float;\n#else\n";c+=" precision mediump float;\n";c+="#endif\n\n";c+="uniform float writeShadowIDs;\nuniform float highBit;\nuniform float lowBit;\nuniform float sceneSize;\nvarying vec3 worldCoord;\nvarying vec2 idCoord;\nvoid main(void) {\n    vec4 col = vec4(0.0, 0.0, highBit, lowBit);\n    if (writeShadowIDs > 0.0) {\n       col.ba = idCoord;\n  }\n    float d = length(worldCoord) / sceneSize;\n    vec2 comp = fract(d * vec2(256.0, 1.0));\n    col.rg = comp - (comp.rr * vec2(0.0, 1.0/256.0));\n    gl_FragColor = col;\n}\n";
var b=a.createShader(a.FRAGMENT_SHADER);a.shaderSource(b,c);a.compileShader(b);a.getShaderParameter(b,a.COMPILE_STATUS)||x3dom.debug.logError("[PickingShader] FragmentShader "+a.getShaderInfoLog(b));return b};x3dom.shader.Picking24Shader=function(a){this.program=a.createProgram();var c=this.generateVertexShader(a),b=this.generateFragmentShader(a);a.attachShader(this.program,c);a.attachShader(this.program,b);a.bindAttribLocation(this.program,0,"position");a.linkProgram(this.program);return this.program};
x3dom.shader.Picking24Shader.prototype.generateVertexShader=function(a){var c="",c=x3dom.caps.MOBILE?"attribute vec3 position;\nattribute vec2 texcoord;\nuniform vec3 bgCenter;\nuniform vec3 bgSize;\nuniform float bgPrecisionMax;\nuniform float writeShadowIDs;\nuniform mat4 modelMatrix;\nuniform mat4 modelViewProjectionMatrix;\nuniform vec3 from;\nvarying vec3 worldCoord;\nvarying vec3 idCoord;\nvoid main(void) {\n    gl_PointSize = 2.0;\n    if (writeShadowIDs > 0.0) {\n       float ID = (texcoord.y * 65536.0 + texcoord.x) + writeShadowIDs;\n       float h = floor(ID / 256.0);\n       idCoord.x = ID - (h * 256.0);\n       idCoord.z = floor(h / 256.0);\n       idCoord.y = h - (idCoord.z * 256.0);\n       idCoord = idCoord.zyx / 255.0;\n  }\n    vec3 pos = bgCenter + bgSize * position / bgPrecisionMax;\n    worldCoord = (modelMatrix * vec4(pos, 1.0)).xyz - from;\n    gl_Position = modelViewProjectionMatrix * vec4(pos, 1.0);\n}\n":
"attribute vec3 position;\nattribute vec2 texcoord;\nuniform vec3 bgCenter;\nuniform vec3 bgSize;\nuniform float bgPrecisionMax;\nuniform mat4 modelMatrix;\nuniform mat4 modelViewProjectionMatrix;\nuniform vec3 from;\nvarying vec3 worldCoord;\nvarying vec3 idCoord;\nuniform float writeShadowIDs;\nuniform float imageGeometry;\nuniform vec3 IG_bboxMin;\nuniform vec3 IG_bboxMax;\nuniform float IG_coordTextureWidth;\nuniform float IG_coordTextureHeight;\nuniform float IG_indexTextureWidth;\nuniform float IG_indexTextureHeight;\nuniform sampler2D IG_indexTexture;\nuniform sampler2D IG_coordinateTexture;\nuniform vec2 IG_implicitMeshSize;\nvoid main(void) {\n   gl_PointSize = 2.0;\n   if (writeShadowIDs > 0.0) {\n       float ID = (texcoord.y * 65536.0 + texcoord.x) + writeShadowIDs;\n       float h = floor(ID / 256.0);\n       idCoord.x = ID - (h * 256.0);\n       idCoord.z = floor(h / 256.0);\n       idCoord.y = h - (idCoord.z * 256.0);\n       idCoord = idCoord.zyx / 255.0;\n }\n if (imageGeometry != 0.0) {\n  vec2 IG_texCoord;\n  if(imageGeometry == 1.0) {\n   vec2 halfPixel = vec2(0.5/IG_indexTextureWidth,0.5/IG_indexTextureHeight);\n   IG_texCoord = vec2(position.x*(IG_implicitMeshSize.x/IG_indexTextureWidth), position.y*(IG_implicitMeshSize.y/IG_indexTextureHeight)) + halfPixel;\n   vec2 IG_index = texture2D( IG_indexTexture, IG_texCoord ).rg;\n   IG_texCoord = IG_index * 0.996108948;\n  } else {\n   vec2 halfPixel = vec2(0.5/IG_coordTextureWidth, 0.5/IG_coordTextureHeight);\n   IG_texCoord = vec2(position.x*(IG_implicitMeshSize.x/IG_coordTextureWidth), position.y*(IG_implicitMeshSize.y/IG_coordTextureHeight)) + halfPixel;\n  }\n  vec3 pos = texture2D( IG_coordinateTexture, IG_texCoord ).rgb;\n   pos = pos * (IG_bboxMax - IG_bboxMin) + IG_bboxMin;\n     worldCoord = (modelMatrix * vec4(pos, 1.0)).xyz - from;\n  gl_Position = modelViewProjectionMatrix * vec4(pos, 1.0);\n } else {\n  vec3 pos = bgCenter + bgSize * position / bgPrecisionMax;\n  worldCoord = (modelMatrix * vec4(pos, 1.0)).xyz - from;\n  gl_Position = modelViewProjectionMatrix * vec4(pos, 1.0);\n }\n}\n",
b=a.createShader(a.VERTEX_SHADER);a.shaderSource(b,c);a.compileShader(b);a.getShaderParameter(b,a.COMPILE_STATUS)||x3dom.debug.logError("[Picking24Shader] VertexShader "+a.getShaderInfoLog(b));return b};
x3dom.shader.Picking24Shader.prototype.generateFragmentShader=function(a){var c;c="#ifdef GL_FRAGMENT_PRECISION_HIGH\nprecision highp float;\n#else\n";c+=" precision mediump float;\n";c+="#endif\n\n";c+="uniform float writeShadowIDs;\nuniform float highBit;\nuniform float lowBit;\nuniform float sceneSize;\nvarying vec3 worldCoord;\nvarying vec3 idCoord;\nvoid main(void) {\n    vec4 col = vec4(0.0, 0.0, highBit, lowBit);\n    if (writeShadowIDs > 0.0) {\n       col.gba = idCoord;\n  }\n    col.r = length(worldCoord) / sceneSize;\n    gl_FragColor = col;\n}\n";var b=
a.createShader(a.FRAGMENT_SHADER);a.shaderSource(b,c);a.compileShader(b);a.getShaderParameter(b,a.COMPILE_STATUS)||x3dom.debug.logError("[Picking24Shader] FragmentShader "+a.getShaderInfoLog(b));return b};x3dom.shader.PickingIdShader=function(a){this.program=a.createProgram();var c=this.generateVertexShader(a),b=this.generateFragmentShader(a);a.attachShader(this.program,c);a.attachShader(this.program,b);a.bindAttribLocation(this.program,0,"position");a.linkProgram(this.program);return this.program};
x3dom.shader.PickingIdShader.prototype.generateVertexShader=function(a){var c=a.createShader(a.VERTEX_SHADER);a.shaderSource(c,"attribute vec3 position;\nattribute vec2 texcoord;\nuniform vec3 bgCenter;\nuniform vec3 bgSize;\nuniform float bgPrecisionMax;\nuniform float writeShadowIDs;\nuniform mat4 modelMatrix;\nuniform mat4 modelViewProjectionMatrix;\nvarying vec2 idCoord;\nvoid main(void) {\n    if (writeShadowIDs > 0.0) {\n     idCoord = vec2((texcoord.x + writeShadowIDs) / 256.0);\n       idCoord.x = floor(idCoord.x) / 255.0;\n       idCoord.y = fract(idCoord.y) * 1.00392156862745;\n  }\n    vec3 pos = bgCenter + bgSize * position / bgPrecisionMax;\n    gl_Position = modelViewProjectionMatrix * vec4(pos, 1.0);\n}\n");
a.compileShader(c);a.getShaderParameter(c,a.COMPILE_STATUS)||x3dom.debug.logError("[PickingIdShader] VertexShader "+a.getShaderInfoLog(c));return c};
x3dom.shader.PickingIdShader.prototype.generateFragmentShader=function(a){var c;c="#ifdef GL_FRAGMENT_PRECISION_HIGH\n precision highp float;\n#else\n";c+=" precision mediump float;\n";c+="#endif\n\n";c+="uniform float writeShadowIDs;\nuniform float highBit;\nuniform float lowBit;\nvarying vec2 idCoord;\nvoid main(void) {\n    vec4 col = vec4(highBit, lowBit, 0.0, 0.0);\n    if (writeShadowIDs > 0.0) {\n       col.ba = idCoord;\n  }\n    gl_FragColor = col;\n}\n";var b=a.createShader(a.FRAGMENT_SHADER);
a.shaderSource(b,c);a.compileShader(b);a.getShaderParameter(b,a.COMPILE_STATUS)||x3dom.debug.logError("[PickingIdShader] FragmentShader "+a.getShaderInfoLog(b));return b};x3dom.shader.PickingColorShader=function(a){this.program=a.createProgram();var c=this.generateVertexShader(a),b=this.generateFragmentShader(a);a.attachShader(this.program,c);a.attachShader(this.program,b);a.bindAttribLocation(this.program,0,"position");a.linkProgram(this.program);return this.program};
x3dom.shader.PickingColorShader.prototype.generateVertexShader=function(a){var c=a.createShader(a.VERTEX_SHADER);a.shaderSource(c,"attribute vec3 position;\nattribute vec3 color;\nvarying vec3 fragColor;\nuniform mat4 modelViewProjectionMatrix;\n\nvoid main(void) {\n    gl_Position = modelViewProjectionMatrix * vec4(position, 1.0);\n    gl_PointSize = 2.0;\n    fragColor = color;\n}\n");a.compileShader(c);a.getShaderParameter(c,a.COMPILE_STATUS)||x3dom.debug.logError("[PickingColorShader] VertexShader "+
a.getShaderInfoLog(c));return c};
x3dom.shader.PickingColorShader.prototype.generateFragmentShader=function(a){var c;c="#ifdef GL_FRAGMENT_PRECISION_HIGH\nprecision highp float;\n#else\n";c+=" precision mediump float;\n";c+="#endif\n\n";c+="uniform float lowBit;\nvarying vec3 fragColor;\n\nvoid main(void) {\n    gl_FragColor = vec4(fragColor, lowBit);\n}\n";var b=a.createShader(a.FRAGMENT_SHADER);a.shaderSource(b,c);a.compileShader(b);a.getShaderParameter(b,a.COMPILE_STATUS)||x3dom.debug.logError("[PickingColorShader] FragmentShader "+a.getShaderInfoLog(b));
return b};x3dom.shader.PickingTexcoordShader=function(a){this.program=a.createProgram();var c=this.generateVertexShader(a),b=this.generateFragmentShader(a);a.attachShader(this.program,c);a.attachShader(this.program,b);a.bindAttribLocation(this.program,0,"position");a.linkProgram(this.program);return this.program};
x3dom.shader.PickingTexcoordShader.prototype.generateVertexShader=function(a){var c=a.createShader(a.VERTEX_SHADER);a.shaderSource(c,"attribute vec3 position;\nattribute vec2 texcoord;\nvarying vec3 fragColor;\nuniform mat4 modelViewProjectionMatrix;\nvoid main(void) {\n    gl_Position = modelViewProjectionMatrix * vec4(position, 1.0);\n    fragColor = vec3(abs(texcoord.x), abs(texcoord.y), 0.0);\n}\n");a.compileShader(c);a.getShaderParameter(c,a.COMPILE_STATUS)||x3dom.debug.logError("[PickingTexcoordShader] VertexShader "+
a.getShaderInfoLog(c));return c};
x3dom.shader.PickingTexcoordShader.prototype.generateFragmentShader=function(a){var c;c="#ifdef GL_FRAGMENT_PRECISION_HIGH\nprecision highp float;\n#else\n";c+=" precision mediump float;\n";c+="#endif\n\n";c+="uniform float lowBit;\nvarying vec3 fragColor;\n\nvoid main(void) {\n    gl_FragColor = vec4(fragColor, lowBit);\n}\n";var b=a.createShader(a.FRAGMENT_SHADER);a.shaderSource(b,c);a.compileShader(b);a.getShaderParameter(b,a.COMPILE_STATUS)||x3dom.debug.logError("[PickingTexcoordShader] FragmentShader "+a.getShaderInfoLog(b));
return b};x3dom.shader.FrontgroundTextureShader=function(a){this.program=a.createProgram();var c=this.generateVertexShader(a),b=this.generateFragmentShader(a);a.attachShader(this.program,c);a.attachShader(this.program,b);a.bindAttribLocation(this.program,0,"position");a.linkProgram(this.program);return this.program};
x3dom.shader.FrontgroundTextureShader.prototype.generateVertexShader=function(a){var c=a.createShader(a.VERTEX_SHADER);a.shaderSource(c,"attribute vec3 position;\nvarying vec2 fragTexCoord;\n\nvoid main(void) {\n    vec2 texCoord = (position.xy + 1.0) * 0.5;\n    fragTexCoord = texCoord;\n    gl_Position = vec4(position.xy, 0.0, 1.0);\n}\n");a.compileShader(c);a.getShaderParameter(c,a.COMPILE_STATUS)||x3dom.debug.logError("[FrontgroundTextureShader] VertexShader "+a.getShaderInfoLog(c));return c};
x3dom.shader.FrontgroundTextureShader.prototype.generateFragmentShader=function(a){var c;c="#ifdef GL_FRAGMENT_PRECISION_HIGH\nprecision highp float;\n#else\n";c+=" precision mediump float;\n";c+="#endif\n\n";c+="uniform sampler2D tex;\nvarying vec2 fragTexCoord;\n\nvoid main(void) {\n    vec4 col = texture2D(tex, fragTexCoord);\n    gl_FragColor = vec4(col.rgb, 1.0);\n}\n";var b=a.createShader(a.FRAGMENT_SHADER);a.shaderSource(b,c);a.compileShader(b);a.getShaderParameter(b,a.COMPILE_STATUS)||x3dom.debug.logError("[FrontgroundTextureShader] FragmentShader "+
a.getShaderInfoLog(b));return b};x3dom.shader.BackgroundTextureShader=function(a){this.program=a.createProgram();var c=this.generateVertexShader(a),b=this.generateFragmentShader(a);a.attachShader(this.program,c);a.attachShader(this.program,b);a.bindAttribLocation(this.program,0,"position");a.linkProgram(this.program);return this.program};
x3dom.shader.BackgroundTextureShader.prototype.generateVertexShader=function(a){var c=a.createShader(a.VERTEX_SHADER);a.shaderSource(c,"attribute vec3 position;\nvarying vec2 fragTexCoord;\n\nvoid main(void) {\n    vec2 texCoord = (position.xy + 1.0) * 0.5;\n    fragTexCoord = texCoord;\n    gl_Position = vec4(position.xy, 0.0, 1.0);\n}\n");a.compileShader(c);a.getShaderParameter(c,a.COMPILE_STATUS)||x3dom.debug.logError("[BackgroundTextureShader] VertexShader "+a.getShaderInfoLog(c));return c};
x3dom.shader.BackgroundTextureShader.prototype.generateFragmentShader=function(a){var c;c="#ifdef GL_FRAGMENT_PRECISION_HIGH\nprecision highp float;\n#else\n";c+=" precision mediump float;\n";c+="#endif\n\n";c+="uniform sampler2D tex;\nvarying vec2 fragTexCoord;\n\nvoid main(void) {\n    gl_FragColor = texture2D(tex, fragTexCoord);\n}";var b=a.createShader(a.FRAGMENT_SHADER);a.shaderSource(b,c);a.compileShader(b);a.getShaderParameter(b,a.COMPILE_STATUS)||x3dom.debug.logError("[BackgroundTextureShader] FragmentShader "+
a.getShaderInfoLog(b));return b};x3dom.shader.BackgroundSkyTextureShader=function(a){this.program=a.createProgram();var c=this.generateVertexShader(a),b=this.generateFragmentShader(a);a.attachShader(this.program,c);a.attachShader(this.program,b);a.bindAttribLocation(this.program,0,"position");a.linkProgram(this.program);return this.program};
x3dom.shader.BackgroundSkyTextureShader.prototype.generateVertexShader=function(a){var c=a.createShader(a.VERTEX_SHADER);a.shaderSource(c,"attribute vec3 position;\nattribute vec2 texcoord;\nuniform mat4 modelViewProjectionMatrix;\nvarying vec2 fragTexCoord;\n\nvoid main(void) {\n    fragTexCoord = texcoord;\n    gl_Position = modelViewProjectionMatrix * vec4(position, 1.0);\n}\n");a.compileShader(c);a.getShaderParameter(c,a.COMPILE_STATUS)||x3dom.debug.logError("[BackgroundSkyTextureShader] VertexShader "+
a.getShaderInfoLog(c));return c};
x3dom.shader.BackgroundSkyTextureShader.prototype.generateFragmentShader=function(a){var c;c="#ifdef GL_FRAGMENT_PRECISION_HIGH\nprecision highp float;\n#else\n";c+=" precision mediump float;\n";c+="#endif\n\n";c+="uniform sampler2D tex;\nvarying vec2 fragTexCoord;\n\nvoid main(void) {\n    gl_FragColor = texture2D(tex, fragTexCoord);\n}\n";var b=a.createShader(a.FRAGMENT_SHADER);a.shaderSource(b,c);a.compileShader(b);a.getShaderParameter(b,a.COMPILE_STATUS)||x3dom.debug.logError("[BackgroundSkyTextureShader] FragmentShader "+a.getShaderInfoLog(b));
return b};x3dom.shader.BackgroundCubeTextureShader=function(a){this.program=a.createProgram();var c=this.generateVertexShader(a),b=this.generateFragmentShader(a);a.attachShader(this.program,c);a.attachShader(this.program,b);a.bindAttribLocation(this.program,0,"position");a.linkProgram(this.program);return this.program};
x3dom.shader.BackgroundCubeTextureShader.prototype.generateVertexShader=function(a){var c=a.createShader(a.VERTEX_SHADER);a.shaderSource(c,"attribute vec3 position;\nuniform mat4 modelViewProjectionMatrix;\nvarying vec3 fragNormal;\n\nvoid main(void) {\n    fragNormal = normalize(position);\n    gl_Position = modelViewProjectionMatrix * vec4(position, 1.0);\n}\n");a.compileShader(c);a.getShaderParameter(c,a.COMPILE_STATUS)||x3dom.debug.logError("[BackgroundCubeTextureShader] VertexShader "+a.getShaderInfoLog(c));
return c};
x3dom.shader.BackgroundCubeTextureShader.prototype.generateFragmentShader=function(a){var c;c="#ifdef GL_FRAGMENT_PRECISION_HIGH\nprecision highp float;\n#else\n";c+=" precision mediump float;\n";c+="#endif\n\n";c+="uniform samplerCube tex;\nvarying vec3 fragNormal;\n\nfloat magn(float val) {\n    return ((val >= 0.0) ? val : -1.0 * val);\n}\nvoid main(void) {\n    vec3 normal = -reflect(normalize(fragNormal), vec3(0.0,0.0,1.0));\n    if (magn(normal.y) >= magn(normal.x) && magn(normal.y) >= magn(normal.z))\n        normal.xz = -normal.xz;\n    gl_FragColor = textureCube(tex, normal);\n}\n";var b=
a.createShader(a.FRAGMENT_SHADER);a.shaderSource(b,c);a.compileShader(b);a.getShaderParameter(b,a.COMPILE_STATUS)||x3dom.debug.logError("[BackgroundCubeTextureShader] FragmentShader "+a.getShaderInfoLog(b));return b};x3dom.shader.ShadowShader=function(a){this.program=a.createProgram();var c=this.generateVertexShader(a),b=this.generateFragmentShader(a);a.attachShader(this.program,c);a.attachShader(this.program,b);a.bindAttribLocation(this.program,0,"position");a.linkProgram(this.program);return this.program};
x3dom.shader.ShadowShader.prototype.generateVertexShader=function(a){var c;c=x3dom.caps.MOBILE?"attribute vec3 position;\nuniform vec3 bgCenter;\nuniform vec3 bgSize;\nuniform float bgPrecisionMax;\nuniform mat4 modelViewProjectionMatrix;\nvarying vec4 projCoords;\nvoid main(void) {\n vec3 pos = bgCenter + bgSize * position / bgPrecisionMax;\n projCoords = modelViewProjectionMatrix * vec4(pos, 1.0);\n gl_Position = projCoords;\n}\n":"attribute vec3 position;\nuniform mat4 modelViewProjectionMatrix;\nvarying vec4 projCoords;\nuniform vec3 bgCenter;\nuniform vec3 bgSize;\nuniform float bgPrecisionMax;\nuniform float imageGeometry;\nuniform vec3 IG_bboxMin;\nuniform vec3 IG_bboxMax;\nuniform float IG_coordTextureWidth;\nuniform float IG_coordTextureHeight;\nuniform float IG_indexTextureWidth;\nuniform float IG_indexTextureHeight;\nuniform sampler2D IG_indexTexture;\nuniform sampler2D IG_coordinateTexture;\nuniform vec2 IG_implicitMeshSize;\nuniform float popGeometry;\nuniform float PG_precisionLevel;\nuniform float PG_powPrecision;\nuniform vec3 PG_maxBBSize;\nuniform vec3 PG_bbMin;\nuniform vec3 PG_bbMaxModF;\nuniform vec3 PG_bboxShiftVec;\nvoid main(void) {\n vec3 pos;\n if (imageGeometry != 0.0) {\n  vec2 IG_texCoord;\n  if(imageGeometry == 1.0) {\n   vec2 halfPixel = vec2(0.5/IG_indexTextureWidth,0.5/IG_indexTextureHeight);\n   IG_texCoord = vec2(position.x*(IG_implicitMeshSize.x/IG_indexTextureWidth), position.y*(IG_implicitMeshSize.y/IG_indexTextureHeight)) + halfPixel;\n   vec2 IG_index = texture2D( IG_indexTexture, IG_texCoord ).rg;\n   IG_texCoord = IG_index * 0.996108948;\n  } else {\n   vec2 halfPixel = vec2(0.5/IG_coordTextureWidth, 0.5/IG_coordTextureHeight);\n   IG_texCoord = vec2(position.x*(IG_implicitMeshSize.x/IG_coordTextureWidth), position.y*(IG_implicitMeshSize.y/IG_coordTextureHeight)) + halfPixel;\n  }\n  pos = texture2D( IG_coordinateTexture, IG_texCoord ).rgb;\n   pos = pos * (IG_bboxMax - IG_bboxMin) + IG_bboxMin;\n } else if (popGeometry != 0.0){\n  pos = position;\n  vec3 offsetVec = step(pos / bgPrecisionMax, PG_bbMaxModF) * PG_bboxShiftVec;\n  if (PG_precisionLevel <= 2.0) {\n     pos = floor(pos / PG_powPrecision) * PG_powPrecision;\n     pos /= (65536.0 - PG_powPrecision);\n  }\n  else {\n     pos /= bgPrecisionMax;\n  }\n  pos = (pos + offsetVec + PG_bbMin) * PG_maxBBSize;\n } else {\n  pos = bgCenter + bgSize * position / bgPrecisionMax;\n }\n   projCoords = modelViewProjectionMatrix * vec4(pos, 1.0);\n   gl_Position = projCoords;\n}\n";
var b=a.createShader(a.VERTEX_SHADER);a.shaderSource(b,c);a.compileShader(b);a.getShaderParameter(b,a.COMPILE_STATUS)||x3dom.debug.logError("[ShadowShader] VertexShader "+a.getShaderInfoLog(b));return b};
x3dom.shader.ShadowShader.prototype.generateFragmentShader=function(a){var c;c="#ifdef GL_FRAGMENT_PRECISION_HIGH\nprecision highp float;\n#else\n";c+=" precision mediump float;\n";c+="#endif\n\n";c+="varying vec4 projCoords;\nuniform float offset;\nuniform bool cameraView;\n";if(!x3dom.caps.FP_TEXTURES||x3dom.caps.MOBILE)c+=x3dom.shader.rgbaPacking();c+="void main(void) {\n    vec3 proj = (projCoords.xyz / projCoords.w);\n";!x3dom.caps.FP_TEXTURES||x3dom.caps.MOBILE?c+="gl_FragColor = packDepth(proj.z);\n":
(c+=" if (!cameraView){\n  proj.z = (proj.z + 1.0)*0.5;\n  proj.y = proj.z * proj.z;\n }\n",c+=" gl_FragColor = vec4(proj, 1.0);\n");c+="}\n";var b=a.createShader(a.FRAGMENT_SHADER);a.shaderSource(b,c);a.compileShader(b);a.getShaderParameter(b,a.COMPILE_STATUS)||x3dom.debug.logError("[ShadowShader] FragmentShader "+a.getShaderInfoLog(b));return b};
x3dom.shader.ShadowRenderingShader=function(a,c){this.program=a.createProgram();var b=this.generateVertexShader(a),d=this.generateFragmentShader(a,c);a.attachShader(this.program,b);a.attachShader(this.program,d);a.bindAttribLocation(this.program,0,"position");a.linkProgram(this.program);return this.program};
x3dom.shader.ShadowRenderingShader.prototype.generateVertexShader=function(a){var c;c="attribute vec2 position;\nvarying vec2 vPosition;\n";c+="void main(void) {\n";c+=" vPosition = position;\n";c+=" gl_Position = vec4(position, -1.0, 1.0);\n";c+="}\n";var b=a.createShader(a.VERTEX_SHADER);a.shaderSource(b,c);a.compileShader(b);a.getShaderParameter(b,a.COMPILE_STATUS)||x3dom.debug.logError("[ShadowRendering] VertexShader "+a.getShaderInfoLog(b));return b};
x3dom.shader.ShadowRenderingShader.prototype.generateFragmentShader=function(a,c){var b;b="#ifdef GL_FRAGMENT_PRECISION_HIGH\nprecision highp float;\n#else\n";b+=" precision mediump float;\n";b+="#endif\n\n";b+="uniform mat4 inverseViewProj;\n";b+="uniform mat4 inverseProj;\n";b+="varying vec2 vPosition;\n";b+="uniform sampler2D sceneMap;\n";for(var d=0;5>d;d++)b+="uniform float cascade"+d+"_Depth;\n";for(d=0;d<c.length;d++){b+="uniform float light"+d+"_On;\nuniform float light"+d+"_Type;\nuniform vec3  light"+
d+"_Location;\nuniform vec3  light"+d+"_Direction;\nuniform vec3  light"+d+"_Attenuation;\nuniform float light"+d+"_Radius;\nuniform float light"+d+"_BeamWidth;\nuniform float light"+d+"_CutOffAngle;\nuniform float light"+d+"_ShadowIntensity;\nuniform float light"+d+"_ShadowOffset;\nuniform mat4 light"+d+"_ViewMatrix;\n";for(var e=0;6>e;e++)b+="uniform mat4 light"+d+"_"+e+"_Matrix;\n",b+="uniform sampler2D light"+d+"_"+e+"_ShadowMap;\n";for(e=0;5>e;e++)b+="uniform float light"+d+"_"+e+"_Split;\n"}if(!x3dom.caps.FP_TEXTURES||
x3dom.caps.MOBILE)b+=x3dom.shader.rgbaPacking();b+=x3dom.shader.shadowRendering();b+="void main(void) {\n float shadowValue = 1.0;\n vec2 texCoordsSceneMap = (vPosition + 1.0)*0.5;\n vec4 projCoords = texture2D(sceneMap, texCoordsSceneMap);\n if (projCoords != vec4(1.0,1.0,1.0,0.0)){\n";if(!x3dom.caps.FP_TEXTURES||x3dom.caps.MOBILE)b+=" projCoords.z = unpackDepth(projCoords);\n projCoords.w = 1.0;\n";b+=" projCoords = projCoords / projCoords.w;\n projCoords.xy = vPosition;\n vec4 eyeCoords = inverseProj*projCoords;\n vec4 worldCoords = inverseViewProj*projCoords;\n float lightInfluence = 0.0;\n";
for(d=0;d<c.length;d++)b+=" lightInfluence = getLightInfluence(light"+d+"_Type, light"+d+"_ShadowIntensity, light"+d+"_On, light"+d+"_Location, light"+d+"_Direction, light"+d+"_CutOffAngle, light"+d+"_BeamWidth, light"+d+"_Attenuation, light"+d+"_Radius, eyeCoords.xyz/eyeCoords.w);\n if (lightInfluence != 0.0){\n  vec4 shadowMapValues;\n  float viewSampleDepth;\n",b=x3dom.isa(c[d],x3dom.nodeTypes.PointLight)?b+("  getShadowValuesPointLight(shadowMapValues, viewSampleDepth, light"+d+"_Location, worldCoords, light"+
d+"_ViewMatrix, light"+d+"_0_Matrix,light"+d+"_1_Matrix,light"+d+"_2_Matrix,light"+d+"_3_Matrix,light"+d+"_4_Matrix,light"+d+"_5_Matrix,light"+d+"_0_ShadowMap,light"+d+"_1_ShadowMap,light"+d+"_2_ShadowMap,light"+d+"_3_ShadowMap,light"+d+"_4_ShadowMap,light"+d+"_5_ShadowMap);\n"):b+("  getShadowValuesCascaded(shadowMapValues, viewSampleDepth, worldCoords, -eyeCoords.z/eyeCoords.w,light"+d+"_0_Matrix,light"+d+"_1_Matrix,light"+d+"_2_Matrix,light"+d+"_3_Matrix,light"+d+"_4_Matrix,light"+d+"_5_Matrix,light"+
d+"_0_ShadowMap,light"+d+"_1_ShadowMap,light"+d+"_2_ShadowMap,light"+d+"_3_ShadowMap,light"+d+"_4_ShadowMap,light"+d+"_5_ShadowMap, light"+d+"_0_Split, light"+d+"_1_Split, light"+d+"_2_Split, light"+d+"_3_Split, \nlight"+d+"_4_Split);\n"),b=!x3dom.caps.FP_TEXTURES||x3dom.caps.MOBILE?b+(" shadowValue *= clamp(ESM(shadowMapValues.z, viewSampleDepth, light"+d+"_ShadowOffset),     1.0 - light"+d+"_ShadowIntensity*lightInfluence, 1.0);\n"):b+("  shadowValue *= clamp(VSM(shadowMapValues.zy, viewSampleDepth, light"+
d+"_ShadowOffset),     1.0 - light"+d+"_ShadowIntensity*lightInfluence, 1.0);\n"),b+=" }\n";b+="}\n gl_FragColor = vec4(shadowValue, shadowValue, shadowValue, 1.0);\n}\n";d=a.createShader(a.FRAGMENT_SHADER);a.shaderSource(d,b);a.compileShader(d);a.getShaderParameter(d,a.COMPILE_STATUS)||x3dom.debug.logError("[ShadowRendering] FragmentShader "+a.getShaderInfoLog(d));return d};
x3dom.shader.BlurShader=function(a){this.program=a.createProgram();var c=this.generateVertexShader(a),b=this.generateFragmentShader(a);a.attachShader(this.program,c);a.attachShader(this.program,b);a.bindAttribLocation(this.program,0,"position");a.linkProgram(this.program);return this.program};
x3dom.shader.BlurShader.prototype.generateVertexShader=function(a){var c;c="attribute vec2 position;\nvarying vec2 vPosition;\n";c+="void main(void) {\n";c+=" vPosition = position;\n";c+=" gl_Position = vec4(position, -1.0, 1.0);\n";c+="}\n";var b=a.createShader(a.VERTEX_SHADER);a.shaderSource(b,c);a.compileShader(b);a.getShaderParameter(b,a.COMPILE_STATUS)||x3dom.debug.logError("[BlurShader] VertexShader "+a.getShaderInfoLog(b));return b};
x3dom.shader.BlurShader.prototype.generateFragmentShader=function(a){var c;c="#ifdef GL_FRAGMENT_PRECISION_HIGH\nprecision highp float;\n#else\n";c+=" precision mediump float;\n";c+="#endif\n\n";c+="varying vec2 vPosition;\nuniform sampler2D texture;\nuniform bool horizontal;\nuniform float pixelSizeHor;\nuniform float pixelSizeVert;\nuniform int filterSize;\n";c=!x3dom.caps.FP_TEXTURES||x3dom.caps.MOBILE?c+(x3dom.shader.rgbaPacking()+"void main(void) {\n vec2 texCoords = (vPosition + 1.0)*0.5;\n vec2 offset;\n if (horizontal) offset = vec2(pixelSizeHor, 0.0);\n else offset = vec2(0.0, pixelSizeVert);\n float depth = unpackDepth(texture2D(texture, texCoords));\n if (filterSize == 3){\n  depth = depth * 0.3844;\n  depth += 0.3078*unpackDepth(texture2D(texture, texCoords-offset));\n  depth += 0.3078*unpackDepth(texture2D(texture, texCoords+offset));\n } else if (filterSize == 5){\n  depth = depth * 0.2921;\n  depth += 0.2339*unpackDepth(texture2D(texture, texCoords-offset));\n  depth += 0.2339*unpackDepth(texture2D(texture, texCoords+offset));\n  depth += 0.1201*unpackDepth(texture2D(texture, texCoords-2.0*offset));\n  depth += 0.1201*unpackDepth(texture2D(texture, texCoords+2.0*offset));\n } else if (filterSize == 7){\n  depth = depth * 0.2161;\n  depth += 0.1907*unpackDepth(texture2D(texture, texCoords-offset));\n  depth += 0.1907*unpackDepth(texture2D(texture, texCoords+offset));\n  depth += 0.1311*unpackDepth(texture2D(texture, texCoords-2.0*offset));\n  depth += 0.1311*unpackDepth(texture2D(texture, texCoords+2.0*offset));\n  depth += 0.0702*unpackDepth(texture2D(texture, texCoords-3.0*offset));\n  depth += 0.0702*unpackDepth(texture2D(texture, texCoords+3.0*offset));\n }\n gl_FragColor = packDepth(depth);\n}\n"):
c+"void main(void) {\n vec2 texCoords = (vPosition + 1.0)*0.5;\n vec2 offset;\n if (horizontal) offset = vec2(pixelSizeHor, 0.0);\n else offset = vec2(0.0, pixelSizeVert);\n vec4 color = texture2D(texture, texCoords);\n if (filterSize == 3){\n  color = color * 0.3844;\n  color += 0.3078*texture2D(texture, texCoords-offset);\n  color += 0.3078*texture2D(texture, texCoords+offset);\n } else if (filterSize == 5){\n  color = color * 0.2921;\n  color += 0.2339*texture2D(texture, texCoords-offset);\n  color += 0.2339*texture2D(texture, texCoords+offset);\n  color += 0.1201*texture2D(texture, texCoords-2.0*offset);\n  color += 0.1201*texture2D(texture, texCoords+2.0*offset);\n } else if (filterSize == 7){\n  color = color * 0.2161;\n  color += 0.1907*texture2D(texture, texCoords-offset);\n  color += 0.1907*texture2D(texture, texCoords+offset);\n  color += 0.1311*texture2D(texture, texCoords-2.0*offset);\n  color += 0.1311*texture2D(texture, texCoords+2.0*offset);\n  color += 0.0702*texture2D(texture, texCoords-3.0*offset);\n  color += 0.0702*texture2D(texture, texCoords+3.0*offset);\n }\n gl_FragColor = color;\n}\n";
var b=a.createShader(a.FRAGMENT_SHADER);a.shaderSource(b,c);a.compileShader(b);a.getShaderParameter(b,a.COMPILE_STATUS)||x3dom.debug.logError("[BlurShader] FragmentShader "+a.getShaderInfoLog(b));return b};
x3dom.gfx_webgl=function(){function a(a,b,d,e){this.ctx3d=a;this.canvas=b;this.name=d;this.x3dElem=e;this.IG_PositionBuffer=null;this.cache=new x3dom.Cache;this.stateManager=new x3dom.StateManager(a);this.activeShader=null}a.prototype.getName=function(){return this.name};a.prototype.setupShape=function(a,b,d){var e=0,f,g,h,k;b=b.shape;var l=b._cf.geometry.node;if(void 0!==b._webgl){var n=!1;!0===b._dirty.colors&&void 0===b._webgl.shader.color&&l._mesh._colors[0].length&&(n=!0);n&&b._cleanupGLObjects&&
b._cleanupGLObjects(!0,!1);if(!0===b._dirty.texture){if(b._webgl.texture.length!=b.getTextures().length){for(e=0;e<b._webgl.texture.length;++e)b._webgl.texture.pop();g=b.getTextures();for(e=0;e<g.length;++e)b._webgl.texture.push(new x3dom.Texture(a,b._nameSpace.doc,this.cache,g[e]));b._dirty.shader=!0;void 0===b._webgl.shader.texcoord&&(b._dirty.texcoords=!0)}else for(g=b.getTextures(),e=0;e<g.length;++e)g[e]!==b._webgl.texture[e].node&&(b._webgl.texture[e].texture=null,b._webgl.texture[e].node=g[e]),
b._webgl.texture[e].update();b._dirty.texture=!1}b._webgl.shader=this.cache.getShaderByProperties(a,b,b.getShaderProperties(d));if(!n&&0==b._webgl.binaryGeometry)for(e=0;e<b._webgl.positions.length;e++){f=5*e;if(!0==b._dirty.positions||!0==b._dirty.indexes)void 0!==b._webgl.shader.position&&(b._webgl.indexes[e]=l._mesh._indices[e],a.deleteBuffer(b._webgl.buffers[f]),h=a.createBuffer(),b._webgl.buffers[f]=h,x3dom.caps.INDEX_UINT&&65535<l._mesh._positions[0].length/3?(k=new Uint32Array(b._webgl.indexes[e]),
b._webgl.indexType=a.UNSIGNED_INT):(k=new Uint16Array(b._webgl.indexes[e]),b._webgl.indexType=a.UNSIGNED_SHORT),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,h),a.bufferData(a.ELEMENT_ARRAY_BUFFER,k,a.STATIC_DRAW),k=null,b._webgl.positions[e]=l._mesh._positions[e],a.deleteBuffer(b._webgl.buffers[f+1]),k=a.createBuffer(),b._webgl.buffers[f+1]=k,a.bindBuffer(a.ARRAY_BUFFER,k),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,b._webgl.buffers[f]),h=new Float32Array(b._webgl.positions[e]),a.bufferData(a.ARRAY_BUFFER,h,a.STATIC_DRAW),
a.bindBuffer(a.ARRAY_BUFFER,k),a.vertexAttribPointer(b._webgl.shader.position,l._mesh._numPosComponents,b._webgl.coordType,!1,b._coordStrideOffset[0],b._coordStrideOffset[1]),h=null),b._dirty.positions=!1,b._dirty.indexes=!1;!0==b._dirty.colors&&(void 0!==b._webgl.shader.color&&(b._webgl.colors[e]=l._mesh._colors[e],a.deleteBuffer(b._webgl.buffers[f+4]),h=a.createBuffer(),b._webgl.buffers[f+4]=h,k=new Float32Array(b._webgl.colors[e]),a.bindBuffer(a.ARRAY_BUFFER,h),a.bufferData(a.ARRAY_BUFFER,k,a.STATIC_DRAW),
a.vertexAttribPointer(b._webgl.shader.color,l._mesh._numColComponents,b._webgl.colorType,!1,b._colorStrideOffset[0],b._colorStrideOffset[1]),k=null),b._dirty.colors=!1);!0==b._dirty.normals&&(void 0!==b._webgl.shader.normal&&(b._webgl.normals[e]=l._mesh._normals[e],a.deleteBuffer(b._webgl.buffers[f+2]),h=a.createBuffer(),b._webgl.buffers[f+2]=h,k=new Float32Array(b._webgl.normals[e]),a.bindBuffer(a.ARRAY_BUFFER,h),a.bufferData(a.ARRAY_BUFFER,k,a.STATIC_DRAW),a.vertexAttribPointer(b._webgl.shader.normal,
l._mesh._numNormComponents,b._webgl.normalType,!1,b._normalStrideOffset[0],b._normalStrideOffset[1]),k=null),b._dirty.normals=!1);!0==b._dirty.texcoords&&(void 0!==b._webgl.shader.texcoord&&(b._webgl.texcoords[e]=l._mesh._texCoords[e],a.deleteBuffer(b._webgl.buffers[f+3]),texCoordBuffer=a.createBuffer(),b._webgl.buffers[f+3]=texCoordBuffer,h=new Float32Array(b._webgl.texcoords[e]),a.bindBuffer(a.ARRAY_BUFFER,texCoordBuffer),a.bufferData(a.ARRAY_BUFFER,h,a.STATIC_DRAW),a.vertexAttribPointer(b._webgl.shader.texCoord,
l._mesh._numTexComponents,b._webgl.texCoordType,!1,b._texCoordStrideOffset[0],b._texCoordStrideOffset[1]),h=null),b._dirty.texcoords=!1)}if(0!=b._webgl.imageGeometry){for(e=0;e<b._webgl.texture.length;++e)b._webgl.texture[e].updateTexture();l.unsetGeoDirty();b.unsetGeoDirty()}if(!n)return}else if(!(x3dom.isa(l,x3dom.nodeTypes.Text)||x3dom.isa(l,x3dom.nodeTypes.BinaryGeometry)||x3dom.isa(l,x3dom.nodeTypes.PopGeometry)||x3dom.isa(l,x3dom.nodeTypes.BitLODGeometry))&&(!l||1>l._mesh._positions[0].length)){2>
x3dom.caps.MAX_VERTEX_TEXTURE_IMAGE_UNITS&&x3dom.isa(l,x3dom.nodeTypes.ImageGeometry)?x3dom.debug.logError("Can't render ImageGeometry nodes with only "+x3dom.caps.MAX_VERTEX_TEXTURE_IMAGE_UNITS+" vertex texture units. Please upgrade your GPU!"):x3dom.debug.logError("NO VALID MESH OR NO VERTEX POSITIONS SET!");return}b.unsetDirty();b._cleanupGLObjects||(b._cleanupGLObjects=function(b,d){if(this._webgl&&(0<arguments.length&&b||0==this._parentNodes.length)){for(var e=this._webgl.shader,f=0;f<this._webgl.positions.length;f++){var g=
5*f;void 0!==e.position&&(a.deleteBuffer(this._webgl.buffers[g+1]),a.deleteBuffer(this._webgl.buffers[g]));void 0!==e.normal&&a.deleteBuffer(this._webgl.buffers[g+2]);void 0!==e.texcoord&&a.deleteBuffer(this._webgl.buffers[g+3]);void 0!==e.color&&a.deleteBuffer(this._webgl.buffers[g+4])}for(f=0;f<this._webgl.dynamicFields.length;f++)g=this._webgl.dynamicFields[f],void 0!==e[g.name]&&a.deleteBuffer(g.buf);void 0===d&&(d=!0);d&&(delete this._webgl,x3dom.BinaryContainerLoader.outOfMemory=!1)}});b._webgl=
{positions:l._mesh._positions,normals:l._mesh._normals,texcoords:l._mesh._texCoords,colors:l._mesh._colors,indexes:l._mesh._indices,indexType:a.UNSIGNED_SHORT,coordType:a.FLOAT,normalType:a.FLOAT,texCoordType:a.FLOAT,colorType:a.FLOAT,texture:[],dirtyLighting:x3dom.Utils.checkDirtyLighting(d),imageGeometry:0,binaryGeometry:0,popGeometry:0,bitLODGeometry:0};g=b.getTextures();for(e=0;e<g.length;++e)b._webgl.texture.push(new x3dom.Texture(a,b._nameSpace.doc,this.cache,g[e]));b._webgl.shader=this.cache.getShaderByProperties(a,
b,b.getShaderProperties(d));n=b._webgl.shader;g=0;b._webgl.buffers=[];b._webgl.dynamicFields=[];if(x3dom.isa(l,x3dom.nodeTypes.X3DBinaryContainerGeometryNode))for(b._webgl.primType=[],e=0;e<l._vf.primType.length;++e)b._webgl.primType.push(x3dom.Utils.primTypeDic(a,l._vf.primType[e]));else b._webgl.primType=x3dom.Utils.primTypeDic(a,l._mesh._primType);if(x3dom.isa(l,x3dom.nodeTypes.BinaryGeometry))x3dom.BinaryContainerLoader.setupBinGeo(b,n,a,d,this);else if(x3dom.isa(l,x3dom.nodeTypes.PopGeometry))x3dom.BinaryContainerLoader.setupPopGeo(b,
n,a,d,this);else if(x3dom.isa(l,x3dom.nodeTypes.BitLODGeometry))x3dom.BinaryContainerLoader.setupBitLODGeo(b,n,a,d,this);else if(x3dom.isa(l,x3dom.nodeTypes.ImageGeometry))x3dom.BinaryContainerLoader.setupImgGeo(b,n,a,d,this);else{for(e=0;e<b._webgl.positions.length;e++){f=5*e;void 0!==n.position&&(h=a.createBuffer(),b._webgl.buffers[f]=h,x3dom.caps.INDEX_UINT&&65535<b._webgl.positions[0].length/3?(k=new Uint32Array(b._webgl.indexes[e]),b._webgl.indexType=a.UNSIGNED_INT):(k=new Uint16Array(b._webgl.indexes[e]),
b._webgl.indexType=a.UNSIGNED_SHORT),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,h),a.bufferData(a.ELEMENT_ARRAY_BUFFER,k,a.STATIC_DRAW),k=null,k=a.createBuffer(),b._webgl.buffers[f+1]=k,a.bindBuffer(a.ARRAY_BUFFER,k),h=new Float32Array(b._webgl.positions[e]),a.bufferData(a.ARRAY_BUFFER,h,a.STATIC_DRAW),a.bindBuffer(a.ARRAY_BUFFER,k),a.vertexAttribPointer(n.position,l._mesh._numPosComponents,b._webgl.coordType,!1,b._coordStrideOffset[0],b._coordStrideOffset[1]),a.enableVertexAttribArray(n.position),h=null);
if(void 0!==n.normal||b._webgl.normals[e])h=a.createBuffer(),b._webgl.buffers[f+2]=h,k=new Float32Array(b._webgl.normals[e]),a.bindBuffer(a.ARRAY_BUFFER,h),a.bufferData(a.ARRAY_BUFFER,k,a.STATIC_DRAW),a.vertexAttribPointer(n.normal,l._mesh._numNormComponents,b._webgl.normalType,!1,b._normalStrideOffset[0],b._normalStrideOffset[1]),a.enableVertexAttribArray(n.normal),k=null;void 0!==n.texcoord&&(d=a.createBuffer(),b._webgl.buffers[f+3]=d,h=new Float32Array(b._webgl.texcoords[e]),a.bindBuffer(a.ARRAY_BUFFER,
d),a.bufferData(a.ARRAY_BUFFER,h,a.STATIC_DRAW),a.vertexAttribPointer(n.texcoord,l._mesh._numTexComponents,b._webgl.texCoordType,!1,b._texCoordStrideOffset[0],b._texCoordStrideOffset[1]),a.enableVertexAttribArray(n.texcoord),h=null);void 0!==n.color&&(h=a.createBuffer(),b._webgl.buffers[f+4]=h,k=new Float32Array(b._webgl.colors[e]),a.bindBuffer(a.ARRAY_BUFFER,h),a.bufferData(a.ARRAY_BUFFER,k,a.STATIC_DRAW),a.vertexAttribPointer(n.color,l._mesh._numColComponents,b._webgl.colorType,!1,b._colorStrideOffset[0],
b._colorStrideOffset[1]),a.enableVertexAttribArray(n.color),k=null)}for(var q in l._mesh._dynamicFields)l._mesh._dynamicFields.hasOwnProperty(q)&&(d=l._mesh._dynamicFields[q],b._webgl.dynamicFields[g]={buf:{},name:q,numComponents:d.numComponents},void 0!==n[q]&&(e=a.createBuffer(),b._webgl.dynamicFields[g++].buf=e,f=new Float32Array(d.value),a.bindBuffer(a.ARRAY_BUFFER,e),a.bufferData(a.ARRAY_BUFFER,f,a.STATIC_DRAW),a.vertexAttribPointer(n[q],d.numComponents,a.FLOAT,!1,0,0),f=null))}};a.prototype.setupScene=
function(a,b){var d=null,e=null,f=this;if(void 0!==b._webgl){if(!b._dirty)return;void 0!==b._webgl.texture&&b._webgl.texture&&a.deleteTexture(b._webgl.texture);b._cleanupGLObjects&&b._cleanupGLObjects();b._webgl={}}b._dirty=!1;e=b.getTexUrl();d=0;if(0<e.length&&0<e[0].length)6<=e.length&&0<e[1].length&&0<e[2].length&&0<e[3].length&&0<e[4].length&&0<e[5].length?(d=new x3dom.nodeTypes.Sphere,b._webgl={positions:d._mesh._positions[0],indexes:d._mesh._indices[0],buffers:[{},{}]},b._webgl.primType=a.TRIANGLES,
b._webgl.shader=this.cache.getShader(a,x3dom.shader.BACKGROUND_CUBETEXTURE),b._webgl.texture=x3dom.Utils.createTextureCube(a,b._nameSpace.doc,e,!0,b._vf.withCredentials,!0)):(b._webgl={positions:[-1,-1,0,-1,1,0,1,-1,0,1,1,0],indexes:[0,1,2,3],buffers:[{},{}]},e=b._nameSpace.getURL(e[0]),b._webgl.texture=x3dom.Utils.createTexture2D(a,b._nameSpace.doc,e,!0,b._vf.withCredentials,!0),b._webgl.primType=a.TRIANGLE_STRIP,b._webgl.shader=this.cache.getShader(a,x3dom.shader.BACKGROUND_TEXTURE));else if(1<
b.getSkyColor().length||b.getGroundColor().length){d=new x3dom.nodeTypes.Sphere;e=a.createTexture();b._webgl={positions:d._mesh._positions[0],texcoords:d._mesh._texCoords[0],indexes:d._mesh._indices[0],buffers:[{},{},{}],texture:e,primType:a.TRIANGLES};for(var g=x3dom.Utils.nextHighestPowerOfTwo(b.getSkyColor().length+b.getGroundColor().length+2),g=512>g?512:g,h=b._vf.groundAngle.length,k=[],l=[],n=[],q=[0],d=0;d<b._vf.skyColor.length;d++)n[d]=b._vf.skyColor[d];for(d=0;d<b._vf.skyAngle.length;d++)q[d+
1]=b._vf.skyAngle[d];if(0<h||1==b._vf.groundColor.length){q[q.length-1]<Math.PI/2&&(q[q.length]=Math.PI/2-x3dom.fields.Eps,n[n.length]=n[n.length-1]);for(d=h-1;0<=d;d--)d==h-1&&Math.PI-b._vf.groundAngle[d]<=Math.PI/2&&(q[q.length]=Math.PI/2,n[n.length]=b._vf.groundColor[b._vf.groundColor.length-1]),q[q.length]=Math.PI-b._vf.groundAngle[d],n[n.length]=b._vf.groundColor[d+1];0==h&&1==b._vf.groundColor.length&&(q[q.length]=Math.PI/2,n[n.length]=b._vf.groundColor[0]);q[q.length]=Math.PI;n[n.length]=b._vf.groundColor[0]}else q[q.length-
1]<Math.PI&&(q[q.length]=Math.PI,n[n.length]=n[n.length-1]);for(d=0;d<q.length;d++)q[d]/=Math.PI;x3dom.debug.assert(q.length==n.length);h=new x3dom.nodeTypes.ColorInterpolator;h._vf.key=new x3dom.fields.MFFloat(q);h._vf.keyValue=new x3dom.fields.MFColor(n);for(d=0;d<g;d++)h._vf.set_fraction=d/(g-1),h.fieldChanged("set_fraction"),k[d]=h._vf.value_changed;k.reverse();g=Math.floor(255*(1-b.getTransparency()));for(d=0;d<k.length;d++)l.push(Math.floor(255*k[d].r),Math.floor(255*k[d].g),Math.floor(255*
k[d].b),g);d=new Uint8Array(l);k=a.RGBA;g=d.length/4;a.bindTexture(a.TEXTURE_2D,e);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE);a.pixelStorei(a.UNPACK_ALIGNMENT,1);a.texImage2D(a.TEXTURE_2D,0,k,1,g,0,k,a.UNSIGNED_BYTE,d);a.bindTexture(a.TEXTURE_2D,null);b._webgl.shader=this.cache.getShader(a,x3dom.shader.BACKGROUND_SKYTEXTURE)}else b._webgl=
{};b._webgl.shader&&(e=b._webgl.shader,d=a.createBuffer(),b._webgl.buffers[1]=d,a.bindBuffer(a.ARRAY_BUFFER,d),g=new Float32Array(b._webgl.positions),a.bufferData(a.ARRAY_BUFFER,g,a.STATIC_DRAW),a.bindBuffer(a.ARRAY_BUFFER,d),a.vertexAttribPointer(e.position,3,a.FLOAT,!1,0,0),a.enableVertexAttribArray(e.position),d=a.createBuffer(),b._webgl.buffers[0]=d,g=new Uint16Array(b._webgl.indexes),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,d),a.bufferData(a.ELEMENT_ARRAY_BUFFER,g,a.STATIC_DRAW),g=g=null,void 0!==
e.texcoord&&(d=a.createBuffer(),b._webgl.buffers[2]=d,g=new Float32Array(b._webgl.texcoords),a.bindBuffer(a.ARRAY_BUFFER,d),a.bufferData(a.ARRAY_BUFFER,g,a.STATIC_DRAW),a.vertexAttribPointer(e.texcoord,2,a.FLOAT,!1,0,0),a.enableVertexAttribArray(e.texcoord),g=null),b._cleanupGLObjects=function(){var b=this._webgl.shader;void 0!==b.position&&(a.deleteBuffer(this._webgl.buffers[0]),a.deleteBuffer(this._webgl.buffers[1]));void 0!==b.texcoord&&a.deleteBuffer(this._webgl.buffers[2])});b._webgl.render=
function(a,c,d){var e=b._webgl.shader,g=1-b.getTransparency(),h=null,k=d._22,l=d._23,n=c.e3();void 0!==e&&null!==e&&void 0!==e.texcoord&&null!==e.texcoord&&void 0!==b._webgl.texture&&null!==b._webgl.texture?(a.clearColor(0,0,0,g),a.clearDepth(1),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT|a.STENCIL_BUFFER_BIT),f.stateManager.frontFace(a.CCW),f.stateManager.disable(a.CULL_FACE),f.stateManager.disable(a.DEPTH_TEST),f.stateManager.disable(a.BLEND),f.stateManager.useProgram(e),e.tex||(e.tex=0),d._22=
100001/99999,d._23=2E5/99999,c._03=0,c._13=0,c._23=0,h=d.mult(c),e.modelViewProjectionMatrix=h.toGL(),c._03=n.x,c._13=n.y,c._23=n.z,d._22=k,d._23=l,a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,b._webgl.texture),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,
b._webgl.buffers[0]),a.bindBuffer(a.ARRAY_BUFFER,b._webgl.buffers[1]),a.vertexAttribPointer(e.position,3,a.FLOAT,!1,0,0),a.enableVertexAttribArray(e.position),a.bindBuffer(a.ARRAY_BUFFER,b._webgl.buffers[2]),a.vertexAttribPointer(e.texcoord,2,a.FLOAT,!1,0,0),a.enableVertexAttribArray(e.texcoord),a.drawElements(b._webgl.primType,b._webgl.indexes.length,a.UNSIGNED_SHORT,0),a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,null),a.disableVertexAttribArray(e.position),a.disableVertexAttribArray(e.texcoord),
a.clear(a.DEPTH_BUFFER_BIT)):!e||!b._webgl.texture||void 0!==b._webgl.texture.textureCubeReady&&!0!==b._webgl.texture.textureCubeReady?(c=b.getSkyColor().toGL(),a.clearColor(c[0],c[1],c[2],g),a.clearDepth(1),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT|a.STENCIL_BUFFER_BIT)):(a.clearColor(0,0,0,g),a.clearDepth(1),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT|a.STENCIL_BUFFER_BIT),f.stateManager.frontFace(a.CCW),f.stateManager.disable(a.CULL_FACE),f.stateManager.disable(a.DEPTH_TEST),f.stateManager.disable(a.BLEND),
f.stateManager.useProgram(e),e.tex||(e.tex=0),b._webgl.texture.textureCubeReady?(d._22=100001/99999,d._23=2E5/99999,c._03=0,c._13=0,c._23=0,h=d.mult(c),e.modelViewProjectionMatrix=h.toGL(),c._03=n.x,c._13=n.y,c._23=n.z,d._22=k,d._23=l,a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_CUBE_MAP,b._webgl.texture),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_MIN_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),
a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE)):(a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,b._webgl.texture),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE)),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,b._webgl.buffers[0]),a.bindBuffer(a.ARRAY_BUFFER,b._webgl.buffers[1]),a.vertexAttribPointer(e.position,
3,a.FLOAT,!1,0,0),a.enableVertexAttribArray(e.position),a.drawElements(b._webgl.primType,b._webgl.indexes.length,a.UNSIGNED_SHORT,0),a.disableVertexAttribArray(e.position),a.activeTexture(a.TEXTURE0),b._webgl.texture.textureCubeReady?a.bindTexture(a.TEXTURE_CUBE_MAP,null):a.bindTexture(a.TEXTURE_2D,null),a.clear(a.DEPTH_BUFFER_BIT))}};a.prototype.setupFgnds=function(a,b){if(void 0===b._fgnd){var d=this;b._fgnd={};b._fgnd._webgl={positions:[-1,-1,0,-1,1,0,1,-1,0,1,1,0],indexes:[0,1,2,3],buffers:[{},
{}]};b._fgnd._webgl.primType=a.TRIANGLE_STRIP;b._fgnd._webgl.shader=this.cache.getShader(a,x3dom.shader.FRONTGROUND_TEXTURE);var e=b._fgnd._webgl.shader,f=a.createBuffer();b._fgnd._webgl.buffers[1]=f;a.bindBuffer(a.ARRAY_BUFFER,f);var g=new Float32Array(b._fgnd._webgl.positions);a.bufferData(a.ARRAY_BUFFER,g,a.STATIC_DRAW);a.bindBuffer(a.ARRAY_BUFFER,f);a.vertexAttribPointer(e.position,3,a.FLOAT,!1,0,0);f=a.createBuffer();b._fgnd._webgl.buffers[0]=f;g=new Uint16Array(b._fgnd._webgl.indexes);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,
f);a.bufferData(a.ELEMENT_ARRAY_BUFFER,g,a.STATIC_DRAW);g=g=null;b._fgnd._webgl.render=function(a,c){b._fgnd._webgl.texture=c;d.stateManager.frontFace(a.CCW);d.stateManager.disable(a.CULL_FACE);d.stateManager.disable(a.DEPTH_TEST);d.stateManager.useProgram(e);e.tex||(e.tex=0);a.activeTexture(a.TEXTURE0);a.bindTexture(a.TEXTURE_2D,b._fgnd._webgl.texture);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST);a.texParameteri(a.TEXTURE_2D,
a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,b._fgnd._webgl.buffers[0]);a.bindBuffer(a.ARRAY_BUFFER,b._fgnd._webgl.buffers[1]);a.vertexAttribPointer(e.position,3,a.FLOAT,!1,0,0);a.enableVertexAttribArray(e.position);a.drawElements(b._fgnd._webgl.primType,b._fgnd._webgl.indexes.length,a.UNSIGNED_SHORT,0);a.disableVertexAttribArray(e.position);a.activeTexture(a.TEXTURE0);a.bindTexture(a.TEXTURE_2D,null)}}};a.prototype.renderShadowPass=
function(a,b,d,e,f,g,h){var k=b._scene,l=k._webgl.shadowShader;this.stateManager.bindFramebuffer(a.FRAMEBUFFER,f.fbo);this.stateManager.viewport(0,0,f.width,f.height);this.stateManager.useProgram(l);l.cameraView=h;l.offset=g;l.PG_precisionLevel=1;l.PG_powPrecision=1;l.PG_maxBBSize=[0,0,0];l.PG_bbMin=[0,0,0];l.PG_bbMaxModF=[0,0,0];l.PG_bboxShiftVec=[0,0,0];a.clearColor(1,1,1,0);a.clearDepth(1);a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT);this.stateManager.depthFunc(a.LEQUAL);this.stateManager.enable(a.DEPTH_TEST);
this.stateManager.enable(a.CULL_FACE);this.stateManager.disable(a.BLEND);f=x3dom.fields.SFVec3f.NullVector.toGL();g=x3dom.fields.SFVec3f.OneVector.toGL();h=k.getEnvironment()._vf.shadowExcludeTransparentObjects;var n,q=k.drawableCollection.length;for(n=0;n<q;n++){var m=k.drawableCollection.get(n),p=m.transform,s=m.shape,t=s._webgl;if(t&&(!h||"transparent"!=m.sortType)){var w=s._cf.geometry.node,z=w._mesh;l.modelViewProjectionMatrix=d.mult(p).toGL();l.imageGeometry=t.imageGeometry;l.popGeometry=t.popGeometry;
t.coordType!=a.FLOAT?(t.popGeometry||!t.bitLODGeometry&&!x3dom.Utils.isUnsignedType(w._vf.coordType)?l.bgCenter=w._vf.position.toGL():l.bgCenter=w.getMin().toGL(),l.bgSize=w._vf.size.toGL(),l.bgPrecisionMax=w.getPrecisionMax("coordType")):(l.bgCenter=f,l.bgSize=g,l.bgPrecisionMax=1);t.colorType!=a.FLOAT&&(l.bgPrecisionColMax=w.getPrecisionMax("colorType"));t.texCoordType!=a.FLOAT&&(l.bgPrecisionTexMax=w.getPrecisionMax("texCoordType"));if(0!=t.imageGeometry&&!x3dom.caps.MOBILE){l.IG_bboxMin=w.getMin().toGL();
l.IG_bboxMax=w.getMax().toGL();l.IG_implicitMeshSize=w._vf.implicitMeshSize.toGL();var u=x3dom.Utils.findTextureByName(t.texture,"IG_coords0");u&&(l.IG_coordTextureWidth=u.texture.width,l.IG_coordTextureHeight=u.texture.height);if(1==t.imageGeometry){var v=x3dom.Utils.findTextureByName(t.texture,"IG_index");v&&(l.IG_indexTextureWidth=v.texture.width,l.IG_indexTextureHeight=v.texture.height);a.activeTexture(a.TEXTURE0);a.bindTexture(a.TEXTURE_2D,v.texture);a.activeTexture(a.TEXTURE1)}else a.activeTexture(a.TEXTURE0);
a.bindTexture(a.TEXTURE_2D,u.texture);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST);u=0;w.getIndexTexture()&&!l.IG_indexTexture&&(l.IG_indexTexture=u++);w.getCoordinateTexture(0)&&!l.IG_coordinateTexture&&(l.IG_coordinateTexture=u++)}s.isSolid()?(this.stateManager.enable(a.CULL_FACE),s.isCCW()?this.stateManager.frontFace(a.CCW):
this.stateManager.frontFace(a.CW)):this.stateManager.disable(a.CULL_FACE);t.popGeometry&&(p=e.mult(p),this.updatePopState(m,w,l,t,k,p,b,this.x3dElem.runtime.fps));m=0;for(p=t.positions.length;m<p;m++){var u=5*m,r;if(void 0!==l.position&&t.buffers[u+1]&&t.indexes[m]){t.buffers[u]&&a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,t.buffers[u]);a.bindBuffer(a.ARRAY_BUFFER,t.buffers[u+1]);a.vertexAttribPointer(l.position,z._numPosComponents,t.coordType,!1,s._coordStrideOffset[0],s._coordStrideOffset[1]);a.enableVertexAttribArray(l.position);
if(0<t.binaryGeometry||0<t.popGeometry||0<t.bitLODGeometry)for(r=u=0,v=w._vf.vertexCount.length;u<v;u++)a.drawElements(t.primType[u],w._vf.vertexCount[u],t.indexType,x3dom.Utils.getByteAwareOffset(r,t.indexType,a)),r+=w._vf.vertexCount[u];else if(0>t.binaryGeometry||0>t.popGeometry||0>t.bitLODGeometry||t.imageGeometry)if(void 0!==t.bitLODtotalVertexCount)a.drawArrays(a.TRIANGLES,0,t.bitLODtotalVertexCount);else for(r=u=0,v=w._vf.vertexCount.length;u<v;u++)a.drawArrays(t.primType[u],r,w._vf.vertexCount[u]),
r+=w._vf.vertexCount[u];else if(w.hasIndexOffset())for(r=s.tessellationProperties(),u=0,v=r.length;u<v;u++)a.drawElements(t.primType,r[u].count,t.indexType,r[u].offset*x3dom.Utils.getOffsetMultiplier(t.indexType,a));else 0==t.indexes[m].length?a.drawArrays(t.primType,0,t.positions[m].length/3):a.drawElements(t.primType,t.indexes[m].length,t.indexType,0);a.disableVertexAttribArray(l.position)}}0==t.imageGeometry||x3dom.caps.MOBILE||(a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,null),1==t.imageGeometry&&
(a.activeTexture(a.TEXTURE1),a.bindTexture(a.TEXTURE_2D,null)))}}a.flush();this.stateManager.bindFramebuffer(a.FRAMEBUFFER,null)};a.prototype.renderPickingPass=function(a,b,d,e,f,g,h,k,l,n,q){var m=b._webgl.pickScale,p=b._webgl.fboPick.height;k*=m;l=p-1-l*m;m=null;switch(h){case 0:m=b._webgl.pickShader;break;case 1:m=b._webgl.pickColorShader;break;case 2:m=b._webgl.pickTexCoordShader;break;case 3:m=b._webgl.pickShader24;break;case 4:m=b._webgl.pickShaderId}if(m){this.stateManager.bindFramebuffer(a.FRAMEBUFFER,
b._webgl.fboPick.fbo);this.stateManager.viewport(0,0,b._webgl.fboPick.width,p);a.clearColor(0,0,0,0);a.clearDepth(1);a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT);var p=b.drawableCollection.viewarea,s=b.getEnvironment(),t=b.drawableCollection.length;s._vf.smallFeatureCulling&&1>s._lowPriorityThreshold&&p.isMovingOrAnimating()&&(t=Math.floor(t*s._lowPriorityThreshold),!t&&b.drawableCollection.length&&(t=1));var s=x3dom.fields.SFVec3f.NullVector.toGL(),w=x3dom.fields.SFVec3f.OneVector.toGL();this.stateManager.depthFunc(a.LEQUAL);
this.stateManager.enable(a.DEPTH_TEST);this.stateManager.enable(a.CULL_FACE);this.stateManager.disable(a.BLEND);this.stateManager.useProgram(m);0==h&&(m.PG_precisionLevel=1,m.PG_powPrecision=1,m.PG_maxBBSize=[0,0,0],m.PG_bbMin=[0,0,0],m.PG_bbMaxModF=[0,0,0],m.PG_bboxShiftVec=[0,0,0]);this.stateManager.lineWidth(2);for(h=0;h<t;h++){var z=b.drawableCollection.get(h),u=z.transform,v=z.shape,r=v._webgl;if(r&&!(1>v._objectID)&&v._vf.isPickable){var A=v._cf.geometry.node,D=A._mesh;m.modelMatrix=u.toGL();
m.modelViewProjectionMatrix=e.mult(u).toGL();m.lowBit=(v._objectID&255)/255;m.highBit=(v._objectID>>>8)/255;m.from=f.toGL();m.sceneSize=g;m.imageGeometry=r.imageGeometry;m.popGeometry=r.popGeometry;m.writeShadowIDs=0!=r.binaryGeometry&&A._vf.idsPerVertex?x3dom.nodeTypes.Shape.objectID+2:0;r.coordType!=a.FLOAT?(r.popGeometry||!r.bitLODGeometry&&!x3dom.Utils.isUnsignedType(A._vf.coordType)?m.bgCenter=A._vf.position.toGL():m.bgCenter=A.getMin().toGL(),m.bgSize=A._vf.size.toGL(),m.bgPrecisionMax=A.getPrecisionMax("coordType")):
(m.bgCenter=s,m.bgSize=w,m.bgPrecisionMax=1);r.colorType!=a.FLOAT&&(m.bgPrecisionColMax=A.getPrecisionMax("colorType"));r.texCoordType!=a.FLOAT&&(m.bgPrecisionTexMax=A.getPrecisionMax("texCoordType"));if(0!=r.imageGeometry&&!x3dom.caps.MOBILE){m.IG_bboxMin=A.getMin().toGL();m.IG_bboxMax=A.getMax().toGL();m.IG_implicitMeshSize=A._vf.implicitMeshSize.toGL();var x=x3dom.Utils.findTextureByName(r.texture,"IG_coords0");x&&(m.IG_coordTextureWidth=x.texture.width,m.IG_coordTextureHeight=x.texture.height);
if(1==r.imageGeometry){var y=x3dom.Utils.findTextureByName(r.texture,"IG_index");y&&(m.IG_indexTextureWidth=y.texture.width,m.IG_indexTextureHeight=y.texture.height);a.activeTexture(a.TEXTURE0);a.bindTexture(a.TEXTURE_2D,y.texture);a.activeTexture(a.TEXTURE1)}else a.activeTexture(a.TEXTURE0);a.bindTexture(a.TEXTURE_2D,x.texture);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,
a.NEAREST);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST);x=0;A.getIndexTexture()&&!m.IG_indexTexture&&(m.IG_indexTexture=x++);A.getCoordinateTexture(0)&&!m.IG_coordinateTexture&&(m.IG_coordinateTexture=x++)}v.isSolid()?(this.stateManager.enable(a.CULL_FACE),v.isCCW()?this.stateManager.frontFace(a.CCW):this.stateManager.frontFace(a.CW)):this.stateManager.disable(a.CULL_FACE);r.popGeometry&&(u=d.mult(u),this.updatePopState(z,A,m,r,b,u,p,this.x3dElem.runtime.fps));z=0;for(u=r.positions.length;z<
u;z++){var x=5*z,B,C;if(void 0!==m.position&&r.buffers[x+1]&&r.indexes[z]){r.buffers[x]&&a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,r.buffers[x]);a.bindBuffer(a.ARRAY_BUFFER,r.buffers[x+1]);a.vertexAttribPointer(m.position,D._numPosComponents,r.coordType,!1,v._coordStrideOffset[0],v._coordStrideOffset[1]);a.enableVertexAttribArray(m.position);void 0!==m.texcoord&&r.buffers[x+3]&&(a.bindBuffer(a.ARRAY_BUFFER,r.buffers[x+3]),a.vertexAttribPointer(m.texcoord,D._numTexComponents,r.texCoordType,!1,v._texCoordStrideOffset[0],
v._texCoordStrideOffset[1]),a.enableVertexAttribArray(m.texcoord));void 0!==m.color&&r.buffers[x+4]&&(a.bindBuffer(a.ARRAY_BUFFER,r.buffers[x+4]),a.vertexAttribPointer(m.color,D._numColComponents,r.colorType,!1,v._colorStrideOffset[0],v._colorStrideOffset[1]),a.enableVertexAttribArray(m.color));if(0<r.binaryGeometry||0<r.popGeometry||0<r.bitLODGeometry)for(C=y=0,B=A._vf.vertexCount.length;y<B;y++)a.drawElements(r.primType[y],A._vf.vertexCount[y],r.indexType,x3dom.Utils.getByteAwareOffset(C,r.indexType,
a)),C+=A._vf.vertexCount[y];else if(0>r.binaryGeometry||0>r.popGeometry||0>r.bitLODGeometry||r.imageGeometry)if(void 0!==r.bitLODtotalVertexCount)a.drawArrays(a.TRIANGLES,0,r.bitLODtotalVertexCount);else for(C=y=0,B=A._vf.vertexCount.length;y<B;y++)a.drawArrays(r.primType[y],C,A._vf.vertexCount[y]),C+=A._vf.vertexCount[y];else if(A.hasIndexOffset())for(C=v.tessellationProperties(),y=0,B=C.length;y<B;y++)a.drawElements(r.primType,C[y].count,r.indexType,C[y].offset*x3dom.Utils.getOffsetMultiplier(r.indexType,
a));else 0==r.indexes[z].length?a.drawArrays(r.primType,0,r.positions[z].length/3):a.drawElements(r.primType,r.indexes[z].length,r.indexType,0);a.disableVertexAttribArray(m.position);void 0!==m.texcoord&&r.buffers[x+3]&&a.disableVertexAttribArray(m.texcoord);void 0!==m.color&&r.buffers[x+4]&&a.disableVertexAttribArray(m.color)}}0==r.imageGeometry||x3dom.caps.MOBILE||(a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,null),1==r.imageGeometry&&(a.activeTexture(a.TEXTURE1),a.bindTexture(a.TEXTURE_2D,
null)))}}this.stateManager.lineWidth(1);a.flush();try{var E=new Uint8Array(4*n*q);a.readPixels(k,l,n,q,a.RGBA,a.UNSIGNED_BYTE,E);b._webgl.fboPick.pixelData=E}catch(F){b._webgl.fboPick.pixelData=[],x3dom.debug.logException(F+" (cannot pick)")}this.stateManager.bindFramebuffer(a.FRAMEBUFFER,null)}};a.prototype.renderShape=function(a,b,d,e,f,g,h,k,l){var n=a.shape,q=a.transform;if(n&&n._webgl&&q){var m=n._webgl,p=m.shader;if(p){var s=this.stateManager.useProgram(p);h=n._cf.appearance.node;var t=n._cf.geometry.node,
w=t._mesh,z=b._scene,u=null;m.coordType!=l.FLOAT?(m.popGeometry||!m.bitLODGeometry&&!x3dom.Utils.isUnsignedType(t._vf.coordType)?p.bgCenter=t._vf.position.toGL():p.bgCenter=t.getMin().toGL(),p.bgSize=t._vf.size.toGL(),p.bgPrecisionMax=t.getPrecisionMax("coordType")):(p.bgCenter=[0,0,0],p.bgSize=[1,1,1],p.bgPrecisionMax=1);p.bgPrecisionColMax=m.colorType!=l.FLOAT?t.getPrecisionMax("colorType"):1;p.bgPrecisionTexMax=m.texCoordType!=l.FLOAT?t.getPrecisionMax("texCoordType"):1;p.bgPrecisionNorMax=m.normalType!=
l.FLOAT?t.getPrecisionMax("normalType"):1;if(0!=m.imageGeometry){p.IG_bboxMin=t.getMin().toGL();p.IG_bboxMax=t.getMax().toGL();p.IG_implicitMeshSize=t._vf.implicitMeshSize.toGL();if(u=x3dom.Utils.findTextureByName(m.texture,"IG_coords0"))p.IG_coordTextureWidth=u.texture.width,p.IG_coordTextureHeight=u.texture.height;1==m.imageGeometry&&(u=x3dom.Utils.findTextureByName(m.texture,"IG_index"))&&(p.IG_indexTextureWidth=u.texture.width,p.IG_indexTextureHeight=u.texture.height)}var v=z.getFog();v&&s&&(p.fogColor=
v._vf.color.toGL(),p.fogRange=v._vf.visibilityRange,p.fogType="LINEAR"==v._vf.fogType?0:1);u=h?h._cf.material.node:null;v=h?h._shader:null;m.csshader?(p.diffuseColor=v._vf.diffuseFactor.toGL(),p.specularColor=v._vf.specularFactor.toGL(),p.emissiveColor=v._vf.emissiveFactor.toGL(),p.shininess=v._vf.shininessFactor,p.ambientIntensity=(v._vf.ambientFactor.x+v._vf.ambientFactor.y+v._vf.ambientFactor.z)/3,p.transparency=1-v._vf.alphaFactor,v.getDisplacementMap()?(u=x3dom.Utils.findTextureByName(m.texture,
"displacementMap"),p.displacementWidth=u.texture.width,p.displacementHeight=u.texture.height,p.displacementFactor=v._vf.displacementFactor,p.displacementAxis="x"==v._vf.displacementAxis?0:"y"==v._vf.displacementAxis?1:2):v.getDiffuseDisplacementMap()&&(u=x3dom.Utils.findTextureByName(m.texture,"diffuseDisplacementMap"),p.displacementWidth=u.texture.width,p.displacementHeight=u.texture.height,p.displacementFactor=v._vf.displacementFactor,p.displacementAxis="x"==v._vf.displacementAxis?0:"y"==v._vf.displacementAxis?
1:2)):u?(p.diffuseColor=u._vf.diffuseColor.toGL(),p.specularColor=u._vf.specularColor.toGL(),p.emissiveColor=u._vf.emissiveColor.toGL(),p.shininess=u._vf.shininess,p.ambientIntensity=u._vf.ambientIntensity,p.transparency=u._vf.transparency):(p.diffuseColor=[1,1,1],p.specularColor=[0,0,0],p.emissiveColor=[0,0,0],p.shininess=0,p.ambientIntensity=1,p.transparency=0);if(v)if(x3dom.isa(v,x3dom.nodeTypes.ComposedShader))for(var r in v._vf)v._vf.hasOwnProperty(r)&&"language"!==r&&(u=v._vf[r])&&(p[r]=u.toGL?
u.toGL():u);else x3dom.isa(v,x3dom.nodeTypes.CommonSurfaceShader)&&(m.csshader=v);for(r=0;r<e&&s;r++)u=f.mult(d[r].getCurrentTransform()),x3dom.isa(d[r],x3dom.nodeTypes.DirectionalLight)?(p["light"+r+"_Type"]=0,p["light"+r+"_On"]=d[r]._vf.on?1:0,p["light"+r+"_Color"]=d[r]._vf.color.toGL(),p["light"+r+"_Intensity"]=d[r]._vf.intensity,p["light"+r+"_AmbientIntensity"]=d[r]._vf.ambientIntensity,p["light"+r+"_Direction"]=u.multMatrixVec(d[r]._vf.direction).toGL(),p["light"+r+"_Attenuation"]=[1,1,1],p["light"+
r+"_Location"]=[1,1,1],p["light"+r+"_Radius"]=0,p["light"+r+"_BeamWidth"]=0,p["light"+r+"_CutOffAngle"]=0,p["light"+r+"_ShadowIntensity"]=d[r]._vf.shadowIntensity):x3dom.isa(d[r],x3dom.nodeTypes.PointLight)?(p["light"+r+"_Type"]=1,p["light"+r+"_On"]=d[r]._vf.on?1:0,p["light"+r+"_Color"]=d[r]._vf.color.toGL(),p["light"+r+"_Intensity"]=d[r]._vf.intensity,p["light"+r+"_AmbientIntensity"]=d[r]._vf.ambientIntensity,p["light"+r+"_Direction"]=[1,1,1],p["light"+r+"_Attenuation"]=d[r]._vf.attenuation.toGL(),
p["light"+r+"_Location"]=u.multMatrixPnt(d[r]._vf.location).toGL(),p["light"+r+"_Radius"]=d[r]._vf.radius,p["light"+r+"_BeamWidth"]=0,p["light"+r+"_CutOffAngle"]=0,p["light"+r+"_ShadowIntensity"]=d[r]._vf.shadowIntensity):x3dom.isa(d[r],x3dom.nodeTypes.SpotLight)&&(p["light"+r+"_Type"]=2,p["light"+r+"_On"]=d[r]._vf.on?1:0,p["light"+r+"_Color"]=d[r]._vf.color.toGL(),p["light"+r+"_Intensity"]=d[r]._vf.intensity,p["light"+r+"_AmbientIntensity"]=d[r]._vf.ambientIntensity,p["light"+r+"_Direction"]=u.multMatrixVec(d[r]._vf.direction).toGL(),
p["light"+r+"_Attenuation"]=d[r]._vf.attenuation.toGL(),p["light"+r+"_Location"]=u.multMatrixPnt(d[r]._vf.location).toGL(),p["light"+r+"_Radius"]=d[r]._vf.radius,p["light"+r+"_BeamWidth"]=d[r]._vf.beamWidth,p["light"+r+"_CutOffAngle"]=d[r]._vf.cutOffAngle,p["light"+r+"_ShadowIntensity"]=d[r]._vf.shadowIntensity);z.getNavigationInfo()._vf.headlight&&s&&(e=e?e:0,p["light"+e+"_Type"]=0,p["light"+e+"_On"]=1,p["light"+e+"_Color"]=[1,1,1],p["light"+e+"_Intensity"]=1,p["light"+e+"_AmbientIntensity"]=0,p["light"+
e+"_Direction"]=[0,0,-1],p["light"+e+"_Attenuation"]=[1,1,1],p["light"+e+"_Location"]=[1,1,1],p["light"+e+"_Radius"]=0,p["light"+e+"_BeamWidth"]=0,p["light"+e+"_CutOffAngle"]=0,p["light"+e+"_ShadowIntensity"]=0);(d=h?h._cf.depthMode.node:null)?d._vf.enableDepthTest?(this.stateManager.enable(l.DEPTH_TEST),this.stateManager.depthMask(!d._vf.readOnly),this.stateManager.depthFunc(x3dom.Utils.depthFunc(l,d._vf.depthFunc)),this.stateManager.depthRange(d._vf.zNearRange,d._vf.zFarRange)):this.stateManager.disable(l.DEPTH_TEST):
(this.stateManager.enable(l.DEPTH_TEST),this.stateManager.depthMask(!0),this.stateManager.depthFunc(l.LEQUAL));(e=h?h._cf.blendMode.node:null)?(s=x3dom.Utils.blendFunc(l,e._vf.srcFactor),r=x3dom.Utils.blendFunc(l,e._vf.destFactor),s&&r?(this.stateManager.enable(l.BLEND),this.stateManager.blendFuncSeparate(s,r,l.ONE,l.ONE),this.stateManager.blendColor(e._vf.color.r,e._vf.color.g,e._vf.color.b,1-e._vf.colorTransparency),this.stateManager.blendEquation(x3dom.Utils.blendEquation(l,e._vf.equation))):this.stateManager.disable(l.BLEND)):
(this.stateManager.enable(l.BLEND),this.stateManager.blendFuncSeparate(l.SRC_ALPHA,l.ONE_MINUS_SRC_ALPHA,l.ONE,l.ONE));(s=h?h._cf.colorMaskMode.node:null)?this.stateManager.colorMask(s._vf.maskR,s._vf.maskG,s._vf.maskB,s._vf.maskA):this.stateManager.colorMask(!0,!0,!0,!0);(r=h?h._cf.lineProperties.node:null)?this.stateManager.lineWidth(r._vf.linewidthScaleFactor):this.stateManager.lineWidth(1);n.isSolid()?(this.stateManager.enable(l.CULL_FACE),n.isCCW()?this.stateManager.frontFace(l.CCW):this.stateManager.frontFace(l.CW)):
this.stateManager.disable(l.CULL_FACE);var u=f.mult(q),A=u.inverse();p.modelViewMatrix=u.toGL();p.viewMatrix=f.toGL();p.normalMatrix=A.transpose().toGL();p.modelViewMatrixInverse=A.toGL();p.projectionMatrix=k.toGL();p.modelViewProjectionMatrix=g.mult(q).toGL();m.popGeometry&&this.updatePopState(a,t,p,m,z,u,b,this.x3dElem.runtime.fps);a=0;for(f=m.texture.length;a<f;a++)u=m.texture[a],l.activeTexture(l.TEXTURE0+a),l.bindTexture(u.type,u.texture),l.texParameteri(u.type,l.TEXTURE_WRAP_S,u.wrapS),l.texParameteri(u.type,
l.TEXTURE_WRAP_T,u.wrapT),l.texParameteri(u.type,l.TEXTURE_MAG_FILTER,u.magFilter),l.texParameteri(u.type,l.TEXTURE_MIN_FILTER,u.minFilter),u.genMipMaps&&l.generateMipmap(u.type),v&&x3dom.isa(v,x3dom.nodeTypes.ComposedShader)||p[u.samplerName]||(p[u.samplerName]=a);h&&h._cf.textureTransform.node&&(a=h.texTransformMatrix(),p.texTrafoMatrix=a.toGL());g=null;a=m.dynamicFields.length;for(k=0;k<a;k++)g=m.dynamicFields[k],void 0!==p[g.name]&&(l.bindBuffer(l.ARRAY_BUFFER,g.buf),l.vertexAttribPointer(p[g.name],
g.numComponents,l.FLOAT,!1,0,0),l.enableVertexAttribArray(p[g.name]));g=0;for(f=m.positions.length;g<f;g++)if(k=5*g,void 0!==p.position&&m.buffers[k+1]&&m.indexes[g]){m.buffers[k]&&l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,m.buffers[k]);l.bindBuffer(l.ARRAY_BUFFER,m.buffers[k+1]);l.vertexAttribPointer(p.position,w._numPosComponents,m.coordType,!1,n._coordStrideOffset[0],n._coordStrideOffset[1]);l.enableVertexAttribArray(p.position);void 0!==p.normal&&m.buffers[k+2]&&(l.bindBuffer(l.ARRAY_BUFFER,m.buffers[k+
2]),l.vertexAttribPointer(p.normal,w._numNormComponents,m.normalType,!1,n._normalStrideOffset[0],n._normalStrideOffset[1]),l.enableVertexAttribArray(p.normal));void 0!==p.texcoord&&m.buffers[k+3]&&(l.bindBuffer(l.ARRAY_BUFFER,m.buffers[k+3]),l.vertexAttribPointer(p.texcoord,w._numTexComponents,m.texCoordType,!1,n._texCoordStrideOffset[0],n._texCoordStrideOffset[1]),l.enableVertexAttribArray(p.texcoord));void 0!==p.color&&m.buffers[k+4]&&(l.bindBuffer(l.ARRAY_BUFFER,m.buffers[k+4]),l.vertexAttribPointer(p.color,
w._numColComponents,m.colorType,!1,n._colorStrideOffset[0],n._colorStrideOffset[1]),l.enableVertexAttribArray(p.color));0!=m.popGeometry&&m.buffers[k+5]&&(l.bindBuffer(l.ARRAY_BUFFER,m.buffers[k+5]),l.vertexAttribPointer(p.PG_vertexID,1,l.FLOAT,!1,4,0),l.enableVertexAttribArray(p.PG_vertexID));k=b.getRenderMode();if(0<k)if(z=1==k?l.POINTS:l.LINES,0<m.binaryGeometry||0<m.popGeometry||0<m.bitLODGeometry)for(q=k=0,v=t._vf.vertexCount.length;k<v;k++)l.drawElements(z,t._vf.vertexCount[k],m.indexType,x3dom.Utils.getByteAwareOffset(q,
m.indexType,l)),q+=t._vf.vertexCount[k];else if(0>m.binaryGeometry||0>m.popGeometry||0>m.bitLODGeometry||m.imageGeometry)for(q=k=0,v=t._vf.vertexCount.length;k<v;k++)l.drawArrays(z,q,t._vf.vertexCount[k]),q+=t._vf.vertexCount[k];else 0==m.indexes[g].length?l.drawArrays(z,0,m.positions[g].length/3):l.drawElements(z,m.indexes[g].length,m.indexType,0);else if(0<m.binaryGeometry||0<m.popGeometry||0<m.bitLODGeometry)for(q=k=0,v=t._vf.vertexCount.length;k<v;k++)l.drawElements(m.primType[k],t._vf.vertexCount[k],
m.indexType,x3dom.Utils.getByteAwareOffset(q,m.indexType,l)),q+=t._vf.vertexCount[k];else if(0>m.binaryGeometry||0>m.popGeometry||0>m.bitLODGeometry||m.imageGeometry)if(void 0!==m.bitLODtotalVertexCount)l.drawArrays(l.TRIANGLES,0,m.bitLODtotalVertexCount);else for(q=k=0,v=t._vf.vertexCount.length;k<v;k++)l.drawArrays(m.primType[k],q,t._vf.vertexCount[k]),q+=t._vf.vertexCount[k];else if(t.hasIndexOffset())for(q=n.tessellationProperties(),k=0,v=q.length;k<v;k++)l.drawElements(m.primType,q[k].count,
m.indexType,q[k].offset*x3dom.Utils.getOffsetMultiplier(m.indexType,l));else 0==m.indexes[g].length?l.drawArrays(m.primType,0,m.positions[g].length/3):l.drawElements(m.primType,m.indexes[g].length,m.indexType,0);l.disableVertexAttribArray(p.position);void 0!==p.normal&&l.disableVertexAttribArray(p.normal);void 0!==p.texcoord&&l.disableVertexAttribArray(p.texcoord);void 0!==p.color&&l.disableVertexAttribArray(p.color);0!=m.popGeometry&&void 0!==p.PG_vertexID&&l.disableVertexAttribArray(p.PG_vertexID)}for(k=
0;k<a;k++)g=m.dynamicFields[k],void 0!==p[g.name]&&l.disableVertexAttribArray(p[g.name]);if(m.imageGeometry)for(v=t._vf.vertexCount.length,this.numDrawCalls+=v,k=0;k<v;k++)this.numFaces=m.primType[k]==l.TRIANGLE_STRIP?this.numFaces+(t._vf.vertexCount[k]-2):this.numFaces+t._vf.vertexCount[k]/3,this.numCoords+=t._vf.vertexCount[k];else this.numCoords+=w._numCoords,this.numFaces+=w._numFaces,m.binaryGeometry||m.popGeometry||m.bitLODGeometry?this.numDrawCalls+=t._vf.vertexCount.length:t.hasIndexOffset()?
this.numDrawCalls+=n.tessellationProperties().length:this.numDrawCalls+=f;d&&(this.stateManager.enable(l.DEPTH_TEST),this.stateManager.depthMask(!0),this.stateManager.depthFunc(l.LEQUAL),this.stateManager.depthRange(0,1));e&&(this.stateManager.enable(l.BLEND),this.stateManager.blendFuncSeparate(l.SRC_ALPHA,l.ONE_MINUS_SRC_ALPHA,l.ONE,l.ONE),this.stateManager.blendColor(1,1,1,1),this.stateManager.blendEquation(l.FUNC_ADD));s&&this.stateManager.colorMask(!0,!0,!0,!0);r&&this.stateManager.lineWidth(1);
f=(b=m.texture)?b.length:0;for(a=0;a<f;a++)b[a]&&h&&h._cf.texture.node&&(u=h._cf.texture.node.getTexture(a),l.activeTexture(l.TEXTURE0+a),x3dom.isa(u,x3dom.nodeTypes.X3DEnvironmentTextureNode)?l.bindTexture(l.TEXTURE_CUBE_MAP,null):l.bindTexture(l.TEXTURE_2D,null))}else x3dom.debug.logError("[Context|RenderShape] No Shader is set!")}else x3dom.debug.logError("[Context|RenderShape] No valid Shape!")};a.prototype.updatePopState=function(a,b,d,e,f,g,h,k){a=x3dom.nodeTypes.PopGeometry.ErrorToleranceFactor*
b._vf.precisionFactor;if(1>=k||h.isMovingOrAnimating())a*=x3dom.nodeTypes.PopGeometry.PrecisionFactorOnMove;k=16;if(0<a){f=f.getViewpoint();k=f.getImgPlaneHeightAtDistOne();f=f.getNear();var l=g.multMatrixPnt(b._vf.position),n=0.5*g.multMatrixVec(b._vf.size).length();g=0.5*g.multMatrixVec(b._vf.maxBBSize).length();h=Math.max(-l.z-n,f)*(k/h._height);k=Math.ceil(Math.log(2*g/(a*h))/0.693147180559945);k=1>k?1:16<k?16:k}h=b._vf.minPrecisionLevel;g=b._vf.maxPrecisionLevel;k=-1!=h&&k<h?h:k;k=-1!=g&&k>g?
g:k;k=h=e.levelsAvailable<k?e.levelsAvailable:k;1>=a&&(k=k==b.getNumLevels()?16:k);a=b._vf.indexedRendering;g=b._mesh;g._numCoords=0;for(f=g._numFaces=0;f<h;++f)l=e.numVerticesAtLevel[f],g._numCoords+=l,g._numFaces+=(a?b.getNumIndicesByLevel(f):l)/3;x3dom.nodeTypes.PopGeometry.numRenderedVerts+=g._numCoords;x3dom.nodeTypes.PopGeometry.numRenderedTris+=g._numFaces;g.currentLOD=k;b.adaptVertexCount(a?3*g._numFaces:g._numCoords);d.PG_maxBBSize=b._vf.maxBBSize.toGL();d.PG_bbMin=b._bbMinBySize;d.PG_numAnchorVertices=
b._vf.numAnchorVertices;d.PG_bbMaxModF=b._vf.bbMaxModF.toGL();d.PG_bboxShiftVec=b._vf.bbShiftVec.toGL();d.PG_precisionLevel=k;d.PG_powPrecision=x3dom.nodeTypes.PopGeometry.powLUT[k-1]};a.prototype.pickValue=function(a,b,d,e,f,g){var h=this.ctx3d,k=a._scene;if(!(h&&k&&k._webgl&&k.drawableCollection))return!1;var l=0;switch(k._vf.pickMode.toLowerCase()){case "box":return!1;case "idbuf":l=0;break;case "idbuf24":l=3;break;case "idbufid":l=4;break;case "color":l=1;break;case "texcoord":l=2}x3dom.Utils.startMeasure("picking");
var n,q;4<arguments.length?(n=f,q=g):(n=a._last_mat_view,q=a._last_mat_scene);var m=x3dom.fields.SFVec3f.copy(k._lastMin),p=x3dom.fields.SFVec3f.copy(k._lastMax),s=n.inverse().e3(),t=x3dom.fields.SFVec3f.copy(s),w=x3dom.fields.SFVec3f.copy(s);t.x>m.x&&(t.x=m.x);t.y>m.y&&(t.y=m.y);t.z>m.z&&(t.z=m.z);w.x<p.x&&(w.x=p.x);w.y<p.y&&(w.y=p.y);w.z<p.z&&(w.z=p.z);k._lastMin.setValues(t);k._lastMax.setValues(w);t=k._lastMax.subtract(k._lastMin).length();w=a.getCCtoWCMatrix();k._lastMin.setValues(m);k._lastMax.setValues(p);
m=x3dom.nodeTypes.Shape.objectID+2;this.renderPickingPass(h,k,n,q,s,t,l,b,d,2,2);if((s=k._webgl.fboPick.pixelData)&&s.length){h=new x3dom.fields.SFVec3f(0,0,0);q=new x3dom.fields.SFVec3f(0,0,1);var z=0;n=s[z+3];var u,p=1/k._webgl.pickScale,v=1/256,r,A;0==l?(n+=256*s[z+2],z=s[z]/255*v+s[z+1]/255,r=a.calcViewRay(b,d,w),h=r.pos.add(r.dir.multiply(z*t)),z=4,z=s[z]/255*v+s[z+1]/255,A=a.calcViewRay(b+p,d,w),q=A.pos.add(A.dir.multiply(z*t)),q=q.subtract(h).normalize(),z=8,z=s[z]/255*v+s[z+1]/255,A=a.calcViewRay(b,
d-p,w),t=A.pos.add(A.dir.multiply(z*t)),t=t.subtract(h).normalize(),q=q.cross(t).normalize()):3==l?(n+=256*s[z+2]+65536*s[z+1],z=s[z]/255,r=a.calcViewRay(b,d,w),h=r.pos.add(r.dir.multiply(z*t)),z=s[4]/255,A=a.calcViewRay(b+p,d,w),q=A.pos.add(A.dir.multiply(z*t)),q=q.subtract(h).normalize(),z=s[8]/255,A=a.calcViewRay(b,d-p,w),t=A.pos.add(A.dir.multiply(z*t)),t=t.subtract(h).normalize(),q=q.cross(t).normalize()):4==l?(n+=256*s[z+2],u=s[z+1],u+=256*s[z],0==n&&0<u&&u<m&&(n=u)):(h.x=s[z],h.y=s[z+1],h.z=
s[z+2]);t=Math.max(e>>>8,e&255);if(n>=m){if(n-=m,4!=l?(a._pickingInfo.pickPos=h,a._pick.setValues(h),a._pickingInfo.pickNorm=q,a._pickNorm.setValues(q),a._pickingInfo.pickObj=null,a._pickingInfo.lastClickObj=null,u=k._xmlNode):(a._pickingInfo.pickObj=x3dom.nodeTypes.Shape.idMap.nodeID[u],u=a._pickingInfo.pickObj._xmlNode),l=a._pickingInfo.shadowObjectId!=n,a._pickingInfo.shadowObjectId=n,(l||t)&&k._xmlNode&&(k._xmlNode.onshadowObjectIdChanged||k._xmlNode.hasAttribute("onshadowObjectIdChanged")||k._listeners.shadowObjectIdChanged)&&
(l={target:k._xmlNode,type:"shadowObjectIdChanged",button:t,mouseup:0<e>>>8,layerX:b,layerY:d,shadowObjectId:n,worldX:h.x,worldY:h.y,worldZ:h.z,normalX:q.x,normalY:q.y,normalZ:q.z,hitPnt:h.toGL(),hitObject:u,cancelBubble:!1,stopPropagation:function(){this.cancelBubble=!0},preventDefault:function(){this.cancelBubble=!0}},k.callEvtHandler("onshadowObjectIdChanged",l)),k._shadowIdMap&&k._shadowIdMap.mapping)for(l=k._shadowIdMap.mapping[n].usage,u=0;u<l.length;u++)if(t=k._nameSpace.defMap[l[u]],t.doIntersect(r)){a._pickingInfo.pickObj=
t;break}}else l=-1!=a._pickingInfo.shadowObjectId,a._pickingInfo.shadowObjectId=-1,l&&k._xmlNode&&(k._xmlNode.onshadowObjectIdChanged||k._xmlNode.hasAttribute("onshadowObjectIdChanged")||k._listeners.shadowObjectIdChanged)&&(l={target:k._xmlNode,type:"shadowObjectIdChanged",button:t,mouseup:0<e>>>8,layerX:b,layerY:d,shadowObjectId:a._pickingInfo.shadowObjectId,cancelBubble:!1,stopPropagation:function(){this.cancelBubble=!0},preventDefault:function(){this.cancelBubble=!0}},k.callEvtHandler("onshadowObjectIdChanged",
l)),0<n?(a._pickingInfo.pickPos=h,a._pickingInfo.pickNorm=q,a._pickingInfo.pickObj=x3dom.nodeTypes.Shape.idMap.nodeID[n]):(a._pickingInfo.pickObj=null,a._pickingInfo.lastClickObj=null)}k=x3dom.Utils.stopMeasure("picking");this.x3dElem.runtime.addMeasurement("PICKING",k);return!0};a.prototype.pickRect=function(a,b,d,e,f){var g=this.ctx3d,h=a?a._scene:null;if(!(g&&h&&h._webgl&&h.drawableCollection))return!1;var k=a._last_mat_view.inverse().e3(),l=h._lastMax.subtract(h._lastMin).length(),n=b<=e?b:e,
q=d>=f?d:f;b=(1+Math.abs(e-b))*h._webgl.pickScale;d=(1+Math.abs(f-d))*h._webgl.pickScale;this.renderPickingPass(g,h,a._last_mat_view,a._last_mat_scene,k,l,0,n,q,1>b?1:b,1>d?1:d);g=[];for(a=0;h._webgl.fboPick.pixelData&&a<h._webgl.fboPick.pixelData.length;a+=4)k=h._webgl.fboPick.pixelData[a+3]+256*h._webgl.fboPick.pixelData[a+2],0<k&&g.push(k);g.sort();h=g;a=[];g=h.length;for(k=0;k<g;k++){for(l=k+1;l<g;l++)h[k]===h[l]&&(l=++k);a.push(h[k])}g=a;h=[];for(a=0;a<g.length;a++)k=g[a],(k=(k=x3dom.nodeTypes.Shape.idMap.nodeID[k])&&
k._xmlNode?k._xmlNode:null)&&h.push(k);return h};a.prototype.renderScene=function(a){var b=this.ctx3d,d=a._scene;if(null!==b&&null!==d){var e=a._doc._nodeBag.renderTextures,f,g,h=e.length,k=b.UNSIGNED_BYTE,l=b.UNSIGNED_BYTE,n=!1;x3dom.caps.FP_TEXTURES&&!x3dom.caps.MOBILE&&(l=k=b.FLOAT,x3dom.caps.FPL_TEXTURES||(n=!0));var q,m,p,s;d.updateVolume();if(d._webgl){q=Math.round(this.canvas.width*d._webgl.pickScale);g=Math.round(this.canvas.height*d._webgl.pickScale);if(d._webgl._currFboWidth!==q||d._webgl._currFboHeight!==
g)d._webgl._currFboWidth=q,d._webgl._currFboHeight=g,d._webgl.fboPick=this.initFbo(b,q,g,!0,d._webgl.fboPick.typ),d._webgl.fboPick.pixelData=null,x3dom.debug.logInfo("Refreshed picking FBO to size ("+q+", "+g+")");for(g=0;g<h;g++)f=e[g],f._webgl&&f._webgl.fbo&&f._webgl.fbo.width==f._vf.dimensions[0]&&f._webgl.fbo.height==f._vf.dimensions[1]||(f.invalidateGLObject(),f._webgl={},f._webgl.fbo=this.initFbo(b,f._vf.dimensions[0],f._vf.dimensions[1],n,k),x3dom.debug.logInfo("Init/resize RenderedTexture_"+
g+" to size "+f._vf.dimensions[0]+" x "+f._vf.dimensions[1]));q=a.getShadowedLights();p=q.length;for(g=0;g<p;g++)if(s=q[g]._vf.shadowMapSize,m=x3dom.isa(q[g],x3dom.nodeTypes.PointLight)?6:Math.max(1,Math.min(q[g]._vf.shadowCascades,6)),"undefined"===typeof d._webgl.fboShadow[g]||d._webgl.fboShadow[g].length!=m||d._webgl.fboShadow[g][0].height!=s)for(d._webgl.fboShadow[g]=[],f=0;f<m;f++)d._webgl.fboShadow[g][f]=this.initFbo(b,s,s,n,l);for(g=0;g<p;g++){s=d._webgl.fboShadow[g][0].height;m=!1;for(f=0;f<
d._webgl.fboBlur.length;f++)s==d._webgl.fboBlur[f].height&&(m=!0);m||(d._webgl.fboBlur[d._webgl.fboBlur.length]=this.initFbo(b,s,s,n,l))}if(0<d._webgl.fboShadow.length&&"undefined"==typeof d._webgl.fboScene||d._webgl.fboScene&&(this.canvas.width!=d._webgl.fboScene.width||this.canvas.height!=d._webgl.fboScene.height))d._webgl.fboScene=this.initFbo(b,this.canvas.width,this.canvas.height,n,l)}else{d._webgl={};this.setupFgnds(b,d);d._webgl.pickScale=0.5;d._webgl._currFboWidth=Math.round(this.canvas.width*
d._webgl.pickScale);d._webgl._currFboHeight=Math.round(this.canvas.height*d._webgl.pickScale);d._webgl.fboPick=this.initFbo(b,d._webgl._currFboWidth,d._webgl._currFboHeight,!0,b.UNSIGNED_BYTE);d._webgl.fboPick.pixelData=null;d._webgl.pickShader=this.cache.getShader(b,x3dom.shader.PICKING);d._webgl.pickShader24=this.cache.getShader(b,x3dom.shader.PICKING_24);d._webgl.pickShaderId=this.cache.getShader(b,x3dom.shader.PICKING_ID);d._webgl.pickColorShader=this.cache.getShader(b,x3dom.shader.PICKING_COLOR);
d._webgl.pickTexCoordShader=this.cache.getShader(b,x3dom.shader.PICKING_TEXCOORD);d._webgl.normalShader=this.cache.getShader(b,x3dom.shader.NORMAL);d._webgl.fboShadow=[];q=a.getShadowedLights();p=q.length;for(g=0;g<p;g++)for(s=q[g]._vf.shadowMapSize,m=x3dom.isa(q[g],x3dom.nodeTypes.PointLight)?6:Math.max(1,Math.min(q[g]._vf.shadowCascades,6)),d._webgl.fboShadow[g]=[],f=0;f<m;f++)d._webgl.fboShadow[g][f]=this.initFbo(b,s,s,n,l);0<d._webgl.fboShadow.length&&(d._webgl.fboScene=this.initFbo(b,this.canvas.width,
this.canvas.height,n,l));d._webgl.fboBlur=[];for(g=0;g<p;g++){s=d._webgl.fboShadow[g][0].height;m=!1;for(f=0;f<d._webgl.fboBlur.length;f++)s==d._webgl.fboBlur[f].height&&(m=!0);m||(d._webgl.fboBlur[d._webgl.fboBlur.length]=this.initFbo(b,s,s,n,l))}d._webgl.ppBuffer=b.createBuffer();b.bindBuffer(b.ARRAY_BUFFER,d._webgl.ppBuffer);b.bufferData(b.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),b.STATIC_DRAW);d._webgl.shadowShader=this.cache.getShader(b,x3dom.shader.SHADOW);for(g=0;g<h;g++)f=
e[g],f._webgl={},f._webgl.fbo=this.initFbo(b,f._vf.dimensions[0],f._vf.dimensions[1],n,k);a._last_mat_view=x3dom.fields.SFMatrix4f.identity();a._last_mat_proj=x3dom.fields.SFMatrix4f.identity();a._last_mat_scene=x3dom.fields.SFMatrix4f.identity();this._calledViewpointChangedHandler=!1}n=d.getEnvironment();n.checkSanity();p=d.getBackground();this.setupScene(b,p);this.numDrawCalls=this.numCoords=this.numFaces=0;k=a.getProjectionMatrix();l=a.getViewMatrix();if(!this._calledViewpointChangedHandler||!a._last_mat_view.equals(l)){g=
d.getViewpoint();try{if(g._xmlNode&&(g._xmlNode.onviewpointChanged||g._xmlNode.hasAttribute("onviewpointChanged")||g._listeners.viewpointChanged)){var t=g.getCurrentTransform(),t=t.inverse().mult(l),w=t.inverse(),z=new x3dom.fields.Quaternion(0,0,1,0);z.setValue(w);var u=w.e3(),v={target:g._xmlNode,type:"viewpointChanged",matrix:t,position:u,orientation:z.toAxisAngle(),cancelBubble:!1,stopPropagation:function(){this.cancelBubble=!0},preventDefault:function(){this.cancelBubble=!0}};g.callEvtHandler("onviewpointChanged",
v);this._calledViewpointChangedHandler=!0}}catch(r){x3dom.debug.logException(r)}}a._last_mat_view=l;a._last_mat_proj=k;w=k.mult(l);a._last_mat_scene=w;d.drawableCollection=null;d.drawableCollection||(d.drawableCollection=new x3dom.DrawableCollection({viewArea:a,sortTrans:n._vf.sortTrans,viewMatrix:l,projMatrix:k,sceneMatrix:w,frustumCulling:!0,smallFeatureThreshold:n._smallFeatureThreshold,context:this,gl:b}),x3dom.Utils.startMeasure("traverse"),d.collectDrawableObjects(x3dom.fields.SFMatrix4f.identity(),
d.drawableCollection,!0,!1,0),g=x3dom.Utils.stopMeasure("traverse"),this.x3dElem.runtime.addMeasurement("TRAVERSE",g));x3dom.Utils.startMeasure("sorting");d.drawableCollection.sort();g=x3dom.Utils.stopMeasure("sorting");this.x3dElem.runtime.addMeasurement("SORT",g);z=a.getLights();u=z.length;v=[];f=[];t=0;x3dom.Utils.startMeasure("shadow");for(var A=0;A<u;A++)if(0<z[A]._vf.shadowIntensity){var D=a.getLightMatrix()[A];s=d._webgl.fboShadow[t];var x=Math.max(0,Math.min(1,z[A]._vf.shadowOffset));if(x3dom.isa(z[A],
x3dom.nodeTypes.PointLight))for(m=a.getWCtoLCMatricesPointLight(D,z[A],k),g=0;6>g;g++)this.renderShadowPass(b,a,m[g],l,s[g],x,!1);else{var y=Math.max(1,Math.min(z[A]._vf.shadowCascades,6));m=a.getWCtoLCMatricesCascaded(D,z[A],k);for(g=0;g<y;g++)this.renderShadowPass(b,a,m[g],l,s[g],x,!1)}t++;v[v.length]=m;f[f.length]=D}0<t?(this.renderShadowPass(b,a,w,l,d._webgl.fboScene,0,!0),g=x3dom.Utils.stopMeasure("shadow"),this.x3dElem.runtime.addMeasurement("SHADOW",g)):this.x3dElem.runtime.removeMeasurement("SHADOW");
m=a.getWCtoLCMatrix(a.getLightMatrix()[0]);for(g=0;g<h;g++)this.renderRTPass(b,a,e[g]);x3dom.Utils.startMeasure("render");this.stateManager.viewport(0,0,this.canvas.width,this.canvas.height);p._webgl.render(b,l,k);x3dom.nodeTypes.PopGeometry.numRenderedVerts=0;x3dom.nodeTypes.PopGeometry.numRenderedTris=0;p=d.drawableCollection.length;n._vf.smallFeatureCulling&&1>n._lowPriorityThreshold&&a.isMovingOrAnimating()&&(p=Math.floor(p*n._lowPriorityThreshold),!p&&d.drawableCollection.length&&(p=1));this.stateManager.unsetProgram();
for(g=0;g<p;g++)n=d.drawableCollection.get(g),this.renderShape(n,a,z,u,l,w,m,k,b);0<t&&this.renderShadows(b,a,q,v,f,l,k,w);this.stateManager.disable(b.BLEND);this.stateManager.disable(b.DEPTH_TEST);a._numRenderedNodes=p;if(void 0!==a._visDbgBuf&&a._visDbgBuf){q=d._vf.pickMode.toLowerCase();if(0==q.indexOf("idbuf")||"color"==q||"texcoord"==q)this.stateManager.viewport(0,3*this.canvas.height/4,this.canvas.width/4,this.canvas.height/4),d._fgnd._webgl.render(b,d._webgl.fboPick.tex);0<t&&(this.stateManager.viewport(this.canvas.width/
4,3*this.canvas.height/4,this.canvas.width/4,this.canvas.height/4),d._fgnd._webgl.render(b,d._webgl.fboScene.tex));q=3;k=2;for(g=0;g<t;g++)for(s=d._webgl.fboShadow[g],f=0;f<s.length;f++)this.stateManager.viewport(k*this.canvas.width/4,q*this.canvas.height/4,this.canvas.width/4,this.canvas.height/4),d._fgnd._webgl.render(b,s[f].tex),2>k?k++:(k=0,q--);for(g=0;g<h;g++)f=e[g],this.stateManager.viewport(g*this.canvas.width/8,5*this.canvas.height/8,this.canvas.width/8,this.canvas.height/8),d._fgnd._webgl.render(b,
f._webgl.fbo.tex)}b.finish();b=x3dom.Utils.stopMeasure("render");this.x3dElem.runtime.addMeasurement("RENDER",b);this.x3dElem.runtime.addMeasurement("DRAW",p?b/p:0);this.x3dElem.runtime.addInfo("#NODES:",d.drawableCollection.numberOfNodes);this.x3dElem.runtime.addInfo("#SHAPES:",a._numRenderedNodes);this.x3dElem.runtime.addInfo("#DRAWS:",this.numDrawCalls);this.x3dElem.runtime.addInfo("#POINTS:",this.numCoords);this.x3dElem.runtime.addInfo("#TRIS:",this.numFaces)}};a.prototype.renderRTPass=function(a,
b,d){switch(d._vf.update.toUpperCase()){case "NONE":return;case "NEXT_FRAME_ONLY":if(!d._needRenderUpdate)return;d._needRenderUpdate=!1}var e=b._scene,f=null,g=d.getViewMatrix(),h=d.getProjectionMatrix(),k=h.mult(g),l=b.getLightMatrix()[0],l=b.getWCtoLCMatrix(l),n,q,m=d._cf.excludeNodes.nodes.length,p=Array(m);for(n=0;n<m;n++)f=d._cf.excludeNodes.nodes[n]._vf.render,p[n]=void 0===f?-1:!0===f?1:0,d._cf.excludeNodes.nodes[n]._vf.render=!1;this.stateManager.bindFramebuffer(a.FRAMEBUFFER,d._webgl.fbo.fbo);
this.stateManager.viewport(0,0,d._webgl.fbo.width,d._webgl.fbo.height);null===d._cf.background.node?(a.clearColor(0,0,0,1),a.clearDepth(1),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT|a.STENCIL_BUFFER_BIT)):(d._cf.background.node===e.getBackground()?f=e.getBackground():(f=d._cf.background.node,this.setupScene(a,f)),f._webgl.render(a,g,h));this.stateManager.depthFunc(a.LEQUAL);this.stateManager.enable(a.DEPTH_TEST);this.stateManager.enable(a.CULL_FACE);this.stateManager.blendFuncSeparate(a.SRC_ALPHA,
a.ONE_MINUS_SRC_ALPHA,a.ONE,a.ONE);this.stateManager.enable(a.BLEND);var f=b.getLights(),s=f.length,t,w=d._cf.scene.node;if(w&&w!==e)if(n=e.getEnvironment(),n={viewArea:b,sortTrans:n._vf.sortTrans,viewMatrix:g,projMatrix:h,sceneMatrix:k,frustumCulling:!1,smallFeatureThreshold:1,context:this,gl:a},w.numberOfNodes=0,w.drawableCollection=new x3dom.DrawableCollection(n),w.collectDrawableObjects(x3dom.fields.SFMatrix4f.identity(),w.drawableCollection,!0,!1,0),w.drawableCollection.sort(),q=w.drawableCollection.length,
d._vf.showNormals)this.renderNormals(a,w,e._webgl.normalShader,g,k);else for(this.stateManager.unsetProgram(),n=0;n<q;n++)t=w.drawableCollection.get(n),t.shape._vf.render&&this.renderShape(t,b,f,s,g,k,l,h,a);else if(q=e.drawableCollection.length,d._vf.showNormals)this.renderNormals(a,e,e._webgl.normalShader,g,k);else for(this.stateManager.unsetProgram(),n=0;n<q;n++)t=e.drawableCollection.get(n),this.renderShape(t,b,f,s,g,k,l,h,a);this.stateManager.disable(a.BLEND);this.stateManager.disable(a.DEPTH_TEST);
a.flush();this.stateManager.bindFramebuffer(a.FRAMEBUFFER,null);for(n=0;n<m;n++)0!==p[n]&&(d._cf.excludeNodes.nodes[n]._vf.render=!0)};a.prototype.renderNormals=function(a,b,d,e,f){if(d&&b){this.stateManager.depthFunc(a.LEQUAL);this.stateManager.enable(a.DEPTH_TEST);this.stateManager.enable(a.CULL_FACE);this.stateManager.disable(a.BLEND);this.stateManager.useProgram(d);for(var g=x3dom.fields.SFVec3f.NullVector.toGL(),h=x3dom.fields.SFVec3f.OneVector.toGL(),k=0,l=b.drawableCollection.length;k<l;k++){var n=
b.drawableCollection.get(k),q=n.transform,n=n.shape,m=n._webgl;if(m&&n&&n._vf.render){var p=n._cf.geometry.node,s=p._mesh,t=e.mult(q).inverse();d.normalMatrix=t.transpose().toGL();d.modelViewProjectionMatrix=f.mult(q).toGL();d.imageGeometry=m.imageGeometry;m.coordType!=a.FLOAT?(0!=m.bitLODGeometry||0!=m.popGeometry||4==s._numPosComponents&&x3dom.Utils.isUnsignedType(p._vf.coordType)?d.bgCenter=p.getMin().toGL():d.bgCenter=p._vf.position.toGL(),d.bgSize=p._vf.size.toGL(),d.bgPrecisionMax=p.getPrecisionMax("coordType")):
(d.bgCenter=g,d.bgSize=h,d.bgPrecisionMax=1);d.bgPrecisionNorMax=m.normalType!=a.FLOAT?p.getPrecisionMax("normalType"):1;n.isSolid()?(this.stateManager.enable(a.CULL_FACE),n.isCCW()?this.stateManager.frontFace(a.CCW):this.stateManager.frontFace(a.CW)):this.stateManager.disable(a.CULL_FACE);q=0;for(t=m.positions.length;q<t;q++){var w=5*q,z,u;if(void 0!==d.position&&m.buffers[w+1]&&m.indexes[q]){m.buffers[w]&&a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,m.buffers[w]);a.bindBuffer(a.ARRAY_BUFFER,m.buffers[w+
1]);a.vertexAttribPointer(d.position,s._numPosComponents,m.coordType,!1,n._coordStrideOffset[0],n._coordStrideOffset[1]);a.enableVertexAttribArray(d.position);void 0!==d.normal&&m.buffers[w+2]&&(a.bindBuffer(a.ARRAY_BUFFER,m.buffers[w+2]),a.vertexAttribPointer(d.normal,s._numNormComponents,m.normalType,!1,n._normalStrideOffset[0],n._normalStrideOffset[1]),a.enableVertexAttribArray(d.normal));if(0<m.binaryGeometry||0<m.popGeometry||0<m.bitLODGeometry)for(u=w=0,z=p._vf.vertexCount.length;w<z;w++)a.drawElements(m.primType[w],
p._vf.vertexCount[w],m.indexType,x3dom.Utils.getByteAwareOffset(u,m.indexType,a)),u+=p._vf.vertexCount[w];else if(0>m.binaryGeometry||0>m.popGeometry||0>m.bitLODGeometry||m.imageGeometry)if(void 0!==m.bitLODtotalVertexCount)a.drawArrays(a.TRIANGLES,0,m.bitLODtotalVertexCount);else for(u=w=0,z=p._vf.vertexCount.length;w<z;w++)a.drawArrays(m.primType[w],u,p._vf.vertexCount[w]),u+=p._vf.vertexCount[w];else if(p.hasIndexOffset())for(u=n.tessellationProperties(),w=0,z=u.length;w<z;w++)a.drawElements(m.primType,
u[w].count,m.indexType,u[w].offset*x3dom.Utils.getOffsetMultiplier(m.indexType,a));else 0==m.indexes[q].length?a.drawArrays(m.primType,0,m.positions[q].length/3):a.drawElements(m.primType,m.indexes[q].length,m.indexType,0);a.disableVertexAttribArray(d.position);void 0!==d.normal&&a.disableVertexAttribArray(d.normal)}}}}}};a.prototype.shutdown=function(a){var b=this.ctx3d;a=a._scene;if(null!=b&&a){var d=a.getBackground();void 0!==d._webgl.position&&(b.deleteBuffer(d._webgl.buffers[1]),b.deleteBuffer(d._webgl.buffers[0]));
d=a._fgnd;void 0!==d._webgl.position&&(b.deleteBuffer(d._webgl.buffers[1]),b.deleteBuffer(d._webgl.buffers[0]));for(var d=a.drawableCollection?a.drawableCollection.length:0,e=0;e<d;e++){var f=a.drawableCollection.get(e).shape;f._cleanupGLObjects&&f._cleanupGLObjects(!0)}this.cache.Release(b)}};a.prototype.emptyTexImage2D=function(a,b,d,e,f,g){try{a.texImage2D(a.TEXTURE_2D,0,b,d,e,0,f,g,null)}catch(h){var k=3;switch(b){case a.DEPTH_COMPONENT:k=3;break;case a.ALPHA:k=1;break;case a.RGB:k=3;break;case a.RGBA:k=
4;break;case a.LUMINANCE:k=1;break;case a.LUMINANCE_ALPHA:k=2}k=new Uint8Array(d*e*k);a.texImage2D(a.TEXTURE_2D,0,b,d,e,0,f,g,k)}};a.prototype.initTex=function(a,b,d,e,f){var g=a.createTexture();a.bindTexture(a.TEXTURE_2D,g);this.emptyTexImage2D(a,a.RGBA,b,d,a.RGBA,f);e?(a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST)):(a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,
a.LINEAR));a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE);a.bindTexture(a.TEXTURE_2D,null);g.width=b;g.height=d;return g};a.prototype.initFbo=function(a,b,d,e,f){var g=a.createFramebuffer(),h=a.createRenderbuffer();e=this.initTex(a,b,d,e,f);this.stateManager.bindFramebuffer(a.FRAMEBUFFER,g);a.bindRenderbuffer(a.RENDERBUFFER,h);a.renderbufferStorage(a.RENDERBUFFER,a.DEPTH_COMPONENT16,b,d);a.bindRenderbuffer(a.RENDERBUFFER,
null);a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,e,0);a.framebufferRenderbuffer(a.FRAMEBUFFER,a.DEPTH_ATTACHMENT,a.RENDERBUFFER,h);this.stateManager.bindFramebuffer(a.FRAMEBUFFER,null);var k=a.checkFramebufferStatus(a.FRAMEBUFFER);k!=a.FRAMEBUFFER_COMPLETE&&x3dom.debug.logWarning("[Context|InitFBO] FBO-Status: "+k);return{fbo:g,rbo:h,tex:e,width:b,height:d,typ:f}};a.prototype.renderShadows=function(a,b,d,e,f,g,h,k){var l=b._scene,n=x3dom.caps.MAX_TEXTURE_IMAGE_UNITS;if(!(7>
n)){var q=1,m=[0],p,s,t,w;for(t=0;t<d.length;t++){var z=d[t]._vf.shadowFilterSize;p=l._webgl.fboShadow[t];s=p.length;for(w=0;w<s;w++)this.blurTex(a,l,p[w],z);q+=6;q>n&&(m[m.length]=t,q=7)}m[m.length]=d.length;n=m.length-1;q=h.inverse();k=k.inverse();this.stateManager.enable(a.BLEND);this.stateManager.blendFunc(a.DST_COLOR,a.ZERO);for(z=0;z<n;z++){var u=m[z],v=m[z+1],r=[];for(s=u;s<v;s++)r[r.length]=d[s];v=this.cache.getShadowRenderingShader(a,r);this.stateManager.useProgram(v);a.bindBuffer(a.ARRAY_BUFFER,
l._webgl.ppBuffer);a.vertexAttribPointer(v.position,2,a.FLOAT,!1,0,0);a.enableVertexAttribArray(v.position);v.sceneMap=0;a.activeTexture(a.TEXTURE0);a.bindTexture(a.TEXTURE_2D,l._webgl.fboScene.tex);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE);v.inverseProj=q.toGL();v.inverseViewProj=k.toGL();for(var A,
D=0,x=0,y=r.length;x<y;x++){A=f[x+u];w=e[x+u];p=l._webgl.fboShadow[x+u];s=w.length;for(t=0;t<s;t++)a.activeTexture(a.TEXTURE1+D),a.bindTexture(a.TEXTURE_2D,p[t].tex),v["light"+x+"_"+t+"_ShadowMap"]=D+1,v["light"+x+"_"+t+"_Matrix"]=w[t].toGL(),D++;v["light"+x+"_ViewMatrix"]=A.toGL();if(!x3dom.isa(r[x],x3dom.nodeTypes.PointLight))for(w=0;w<s;w++)p=Math.max(1,Math.min(r[x]._vf.shadowCascades,6)),t=Math.max(0,Math.min(r[x]._vf.shadowSplitFactor,1)),A=Math.max(0,Math.min(r[x]._vf.shadowSplitOffset,1)),
p=b.getShadowSplitDepths(p,t,A,!1,h),v["light"+x+"_"+w+"_Split"]=p[w+1];s=g.mult(r[x].getCurrentTransform());x3dom.isa(r[x],x3dom.nodeTypes.DirectionalLight)?(v["light"+x+"_Type"]=0,v["light"+x+"_On"]=r[x]._vf.on?1:0,v["light"+x+"_Direction"]=s.multMatrixVec(r[x]._vf.direction).toGL(),v["light"+x+"_Attenuation"]=[1,1,1],v["light"+x+"_Location"]=[1,1,1],v["light"+x+"_Radius"]=0,v["light"+x+"_BeamWidth"]=0,v["light"+x+"_CutOffAngle"]=0,v["light"+x+"_ShadowIntensity"]=r[x]._vf.shadowIntensity,v["light"+
x+"_ShadowCascades"]=r[x]._vf.shadowCascades,v["light"+x+"_ShadowOffset"]=Math.max(0,Math.min(1,r[x]._vf.shadowOffset))):x3dom.isa(r[x],x3dom.nodeTypes.PointLight)?(v["light"+x+"_Type"]=1,v["light"+x+"_On"]=r[x]._vf.on?1:0,v["light"+x+"_Direction"]=[1,1,1],v["light"+x+"_Attenuation"]=r[x]._vf.attenuation.toGL(),v["light"+x+"_Location"]=s.multMatrixPnt(r[x]._vf.location).toGL(),v["light"+x+"_Radius"]=r[x]._vf.radius,v["light"+x+"_BeamWidth"]=0,v["light"+x+"_CutOffAngle"]=0,v["light"+x+"_ShadowIntensity"]=
r[x]._vf.shadowIntensity,v["light"+x+"_ShadowOffset"]=Math.max(0,Math.min(1,r[x]._vf.shadowOffset))):x3dom.isa(r[x],x3dom.nodeTypes.SpotLight)&&(v["light"+x+"_Type"]=2,v["light"+x+"_On"]=r[x]._vf.on?1:0,v["light"+x+"_Direction"]=s.multMatrixVec(r[x]._vf.direction).toGL(),v["light"+x+"_Attenuation"]=r[x]._vf.attenuation.toGL(),v["light"+x+"_Location"]=s.multMatrixPnt(r[x]._vf.location).toGL(),v["light"+x+"_Radius"]=r[x]._vf.radius,v["light"+x+"_BeamWidth"]=r[x]._vf.beamWidth,v["light"+x+"_CutOffAngle"]=
r[x]._vf.cutOffAngle,v["light"+x+"_ShadowIntensity"]=r[x]._vf.shadowIntensity,v["light"+x+"_ShadowCascades"]=r[x]._vf.shadowCascades,v["light"+x+"_ShadowOffset"]=Math.max(0,Math.min(1,r[x]._vf.shadowOffset)))}a.drawArrays(a.TRIANGLES,0,6);u=D+1;for(s=0;s<u;s++)a.activeTexture(a.TEXTURE0+s),a.bindTexture(a.TEXTURE_2D,null);a.disableVertexAttribArray(v.position)}this.stateManager.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA)}};a.prototype.blurTex=function(a,b,d,e){if(!(0>=e)){e=5>e?3:7>e?5:7;for(var f=
d.width,g=d.height,h=null,k=0,l=b._webgl.fboBlur.length;k<l;k++)if(g==b._webgl.fboBlur[k].height){h=b._webgl.fboBlur[k];break}this.stateManager.bindFramebuffer(a.FRAMEBUFFER,h.fbo);this.stateManager.viewport(0,0,f,g);this.stateManager.enable(a.BLEND);this.stateManager.blendFunc(a.ONE,a.ZERO);this.stateManager.disable(a.CULL_FACE);this.stateManager.disable(a.DEPTH_TEST);a.clearColor(1,1,1,0);a.clearDepth(1);a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT);k=this.cache.getShader(a,x3dom.shader.BLUR);
this.stateManager.useProgram(k);a.bindBuffer(a.ARRAY_BUFFER,b._webgl.ppBuffer);a.vertexAttribPointer(k.position,2,a.FLOAT,!1,0,0);a.enableVertexAttribArray(k.position);k.pixelSizeHor=1/f;k.pixelSizeVert=1/g;k.filterSize=e;k.horizontal=!0;k.texture=0;a.activeTexture(a.TEXTURE0);a.bindTexture(a.TEXTURE_2D,d.tex);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE);a.texParameteri(a.TEXTURE_2D,
a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE);a.drawArrays(a.TRIANGLES,0,6);this.stateManager.bindFramebuffer(a.FRAMEBUFFER,d.fbo);a.clearColor(1,1,1,0);a.clearDepth(1);a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT);k.horizontal=!1;a.activeTexture(a.TEXTURE0);a.bindTexture(a.TEXTURE_2D,h.tex);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,
a.CLAMP_TO_EDGE);a.drawArrays(a.TRIANGLES,0,6);a.activeTexture(a.TEXTURE0);a.bindTexture(a.TEXTURE_2D,null);a.disableVertexAttribArray(k.position);a.flush();this.stateManager.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA);this.stateManager.bindFramebuffer(a.FRAMEBUFFER,null);this.stateManager.viewport(0,0,this.canvas.width,this.canvas.height)}};return function(c,b,d,e,f){var g=["moz-webgl","webkit-3d","experimental-webgl","webgl"];e&&(g=["experimental-webgl2"].concat(g));e=null;for(var h={alpha:!0,
depth:!0,stencil:!0,antialias:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!0},k=0;k<g.length;k++)try{if(e=c.getContext(g[k],h)){var l=new a(e,c,"webgl",f);try{x3dom.caps.VENDOR=e.getParameter(e.VENDOR);x3dom.caps.VERSION=e.getParameter(e.VERSION);x3dom.caps.RENDERER=e.getParameter(e.RENDERER);x3dom.caps.SHADING_LANGUAGE_VERSION=e.getParameter(e.SHADING_LANGUAGE_VERSION);x3dom.caps.RED_BITS=e.getParameter(e.RED_BITS);x3dom.caps.GREEN_BITS=e.getParameter(e.GREEN_BITS);x3dom.caps.BLUE_BITS=e.getParameter(e.BLUE_BITS);
x3dom.caps.ALPHA_BITS=e.getParameter(e.ALPHA_BITS);x3dom.caps.DEPTH_BITS=e.getParameter(e.DEPTH_BITS);x3dom.caps.MAX_VERTEX_ATTRIBS=e.getParameter(e.MAX_VERTEX_ATTRIBS);x3dom.caps.MAX_VERTEX_TEXTURE_IMAGE_UNITS=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS);x3dom.caps.MAX_VARYING_VECTORS=e.getParameter(e.MAX_VARYING_VECTORS);x3dom.caps.MAX_VERTEX_UNIFORM_VECTORS=e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS);x3dom.caps.MAX_COMBINED_TEXTURE_IMAGE_UNITS=e.getParameter(e.MAX_COMBINED_TEXTURE_IMAGE_UNITS);
x3dom.caps.MAX_TEXTURE_SIZE=e.getParameter(e.MAX_TEXTURE_SIZE);x3dom.caps.MAX_TEXTURE_IMAGE_UNITS=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS);x3dom.caps.MAX_CUBE_MAP_TEXTURE_SIZE=e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE);x3dom.caps.COMPRESSED_TEXTURE_FORMATS=e.getParameter(e.COMPRESSED_TEXTURE_FORMATS);x3dom.caps.MAX_RENDERBUFFER_SIZE=e.getParameter(e.MAX_RENDERBUFFER_SIZE);x3dom.caps.MAX_VIEWPORT_DIMS=e.getParameter(e.MAX_VIEWPORT_DIMS);x3dom.caps.ALIASED_LINE_WIDTH_RANGE=e.getParameter(e.ALIASED_LINE_WIDTH_RANGE);
x3dom.caps.ALIASED_POINT_SIZE_RANGE=e.getParameter(e.ALIASED_POINT_SIZE_RANGE);x3dom.caps.SAMPLES=e.getParameter(e.SAMPLES);x3dom.caps.INDEX_UINT=e.getExtension("OES_element_index_uint");x3dom.caps.FP_TEXTURES=e.getExtension("OES_texture_float");x3dom.caps.FPL_TEXTURES=e.getExtension("OES_texture_float_linear");x3dom.caps.STD_DERIVATIVES=e.getExtension("OES_standard_derivatives");x3dom.caps.DRAW_BUFFERS=e.getExtension("WEBGL_draw_buffers");x3dom.caps.EXTENSIONS=e.getSupportedExtensions();x3dom.debug.logInfo("\nVendor: "+
x3dom.caps.VENDOR+", Renderer: "+x3dom.caps.RENDERER+", Version: "+x3dom.caps.VERSION+", ShadingLangV.: "+x3dom.caps.SHADING_LANGUAGE_VERSION+", MSAA samples: "+x3dom.caps.SAMPLES+"\nExtensions: "+x3dom.caps.EXTENSIONS);x3dom.caps.INDEX_UINT&&(x3dom.Utils.maxIndexableCoords=4294967295);var n=x3dom.caps,q,m=navigator.userAgent||navigator.vendor||window.opera;q=/android.+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(m)||
/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|e\-|e\/|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(di|rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|xda(\-|2|g)|yas\-|your|zeto|zte\-/i.test(m.substr(0,
4));n.MOBILE=q;if(0<=x3dom.caps.RENDERER.indexOf("PowerVR")||-1<navigator.appVersion.indexOf("Mobile")||8>=x3dom.caps.MAX_VARYING_VECTORS||2>x3dom.caps.MAX_VERTEX_TEXTURE_IMAGE_UNITS)x3dom.caps.MOBILE=!0;x3dom.caps.MOBILE?b?(x3dom.caps.MOBILE=!1,x3dom.debug.logWarning("Detected mobile graphics card! But being forced to desktop shaders which might not work!")):x3dom.debug.logWarning("Detected mobile graphics card! Using low quality shaders without ImageGeometry support!"):d&&(x3dom.caps.MOBILE=!0,
x3dom.debug.logWarning("Detected desktop graphics card! But being forced to mobile shaders with lower quality!"))}catch(p){x3dom.debug.logWarning("Your browser probably supports an older WebGL version. Please try the old mobile runtime instead:\nhttp://www.x3dom.org/x3dom/src_mobile/x3dom.js"),l=null}return l}}catch(s){}return null}}();
x3dom.bridge={setFlashReady:function(a,c){x3dom.canvases[c].isFlashReady=!0;x3dom.debug.logInfo("Flash is ready for rendering ("+a+")")},onMouseDown:function(a,c,b,d){d=x3dom.canvases[d];d.doc.onMousePress(d.gl,a,c,b);d.doc.needRender=!0},onMouseUp:function(a,c,b,d){d=x3dom.canvases[d];d.doc.onMouseRelease(d.gl,a,c,b);d.doc.needRender=!0},onMouseOver:function(a,c,b,d){d=x3dom.canvases[d];d.doc.onMouseOver(d.gl,a,c,b);d.doc.needRender=!0},onMouseOut:function(a,c,b,d){d=x3dom.canvases[d];d.doc.onMouseOut(d.gl,
a,c,b);d.doc.needRender=!0},onDoubleClick:function(a,c,b){b=x3dom.canvases[b];b.doc.onDoubleClick(b.gl,a,c);b.doc.needRender=!0;x3dom.debug.logInfo("dblClick")},onMouseDrag:function(a,c,b,d){d=x3dom.canvases[d];d.doc.onDrag(d.gl,a,c,b);d.doc.needRender=!0},onMouseMove:function(a,c,b,d){d=x3dom.canvases[d];d.doc.onMove(d.gl,a,c,b);d.doc.needRender=!0},onMouseWheel:function(a,c,b,d){d=x3dom.canvases[d];d.doc.onDrag(d.gl,a,c,b);d.doc.needRender=!0},onKeyDown:function(a,c){var b=x3dom.canvases[c],d=b.x3dElem.getAttribute("keysEnabled");
if(!d||"true"===d.toLowerCase())b.doc.onKeyPress(a);b.doc.needRender=!0},setBBox:function(a,c,b){},setShapeDirty:function(a){x3dom.nodeTypes.Shape.idMap.nodeID[a].setAllDirty()}};
x3dom.gfx_flash=function(){function a(a,b,d){this.object=a;this.name=b;this.isAlreadySet=!1;this.renderType=d}a.prototype.getName=function(){return this.name};a.prototype.renderScene=function(a){var b=a._scene,d=x3dom.fields.SFVec3f.MAX(),e=x3dom.fields.SFVec3f.MIN();b.getVolume().getBounds(d,e);b._lastMin=d;b._lastMax=e;a._last_mat_view=x3dom.fields.SFMatrix4f.identity();a._last_mat_proj=x3dom.fields.SFMatrix4f.identity();a._last_mat_scene=x3dom.fields.SFMatrix4f.identity();d=b.getViewpoint();if(-1==
d._vf.zNear||-1==d._vf.zFar)d._vf.zFar=2E4,d._vf.zNear=0.1;var d=a.getViewMatrix(),e=a.getProjectionMatrix(),f=e.mult(d);this.setupScene(b,a);var g=b.getBackground();this.setupBackground(g);b.drawableCollection=null;g=b.getEnvironment();b.drawableCollection=new x3dom.DrawableCollection({viewArea:a,sortTrans:g._vf.sortTrans,viewMatrix:d,projMatrix:e,sceneMatrix:f,frustumCulling:!1,smallFeatureThreshold:!1,context:null,gl:null});b.collectDrawableObjects(x3dom.fields.SFMatrix4f.identity(),b.drawableCollection,
!0,!1,0);b.drawableCollection.concat();a=b.drawableCollection.length;if(0<a)for(d=[],e=0;e<a;e++)g=b.drawableCollection.get(e),f=g.transform,g=g.shape,void 0!=d[g._objectID]?d[g._objectID]++:d[g._objectID]=0,this.setupShape(g,f,d[g._objectID]);this.object.renderScene()};a.prototype.setupScene=function(a,b){var d=b.getViewMatrix();if(!b._last_mat_view.equals(d)){var e=b._scene.getViewpoint();try{if(e._xmlNode&&(e._xmlNode.onviewpointChanged||e._xmlNode.hasAttribute("onviewpointChanged")||e._listeners.viewpointChanged)){var f=
e.getCurrentTransform(),f=f.inverse().mult(d),g=f.inverse(),h=new x3dom.fields.Quaternion(0,0,1,0),k=g.e3(),l={target:e._xmlNode,type:"viewpointChanged",matrix:f,position:k,orientation:h.toAxisAngle(),cancelBubble:!1,stopPropagation:function(){this.cancelBubble=!0}};e.callEvtHandler("viewpointChanged",l)}}catch(n){x3dom.debug.logException(n)}}b._last_mat_view=d;e=a.getViewpoint();f=b.getProjectionMatrix();this.object.setViewpoint({fov:e._vf.fov,zFar:e._vf.zFar,zNear:e._vf.zNear,viewMatrix:d.toGL(),
projectionMatrix:f.toGL()});a.getNavigationInfo()._vf.headlight&&this.object.setHeadLight({id:-1,on:1,color:[1,1,1],intensity:1,ambientIntensity:0,direction:[0,0,-1]});if("deferred"==this.renderType)for(e=b.getLights(),f=0;f<e.length;f++)e[f]._dirty&&(x3dom.isa(e[f],x3dom.nodeTypes.DirectionalLight)?this.object.setDirectionalLight({id:e[f]._lightID,on:e[f]._vf.on,color:e[f]._vf.color.toGL(),intensity:e[f]._vf.intensity,ambientIntensity:e[f]._vf.ambientIntensity,direction:e[f]._vf.direction.toGL()}):
x3dom.isa(e[f],x3dom.nodeTypes.PointLight)?(d.mult(e[f].getCurrentTransform()),this.object.setPointLight({id:e[f]._lightID,on:e[f]._vf.on,color:e[f]._vf.color.toGL(),intensity:e[f]._vf.intensity,ambientIntensity:e[f]._vf.ambientIntensity,attenuation:e[f]._vf.attenuation.toGL(),location:e[f]._vf.location.toGL(),radius:e[f]._vf.radius})):x3dom.isa(e[f],x3dom.nodeTypes.SpotLight),e[f]._dirty=!1)};a.prototype.setupBackground=function(a){a._dirty&&(this.object.setBackground({texURLs:a.getTexUrl(),skyAngle:a._vf.skyAngle,
skyColor:a.getSkyColor().toGL(),groundAngle:a._vf.groundAngle,groundColor:a.getGroundColor().toGL(),transparency:a.getTransparency()}),a._dirty=!1)};a.prototype.setupShape=function(a,b,d){x3dom.isa(a._cf.geometry.node,x3dom.nodeTypes.PointSet)?x3dom.debug.logError("Flash backend doesn't support PointSets yet"):x3dom.isa(a._cf.geometry.node,x3dom.nodeTypes.IndexedLineSet)?x3dom.debug.logError("Flash backend doesn't support LineSets yet"):x3dom.isa(a._cf.geometry.node,x3dom.nodeTypes.Text)?this.setupText(a,
b,d):this.setupIndexedFaceSet(a,b,d)};a.prototype.setupIndexedFaceSet=function(a,b,d){this.object.setMeshTransform({id:a._objectID,refID:d,transform:b.toGL()});if(0==d){d=x3dom.isa(a._cf.geometry.node,x3dom.nodeTypes.ImageGeometry);var e=x3dom.isa(a._cf.geometry.node,x3dom.nodeTypes.BinaryGeometry),f=x3dom.isa(a._cf.geometry.node,x3dom.nodeTypes.BitLODGeometry),g=(b=a._cf.appearance.node)?a._cf.appearance.node._vf.sortType:"auto",h=b?a._cf.appearance.node._vf.sortKey:0;d?this.object.setMeshProperties({id:a._objectID,
type:"ImageGeometry",sortType:g,sortKey:h,solid:a.isSolid(),bboxMin:a._cf.geometry.node.getMin().toGL(),bboxMax:a._cf.geometry.node.getMax().toGL(),bboxCenter:a._cf.geometry.node.getCenter().toGL(),primType:a._cf.geometry.node._vf.primType,vertexCount:a._cf.geometry.node._vf.vertexCount}):e?this.object.setMeshProperties({id:a._objectID,type:"BinaryGeometry",sortType:g,sortKey:h,solid:a.isSolid(),bgCenter:a._cf.geometry.node._vf.position.toGL(),bgSize:a._cf.geometry.node._vf.size.toGL(),bboxCenter:a._cf.geometry.node.getCenter().toGL(),
primType:a._cf.geometry.node._vf.primType,vertexCount:a._cf.geometry.node._vf.vertexCount}):f?this.object.setMeshProperties({id:a._objectID,type:"BitLODGeometry",sortType:g,sortKey:h,solid:a.isSolid(),bboxMin:a._cf.geometry.node.getMin().toGL(),bboxMax:a._cf.geometry.node.getMax().toGL(),bboxCenter:a._cf.geometry.node.getCenter().toGL(),primType:a._cf.geometry.node._vf.primType,vertexCount:a._cf.geometry.node._vf.vertexCount}):this.object.setMeshProperties({id:a._objectID,type:"Default",sortType:g,
sortKey:h,solid:a.isSolid()});if(!0===a._dirty.indexes){if(!d)if(e)this.object.setMeshIndices({id:a._objectID,idx:0,indices:a._nameSpace.getURL(a._cf.geometry.node._vf.index)});else if(f)this.object.setMeshIndices({id:a._objectID,idx:0,indices:a._nameSpace.getURL(a._cf.geometry.node._vf.index)});else for(g=0;g<a._cf.geometry.node._mesh._indices.length;g++)this.object.setMeshIndices({id:a._objectID,idx:g,indices:a._cf.geometry.node._mesh._indices[g]});a._dirty.indexes=!1}if(!0===a._dirty.positions){if(d)this.object.setMeshVertices({id:a._objectID,
idx:0,coordinateTexture0:a._cf.geometry.node.getCoordinateTextureURL(0),coordinateTexture1:a._cf.geometry.node.getCoordinateTextureURL(1)});else if(e)this.object.setMeshVertices({id:a._objectID,idx:0,interleaved:a._cf.geometry.node._hasStrideOffset,vertices:a._nameSpace.getURL(a._cf.geometry.node._vf.coord),normals:a._nameSpace.getURL(a._cf.geometry.node._vf.normal),texCoords:a._nameSpace.getURL(a._cf.geometry.node._vf.texCoord),colors:a._nameSpace.getURL(a._cf.geometry.node._vf.color),numColorComponents:a._cf.geometry.node._mesh._numColComponents,
numNormalComponents:a._cf.geometry.node._mesh._numNormComponents,vertexType:a._cf.geometry.node._vf.coordType,normalType:a._cf.geometry.node._vf.normalType,texCoordType:a._cf.geometry.node._vf.texCoordType,colorType:a._cf.geometry.node._vf.colorType,vertexStrideOffset:a._coordStrideOffset,normalStrideOffset:a._normalStrideOffset,texCoordStrideOffset:a._texCoordStrideOffset,colorStrideOffset:a._colorStrideOffset});else if(f)this.object.setMeshVertices({id:a._objectID,componentURLs:a._cf.geometry.node.getComponentsURLs(),
componentFormats:a._cf.geometry.node.getComponentFormats(),componentAttribs:a._cf.geometry.node.getComponentAttribs()});else for(g=0;g<a._cf.geometry.node._mesh._positions.length;g++)this.object.setMeshVertices({id:a._objectID,idx:g,vertices:a._cf.geometry.node._mesh._positions[g]});a._dirty.positions=!1}if(!0===a._dirty.normals){if(d)this.object.setMeshNormals({id:a._objectID,idx:0,normalTexture:a._cf.geometry.node.getNormalTextureURL()});else if(e)a._cf.geometry.node._hasStrideOffset||this.object.setMeshNormals({id:a._objectID,
idx:0,normals:a._nameSpace.getURL(a._cf.geometry.node._vf.normal)});else if(!f&&a._cf.geometry.node._mesh._normals[0].length)for(g=0;g<a._cf.geometry.node._mesh._normals.length;g++)this.object.setMeshNormals({id:a._objectID,idx:g,normals:a._cf.geometry.node._mesh._normals[g]});a._dirty.normals=!1}if(!0===a._dirty.colors){if(d)this.object.setMeshColors({id:a._objectID,idx:0,colorTexture:a._cf.geometry.node.getColorTextureURL(),components:a._cf.geometry.node._mesh._numColComponents});else if(e)a._cf.geometry.node._hasStrideOffset||
this.object.setMeshColors({id:a._objectID,idx:0,colors:a._nameSpace.getURL(a._cf.geometry.node._vf.color),components:a._cf.geometry.node._mesh._numColComponents});else if(!f&&a._cf.geometry.node._mesh._colors[0].length)for(g=0;g<a._cf.geometry.node._mesh._colors.length;g++)this.object.setMeshColors({id:a._objectID,idx:g,colors:a._cf.geometry.node._mesh._colors[g],components:a._cf.geometry.node._mesh._numColComponents});a._dirty.colors=!1}if(!0===a._dirty.texcoords){if(d)this.object.setMeshTexCoords({id:a._objectID,
idx:0,texCoordTexture:a._cf.geometry.node.getTexCoordTextureURL()});else if(e)a._cf.geometry.node._hasStrideOffset||this.object.setMeshTexCoords({id:a._objectID,idx:0,texCoords:a._nameSpace.getURL(a._cf.geometry.node._vf.texCoord)});else if(!f&&a._cf.geometry.node._mesh._texCoords[0].length)for(g=0;g<a._cf.geometry.node._mesh._texCoords.length;g++)this.object.setMeshTexCoords({id:a._objectID,idx:g,texCoords:a._cf.geometry.node._mesh._texCoords[g]});a._dirty.texcoords=!1}!0===a._dirty.material&&(b&&
(d=a._cf.appearance.node._cf.material.node)&&this.object.setMeshMaterial({id:a._objectID,ambientIntensity:d._vf.ambientIntensity,diffuseColor:d._vf.diffuseColor.toGL(),emissiveColor:d._vf.emissiveColor.toGL(),shininess:d._vf.shininess,specularColor:d._vf.specularColor.toGL(),transparency:d._vf.transparency}),a._dirty.material=!1);!0===a._dirty.texture&&(b&&(d=null,b._cf.textureTransform.node&&(d=b.texTransformMatrix().toGL()),(b=a._cf.appearance.node._cf.texture.node)?x3dom.isa(b,x3dom.nodeTypes.PixelTexture)?
this.object.setPixelTexture({id:a._objectID,width:b._vf.image.width,height:b._vf.image.height,comp:b._vf.image.comp,pixels:b._vf.image.toGL()}):x3dom.isa(b,x3dom.nodeTypes.ComposedCubeMapTexture)?this.object.setCubeTexture({id:a._objectID,texURLs:b.getTexUrl()}):b._isCanvas&&b._canvas?this.object.setCanvasTexture({id:a._objectID,width:b._canvas.width,height:b._canvas.height,dataURL:b._canvas.toDataURL()}):x3dom.isa(b,x3dom.nodeTypes.MultiTexture)?x3dom.debug.logError("Flash backend doesn't support MultiTextures yet"):
x3dom.isa(b,x3dom.nodeTypes.MovieTexture)?x3dom.debug.logError("Flash backend doesn't support MovieTextures yet"):this.object.setMeshTexture({id:a._objectID,origChannelCount:b._vf.origChannelCount,repeatS:b._vf.repeatS,repeatT:b._vf.repeatT,url:b._vf.url[0],transform:d}):this.object.removeTexture({id:a._objectID})),a._dirty.texture=!1);void 0!==a._cf.geometry.node._cf.texCoord&&null!==a._cf.geometry.node._cf.texCoord.node&&!x3dom.isa(a._cf.geometry.node._cf.texCoord.node,x3dom.nodeTypes.X3DTextureNode)&&
a._cf.geometry.node._cf.texCoord.node._vf.mode?"sphere"==a._cf.geometry.node._cf.texCoord.node._vf.mode.toLowerCase()?this.object.setSphereMapping({id:a._objectID,sphereMapping:1}):this.object.setSphereMapping({id:a._objectID,sphereMapping:0}):this.object.setSphereMapping({id:a._objectID,sphereMapping:0})}};a.prototype.setupText=function(a,b,d){this.object.setMeshTransform({id:a._objectID,refID:d,transform:b.toGL()});if(0==d){d=(b=a._cf.appearance.node)?a._cf.appearance.node._vf.sortType:"auto";var e=
b?a._cf.appearance.node._vf.sortKey:0;if(!0===a._dirty.text){var f=a._cf.geometry.node._cf.fontStyle.node;null===f?this.object.setMeshProperties({id:a._objectID,type:"Text",sortType:d,sortKey:e,solid:a.isSolid(),text:a._cf.geometry.node._vf.string,fontFamily:["SERIF"],fontStyle:"PLAIN",fontAlign:"BEGIN",fontSize:32,fontSpacing:1,fontHorizontal:!0,fontLanguage:"",fontLeftToRight:!0,fontTopToBottom:!0}):this.object.setMeshProperties({id:a._objectID,type:"Text",sortType:d,sortKey:e,solid:a.isSolid(),
text:a._cf.geometry.node._vf.string,fontFamily:f._vf.family.toString(),fontStyle:f._vf.style.toString(),fontAlign:f._vf.justify.toString(),fontSize:f._vf.size,fontSpacing:f._vf.spacing,fontHorizontal:f._vf.horizontal,fontLanguage:f._vf.language,fontLeftToRight:f._vf.leftToRight,fontTopToBottom:f._vf.topToBottom});a._dirty.text=!1}!0===a._dirty.material&&(b&&(b=a._cf.appearance.node._cf.material.node)&&this.object.setMeshMaterial({id:a._objectID,ambientIntensity:b._vf.ambientIntensity,diffuseColor:b._vf.diffuseColor.toGL(),
emissiveColor:b._vf.emissiveColor.toGL(),shininess:b._vf.shininess,specularColor:b._vf.specularColor.toGL(),transparency:b._vf.transparency}),a._dirty.material=!1)}};a.prototype.pickValue=function(a,b,d,e,f){b=a._scene;if(null===this.object||null===b||void 0===b.drawableCollection||!b.drawableCollection||"box"===b._vf.pickMode.toLowerCase())return!1;b="color"===b._vf.pickMode.toLowerCase()?1:"texcoord"===b._vf.pickMode.toLowerCase()?2:0;b=this.object.pickValue({pickMode:b});0<b.objID?(a._pickingInfo.pickPos=
new x3dom.fields.SFVec3f(b.pickPosX,b.pickPosY,b.pickPosZ),a._pickingInfo.pickObj=x3dom.nodeTypes.Shape.idMap.nodeID[b.objID]):(a._pickingInfo.pickObj=null,a._pickingInfo.lastClickObj=null);return!0};a.prototype.shutdown=function(a){};return function(c,b){return new a(c,"flash",b)}}();
x3dom.X3DDocument=function(a,c,b){this.canvas=a;this.ctx=c;this.properties=b;this.needRender=!0;this._viewarea=this._scene=this._x3dElem=null;this.downloadCount=0;this._nodeBag={timer:[],lights:[],clipPlanes:[],followers:[],trans:[],renderTextures:[],viewarea:[]};this.onload=function(){};this.onerror=function(){}};
x3dom.X3DDocument.prototype.load=function(a,c){function b(){if(0===e.length)f._setup(d[a],d,c),f.onload();else{var g=e.shift();!x3dom.isX3DElement(g)||"x3d"!==g.localName.toLowerCase()&&"websg"!==g.localName.toLowerCase()||(d[g]=g,f._x3dElem=g,b())}}var d={},e=[a],f=this;b()};
x3dom.findScene=function(a){for(var c=[],b=0;b<a.childNodes.length;b++){var d=a.childNodes[b];d&&d.localName&&"scene"===d.localName.toLowerCase()&&c.push(d)}if(1<c.length)x3dom.debug.logError("X3D element has more than one Scene child (has "+a.childNodes.length+").");else return c[0];return null};
x3dom.X3DDocument.prototype._setup=function(a,c,b){function d(a,b){for(var c=0,d=a.length;c<d;c++)if(a[c]===b){a.splice(c,1);break}}function e(a){for(var b=a.childNodes,c=0,l=b.length;c<l;c++)e(b[c]);if(a._x3domNode){b=a._x3domNode;c=b._nameSpace;if(x3dom.isa(b,x3dom.nodeTypes.X3DShapeNode))b._cleanupGLObjects&&b._cleanupGLObjects(!0),x3dom.nodeTypes.Shape.idMap.nodeID[b._objectID]&&delete x3dom.nodeTypes.Shape.idMap.nodeID[b._objectID];else if(x3dom.isa(b,x3dom.nodeTypes.TimeSensor))d(f._nodeBag.timer,
b);else if(x3dom.isa(b,x3dom.nodeTypes.X3DLightNode))d(f._nodeBag.lights,b);else if(x3dom.isa(b,x3dom.nodeTypes.X3DFollowerNode))d(f._nodeBag.followers,b);else if(x3dom.isa(b,x3dom.nodeTypes.X3DTransformNode))d(f._nodeBag.trans,b);else if(x3dom.isa(b,x3dom.nodeTypes.RenderedTexture))d(f._nodeBag.renderTextures,b);else if(x3dom.isa(b,x3dom.nodeTypes.X3DBindableNode)){if(l=b._stack)b.bind(!1),d(l._bindBag,b);b._cleanupGLObjects&&b._cleanupGLObjects()}c&&c.removeNode(b._DEF);b._xmlNode=null;delete a._x3domNode}}
var f=this;c=function(a){"_x3domNode"in a.target&&(a.target._x3domNode.updateField(a.attrName,a.newValue),f.needRender=!0)};a.addEventListener("DOMNodeRemoved",function(a){if(a=a.target)if("_x3domNode"in a.parentNode&&"_x3domNode"in a){var b=a.parentNode._x3domNode,c=a._x3domNode;b&&c&&(b.removeChild(c),b.nodeChanged(),e(a),f._viewarea&&f._viewarea._scene&&(f._viewarea._scene.nodeChanged(),f._viewarea._scene.updateVolume(),f.needRender=!0))}else a.localName&&"ROUTE"==a.localName.toUpperCase()&&a._nodeNameSpace&&
(b=a._nodeNameSpace.defMap[a.getAttribute("fromNode")],c=a._nodeNameSpace.defMap[a.getAttribute("toNode")],b&&c&&b.removeRoute(a.getAttribute("fromField"),c,a.getAttribute("toField")))},!0);a.addEventListener("DOMNodeInserted",function(a){a=a.target;var b=a.parentNode;if("_x3domNode"in b&&(!b.tagName||"inline"!=b.tagName.toLowerCase())){var c=b._x3domNode;if(c&&c._nameSpace&&a instanceof Element){e(a);var d=c._nameSpace.setupTree(a);c.addChild(d,a.getAttribute("containerField"));c.nodeChanged();(a=
b.parentNode)&&a._x3domNode&&a._x3domNode.nodeChanged();f._viewarea&&f._viewarea._scene&&(f._viewarea._scene.nodeChanged(),f._viewarea._scene.updateVolume(),f.needRender=!0)}else x3dom.debug.logWarning("No _nameSpace in onNodeInserted")}},!0);!0===x3dom.userAgentFeature.supportsDOMAttrModified&&a.addEventListener("DOMAttrModified",c,!0);a=x3dom.findScene(a);this._bindableBag=new x3dom.BindableBag(this);this._scene=a=(new x3dom.NodeNameSpace("scene",f)).setupTree(a);this._bindableBag.setRefNode(a);
this._viewarea=new x3dom.Viewarea(this,a);this._viewarea._width=this.canvas.width;this._viewarea._height=this.canvas.height};
x3dom.X3DDocument.prototype.advanceTime=function(a){var c=0;if(this._nodeBag.timer.length)for(c=0;c<this._nodeBag.timer.length;c++)this.needRender|=this._nodeBag.timer[c].tick(a);if(this._nodeBag.followers.length)for(c=0;c<this._nodeBag.followers.length;c++)this.needRender|=this._nodeBag.followers[c].tick(a);if(this._nodeBag.trans.length)for(c=0;c<this._nodeBag.trans.length;c++)this.needRender|=this._nodeBag.trans[c].tick(a);if(this._nodeBag.viewarea.length)for(c=0;c<this._nodeBag.viewarea.length;c++)this.needRender|=
this._nodeBag.viewarea[c].tick(a)};x3dom.X3DDocument.prototype.render=function(a){a&&this._viewarea&&a.renderScene(this._viewarea)};x3dom.X3DDocument.prototype.onPick=function(a,c,b){a&&this._viewarea&&a.pickValue(this._viewarea,c,b,1)};x3dom.X3DDocument.prototype.onPickRect=function(a,c,b,d,e){return a&&this._viewarea?a.pickRect(this._viewarea,c,b,d,e):[]};
x3dom.X3DDocument.prototype.onMove=function(a,c,b,d){a&&this._viewarea&&(this._viewarea._scene._vf.doPickPass&&a.pickValue(this._viewarea,c,b,d),this._viewarea.onMove(c,b,d))};x3dom.X3DDocument.prototype.onMoveView=function(a,c,b){if(a&&this._viewarea)this._viewarea.onMoveView(c,b)};x3dom.X3DDocument.prototype.onDrag=function(a,c,b,d){a&&this._viewarea&&(this._viewarea._scene._vf.doPickPass&&a.pickValue(this._viewarea,c,b,d),this._viewarea.onDrag(c,b,d))};
x3dom.X3DDocument.prototype.onMousePress=function(a,c,b,d){a&&this._viewarea&&(this._viewarea._scene.updateVolume(),a.pickValue(this._viewarea,c,b,d),this._viewarea.onMousePress(c,b,d))};x3dom.X3DDocument.prototype.onMouseRelease=function(a,c,b,d,e){a&&this._viewarea&&(a.pickValue(this._viewarea,c,b,e<<8|d),this._viewarea.onMouseRelease(c,b,d,e))};x3dom.X3DDocument.prototype.onMouseOver=function(a,c,b,d){a&&this._viewarea&&(a.pickValue(this._viewarea,c,b,d),this._viewarea.onMouseOver(c,b,d))};
x3dom.X3DDocument.prototype.onMouseOut=function(a,c,b,d){a&&this._viewarea&&(a.pickValue(this._viewarea,c,b,d),this._viewarea.onMouseOut(c,b,d))};x3dom.X3DDocument.prototype.onDoubleClick=function(a,c,b){if(a&&this._viewarea)this._viewarea.onDoubleClick(c,b)};x3dom.X3DDocument.prototype.onKeyDown=function(a){switch(a){case 37:this._viewarea.strafeLeft();break;case 38:this._viewarea.moveFwd();break;case 39:this._viewarea.strafeRight();break;case 40:this._viewarea.moveBwd()}};
x3dom.X3DDocument.prototype.onKeyUp=function(a){var c=null;switch(a){case 13:x3dom.toggleFullScreen();break;case 27:window.history.back();break;case 33:(c=this._scene.getViewpoint()._stack)?c.switchTo("next"):x3dom.debug.logError("No valid ViewBindable stack.");break;case 34:(c=this._scene.getViewpoint()._stack)?c.switchTo("prev"):x3dom.debug.logError("No valid ViewBindable stack.")}};
x3dom.X3DDocument.prototype.onKeyPress=function(a){var c=this._scene.getNavigationInfo(),b=this._scene.getEnvironment();switch(a){case 32:(a=this.canvas.parent.stateViewer)&&a.display();x3dom.debug.logInfo("a: show all | d: show helper buffers | s: small feature culling | t: light view | m: toggle render mode | c: frustum culling | p: intersect type | r: reset view | e: examine mode | f: fly mode | y: freefly mode | w: walk mode | h: helicopter mode | l: lookAt mode | o: lookaround | g: game mode | u: upright position | v: print viewpoint info | pageUp: next view | pageDown: prev. view | +: increase speed | -: decrease speed ");
break;case 43:c._vf.speed*=2;x3dom.debug.logInfo("Changed navigation speed to "+c._vf.speed);break;case 45:c._vf.speed*=0.5;x3dom.debug.logInfo("Changed navigation speed to "+c._vf.speed);break;case 51:x3dom.nodeTypes.PopGeometry.ErrorToleranceFactor+=0.5;x3dom.debug.logInfo("Changed POP error tolerance to "+x3dom.nodeTypes.PopGeometry.ErrorToleranceFactor);break;case 52:x3dom.nodeTypes.PopGeometry.ErrorToleranceFactor-=0.5;x3dom.debug.logInfo("Changed POP error tolerance to "+x3dom.nodeTypes.PopGeometry.ErrorToleranceFactor);
break;case 54:c._vf.typeParams[1]+=1;c._heliUpdated=!1;x3dom.debug.logInfo("Changed helicopter height to "+c._vf.typeParams[1]);break;case 55:c._vf.typeParams[1]-=1;c._heliUpdated=!1;x3dom.debug.logInfo("Changed helicopter height to "+c._vf.typeParams[1]);break;case 56:c._vf.typeParams[0]-=0.02;c._heliUpdated=!1;x3dom.debug.logInfo("Changed helicopter angle to "+c._vf.typeParams[0]);break;case 57:c._vf.typeParams[0]+=0.02;c._heliUpdated=!1;x3dom.debug.logInfo("Changed helicopter angle to "+c._vf.typeParams[0]);
break;case 97:this._viewarea.showAll();break;case 99:b._vf.frustumCulling=!b._vf.frustumCulling;x3dom.debug.logInfo("Viewfrustum culling "+(b._vf.frustumCulling?"on":"off"));break;case 100:void 0===this._viewarea._visDbgBuf&&(this._viewarea._visDbgBuf="true"===this._x3dElem.getAttribute("showLog"));this._viewarea._visDbgBuf=!this._viewarea._visDbgBuf;x3dom.debug.logContainer.style.display=!0==this._viewarea._visDbgBuf?"block":"none";break;case 101:c.setType("examine",this._viewarea);break;case 102:c.setType("fly",
this._viewarea);break;case 103:c.setType("game",this._viewarea);break;case 104:c.setType("helicopter",this._viewarea);break;case 108:c.setType("lookat",this._viewarea);break;case 109:this._viewarea._points=++this._viewarea._points%3;break;case 110:c.setType("turntable",this._viewarea);break;case 111:c.setType("lookaround",this._viewarea);break;case 112:switch(this._scene._vf.pickMode.toLowerCase()){case "idbuf":this._scene._vf.pickMode="color";break;case "color":this._scene._vf.pickMode="texCoord";
break;case "texcoord":this._scene._vf.pickMode="box";break;default:this._scene._vf.pickMode="idBuf"}x3dom.debug.logInfo("Switch pickMode to '"+this._scene._vf.pickMode+"'.");break;case 114:this._viewarea.resetView();break;case 115:b._vf.smallFeatureCulling=!b._vf.smallFeatureCulling;x3dom.debug.logInfo("Small feature culling "+(b._vf.smallFeatureCulling?"on":"off"));break;case 116:0<this._nodeBag.lights.length&&this._viewarea.animateTo(this._viewarea.getLightMatrix()[0],this._scene.getViewpoint());
break;case 117:this._viewarea.uprightView();break;case 118:a=this._viewarea._scene.getViewpoint();c=this._viewarea.getViewMatrix().inverse();b=new x3dom.fields.Quaternion(0,0,1,0);b.setValue(c);b=b.toAxisAngle();c=c.e3();x3dom.debug.logInfo('\n&lt;Viewpoint position="'+c.x.toFixed(5)+" "+c.y.toFixed(5)+" "+c.z.toFixed(5)+'" orientation="'+b[0].x.toFixed(5)+" "+b[0].y.toFixed(5)+" "+b[0].z.toFixed(5)+" "+b[1].toFixed(5)+'" \n\tzNear="'+a.getNear().toFixed(5)+'" zFar="'+a.getFar().toFixed(5)+'" description="'+
a._vf.description+'"&gt;&lt;/Viewpoint&gt;');break;case 119:c.setType("walk",this._viewarea);break;case 121:c.setType("freefly",this._viewarea)}};x3dom.X3DDocument.prototype.shutdown=function(a){a&&a.shutdown(this._viewarea)};
x3dom.MatrixMixer=function(a,c){0===arguments.length?(this._beginTime=0,this._endTime=1):(this._beginTime=a,this._endTime=c);this._beginMat=x3dom.fields.SFMatrix4f.identity();this._beginInvMat=x3dom.fields.SFMatrix4f.identity();this._beginLogMat=x3dom.fields.SFMatrix4f.identity();this._endMat=x3dom.fields.SFMatrix4f.identity();this._endLogMat=x3dom.fields.SFMatrix4f.identity()};
x3dom.MatrixMixer.prototype.calcFraction=function(a){return(Math.sin((a-this._beginTime)/(this._endTime-this._beginTime)*Math.PI-Math.PI/2)+1)/2};x3dom.MatrixMixer.prototype.setBeginMatrix=function(a){this._beginMat.setValues(a);this._beginInvMat=a.inverse();this._beginLogMat=x3dom.fields.SFMatrix4f.zeroMatrix()};
x3dom.MatrixMixer.prototype.setEndMatrix=function(a){this._endMat.setValues(a);this._endLogMat=a.mult(this._beginInvMat).log();this._logDiffMat=this._endLogMat.addScaled(this._beginLogMat,-1)};x3dom.MatrixMixer.prototype.mix=function(a){var c=null;a<=this._beginTime?c=x3dom.fields.SFMatrix4f.copy(this._beginLogMat):a>=this._endTime?c=x3dom.fields.SFMatrix4f.copy(this._endLogMat):(a=this.calcFraction(a),c=this._logDiffMat.multiply(a).add(this._beginLogMat));return c.exp().mult(this._beginMat)};
x3dom.Viewarea=function(a,c){this._doc=a;this._scene=c;a._nodeBag.viewarea.push(this);this._pickingInfo={pickPos:new x3dom.fields.SFVec3f(0,0,0),pickNorm:new x3dom.fields.SFVec3f(0,0,1),pickObj:null,firstObj:null,lastObj:null,lastClickObj:null,shadowObjectId:-1};this._rotMat=x3dom.fields.SFMatrix4f.identity();this._transMat=x3dom.fields.SFMatrix4f.identity();this._movement=new x3dom.fields.SFVec3f(0,0,0);this._needNavigationMatrixUpdate=!0;this._yaw=this._pitch=this._deltaT=0;this._eyePos=new x3dom.fields.SFVec3f(0,
0,0);this._width=400;this._height=300;this._dy=this._dx=0;this._pressY=this._pressX=this._lastY=this._lastX=-1;this._numRenderedNodes=this._points=this._lastButton=0;this._pick=new x3dom.fields.SFVec3f(0,0,0);this._pickNorm=new x3dom.fields.SFVec3f(0,0,1);this._isMoving=this._isAnimating=!1;this._lastTS=0;this._mixer=new x3dom.MatrixMixer;this.arc=null};
x3dom.Viewarea.prototype.tick=function(a){var c=!1;this._scene.getEnvironment()._vf.enableARC&&null==this.arc&&(this.arc=new x3dom.arc.AdaptiveRenderControl(this._scene));if(0<this._mixer._beginTime)if(c=!0,a>=this._mixer._beginTime)if(a<=this._mixer._endTime){var b=this._mixer.mix(a);this._scene.getViewpoint().setView(b)}else this._mixer._beginTime=0,this._mixer._endTime=0,this._scene.getViewpoint().setView(this._mixer._endMat);else this._mixer._beginTime=0,this._mixer._endTime=0,this._scene.getViewpoint().setView(this._mixer._beginMat);
var b=this.navigateTo(a),d=this._isAnimating;this._lastTS=a;this._isAnimating=c||b;null!=this.arc&&this.arc.update(this.isMovingOrAnimating()?1:0,this._doc._x3dElem.runtime.getFPS());return this._isAnimating||d};x3dom.Viewarea.prototype.isMoving=function(){return this._isMoving};x3dom.Viewarea.prototype.isAnimating=function(){return this._isAnimating};x3dom.Viewarea.prototype.isMovingOrAnimating=function(){return this._isMoving||this._isAnimating};
x3dom.Viewarea.prototype.navigateTo=function(a){var c=this._scene.getNavigationInfo(),b=c.getType(),d="game"===b||0<this._lastButton&&(0<=b.indexOf("fly")||"walk"===b||"helicopter"===b||"looka"===b.substr(0,5));this._deltaT=a-this._lastTS;if(d){var e=0.25;a=1.6;2<c._vf.avatarSize.length&&(e=c._vf.avatarSize[0],a=c._vf.avatarSize[1]);var f=this.getViewMatrix(),g=0,h=this._lastButton&2?-1:1,h=h*this._deltaT*c._vf.speed,k=Math.PI*this._deltaT*(this._pressX-this._lastX)/this._width,g=Math.PI*this._deltaT*
(this._pressY-this._lastY)/this._height;if(!0===this._needNavigationMatrixUpdate){this._needNavigationMatrixUpdate=!1;this._rotMat=x3dom.fields.SFMatrix4f.identity();this._transMat=x3dom.fields.SFMatrix4f.identity();this._movement=new x3dom.fields.SFVec3f(0,0,0);var l=0,n=Math.asin(f._02),q=Math.cos(n);1E-4<Math.abs(q)&&(l=Math.atan2(-f._12/q,f._22/q));this._flyMat=f.inverse();this._from=this._flyMat.e3();this._at=this._from.subtract(this._flyMat.e2());"helicopter"===b&&(this._at.y=this._from.y);
"looka"!==b.substr(0,5)?this._up=new x3dom.fields.SFVec3f(0,1,0):this._up=this._flyMat.e1();this._pitch=180*l/Math.PI;this._yaw=180*n/Math.PI;this._eyePos=this._from.negate()}f=l=f=null;if("game"===b)return this._pitch+=this._dy,this._yaw+=this._dx,89<=this._pitch&&(this._pitch=89),-89>=this._pitch&&(this._pitch=-89),360<=this._yaw&&(this._yaw-=360),0>this._yaw&&(this._yaw=360+this._yaw),this._dy=this._dx=0,h=x3dom.fields.SFMatrix4f.rotationX(this._pitch/180*Math.PI),b=x3dom.fields.SFMatrix4f.rotationY(this._yaw/
180*Math.PI),e=x3dom.fields.SFMatrix4f.translation(this._eyePos),this._flyMat=h.mult(b).mult(e),h=this._flyMat.inverse(),b=h.e3(),l=new x3dom.fields.SFVec3f(0,-1,0),f=b.add(l),l=h.e0().cross(l).normalize(),f=x3dom.fields.SFMatrix4f.lookAt(b,f,l),f=f.inverse(),this._scene._nameSpace.doc.ctx.pickValue(this,this._width/2,this._height/2,this._lastButton,f,this.getProjectionMatrix().mult(f)),this._pickingInfo.pickObj&&(g=this._pickingInfo.pickPos.subtract(b).length(),b.y+=a-g,h.setTranslate(b),this._eyePos=
h.e3().negate(),this._flyMat=h.inverse(),this._pickingInfo.pickObj=null),this._scene.getViewpoint().setView(this._flyMat),d;if("helicopter"===b)return a=c.getTypeParams(),this._lastButton&2&&(b=this._deltaT*this._deltaT*c._vf.speed,b=0.1*b*(this._pressY-this._lastY)*Math.abs(this._pressY-this._lastY),a[1]+=b,c.setTypeParams(a)),h=this._lastButton&1?0.01*h*(this._pressY-this._lastY)*Math.abs(this._pressY-this._lastY):0,g=a[0],this._from.y=a[1],this._at.y=this._from.y,f=x3dom.fields.Quaternion.axisAngle(this._up,
k),f=f.toMatrix(),l=x3dom.fields.SFMatrix4f.translation(this._from),l=l.mult(f),f=x3dom.fields.SFMatrix4f.translation(this._from.negate()),l=l.mult(f),this._at=l.multMatrixPnt(this._at),f=this._at.subtract(this._from).normalize(),k=f.cross(this._up).normalize(),c=k.cross(f).normalize(),f=f.multiply(h),this._from=this._from.add(f),this._at=this._at.add(f),f=x3dom.fields.Quaternion.axisAngle(k,g),f=f.toMatrix(),l=x3dom.fields.SFMatrix4f.translation(this._from),l=l.mult(f),f=x3dom.fields.SFMatrix4f.translation(this._from.negate()),
l=l.mult(f),a=l.multMatrixPnt(this._at),this._flyMat=x3dom.fields.SFMatrix4f.lookAt(this._from,a,c),this._scene.getViewpoint().setView(this._flyMat.inverse()),d;f=x3dom.fields.Quaternion.axisAngle(this._up,k);f=f.toMatrix();l=x3dom.fields.SFMatrix4f.translation(this._from);l=l.mult(f);f=x3dom.fields.SFMatrix4f.translation(this._from.negate());l=l.mult(f);this._at=l.multMatrixPnt(this._at);f=this._at.subtract(this._from).normalize();k=f.cross(this._up).normalize();c=k.cross(f).normalize();f=x3dom.fields.Quaternion.axisAngle(k,
g);f=f.toMatrix();l=x3dom.fields.SFMatrix4f.translation(this._from);l=l.mult(f);f=x3dom.fields.SFMatrix4f.translation(this._from.negate());l=l.mult(f);this._at=l.multMatrixPnt(this._at);"looka"!==b.substr(0,5)&&(n=this.getProjectionMatrix(),"freefly"!==b&&(0>h?(f=new x3dom.fields.SFMatrix4f,f.setValue(this._last_mat_view.e0(),this._last_mat_view.e1(),this._last_mat_view.e2().negate(),this._last_mat_view.e3()),this._scene._nameSpace.doc.ctx.pickValue(this,this._width/2,this._height/2,this._lastButton,
f,n.mult(f))):this._scene._nameSpace.doc.ctx.pickValue(this,this._width/2,this._height/2,this._lastButton),this._pickingInfo.pickObj&&(g=this._pickingInfo.pickPos.subtract(this._from).length(),g<=e&&(h=0))),f=this._at.subtract(this._from).normalize().multiply(h),this._at=this._at.add(f),this._from=this._from.add(f),"walk"===b&&(f=this._from.addScaled(c,-1),l=k.cross(c.negate()).normalize(),f=x3dom.fields.SFMatrix4f.lookAt(this._from,f,l),f=f.inverse(),this._scene._nameSpace.doc.ctx.pickValue(this,
this._width/2,this._height/2,this._lastButton,f,n.mult(f)),this._pickingInfo.pickObj&&(g=this._pickingInfo.pickPos.subtract(this._from).length(),this._at=this._at.add(c.multiply(a-g)),this._from=this._from.add(c.multiply(a-g)))),this._pickingInfo.pickObj=null);this._flyMat=x3dom.fields.SFMatrix4f.lookAt(this._from,this._at,c);this._scene.getViewpoint().setView(this._flyMat.inverse())}return d};
x3dom.Viewarea.prototype.moveFwd=function(){var a=this._scene.getNavigationInfo();if("game"===a.getType()){var c=0.25;2<a._vf.avatarSize.length&&(c=a._vf.avatarSize[0]);var a=5*this._deltaT*a._vf.speed,b=this._yaw/180*Math.PI,d=this._pitch/180*Math.PI,e=0,e=this._flyMat.inverse();this._scene._nameSpace.doc.ctx.pickValue(this,this._width/2,this._height/2,this._lastButton);this._pickingInfo.pickObj&&(e=this._pickingInfo.pickPos.subtract(e.e3()).length(),e<=2*c||(this._eyePos.x-=Math.sin(b)*a,this._eyePos.z+=
Math.cos(b)*a,this._eyePos.y+=Math.sin(d)*a))}};x3dom.Viewarea.prototype.moveBwd=function(){var a=this._scene.getNavigationInfo();if("game"===a.getType()){var a=5*this._deltaT*a._vf.speed,c=this._yaw/180*Math.PI,b=this._pitch/180*Math.PI;this._eyePos.x+=Math.sin(c)*a;this._eyePos.z-=Math.cos(c)*a;this._eyePos.y-=Math.sin(b)*a}};
x3dom.Viewarea.prototype.strafeRight=function(){var a=this._scene.getNavigationInfo();if("game"===a.getType()){var a=5*this._deltaT*a._vf.speed,c=this._yaw/180*Math.PI;this._eyePos.x-=Math.cos(c)*a;this._eyePos.z-=Math.sin(c)*a}};x3dom.Viewarea.prototype.strafeLeft=function(){var a=this._scene.getNavigationInfo();if("game"===a.getType()){var a=5*this._deltaT*a._vf.speed,c=this._yaw/180*Math.PI;this._eyePos.x+=Math.cos(c)*a;this._eyePos.z+=Math.sin(c)*a}};
x3dom.Viewarea.prototype.animateTo=function(a,c,b){var d=this._scene.getNavigationInfo();x3dom.isa(a,x3dom.nodeTypes.X3DViewpointNode)&&(a=a.getViewMatrix().mult(a.getCurrentTransform().inverse()));"teleport"!==d._vf.transitionType[0].toLowerCase()&&"game"!==d.getType()?c&&x3dom.isa(c,x3dom.nodeTypes.X3DViewpointNode)?(c=c.getViewMatrix().mult(c.getCurrentTransform().inverse()).mult(this._transMat).mult(this._rotMat),this._mixer._beginTime=this._lastTS,this._mixer._endTime=3<=arguments.length?this._lastTS+
b:this._lastTS+d._vf.transitionTime,this._mixer.setBeginMatrix(c),this._mixer.setEndMatrix(a),this._scene.getViewpoint().setView(c)):this._scene.getViewpoint().setView(a):this._scene.getViewpoint().setView(a);this._rotMat=x3dom.fields.SFMatrix4f.identity();this._transMat=x3dom.fields.SFMatrix4f.identity();this._movement=new x3dom.fields.SFVec3f(0,0,0);this._needNavigationMatrixUpdate=!0};
x3dom.Viewarea.prototype.getLights=function(){for(var a=[],c=0;c<this._doc._nodeBag.lights.length;c++)!0==this._doc._nodeBag.lights[c]._vf.on&&a.push(this._doc._nodeBag.lights[c]);return a};x3dom.Viewarea.prototype.getLightsShadow=function(){for(var a=this._doc._nodeBag.lights,c=0;c<a.length;c++)if(0<a[c]._vf.shadowIntensity)return!0;return!1};
x3dom.Viewarea.prototype.updateSpecialNavigation=function(a,c){var b=this._scene.getNavigationInfo();if("helicopter"==b.getType()&&!b._heliUpdated){var d=b.getTypeParams(),e=d[0],f=a.getViewMatrix().mult(c.inverse()).inverse();this._from=f.e3();this._at=this._from.subtract(f.e2());this._up=new x3dom.fields.SFVec3f(0,1,0);this._from.y=d[1];this._at.y=this._from.y;d=f.e0();e=x3dom.fields.Quaternion.axisAngle(d,e).toMatrix();d=x3dom.fields.SFMatrix4f.translation(this._from);d=d.mult(e);e=x3dom.fields.SFMatrix4f.translation(this._from.negate());
d=d.mult(e);this._at=d.multMatrixPnt(this._at);this._flyMat=x3dom.fields.SFMatrix4f.lookAt(this._from,this._at,this._up);this._scene.getViewpoint().setView(this._flyMat.inverse());b._heliUpdated=!0}};x3dom.Viewarea.prototype.getViewpointMatrix=function(){var a=this._scene.getViewpoint(),c=a.getCurrentTransform();this.updateSpecialNavigation(a,c);return a.getViewMatrix().mult(c.inverse())};x3dom.Viewarea.prototype.getViewMatrix=function(){return this.getViewpointMatrix().mult(this._transMat).mult(this._rotMat)};
x3dom.Viewarea.prototype.getLightMatrix=function(){var a=this._doc._nodeBag.lights,c,b=a.length;if(0<b){var d=this._scene.getVolume();if(d.isValid()){c=x3dom.fields.SFVec3f.MAX();var e=x3dom.fields.SFVec3f.MIN();d.getBounds(c,e);var d=[],f=this._scene.getViewpoint().getFieldOfView(),e=e.subtract(c),g=e.y/2/Math.tan(f/2)+e.z/2,f=e.x/2/Math.tan(f/2)+e.z/2,e=c.add(e.multiply(0.5));for(c=0;c<b;c++){if(x3dom.isa(a[c],x3dom.nodeTypes.PointLight))var h=a[c].getCurrentTransform().multMatrixPnt(a[c]._vf.location),
e=e.subtract(h).normalize();else h=a[c].getCurrentTransform().multMatrixVec(a[c]._vf.direction),h=h.normalize().negate(),e=e.add(h.multiply(1.2*(g>f?g:f)));d[c]=a[c].getViewMatrix(e)}return d}}return[this.getViewMatrix()]};x3dom.Viewarea.prototype.getWCtoLCMatrix=function(a){var c=this.getProjectionMatrix(),b;b=0===arguments.length?this.getLightMatrix()[0]:a;return c.mult(b)};
x3dom.Viewarea.prototype.getWCtoLCMatricesPointLight=function(a,c,b){c=this.getLightProjectionMatrix(a,c._vf.zNear,c._vf.zFar,!1,b);c._00=1;c._11=1;b=[];b[0]=c.mult(a);for(var d,e=1;3>=e;e++)d=x3dom.fields.SFMatrix4f.rotationY(e*Math.PI/2),b[e]=c.mult(d.mult(a));d=x3dom.fields.SFMatrix4f.rotationX(Math.PI/2);b[4]=c.mult(d.mult(a));d=x3dom.fields.SFMatrix4f.rotationX(3*Math.PI/2);b[5]=c.mult(d.mult(a));return b};
x3dom.Viewarea.prototype.getWCtoLCMatricesCascaded=function(a,c,b){var d=Math.max(1,Math.min(c._vf.shadowCascades,6)),e=Math.max(0,Math.min(c._vf.shadowSplitFactor,1)),f=Math.max(0,Math.min(c._vf.shadowSplitOffset,1)),g=x3dom.isa(c,x3dom.nodeTypes.SpotLight);c=this.getLightProjectionMatrix(a,c._vf.zNear,c._vf.zFar,!0,b);g&&(c._00=1,c._11=1);a=c.mult(a);g=[];if(1==d)return g[0]=a,g;e=this.getShadowSplitDepths(d,e,f,!0,b);for(f=0;f<d;f++)c=this.getLightFittingMatrix(a,e[f],e[f+1],b),g[f]=c.mult(a);
return g};x3dom.Viewarea.prototype.getLightProjectionMatrix=function(a,c,b,d,e){e=x3dom.fields.SFMatrix4f.copy(e);if(!d||0<c||0<b){d=a.inverse().e3();var f=x3dom.fields.SFVec3f.copy(this._scene._lastMin),g=x3dom.fields.SFVec3f.copy(this._scene._lastMax).subtract(f);a=g.length()/2;f=f.add(g.multiply(0.5));d=d.subtract(f).length();var h,k;a&&(h=d>a?0.8*(d-a):1,k=1.2*(d+a));0<c&&(h=c);0<b&&(k=b);e._22=-(k+h)/(k-h);e._23=-2*k*h/(k-h);return e}return this.getLightCropMatrix(e.mult(a)).mult(e)};
x3dom.Viewarea.prototype.getProjectionMatrix=function(){return this._scene.getViewpoint().getProjectionMatrix(this._width/this._height)};x3dom.Viewarea.prototype.getViewfrustum=function(a){if(!0==this._scene.getEnvironment()._vf.frustumCulling){if(0==arguments.length){var c=this.getProjectionMatrix(),b=this.getViewMatrix();return new x3dom.fields.FrustumVolume(c.mult(b))}return new x3dom.fields.FrustumVolume(a)}return null};
x3dom.Viewarea.prototype.getWCtoCCMatrix=function(){var a=this.getViewMatrix();return this.getProjectionMatrix().mult(a)};x3dom.Viewarea.prototype.getCCtoWCMatrix=function(){return this.getWCtoCCMatrix().inverse()};
x3dom.Viewarea.prototype.calcViewRay=function(a,c,b){b=b?b:this.getCCtoWCMatrix();a=a/(this._width-1)*2-1;var d=(this._height-1-c)/(this._height-1)*2-1;c=b.multFullMatrixPnt(new x3dom.fields.SFVec3f(a,d,-1));b=b.multFullMatrixPnt(new x3dom.fields.SFVec3f(a,d,1)).subtract(c);return new x3dom.fields.Line(c,b)};
x3dom.Viewarea.prototype.showAll=function(a){void 0===a&&(a="negZ");var c=this._scene;c.updateVolume();var b=x3dom.fields.SFVec3f.copy(c._lastMin),d=x3dom.fields.SFVec3f.copy(c._lastMax),e="x",f="y",g="z",h=1,k=new x3dom.fields.SFVec3f(0,0,-1);switch(a){case "posX":h=-1;case "negX":g="x";e="y";f="z";a=new x3dom.fields.SFVec3f(h,0,0);break;case "posY":h=-1;case "negY":g="y";e="z";f="x";a=new x3dom.fields.SFVec3f(0,h,0);break;case "posZ":h=-1;default:a=new x3dom.fields.SFVec3f(0,0,-h)}var c=c.getViewpoint(),
l=c.getFieldOfView(),d=d.subtract(b),n=d[g]/2,l=Math.tan(l/2),f=d[f]/2/l+n,e=d[e]/2/l+n,d=b.add(d.multiply(0.5));d[g]+=h*(f>e?f:e)*1.01;b=x3dom.fields.Quaternion.rotateFromTo(k,a).toMatrix();b=b.mult(x3dom.fields.SFMatrix4f.translation(d.negate()));this.animateTo(b,c)};
x3dom.Viewarea.prototype.resetView=function(){var a=this._scene.getNavigationInfo();if("teleport"!==a._vf.transitionType[0].toLowerCase()&&"game"!==a.getType()){this._mixer._beginTime=this._lastTS;this._mixer._endTime=this._lastTS+a._vf.transitionTime;this._mixer.setBeginMatrix(this.getViewMatrix());var c=this._scene.getViewpoint();c.resetView();c=c.getViewMatrix().mult(c.getCurrentTransform().inverse());this._mixer.setEndMatrix(c)}else this._scene.getViewpoint().resetView();this._rotMat=x3dom.fields.SFMatrix4f.identity();
this._transMat=x3dom.fields.SFMatrix4f.identity();this._movement=new x3dom.fields.SFVec3f(0,0,0);this._needNavigationMatrixUpdate=!0;a._heliUpdated=!1};x3dom.Viewarea.prototype.uprightView=function(){var a=this.getViewMatrix().inverse(),c=a.e3(),b=c.subtract(a.e2()),d=new x3dom.fields.SFVec3f(0,1,0),a=a.e2().cross(d).normalize().cross(d).normalize(),b=c.add(a),a=x3dom.fields.SFMatrix4f.lookAt(c,b,d),a=a.inverse();this.animateTo(a,this._scene.getViewpoint())};
x3dom.Viewarea.prototype.callEvtHandler=function(a,c,b){if(!a||!a._xmlNode)return null;b.target=a._xmlNode;var d=a._xmlNode[c];try{if("function"===typeof d)d.call(a._xmlNode,b);else{var e=a._xmlNode.getAttribute(c);(new Function("event",e)).call(a._xmlNode,b)}var f=a._listeners[b.type];if(f)for(c=0;c<f.length;c++)f[c].call(a._xmlNode,b)}catch(g){x3dom.debug.logException(g)}return b.cancelBubble};
x3dom.Viewarea.prototype.checkEvents=function(a,c,b,d,e){var f=this,g=!0,h={target:{},type:e.substr(2,e.length-2),button:d,layerX:c,layerY:b,worldX:f._pick.x,worldY:f._pick.y,worldZ:f._pick.z,normalX:f._pickNorm.x,normalY:f._pickNorm.y,normalZ:f._pickNorm.z,hitPnt:f._pick.toGL(),hitObject:a&&a._xmlNode?a._xmlNode:null,shadowObjectId:f._pickingInfo.shadowObjectId,cancelBubble:!1,stopPropagation:function(){this.cancelBubble=!0},preventDefault:function(){this.cancelBubble=!0}};try{(c=a)&&c._xmlNode&&
c._cf.geometry&&!c._xmlNode[e]&&!c._xmlNode.hasAttribute(e)&&!c._listeners[h.type]&&(c=c._cf.geometry.node),c&&!0===f.callEvtHandler(c,e,h)&&(g=!1)}catch(k){x3dom.debug.logException(k)}var l=function(a){Array.forEach(a._parentNodes,function(a){a._xmlNode&&(a._xmlNode[e]||a._xmlNode.hasAttribute(e)||a._listeners[h.type])&&!0===f.callEvtHandler(a,e,h)&&(g=!1);x3dom.isa(a,x3dom.nodeTypes.Anchor)&&"onclick"===e?(a.handleTouch(),g=!1):g&&l(a)})};g&&a&&l(a);return g};
x3dom.Viewarea.prototype.initMouseState=function(){this._dy=this._dx=this._deltaT=0;this._pressY=this._pressX=this._lastY=this._lastX=-1;this._lastButton=0;this._isMoving=!1;this._needNavigationMatrixUpdate=!0};
x3dom.Viewarea.prototype.onMousePress=function(a,c,b){this._needNavigationMatrixUpdate=!0;this.prepareEvents(a,c,b,"onmousedown");this._pickingInfo.lastClickObj=this._pickingInfo.pickObj;this._pickingInfo.firstObj=this._pickingInfo.pickObj;this._dy=this._dx=0;this._lastX=a;this._lastY=c;this._pressX=a;this._pressY=c;this._lastButton=b;this._isMoving=!1;c=this._scene.getNavigationInfo();if("turntable"===c.getType()){b=this.getViewMatrix();a=this._scene.getViewpoint();var d=x3dom.fields.SFVec3f.copy(a.getCenterOfRotation());
this._flyMat=b.inverse();this._from=this._flyMat.e3();this._at=d;this._up=this._flyMat.e1();this._flyMat=x3dom.fields.SFMatrix4f.lookAt(this._from,this._at,this._up);c=0.2/c._vf.speed;this.animateTo(this._flyMat.inverse(),a,c)}};
x3dom.Viewarea.prototype.onMouseRelease=function(a,c,b,d){var e=this._scene.getNavigationInfo(),f=e.getType();if("box"!==this._scene._vf.pickMode.toLowerCase())if(this.prepareEvents(a,c,d,"onmouseup"),this._pickingInfo.pickObj&&this._pickingInfo.pickObj===this._pickingInfo.lastClickObj)this.prepareEvents(a,c,d,"onclick");else{if(!this._pickingInfo.pickObj&&!this._pickingInfo.lastClickObj&&!this._pickingInfo.firstObj)try{this._scene._xmlNode&&(this._scene._xmlNode.onbackgroundClicked||this._scene._xmlNode.hasAttribute("onbackgroundClicked")||
this._scene._listeners.backgroundClicked)&&this._scene.callEvtHandler("onbackgroundClicked",{target:{},type:"backgroundClicked",button:d,layerX:a,layerY:c,cancelBubble:!1,stopPropagation:function(){this.cancelBubble=!0},preventDefault:function(){this.cancelBubble=!0}})}catch(g){x3dom.debug.logException("backgroundClicked: "+g)}}else{var h=(new Date).getTime(),k=this.calcViewRay(a,c);d=this._scene.doIntersect(k);var l=k.hitObject;d&&l&&(this._pick.setValues(k.hitPoint),this.checkEvents(l,a,c,b,"onclick"),
x3dom.debug.logInfo("Hit '"+l._xmlNode.localName+"/ "+l._DEF+"' at dist="+k.dist.toFixed(4)),x3dom.debug.logInfo("Ray hit at position "+this._pick));h=(new Date).getTime()-h;x3dom.debug.logInfo("Picking time (box): "+h+"ms");d||(d=this.getViewMatrix().e2().negate(),d=d.dot(k.pos.negate())/d.dot(k.dir),this._pick=k.pos.add(k.dir.multiply(d)))}this._pickingInfo.firstObj=null;if((this._pickingInfo.pickObj||0<=this._pickingInfo.shadowObjectId)&&"lookat"===f&&this._pressX===a&&this._pressY===c){k=this._lastButton&
2?-1:1;h=this._pickingInfo.pickPos.subtract(this._from).length()/3;d=new x3dom.fields.SFMatrix4f;d.setValues(this.getViewMatrix());d=d.inverse();f=d.e3();f.subtract(d.e2());l=d.e1();d=this._pickingInfo.pickPos.subtract(f);var n=d.length();d=d.normalize();var q=f.addScaled(d,n);d=d.cross(l).normalize().cross(l).normalize();0>k&&(h=2*(0.5+n+h));k=q.addScaled(d,h);d=x3dom.fields.SFMatrix4f.lookAt(k,q,l);d=d.inverse();h=k.subtract(f).length();e=Math.max(0.5,Math.log((1+h)/e._vf.speed));this.animateTo(d,
this._scene.getViewpoint(),e)}this._dy=this._dx=0;this._lastX=a;this._lastY=c;this._lastButton=b;this._isMoving=!1};x3dom.Viewarea.prototype.onMouseOver=function(a,c,b){this._lastButton=this._dy=this._dx=0;this._isMoving=!1;this._lastX=a;this._lastY=c;this._deltaT=0};x3dom.Viewarea.prototype.onMouseOut=function(a,c,b){this._lastButton=this._dy=this._dx=0;this._isMoving=!1;this._lastX=a;this._lastY=c;this._deltaT=0};
x3dom.Viewarea.prototype.onDoubleClick=function(a,c){if("true"!==this._doc.properties.getProperty("disableDoubleClick","false")&&"none"!=this._scene.getNavigationInfo().getType()){var b=this._scene._vf.pickMode.toLowerCase();if("color"!=b&&"texcoord"!=b){b=this._scene.getViewpoint();b._vf.centerOfRotation?b._vf.centerOfRotation.setValues(this._pick):b._centerOfRotation.setValues(this._pick);x3dom.debug.logInfo("New center of Rotation:  "+this._pick);var d=this.getViewMatrix().inverse(),e=d.e3(),f=
this._pick,g=d.e1(),d=d.e0().cross(g).normalize(),e=d.dot(this._pick.subtract(e)),e=f.addScaled(d,-e),d=x3dom.fields.SFMatrix4f.lookAt(e,f,g);x3dom.debug.logInfo("New camera position:  "+e);this.animateTo(d.inverse(),b)}}};
x3dom.Viewarea.prototype.handleMoveEvt=function(a,c,b){this.prepareEvents(a,c,b,"onmousemove");if(this._pickingInfo.pickObj!==this._pickingInfo.lastObj){if(this._pickingInfo.lastObj){var d=this._pickingInfo.pickObj;this._pickingInfo.pickObj=this._pickingInfo.lastObj;this.prepareEvents(a,c,b,"onmouseout");this._pickingInfo.pickObj=d}this._pickingInfo.pickObj&&this.prepareEvents(a,c,b,"onmouseover");this._pickingInfo.lastObj=this._pickingInfo.pickObj}};
x3dom.Viewarea.prototype.onMove=function(a,c,b){this.handleMoveEvt(a,c,b);if(0>this._lastX||0>this._lastY)this._lastX=a,this._lastY=c;this._dx=a-this._lastX;this._dy=c-this._lastY;this._lastX=a;this._lastY=c};
x3dom.Viewarea.prototype.onMoveView=function(a,c){var b=this._scene.getNavigationInfo(),d=this._scene.getViewpoint();if("examine"===b.getType()){if(a){var e=this._scene._lastMax.subtract(this._scene._lastMin).length(),e=(e<x3dom.fields.Eps?1:e)*b._vf.speed;a=a.multiply(e);this._movement=this._movement.add(a);this._transMat=d.getViewMatrix().inverse().mult(x3dom.fields.SFMatrix4f.translation(this._movement)).mult(d.getViewMatrix())}c&&(b=d.getCenterOfRotation(),d=this.getViewMatrix(),d.setTranslate(new x3dom.fields.SFVec3f(0,
0,0)),this._rotMat=this._rotMat.mult(x3dom.fields.SFMatrix4f.translation(b)).mult(d.inverse()).mult(c).mult(d).mult(x3dom.fields.SFMatrix4f.translation(b.negate())));this._isMoving=!0}};
x3dom.Viewarea.prototype.onDrag=function(a,c,b){this.handleMoveEvt(a,c,b);var d=this._scene.getNavigationInfo(),e=d.getType(),f=d.getExplorationMode();if("none"!==e&&0!=f){var g=this._scene.getViewpoint(),h=a-this._lastX,k=c-this._lastY,l;l=null;var n;b=(f&b)!=b?f:b;"examine"===e?(b&1&&(n=2*k*Math.PI/this._width,f=2*h*Math.PI/this._height,l=this.getViewMatrix(),e=x3dom.fields.SFMatrix4f.rotationX(n),f=x3dom.fields.SFMatrix4f.rotationY(f),g=g.getCenterOfRotation(),l.setTranslate(new x3dom.fields.SFVec3f(0,
0,0)),this._rotMat=this._rotMat.mult(x3dom.fields.SFMatrix4f.translation(g)).mult(l.inverse()).mult(e).mult(f).mult(l).mult(x3dom.fields.SFMatrix4f.translation(g.negate()))),b&4&&(l=this._scene._lastMax.subtract(this._scene._lastMin).length(),l=(l<x3dom.fields.Eps?1:l)*d._vf.speed,g=new x3dom.fields.SFVec3f(l*h/this._width,l*-k/this._height,0),this._movement=this._movement.add(g),l=this.getViewpointMatrix().mult(this._transMat),this._transMat=l.inverse().mult(x3dom.fields.SFMatrix4f.translation(this._movement)).mult(l)),
b&2&&(l=this._scene._lastMax.subtract(this._scene._lastMin).length(),l=(l<x3dom.fields.Eps?1:l)*d._vf.speed,g=new x3dom.fields.SFVec3f(0,0,l*(h+k)/this._height),this._movement=this._movement.add(g),l=this.getViewpointMatrix().mult(this._transMat),this._transMat=l.inverse().mult(x3dom.fields.SFMatrix4f.translation(this._movement)).mult(l)),this._isMoving=!0):"turntable"===e&&(b&1?(n=2*k*Math.PI/this._height,f=2*h*Math.PI/this._width,this._up=this._flyMat.e1(),this._from=this._flyMat.e3(),b=this._from.subtract(this._at),
l=Math.atan2(b.x,b.z),e=Math.atan2(Math.sqrt(b.x*b.x+b.z*b.z),b.y),l-=Math.min(f,0.1),e-=Math.min(n,0.1),d=d.getTypeParams(),e=Math.max(d[2],Math.min(d[3],e)),d=b.length(),f=d*Math.sin(e),b.x=f*Math.sin(l),b.y=d*Math.cos(e),b.z=f*Math.cos(l),b=this._at.add(b),e-=Math.PI/2,d=Math.sin(e),e=Math.cos(e),d=new x3dom.fields.SFVec3f(d*Math.sin(l),e,d*Math.cos(l)),0>d.y&&(d=d.negate()),this._flyMat=x3dom.fields.SFMatrix4f.lookAt(b,this._at,d),g.setView(this._flyMat.inverse())):b&2&&(l=this._scene._lastMax.subtract(this._scene._lastMin).length(),
l=(l<x3dom.fields.Eps?1:l)*d._vf.speed,this._up=this._flyMat.e1(),this._from=this._flyMat.e3(),d=this._from.subtract(this._at),b=d.length(),b=Math.max(b+-l*(h+k)/this._height,1),this._from=this._at.addScaled(d.normalize(),b),this._flyMat=x3dom.fields.SFMatrix4f.lookAt(this._from,this._at,this._up),g.setView(this._flyMat.inverse())),this._isMoving=!0);this._dx=h;this._dy=k;this._lastX=a;this._lastY=c}};
x3dom.Viewarea.prototype.prepareEvents=function(a,c,b,d){var e=this._scene._vf.pickMode.toLowerCase();if(0==e.indexOf("idbuf")||"color"==e||"texcoord"==e)if(e=this._pickingInfo.pickObj)this._pick.setValues(this._pickingInfo.pickPos),this._pickNorm.setValues(this._pickingInfo.pickNorm),this.checkEvents(e,a,c,b,d),"onclick"===d&&(e._xmlNode&&x3dom.debug.logInfo('Hit "'+e._xmlNode.localName+"/ "+e._DEF+'"'),x3dom.debug.logInfo("Ray hit at position "+this._pick))};
x3dom.Viewarea.prototype.getRenderMode=function(){return this._points};x3dom.Viewarea.prototype.getShadowedLights=function(){for(var a=[],c=0,b=this.getLights(),d=0;d<b.length;d++)0<b[d]._vf.shadowIntensity&&(a[c]=b[d],c++);return a};
x3dom.Viewarea.prototype.getShadowSplitDepths=function(a,c,b,d,e){var f=[],g=this._scene.getViewpoint(),h=g.getNear(),g=g.getFar();f[0]=h;for(var h=h+b*(g-h)/10,k=1;k<a;k++)b=h*Math.pow(g/h,k/a),f[k]=c*b+(1-c)*(h+k/(a*(h-g)));f[a]=g;if(!d)return f;c=[];for(d=0;d<=a;d++)c[d]=e.multFullMatrixPnt(new x3dom.fields.SFVec3f(0,0,-f[d])).z;return c};
x3dom.Viewarea.prototype.getLightCropMatrix=function(a){var c=x3dom.fields.SFVec3f.copy(this._scene._lastMin),b=x3dom.fields.SFVec3f.copy(this._scene._lastMax),d=[];d[0]=new x3dom.fields.SFVec3f(c.x,c.y,c.z);d[1]=new x3dom.fields.SFVec3f(c.x,c.y,b.z);d[2]=new x3dom.fields.SFVec3f(c.x,b.y,c.z);d[3]=new x3dom.fields.SFVec3f(c.x,b.y,b.z);d[4]=new x3dom.fields.SFVec3f(b.x,c.y,c.z);d[5]=new x3dom.fields.SFVec3f(b.x,c.y,b.z);d[6]=new x3dom.fields.SFVec3f(b.x,b.y,c.z);d[7]=new x3dom.fields.SFVec3f(b.x,b.y,
b.z);for(c=0;8>c;c++)d[c]=a.multFullMatrixPnt(d[c]);a=x3dom.fields.SFVec3f.copy(d[0]);b=x3dom.fields.SFVec3f.copy(d[0]);for(c=1;8>c;c++)a.z=Math.min(d[c].z,a.z),b.z=Math.max(d[c].z,b.z);d=2/(b.z-a.z);a=-(d*(b.z+a.z))/2;c=x3dom.fields.SFMatrix4f.identity();c._22=d;c._23=a;return c};
x3dom.Viewarea.prototype.getLightFittingMatrix=function(a,c,b,d){var e=this.getViewMatrix(),e=d.mult(e).inverse();d=[];d[0]=new x3dom.fields.SFVec3f(-1,-1,b);d[1]=new x3dom.fields.SFVec3f(-1,-1,c);d[2]=new x3dom.fields.SFVec3f(-1,1,b);d[3]=new x3dom.fields.SFVec3f(-1,1,c);d[4]=new x3dom.fields.SFVec3f(1,-1,b);d[5]=new x3dom.fields.SFVec3f(1,-1,c);d[6]=new x3dom.fields.SFVec3f(1,1,b);d[7]=new x3dom.fields.SFVec3f(1,1,c);for(c=0;8>c;c++)d[c]=e.multFullMatrixPnt(d[c]),d[c]=a.multFullMatrixPnt(d[c]);
b=x3dom.fields.SFVec3f.copy(d[0]);a=x3dom.fields.SFVec3f.copy(d[0]);for(c=1;8>c;c++)b.x=Math.min(d[c].x,b.x),b.y=Math.min(d[c].y,b.y),b.z=Math.min(d[c].z,b.z),a.x=Math.max(d[c].x,a.x),a.y=Math.max(d[c].y,a.y),a.z=Math.max(d[c].z,a.z);d=b.x;c=b.y;var f=b.z;b=a.x;e=a.y;a=a.z;1<d||-1>b?(d=-1,b=1):(d=Math.max(d,-1),b=Math.min(b,1));1<c||-1>e?(c=-1,e=1):(c=Math.max(c,-1),e=Math.min(e,1));1<f||-1>a?(f=-1,a=1):(f=Math.max(f,-1),a=Math.min(a,1));d=new x3dom.fields.SFVec3f(d,c,f);a=new x3dom.fields.SFVec3f(b,
e,a);b=new x3dom.fields.BoxVolume(d,a);a=2/(b.max.x-b.min.x);d=2/(b.max.y-b.min.y);c=-(a*(b.max.x+b.min.x))/2;b=-(d*(b.max.y+b.min.y))/2;e=x3dom.fields.SFMatrix4f.identity();e._00=a;e._11=d;e._03=c;e._13=b;return e};
x3dom.Mesh=function(a){this._parent=a;this._vol=new x3dom.fields.BoxVolume;this._invalidate=!0;this._numCoords=this._numFaces=0;this._primType="TRIANGLES";this._positions=[];this._normals=[];this._texCoords=[];this._colors=[];this._indices=[];this._positions[0]=[];this._normals[0]=[];this._texCoords[0]=[];this._colors[0]=[];this._indices[0]=[]};x3dom.Mesh.prototype._dynamicFields={};x3dom.Mesh.prototype._numPosComponents=3;x3dom.Mesh.prototype._numTexComponents=2;
x3dom.Mesh.prototype._numColComponents=3;x3dom.Mesh.prototype._numNormComponents=3;x3dom.Mesh.prototype._lit=!0;x3dom.Mesh.prototype._vol=null;x3dom.Mesh.prototype._invalidate=!0;x3dom.Mesh.prototype._numFaces=0;x3dom.Mesh.prototype._numCoords=0;x3dom.Mesh.prototype.setMeshData=function(a,c,b,d,e){this._positions[0]=a;this._normals[0]=c;this._texCoords[0]=b;this._colors[0]=d;this._indices[0]=e;this._invalidate=!0;this._numFaces=this._indices[0].length/3;this._numCoords=this._positions[0].length/3};
x3dom.Mesh.prototype.getVolume=function(){if(!0==this._invalidate&&!this._vol.isValid()){var a=this._positions[0],c=a.length;if(3<c){var b=new x3dom.fields.SFVec3f(a[0],a[1],a[2]);this._vol.setBounds(b,b);for(b=3;b<c;b+=3)this._vol.min.x>a[b]&&(this._vol.min.x=a[b]),this._vol.min.y>a[b+1]&&(this._vol.min.y=a[b+1]),this._vol.min.z>a[b+2]&&(this._vol.min.z=a[b+2]),this._vol.max.x<a[b]&&(this._vol.max.x=a[b]),this._vol.max.y<a[b+1]&&(this._vol.max.y=a[b+1]),this._vol.max.z<a[b+2]&&(this._vol.max.z=a[b+
2]);this._invalidate=!1}}return this._vol};x3dom.Mesh.prototype.invalidate=function(){this._invalidate=!0;this._vol.invalidate()};x3dom.Mesh.prototype.isValid=function(){return this._vol.isValid()};x3dom.Mesh.prototype.getCenter=function(){return this.getVolume().getCenter()};x3dom.Mesh.prototype.getDiameter=function(){return this.getVolume().getDiameter()};
x3dom.Mesh.prototype.doIntersect=function(a){var c=this.getVolume();(c=a.intersect(c.min,c.max))&&a.enter<a.dist&&(a.dist=a.enter,a.hitObject=this._parent,a.hitPoint=a.pos.add(a.dir.multiply(a.enter)));return c};
x3dom.Mesh.prototype.calcNormals=function(a,c){void 0===c&&(c=!0);var b=this._multiIndIndices&&this._multiIndIndices.length,d=b?this._multiIndIndices:this._indices[0],e=this._positions[0],f=[],g=[],h,k=e.length,l,n;l=null;var q=void 0!==this._posSize&&this._posSize>k?this._posSize/3:k/3,q=3*(0<q-Math.floor(q)?Math.floor(q+1):q);for(h=0;h<q;++h)g[h]=[];q=d.length;for(h=0;h<q;h+=3){var m,p,s;b?(m=3*h,p=3*(h+1),s=3*(h+2),n=new x3dom.fields.SFVec3f(e[p],e[p+1],e[p+2]),l=(new x3dom.fields.SFVec3f(e[m],
e[m+1],e[m+2])).subtract(n),n=n.subtract(new x3dom.fields.SFVec3f(e[s],e[s+1],e[s+2]))):(m=3*d[h],p=3*d[h+1],s=3*d[h+2],n=new x3dom.fields.SFVec3f(e[p],e[p+1],e[p+2]),l=(new x3dom.fields.SFVec3f(e[m],e[m+1],e[m+2])).subtract(n),n=n.subtract(new x3dom.fields.SFVec3f(e[s],e[s+1],e[s+2])),m=3*h,p=3*(h+1),s=3*(h+2));l=l.cross(n).normalize();c||(l=l.negate());a<=x3dom.fields.Eps?(f[m]=f[p]=f[s]=l.x,f[m+1]=f[p+1]=f[s+1]=l.y,f[m+2]=f[p+2]=f[s+2]=l.z):(g[d[h]].push(l),g[d[h+1]].push(l),g[d[h+2]].push(l))}if(a>
x3dom.fields.Eps)for(h=0;h<k;h+=3){q=h/3;m=b?g[d[q]]:g[q];q=m.length;l=new x3dom.fields.SFVec3f(0,0,0);for(e=0;e<q;++e)l=l.add(m[e]);l=l.normalize();f[h]=l.x;f[h+1]=l.y;f[h+2]=l.z}this._normals[0]=f};
x3dom.Mesh.prototype.splitMesh=function(a){var c;c="undefined"==typeof a?3:a;a=x3dom.Utils.maxIndexableCoords;a=Math.floor(a/c)*c;if(!(this._positions[0].length/3<=a)){c=this._positions[0];var b=this._normals[0],d=this._texCoords[0],e=this._colors[0],f=this._indices[0],g=0;do{this._positions[g]=[];this._normals[g]=[];this._texCoords[g]=[];this._colors[g]=[];this._indices[g]=[];var h=0<=f.length-(g+1)*a;this._indices[g]=h?f.slice(g*a,(g+1)*a):f.slice(g*a);if(g)for(var k=g*a,l=0,n=this._indices[g].length;l<
n;l++)this._indices[g][l]-=k;this._positions[g]=h?c.slice(g*a*3,3*(g+1)*a):c.slice(g*a*3);b.length&&(this._normals[g]=h?b.slice(g*a*3,3*(g+1)*a):b.slice(g*a*3));d.length&&(this._texCoords[g]=h?d.slice(g*a*this._numTexComponents,this._numTexComponents*(g+1)*a):d.slice(g*a*this._numTexComponents));e.length&&(this._colors[g]=h?e.slice(g*a*this._numColComponents,this._numColComponents*(g+1)*a):e.slice(g*a*this._numColComponents))}while(c.length>++g*a*3)}};
x3dom.Mesh.prototype.calcTexCoords=function(a){this._texCoords[0]=[];if("sphere-local"===a.toLowerCase())for(var c=a=0,b=this._normals[0].length;a<b;a+=3)this._texCoords[0][c++]=0.5+this._normals[0][a]/2,this._texCoords[0][c++]=0.5+this._normals[0][a+1]/2;else{var d=new x3dom.fields.SFVec3f(0,0,0);a=new x3dom.fields.SFVec3f(0,0,0);this.getVolume().getBounds(d,a);var e=a.subtract(d);a=0;c=1;e.x>=e.y?e.x>=e.z?(a=0,c=e.y>=e.z?1:2):(a=2,c=0):e.y>=e.z?(a=1,c=e.x>=e.z?0:2):(a=2,c=1);var f=b=1,g=0,h=0;switch(a){case 0:b=
e.x;g=d.x;break;case 1:b=e.y;g=d.y;break;case 2:b=e.z,g=d.z}switch(c){case 0:f=e.x;h=d.x;break;case 1:f=e.y;h=d.y;break;case 2:f=e.z,h=d.z}for(var e=d=0,k=this._positions[0].length;d<k;d+=3)this._texCoords[0][e++]=(this._positions[0][d+a]-g)/b,this._texCoords[0][e++]=(this._positions[0][d+c]-h)/f}};
"undefined"===typeof x3dom&&(x3dom={extend:function(a){function c(){}c.prototype=a.prototype||a;return new c},debug:{logInfo:function(a){console.log(a)},logWarning:function(a){console.warn(a)},logError:function(a){console.error(a)}}},Array.map||(Array.map=function(a,c,b){for(var d=a.length,e=[],f=0;f<d;f++)f in a&&(e[f]=c.call(b,a[f],f,a));return e}),console.log("Using x3dom fields.js as standalone math and/or base types library."));x3dom.fields={};x3dom.fields.Eps=1E-6;
x3dom.fields.SFMatrix4f=function(a,c,b,d,e,f,g,h,k,l,n,q,m,p,s,t){0===arguments.length?(this._00=1,this._10=this._03=this._02=this._01=0,this._11=1,this._21=this._20=this._13=this._12=0,this._22=1,this._32=this._31=this._30=this._23=0,this._33=1):(this._00=a,this._01=c,this._02=b,this._03=d,this._10=e,this._11=f,this._12=g,this._13=h,this._20=k,this._21=l,this._22=n,this._23=q,this._30=m,this._31=p,this._32=s,this._33=t)};
x3dom.fields.SFMatrix4f.prototype.e0=function(){return(new x3dom.fields.SFVec3f(this._00,this._10,this._20)).normalize()};x3dom.fields.SFMatrix4f.prototype.e1=function(){return(new x3dom.fields.SFVec3f(this._01,this._11,this._21)).normalize()};x3dom.fields.SFMatrix4f.prototype.e2=function(){return(new x3dom.fields.SFVec3f(this._02,this._12,this._22)).normalize()};x3dom.fields.SFMatrix4f.prototype.e3=function(){return new x3dom.fields.SFVec3f(this._03,this._13,this._23)};
x3dom.fields.SFMatrix4f.copy=function(a){return new x3dom.fields.SFMatrix4f(a._00,a._01,a._02,a._03,a._10,a._11,a._12,a._13,a._20,a._21,a._22,a._23,a._30,a._31,a._32,a._33)};x3dom.fields.SFMatrix4f.identity=function(){return new x3dom.fields.SFMatrix4f(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)};x3dom.fields.SFMatrix4f.zeroMatrix=function(){return new x3dom.fields.SFMatrix4f(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)};
x3dom.fields.SFMatrix4f.translation=function(a){return new x3dom.fields.SFMatrix4f(1,0,0,a.x,0,1,0,a.y,0,0,1,a.z,0,0,0,1)};x3dom.fields.SFMatrix4f.rotationX=function(a){var c=Math.cos(a);a=Math.sin(a);return new x3dom.fields.SFMatrix4f(1,0,0,0,0,c,-a,0,0,a,c,0,0,0,0,1)};x3dom.fields.SFMatrix4f.rotationY=function(a){var c=Math.cos(a);a=Math.sin(a);return new x3dom.fields.SFMatrix4f(c,0,a,0,0,1,0,0,-a,0,c,0,0,0,0,1)};
x3dom.fields.SFMatrix4f.rotationZ=function(a){var c=Math.cos(a);a=Math.sin(a);return new x3dom.fields.SFMatrix4f(c,-a,0,0,a,c,0,0,0,0,1,0,0,0,0,1)};x3dom.fields.SFMatrix4f.scale=function(a){return new x3dom.fields.SFMatrix4f(a.x,0,0,0,0,a.y,0,0,0,0,a.z,0,0,0,0,1)};
x3dom.fields.SFMatrix4f.lookAt=function(a,c,b){c=a.subtract(c).normalize();b=b.normalize().cross(c);if(b.dot(b)<x3dom.fields.Eps)return x3dom.debug.logWarning("View matrix is linearly dependent."),x3dom.fields.SFMatrix4f.translation(a);var d=c.cross(b.normalize()).normalize(),e=x3dom.fields.SFMatrix4f.identity();e.setValue(b,d,c,a);return e};
x3dom.fields.SFMatrix4f.perspective=function(a,c,b,d){a=1/Math.tan(a/2);return new x3dom.fields.SFMatrix4f(a/c,0,0,0,0,a,0,0,0,0,(b+d)/(b-d),2*b*d/(b-d),0,0,-1,0)};x3dom.fields.SFMatrix4f.ortho=function(a,c,b,d,e,f,g){var h=(c-a)/2,k=(d-b)/2,l=f-e;void 0===g&&(g=1);g<h/k?k=h/g:h=k*g;a=-h;c=h;b=-k;d=k;h*=2;k*=2;return new x3dom.fields.SFMatrix4f(2/h,0,0,-(c+a)/h,0,2/k,0,-(d+b)/k,0,0,-2/l,-(f+e)/l,0,0,0,1)};
x3dom.fields.SFMatrix4f.prototype.setTranslate=function(a){this._03=a.x;this._13=a.y;this._23=a.z};x3dom.fields.SFMatrix4f.prototype.setScale=function(a){this._00=a.x;this._11=a.y;this._22=a.z};x3dom.fields.SFMatrix4f.prototype.setRotate=function(a){var c=a.x*a.x,b=a.x*a.y,d=a.x*a.z,e=a.y*a.y,f=a.y*a.z,g=a.z*a.z,h=a.w*a.x,k=a.w*a.y;a=a.w*a.z;this._00=1-2*(e+g);this._01=2*(b-a);this._02=2*(d+k);this._10=2*(b+a);this._11=1-2*(c+g);this._12=2*(f-h);this._20=2*(d-k);this._21=2*(f+h);this._22=1-2*(c+e)};
x3dom.fields.SFMatrix4f.parseRotation=function(a){var c=/^([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)$/.exec(a);a=+c[1];var b=+c[2],d=+c[3],e=+c[4],c=Math.sqrt(a*a+b*b+d*d);0===c?(a=1,b=d=0):(a/=c,b/=c,d/=c);var c=Math.cos(e),e=Math.sin(e),f=1-c;return(new x3dom.fields.SFMatrix4f(f*a*a+c,f*a*b+e*d,f*a*d-e*b,0,f*a*b-e*d,f*b*b+c,f*b*d+e*a,0,f*a*d+e*b,f*b*d-e*a,f*d*d+c,0,0,0,0,1)).transpose()};
x3dom.fields.SFMatrix4f.parse=function(a){var c=!1;/matrix.*\((.+)\)/.exec(a)&&(a=RegExp.$1,c=!0);var b=Array.map(a.split(/[,\s]+/),function(a){return+a});if(16<=b.length)return c?new x3dom.fields.SFMatrix4f(b[0],b[4],b[8],b[12],b[1],b[5],b[9],b[13],b[2],b[6],b[10],b[14],b[3],b[7],b[11],b[15]):new x3dom.fields.SFMatrix4f(b[0],b[1],b[2],b[3],b[4],b[5],b[6],b[7],b[8],b[9],b[10],b[11],b[12],b[13],b[14],b[15]);if(6===b.length)return new x3dom.fields.SFMatrix4f(b[0],b[1],0,b[4],b[2],b[3],0,b[5],0,0,1,
0,0,0,0,1);x3dom.debug.logWarning("SFMatrix4f - can't parse string: "+a);return x3dom.fields.SFMatrix4f.identity()};
x3dom.fields.SFMatrix4f.prototype.mult=function(a){return new x3dom.fields.SFMatrix4f(this._00*a._00+this._01*a._10+this._02*a._20+this._03*a._30,this._00*a._01+this._01*a._11+this._02*a._21+this._03*a._31,this._00*a._02+this._01*a._12+this._02*a._22+this._03*a._32,this._00*a._03+this._01*a._13+this._02*a._23+this._03*a._33,this._10*a._00+this._11*a._10+this._12*a._20+this._13*a._30,this._10*a._01+this._11*a._11+this._12*a._21+this._13*a._31,this._10*a._02+this._11*a._12+this._12*a._22+this._13*a._32,
this._10*a._03+this._11*a._13+this._12*a._23+this._13*a._33,this._20*a._00+this._21*a._10+this._22*a._20+this._23*a._30,this._20*a._01+this._21*a._11+this._22*a._21+this._23*a._31,this._20*a._02+this._21*a._12+this._22*a._22+this._23*a._32,this._20*a._03+this._21*a._13+this._22*a._23+this._23*a._33,this._30*a._00+this._31*a._10+this._32*a._20+this._33*a._30,this._30*a._01+this._31*a._11+this._32*a._21+this._33*a._31,this._30*a._02+this._31*a._12+this._32*a._22+this._33*a._32,this._30*a._03+this._31*
a._13+this._32*a._23+this._33*a._33)};x3dom.fields.SFMatrix4f.prototype.multMatrixPnt=function(a){return new x3dom.fields.SFVec3f(this._00*a.x+this._01*a.y+this._02*a.z+this._03,this._10*a.x+this._11*a.y+this._12*a.z+this._13,this._20*a.x+this._21*a.y+this._22*a.z+this._23)};x3dom.fields.SFMatrix4f.prototype.multMatrixVec=function(a){return new x3dom.fields.SFVec3f(this._00*a.x+this._01*a.y+this._02*a.z,this._10*a.x+this._11*a.y+this._12*a.z,this._20*a.x+this._21*a.y+this._22*a.z)};
x3dom.fields.SFMatrix4f.prototype.multFullMatrixPnt=function(a){var c=this._30*a.x+this._31*a.y+this._32*a.z+this._33;c&&(c=1/c);return new x3dom.fields.SFVec3f((this._00*a.x+this._01*a.y+this._02*a.z+this._03)*c,(this._10*a.x+this._11*a.y+this._12*a.z+this._13)*c,(this._20*a.x+this._21*a.y+this._22*a.z+this._23)*c)};
x3dom.fields.SFMatrix4f.prototype.transpose=function(){return new x3dom.fields.SFMatrix4f(this._00,this._10,this._20,this._30,this._01,this._11,this._21,this._31,this._02,this._12,this._22,this._32,this._03,this._13,this._23,this._33)};x3dom.fields.SFMatrix4f.prototype.negate=function(){return new x3dom.fields.SFMatrix4f(-this._00,-this._01,-this._02,-this._03,-this._10,-this._11,-this._12,-this._13,-this._20,-this._21,-this._22,-this._23,-this._30,-this._31,-this._32,-this._33)};
x3dom.fields.SFMatrix4f.prototype.multiply=function(a){return new x3dom.fields.SFMatrix4f(a*this._00,a*this._01,a*this._02,a*this._03,a*this._10,a*this._11,a*this._12,a*this._13,a*this._20,a*this._21,a*this._22,a*this._23,a*this._30,a*this._31,a*this._32,a*this._33)};
x3dom.fields.SFMatrix4f.prototype.add=function(a){return new x3dom.fields.SFMatrix4f(this._00+a._00,this._01+a._01,this._02+a._02,this._03+a._03,this._10+a._10,this._11+a._11,this._12+a._12,this._13+a._13,this._20+a._20,this._21+a._21,this._22+a._22,this._23+a._23,this._30+a._30,this._31+a._31,this._32+a._32,this._33+a._33)};
x3dom.fields.SFMatrix4f.prototype.addScaled=function(a,c){return new x3dom.fields.SFMatrix4f(this._00+c*a._00,this._01+c*a._01,this._02+c*a._02,this._03+c*a._03,this._10+c*a._10,this._11+c*a._11,this._12+c*a._12,this._13+c*a._13,this._20+c*a._20,this._21+c*a._21,this._22+c*a._22,this._23+c*a._23,this._30+c*a._30,this._31+c*a._31,this._32+c*a._32,this._33+c*a._33)};
x3dom.fields.SFMatrix4f.prototype.setValues=function(a){this._00=a._00;this._01=a._01;this._02=a._02;this._03=a._03;this._10=a._10;this._11=a._11;this._12=a._12;this._13=a._13;this._20=a._20;this._21=a._21;this._22=a._22;this._23=a._23;this._30=a._30;this._31=a._31;this._32=a._32;this._33=a._33};
x3dom.fields.SFMatrix4f.prototype.setValue=function(a,c,b,d){this._00=a.x;this._01=c.x;this._02=b.x;this._10=a.y;this._11=c.y;this._12=b.y;this._20=a.z;this._21=c.z;this._22=b.z;this._32=this._31=this._30=0;3<arguments.length&&(this._03=d.x,this._13=d.y,this._23=d.z,this._33=1)};
x3dom.fields.SFMatrix4f.prototype.setFromArray=function(a){this._00=a[0];this._01=a[4];this._02=a[8];this._03=a[12];this._10=a[1];this._11=a[5];this._12=a[9];this._13=a[13];this._20=a[2];this._21=a[6];this._22=a[10];this._23=a[14];this._30=a[3];this._31=a[7];this._32=a[11];this._33=a[15]};x3dom.fields.SFMatrix4f.prototype.toGL=function(){return[this._00,this._10,this._20,this._30,this._01,this._11,this._21,this._31,this._02,this._12,this._22,this._32,this._03,this._13,this._23,this._33]};
x3dom.fields.SFMatrix4f.prototype.at=function(a,c){return this["_"+a+c]};x3dom.fields.SFMatrix4f.prototype.sqrt=function(){for(var a=x3dom.fields.SFMatrix4f.identity(),c=x3dom.fields.SFMatrix4f.copy(this),b=0;6>b;b++)var d=c.inverse(),e=0==b?x3dom.fields.SFMatrix4f.identity():a.inverse(),f=c.det(),g=a.det(),f=Math.abs(Math.pow(f*g,-0.125)),g=1/f,c=c.multiply(f),c=c.addScaled(e,g),c=c.multiply(0.5),a=a.multiply(f),a=a.addScaled(d,g),a=a.multiply(0.5);return c};
x3dom.fields.SFMatrix4f.prototype.normInfinity=function(){var a=0,c=0;(a=Math.abs(this._00))>c&&(c=a);(a=Math.abs(this._01))>c&&(c=a);(a=Math.abs(this._02))>c&&(c=a);(a=Math.abs(this._03))>c&&(c=a);(a=Math.abs(this._10))>c&&(c=a);(a=Math.abs(this._11))>c&&(c=a);(a=Math.abs(this._12))>c&&(c=a);(a=Math.abs(this._13))>c&&(c=a);(a=Math.abs(this._20))>c&&(c=a);(a=Math.abs(this._21))>c&&(c=a);(a=Math.abs(this._22))>c&&(c=a);(a=Math.abs(this._23))>c&&(c=a);(a=Math.abs(this._30))>c&&(c=a);(a=Math.abs(this._31))>
c&&(c=a);(a=Math.abs(this._32))>c&&(c=a);(a=Math.abs(this._33))>c&&(c=a);return c};x3dom.fields.SFMatrix4f.prototype.norm1_3x3=function(){var a=Math.abs(this._00)+Math.abs(this._10)+Math.abs(this._20),c=0;(c=Math.abs(this._01)+Math.abs(this._11)+Math.abs(this._21))>a&&(a=c);(c=Math.abs(this._02)+Math.abs(this._12)+Math.abs(this._22))>a&&(a=c);return a};
x3dom.fields.SFMatrix4f.prototype.normInf_3x3=function(){var a=Math.abs(this._00)+Math.abs(this._01)+Math.abs(this._02),c=0;(c=Math.abs(this._10)+Math.abs(this._11)+Math.abs(this._12))>a&&(a=c);(c=Math.abs(this._20)+Math.abs(this._21)+Math.abs(this._22))>a&&(a=c);return a};
x3dom.fields.SFMatrix4f.prototype.adjointT_3x3=function(){var a=x3dom.fields.SFMatrix4f.identity();a._00=this._11*this._22-this._12*this._21;a._01=this._12*this._20-this._10*this._22;a._02=this._10*this._21-this._11*this._20;a._10=this._21*this._02-this._22*this._01;a._11=this._22*this._00-this._20*this._02;a._12=this._20*this._01-this._21*this._00;a._20=this._01*this._12-this._02*this._11;a._21=this._02*this._10-this._00*this._12;a._22=this._00*this._11-this._01*this._10;return a};
x3dom.fields.SFMatrix4f.prototype.equals=function(a){return 1E-12>Math.abs(this._00-a._00)&&1E-12>Math.abs(this._01-a._01)&&1E-12>Math.abs(this._02-a._02)&&1E-12>Math.abs(this._03-a._03)&&1E-12>Math.abs(this._10-a._10)&&1E-12>Math.abs(this._11-a._11)&&1E-12>Math.abs(this._12-a._12)&&1E-12>Math.abs(this._13-a._13)&&1E-12>Math.abs(this._20-a._20)&&1E-12>Math.abs(this._21-a._21)&&1E-12>Math.abs(this._22-a._22)&&1E-12>Math.abs(this._23-a._23)&&1E-12>Math.abs(this._30-a._30)&&1E-12>Math.abs(this._31-a._31)&&
1E-12>Math.abs(this._32-a._32)&&1E-12>Math.abs(this._33-a._33)};x3dom.fields.SFMatrix4f.prototype.getTransform=function(a,c,b,d,e){var f=null;if(4<arguments.length)var f=x3dom.fields.SFMatrix4f.translation(e.negate()),f=f.mult(this),g=x3dom.fields.SFMatrix4f.translation(e),f=f.mult(g);else f=x3dom.fields.SFMatrix4f.copy(this);f=f.decompose(a,c,b,d);b.setValues(b.multiply(f))};
x3dom.fields.SFMatrix4f.prototype.decompose=function(a,c,b,d){var e=x3dom.fields.SFMatrix4f.copy(this),f=x3dom.fields.SFMatrix4f.identity(),g=x3dom.fields.SFMatrix4f.identity(),h=x3dom.fields.SFMatrix4f.identity();a.x=e._03;a.y=e._13;a.z=e._23;e._03=0;e._13=0;e._23=0;e._30=0;e._31=0;e._32=0;a=1;0>e.polarDecompose(f,g)&&(f=f.negate(),a=-1);c.setValue(f);g.spectralDecompose(h,b);d.setValue(h);return a};
x3dom.fields.SFMatrix4f.prototype.polarDecompose=function(a,c){var b=this.transpose(),d=x3dom.fields.SFMatrix4f.identity(),e=b.norm1_3x3(),f=b.normInf_3x3(),g,h,k,l;do{g=b.adjointT_3x3();l=b._00*g._00+b._01*g._01+b._02*g._02;if(0==l){x3dom.debug.logWarning("polarDecompose: Mk_det == 0.0");break}h=g.norm1_3x3();k=g.normInf_3x3();f=Math.sqrt(Math.sqrt(h*k/(e*f))/Math.abs(l));e=0.5*f;f=0.5/(f*l);d.setValues(b);b=b.multiply(e);b=b.addScaled(g,f);d=d.addScaled(b,-1);g=d.norm1_3x3();e=b.norm1_3x3();f=b.normInf_3x3()}while(g>
1E-12*e);a.setValues(b.transpose());c.setValues(b.mult(this));for(b=0;3>b;++b)for(d=b;3>d;++d)c["_"+d+b]=0.5*(c["_"+d+b]+c["_"+b+d]),c["_"+b+d]=0.5*(c["_"+d+b]+c["_"+b+d]);return l};
x3dom.fields.SFMatrix4f.prototype.spectralDecompose=function(a,c){for(var b=[1,2,0],d=[this._00,this._11,this._22],e=[this._12,this._20,this._01],f=0;20>f&&0!=Math.abs(e[0])+Math.abs(e[1])+Math.abs(e[2]);++f)for(var g=2;0<=g;--g){var h=b[g],k=b[h],l=Math.abs(e[g]),n=100*l;if(0<l){var q=0,l=d[k]-d[h],q=Math.abs(l);q+n==q?q=e[g]/l:(n=0.5*l/e[g],q=1/(Math.abs(n)+Math.sqrt(n*n+1)),q=0>n?-q:q);l=1/Math.sqrt(q*q+1);n=q*l;l=n/(l+1);q*=e[g];e[g]=0;d[h]-=q;d[k]+=q;q=e[k];e[k]-=n*(e[h]+l*q);e[h]+=n*(q-l*e[h]);
for(q=2;0<=q;--q){var m=a["_"+q+h],p=a["_"+q+k];a["_"+q+h]-=n*(p+l*m);a["_"+q+k]+=n*(m-l*p)}}}c.x=d[0];c.y=d[1];c.z=d[2]};
x3dom.fields.SFMatrix4f.prototype.log=function(){var a=x3dom.fields.SFMatrix4f.copy(this),c=x3dom.fields.SFMatrix4f.copy(this);c._00-=1;c._11-=1;c._22-=1;c._33-=1;for(var b=0;0.5<c.normInfinity();)a=a.sqrt(),c.setValues(a),c._00-=1,c._11-=1,c._22-=1,c._33-=1,b++;a._00-=1;a._11-=1;a._22-=1;a._33-=1;a=a.negate();c.setValues(a);for(var d=x3dom.fields.SFMatrix4f.copy(a),e=1;1E-12<c.normInfinity()&&12>e;)c=c.mult(a),e++,d=d.addScaled(c,1/e);return d.multiply(-(1<<b))};
x3dom.fields.SFMatrix4f.prototype.exp=function(){var a=x3dom.fields.SFMatrix4f.copy(this),c=x3dom.fields.SFMatrix4f.identity(),b=x3dom.fields.SFMatrix4f.identity(),d=x3dom.fields.SFMatrix4f.identity(),e=0,f=1,g=1+parseInt(Math.log(a.normInfinity()/0.693));0>g&&(g=0);a=a.multiply(1/(1<<g));for(e=1;6>=e;e++)f*=(6-e+1)/(e*(12-e+1)),d=a.mult(d),b=b.addScaled(d,f),c=e%2?c.addScaled(d,-f):c.addScaled(d,f);d=c.inverse().mult(b);for(e=0;e<g;e++)d=d.mult(d);return d};
x3dom.fields.SFMatrix4f.prototype.det3=function(a,c,b,d,e,f,g,h,k){return a*e*k+c*f*g+b*d*h-a*f*h-c*d*k-b*e*g};x3dom.fields.SFMatrix4f.prototype.det=function(){var a=this._10,c=this._20,b=this._30,d=this._01,e=this._11,f=this._21,g=this._31,h=this._02,k=this._12,l=this._22,n=this._32,q=this._03,m=this._13,p=this._23,s=this._33;return this._00*this.det3(e,k,m,f,l,p,g,n,s)-a*this.det3(d,h,q,f,l,p,g,n,s)+c*this.det3(d,h,q,e,k,m,g,n,s)-b*this.det3(d,h,q,e,k,m,f,l,p)};
x3dom.fields.SFMatrix4f.prototype.inverse=function(){var a=this._00,c=this._10,b=this._20,d=this._30,e=this._01,f=this._11,g=this._21,h=this._31,k=this._02,l=this._12,n=this._22,q=this._32,m=this._03,p=this._13,s=this._23,t=this._33,w=this.det();if(0==w)return x3dom.debug.logWarning("Invert matrix: singular matrix, no inverse!"),x3dom.fields.SFMatrix4f.identity();w=1/w;return new x3dom.fields.SFMatrix4f(+this.det3(f,l,p,g,n,s,h,q,t)*w,-this.det3(e,k,m,g,n,s,h,q,t)*w,+this.det3(e,k,m,f,l,p,h,q,t)*
w,-this.det3(e,k,m,f,l,p,g,n,s)*w,-this.det3(c,l,p,b,n,s,d,q,t)*w,+this.det3(a,k,m,b,n,s,d,q,t)*w,-this.det3(a,k,m,c,l,p,d,q,t)*w,+this.det3(a,k,m,c,l,p,b,n,s)*w,+this.det3(c,f,p,b,g,s,d,h,t)*w,-this.det3(a,e,m,b,g,s,d,h,t)*w,+this.det3(a,e,m,c,f,p,d,h,t)*w,-this.det3(a,e,m,c,f,p,b,g,s)*w,-this.det3(c,f,l,b,g,n,d,h,q)*w,+this.det3(a,e,k,b,g,n,d,h,q)*w,-this.det3(a,e,k,c,f,l,d,h,q)*w,+this.det3(a,e,k,c,f,l,b,g,n)*w)};
x3dom.fields.SFMatrix4f.prototype.getEulerAngles=function(){var a,c,b,d,e,f;if(1!=Math.abs(this._20))return a=-Math.asin(this._20),c=Math.PI-a,b=Math.cos(a),d=Math.cos(c),e=Math.atan2(this._21/b,this._22/b),f=Math.atan2(this._21/d,this._22/d),b=Math.atan2(this._10/b,this._00/b),d=Math.atan2(this._10/d,this._00/d),[e,a,b,f,c,d];-1==this._20?(a=Math.PI/2,c=0+Math.atan2(this._01,this._02)):(a=-(Math.PI/2),c=-0+Math.atan2(-this._01,-this._02));return[c,a,0,c,a,0]};
x3dom.fields.SFMatrix4f.prototype.toString=function(){return"\n"+this._00.toFixed(6)+", "+this._01.toFixed(6)+", "+this._02.toFixed(6)+", "+this._03.toFixed(6)+", \n"+this._10.toFixed(6)+", "+this._11.toFixed(6)+", "+this._12.toFixed(6)+", "+this._13.toFixed(6)+", \n"+this._20.toFixed(6)+", "+this._21.toFixed(6)+", "+this._22.toFixed(6)+", "+this._23.toFixed(6)+", \n"+this._30.toFixed(6)+", "+this._31.toFixed(6)+", "+this._32.toFixed(6)+", "+this._33.toFixed(6)};
x3dom.fields.SFMatrix4f.prototype.setValueByStr=function(a){var c=!1;/matrix.*\((.+)\)/.exec(a)&&(a=RegExp.$1,c=!0);var b=Array.map(a.split(/[,\s]+/),function(a){return+a});16<=b.length?(c?(this._00=b[0],this._01=b[4],this._02=b[8],this._03=b[12],this._10=b[1],this._11=b[5],this._12=b[9],this._13=b[13],this._20=b[2],this._21=b[6],this._22=b[10],this._23=b[14],this._30=b[3],this._31=b[7],this._32=b[11]):(this._00=b[0],this._01=b[1],this._02=b[2],this._03=b[3],this._10=b[4],this._11=b[5],this._12=b[6],
this._13=b[7],this._20=b[8],this._21=b[9],this._22=b[10],this._23=b[11],this._30=b[12],this._31=b[13],this._32=b[14]),this._33=b[15]):6===b.length?(this._00=b[0],this._01=b[1],this._02=0,this._03=b[4],this._10=b[2],this._11=b[3],this._12=0,this._13=b[5],this._21=this._20=0,this._22=1,this._32=this._31=this._30=this._23=0,this._33=1):x3dom.debug.logWarning("SFMatrix4f - can't parse string: "+a);return this};x3dom.fields.SFVec2f=function(a,c){0===arguments.length?this.y=this.x=0:(this.x=a,this.y=c)};
x3dom.fields.SFVec2f.copy=function(a){return new x3dom.fields.SFVec2f(a.x,a.y)};x3dom.fields.SFVec2f.parse=function(a){a=/^\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*$/.exec(a);return new x3dom.fields.SFVec2f(+a[1],+a[2])};x3dom.fields.SFVec2f.prototype.setValues=function(a){this.x=a.x;this.y=a.y};x3dom.fields.SFVec2f.prototype.at=function(a){switch(a){case 0:return this.x;case 1:return this.y;default:return this.x}};
x3dom.fields.SFVec2f.prototype.add=function(a){return new x3dom.fields.SFVec2f(this.x+a.x,this.y+a.y)};x3dom.fields.SFVec2f.prototype.subtract=function(a){return new x3dom.fields.SFVec2f(this.x-a.x,this.y-a.y)};x3dom.fields.SFVec2f.prototype.negate=function(){return new x3dom.fields.SFVec2f(-this.x,-this.y)};x3dom.fields.SFVec2f.prototype.dot=function(a){return this.x*a.x+this.y*a.y};
x3dom.fields.SFVec2f.prototype.reflect=function(a){var c=2*this.dot(a);return new x3dom.fields.SFVec2f(this.x-c*a.x,this.y-c*a.y)};x3dom.fields.SFVec2f.prototype.normalize=function(){var a=this.length();a&&(a=1/a);return new x3dom.fields.SFVec2f(this.x*a,this.y*a)};x3dom.fields.SFVec2f.prototype.multComponents=function(a){return new x3dom.fields.SFVec2f(this.x*a.x,this.y*a.y)};x3dom.fields.SFVec2f.prototype.multiply=function(a){return new x3dom.fields.SFVec2f(this.x*a,this.y*a)};
x3dom.fields.SFVec2f.prototype.divide=function(a){a=a?1/a:1;return new x3dom.fields.SFVec2f(this.x*a,this.y*a)};x3dom.fields.SFVec2f.prototype.equals=function(a,c){return Math.abs(this.x-a.x)<c&&Math.abs(this.y-a.y)<c};x3dom.fields.SFVec2f.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)};x3dom.fields.SFVec2f.prototype.toGL=function(){return[this.x,this.y]};x3dom.fields.SFVec2f.prototype.toString=function(){return this.x+" "+this.y};
x3dom.fields.SFVec2f.prototype.setValueByStr=function(a){a=/^\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*$/.exec(a);this.x=+a[1];this.y=+a[2];return this};x3dom.fields.SFVec3f=function(a,c,b){0===arguments.length?this.z=this.y=this.x=0:(this.x=a,this.y=c,this.z=b)};x3dom.fields.SFVec3f.NullVector=new x3dom.fields.SFVec3f(0,0,0);x3dom.fields.SFVec3f.OneVector=new x3dom.fields.SFVec3f(1,1,1);
x3dom.fields.SFVec3f.copy=function(a){return new x3dom.fields.SFVec3f(a.x,a.y,a.z)};x3dom.fields.SFVec3f.MIN=function(){return new x3dom.fields.SFVec3f(Number.MIN_VALUE,Number.MIN_VALUE,Number.MIN_VALUE)};x3dom.fields.SFVec3f.MAX=function(){return new x3dom.fields.SFVec3f(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)};
x3dom.fields.SFVec3f.parse=function(a){try{var c=/^\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*$/.exec(a);return new x3dom.fields.SFVec3f(+c[1],+c[2],+c[3])}catch(b){return a=x3dom.fields.SFColor.colorParse(a),new x3dom.fields.SFVec3f(a.r,a.g,a.b)}};x3dom.fields.SFVec3f.prototype.setValues=function(a){this.x=a.x;this.y=a.y;this.z=a.z};
x3dom.fields.SFVec3f.prototype.at=function(a){switch(a){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:return this.x}};x3dom.fields.SFVec3f.prototype.add=function(a){return new x3dom.fields.SFVec3f(this.x+a.x,this.y+a.y,this.z+a.z)};x3dom.fields.SFVec3f.prototype.addScaled=function(a,c){return new x3dom.fields.SFVec3f(this.x+c*a.x,this.y+c*a.y,this.z+c*a.z)};x3dom.fields.SFVec3f.prototype.subtract=function(a){return new x3dom.fields.SFVec3f(this.x-a.x,this.y-a.y,this.z-a.z)};
x3dom.fields.SFVec3f.prototype.negate=function(){return new x3dom.fields.SFVec3f(-this.x,-this.y,-this.z)};x3dom.fields.SFVec3f.prototype.dot=function(a){return this.x*a.x+this.y*a.y+this.z*a.z};x3dom.fields.SFVec3f.prototype.cross=function(a){return new x3dom.fields.SFVec3f(this.y*a.z-this.z*a.y,this.z*a.x-this.x*a.z,this.x*a.y-this.y*a.x)};x3dom.fields.SFVec3f.prototype.reflect=function(a){var c=2*this.dot(a);return new x3dom.fields.SFVec3f(this.x-c*a.x,this.y-c*a.y,this.z-c*a.z)};
x3dom.fields.SFVec3f.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)};x3dom.fields.SFVec3f.prototype.normalize=function(){var a=this.length();a&&(a=1/a);return new x3dom.fields.SFVec3f(this.x*a,this.y*a,this.z*a)};x3dom.fields.SFVec3f.prototype.multComponents=function(a){return new x3dom.fields.SFVec3f(this.x*a.x,this.y*a.y,this.z*a.z)};x3dom.fields.SFVec3f.prototype.multiply=function(a){return new x3dom.fields.SFVec3f(this.x*a,this.y*a,this.z*a)};
x3dom.fields.SFVec3f.prototype.divide=function(a){a=a?1/a:1;return new x3dom.fields.SFVec3f(this.x*a,this.y*a,this.z*a)};x3dom.fields.SFVec3f.prototype.equals=function(a,c){return Math.abs(this.x-a.x)<c&&Math.abs(this.y-a.y)<c&&Math.abs(this.z-a.z)<c};x3dom.fields.SFVec3f.prototype.toGL=function(){return[this.x,this.y,this.z]};x3dom.fields.SFVec3f.prototype.toString=function(){return this.x+" "+this.y+" "+this.z};
x3dom.fields.SFVec3f.prototype.setValueByStr=function(a){try{var c=/^\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*$/.exec(a);this.x=+c[1];this.y=+c[2];this.z=+c[3]}catch(b){a=x3dom.fields.SFColor.colorParse(a),this.x=a.r,this.y=a.g,this.z=a.b}return this};x3dom.fields.SFVec4f=function(a,c,b,d){0===arguments.length?this.w=this.z=this.y=this.x=0:(this.x=a,this.y=c,this.z=b,this.w=d)};
x3dom.fields.SFVec4f.copy=function(a){return new x3dom.fields.SFVec4f(a.x,a.y,a.z,a.w)};x3dom.fields.SFVec4f.parse=function(a){a=/^\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*$/.exec(a);return new x3dom.fields.SFVec4f(+a[1],+a[2],+a[3],+a[4])};
x3dom.fields.SFVec4f.prototype.setValueByStr=function(a){a=/^\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*$/.exec(a);this.x=+a[1];this.y=+a[2];this.z=+a[3];this.w=+a[4];return this};x3dom.fields.SFVec4f.prototype.toGL=function(){return[this.x,this.y,this.z,this.w]};x3dom.fields.SFVec4f.prototype.toString=function(){return this.x+" "+this.y+" "+this.z+" "+this.w};
x3dom.fields.Quaternion=function(a,c,b,d){0===arguments.length?(this.y=this.x=0,this.z=1,this.w=0):(this.x=a,this.y=c,this.z=b,this.w=d)};x3dom.fields.Quaternion.copy=function(a){return new x3dom.fields.Quaternion(a.x,a.y,a.z,a.w)};x3dom.fields.Quaternion.prototype.multiply=function(a){return new x3dom.fields.Quaternion(this.w*a.x+this.x*a.w+this.y*a.z-this.z*a.y,this.w*a.y+this.y*a.w+this.z*a.x-this.x*a.z,this.w*a.z+this.z*a.w+this.x*a.y-this.y*a.x,this.w*a.w-this.x*a.x-this.y*a.y-this.z*a.z)};
x3dom.fields.Quaternion.parseAxisAngle=function(a){a=/^\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*$/.exec(a);return x3dom.fields.Quaternion.axisAngle(new x3dom.fields.SFVec3f(+a[1],+a[2],+a[3]),+a[4])};
x3dom.fields.Quaternion.axisAngle=function(a,c){var b=a.length();if(b>x3dom.fields.Eps){var b=Math.sin(c/2)/b,d=Math.cos(c/2);return new x3dom.fields.Quaternion(a.x*b,a.y*b,a.z*b,d)}return new x3dom.fields.Quaternion(0,0,0,1)};
x3dom.fields.Quaternion.prototype.toMatrix=function(){var a=this.x*this.x,c=this.x*this.y,b=this.x*this.z,d=this.y*this.y,e=this.y*this.z,f=this.z*this.z,g=this.w*this.x,h=this.w*this.y,k=this.w*this.z;return new x3dom.fields.SFMatrix4f(1-2*(d+f),2*(c-k),2*(b+h),0,2*(c+k),1-2*(a+f),2*(e-g),0,2*(b-h),2*(e+g),1-2*(a+d),0,0,0,0,1)};
x3dom.fields.Quaternion.prototype.toAxisAngle=function(){var a=0,c=0,b=0,d=b=0,e=this;1<this.w&&(e=x3dom.fields.Quaternion.normalize(this));d=2*Math.acos(e.w);b=Math.sqrt(1-e.w*e.w);0==b?(a=e.x,c=e.y,b=e.z):(a=e.x/b,c=e.y/b,b=e.z/b);return[new x3dom.fields.SFVec3f(a,c,b),d]};x3dom.fields.Quaternion.prototype.angle=function(){return 2*Math.acos(this.w)};
x3dom.fields.Quaternion.prototype.setValue=function(a){var c,b=1,d=[0,0,0],e=c=0,f=0,b=[1,2,0];c=a._00+a._11+a._22;0<c?(b=Math.sqrt(c+1),this.w=0.5*b,b=0.5/b,this.x=(a._21-a._12)*b,this.y=(a._02-a._20)*b,this.z=(a._10-a._01)*b):(c=a._11>a._00?1:0,a._22>a.at(c,c)&&(c=2),e=b[c],f=b[e],b=Math.sqrt(a.at(c,c)-(a.at(e,e)+a.at(f,f))+1),d[c]=0.5*b,b=0.5/b,this.w=(a.at(f,e)-a.at(e,f))*b,d[e]=(a.at(e,c)+a.at(c,e))*b,d[f]=(a.at(f,c)+a.at(c,f))*b,this.x=d[0],this.y=d[1],this.z=d[2]);if(1<this.w||-1>this.w)a=
1+100*x3dom.fields.Eps,(this.w>a||this.w<-a)&&x3dom.debug.logInfo("MatToQuat: BUG: |quat[4]| ("+this.w+") >> 1.0 !"),this.w=1<this.w?1:-1};x3dom.fields.Quaternion.prototype.dot=function(a){return this.x*a.x+this.y*a.y+this.z*a.z+this.w*a.w};x3dom.fields.Quaternion.prototype.add=function(a){return new x3dom.fields.Quaternion(this.x+a.x,this.y+a.y,this.z+a.z,this.w+a.w)};
x3dom.fields.Quaternion.prototype.subtract=function(a){return new x3dom.fields.Quaternion(this.x-a.x,this.y-a.y,this.z-a.z,this.w-a.w)};x3dom.fields.Quaternion.prototype.setValues=function(a){this.x=a.x;this.y=a.y;this.z=a.z;this.w=a.w};x3dom.fields.Quaternion.prototype.equals=function(a,c){return this.dot(a)>=1-c};x3dom.fields.Quaternion.prototype.multScalar=function(a){return new x3dom.fields.Quaternion(this.x*a,this.y*a,this.z*a,this.w*a)};
x3dom.fields.Quaternion.prototype.normalize=function(a){a=this.dot(a);var c=1;a&&(c=1/Math.sqrt(a));return new x3dom.fields.Quaternion(this.x*c,this.y*c,this.z*c,this.w*c)};x3dom.fields.Quaternion.prototype.negate=function(){return new x3dom.fields.Quaternion(-this.x,-this.y,-this.z,-this.w)};x3dom.fields.Quaternion.prototype.inverse=function(){return new x3dom.fields.Quaternion(-this.x,-this.y,-this.z,this.w)};
x3dom.fields.Quaternion.prototype.slerp=function(a,c){var b=this.dot(a),d;0>b?(b=-b,d=a.negate()):d=new x3dom.fields.Quaternion(a.x,a.y,a.z,a.w);var e;if(1E-5<1-b){e=Math.acos(b);var f=Math.sin(e),b=Math.sin((1-c)*e)/f;e=Math.sin(c*e)/f}else b=1-c,e=c;return this.multScalar(b).add(d.multScalar(e))};
x3dom.fields.Quaternion.rotateFromTo=function(a,c){var b=a.normalize(),d=c.normalize(),d=b.dot(d);if(0.99999<d)return new x3dom.fields.Quaternion(0,0,0,1);if(-0.99999>d){var d=new x3dom.fields.SFVec3f(1,0,0),e=b.cross(d);1E-5>e.length()&&(d.x=0,d.y=1,d.z=0,e=b.cross(d));e=e.normalize();return x3dom.fields.Quaternion.axisAngle(e,Math.PI)}b=a.cross(c);b=b.normalize();e=Math.sqrt(0.5*(1-d));b=b.multiply(e);e=Math.sqrt(0.5*(1+d));return new x3dom.fields.Quaternion(b.x,b.y,b.z,e)};
x3dom.fields.Quaternion.prototype.toGL=function(){var a=this.toAxisAngle();return[a[0].x,a[0].y,a[0].z,a[1]]};x3dom.fields.Quaternion.prototype.toString=function(){return this.x+" "+this.y+" "+this.z+", "+this.w};
x3dom.fields.Quaternion.prototype.setValueByStr=function(a){a=/^\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*$/.exec(a);a=x3dom.fields.Quaternion.axisAngle(new x3dom.fields.SFVec3f(+a[1],+a[2],+a[3]),+a[4]);this.x=a.x;this.y=a.y;this.z=a.z;this.w=a.w;return this};x3dom.fields.SFColor=function(a,c,b){0===arguments.length?this.b=this.g=this.r=0:(this.r=a,this.g=c,this.b=b)};
x3dom.fields.SFColor.parse=function(a){try{var c=/^\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*$/.exec(a);return new x3dom.fields.SFColor(+c[1],+c[2],+c[3])}catch(b){return x3dom.fields.SFColor.colorParse(a)}};x3dom.fields.SFColor.prototype.setHSV=function(a,c,b){x3dom.debug.logWarning("SFColor.setHSV() NYI")};x3dom.fields.SFColor.prototype.getHSV=function(){x3dom.debug.logWarning("SFColor.getHSV() NYI");return[0,0,0]};
x3dom.fields.SFColor.prototype.setValues=function(a){this.r=a.r;this.g=a.g;this.b=a.b};x3dom.fields.SFColor.prototype.equals=function(a,c){return Math.abs(this.r-a.r)<c&&Math.abs(this.g-a.g)<c&&Math.abs(this.b-a.b)<c};x3dom.fields.SFColor.prototype.add=function(a){return new x3dom.fields.SFColor(this.r+a.r,this.g+a.g,this.b+a.b)};x3dom.fields.SFColor.prototype.subtract=function(a){return new x3dom.fields.SFColor(this.r-a.r,this.g-a.g,this.b-a.b)};
x3dom.fields.SFColor.prototype.multiply=function(a){return new x3dom.fields.SFColor(this.r*a,this.g*a,this.b*a)};x3dom.fields.SFColor.prototype.toGL=function(){return[this.r,this.g,this.b]};x3dom.fields.SFColor.prototype.toString=function(){return this.r+" "+this.g+" "+this.b};
x3dom.fields.SFColor.prototype.setValueByStr=function(a){try{var c=/^\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*$/.exec(a);this.r=+c[1];this.g=+c[2];this.b=+c[3]}catch(b){a=x3dom.fields.SFColor.colorParse(a),this.r=a.r,this.g=a.g,this.b=a.b}return this};
x3dom.fields.SFColor.colorParse=function(a){var c=0,b=0,d=0,e={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"00ffff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000000",blanchedalmond:"ffebcd",blue:"0000ff",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"00ffff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",
darkgreen:"006400",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dodgerblue:"1e90ff",feldspar:"d19275",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"ff00ff",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",
gray:"808080",green:"008000",greenyellow:"adff2f",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgrey:"d3d3d3",lightgreen:"90ee90",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslateblue:"8470ff",lightslategray:"778899",lightsteelblue:"b0c4de",
lightyellow:"ffffe0",lime:"00ff00",limegreen:"32cd32",linen:"faf0e6",magenta:"ff00ff",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370d8",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",
orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"d87093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",red:"ff0000",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",
tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",violetred:"d02090",wheat:"f5deb3",white:"ffffff",whitesmoke:"f5f5f5",yellow:"ffff00",yellowgreen:"9acd32"};e[a]&&(a="#"+e[a]);a.substr&&"#"===a.substr(0,1)&&(a=a.substr(1),e=a.length,6===e?(c=parseInt("0x"+a.substr(0,2),16)/255,b=parseInt("0x"+a.substr(2,2),16)/255,d=parseInt("0x"+a.substr(4,2),16)/255):3===e&&(c=parseInt("0x"+a.substr(0,1),16)/15,b=parseInt("0x"+a.substr(1,1),16)/15,d=parseInt("0x"+a.substr(2,
1),16)/15));return new x3dom.fields.SFColor(c,b,d)};x3dom.fields.SFColorRGBA=function(a,c,b,d){0===arguments.length?(this.b=this.g=this.r=0,this.a=1):(this.r=a,this.g=c,this.b=b,this.a=d)};x3dom.fields.SFColorRGBA.parse=function(a){try{var c=/^([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)$/.exec(a);return new x3dom.fields.SFColorRGBA(+c[1],+c[2],+c[3],+c[4])}catch(b){return x3dom.fields.SFColorRGBA.colorParse(a)}};
x3dom.fields.SFColorRGBA.prototype.setValues=function(a){this.r=a.r;this.g=a.g;this.b=a.b;this.a=a.a};x3dom.fields.SFColorRGBA.prototype.equals=function(a,c){return Math.abs(this.r-a.r)<c&&Math.abs(this.g-a.g)<c&&Math.abs(this.b-a.b)<c&&Math.abs(this.a-a.a)<c};x3dom.fields.SFColorRGBA.prototype.toGL=function(){return[this.r,this.g,this.b,this.a]};x3dom.fields.SFColorRGBA.prototype.toString=function(){return this.r+" "+this.g+" "+this.b+" "+this.a};
x3dom.fields.SFColorRGBA.prototype.setValueByStr=function(a){try{var c=/^([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)\s*,?\s*([+\-]?\d*\.*\d*[eE]?[+\-]?\d*?)$/.exec(a);this.r=+c[1];this.g=+c[2];this.b=+c[3];this.a=+c[4]}catch(b){a=x3dom.fields.SFColorRGBA.colorParse(a),this.r=a.r,this.g=a.g,this.b=a.b,this.a=a.a}return this};
x3dom.fields.SFImage=function(a,c,b,d){if(0!==arguments.length&&d&&d.map){this.width=a;this.height=c;this.comp=b;var e=this.array;d.map(function(a){e.push(a)},this.array)}else this.comp=this.height=this.width=0,this.array=[]};x3dom.fields.SFImage.parse=function(a){var c=new x3dom.fields.SFImage;c.setValueByStr(a);return c};
x3dom.fields.SFImage.prototype.setValueByStr=function(a){a=a.match(/(\w+)/g);var c=a.length,b=0;this.array=[];if(2<c){this.width=+a[0];this.height=+a[1];this.comp=+a[2];var b=2*this.comp,d,e;for(e=3;e<c;e++)if(a[e].substr){if("x"!==a[e].substr(1,1).toLowerCase()){d="";for(var f=parseInt(a[e],10);0!==f;)d="0123456789ABCDEF".charAt(f%16)+d,f>>=4;for(;d.length<b;)d="0"+d;a[e]="0x"+d}if("x"===a[e].substr(1,1).toLowerCase()){a[e]=a[e].substr(2);d=a[e].length;var g,h;d===b&&(1===this.comp?(d=parseInt("0x"+
a[e].substr(0,2),16),this.array.push(d)):2===this.comp?(d=parseInt("0x"+a[e].substr(0,2),16),f=parseInt("0x"+a[e].substr(2,2),16),this.array.push(d,f)):3===this.comp?(d=parseInt("0x"+a[e].substr(0,2),16),f=parseInt("0x"+a[e].substr(2,2),16),g=parseInt("0x"+a[e].substr(4,2),16),this.array.push(d,f,g)):4===this.comp&&(d=parseInt("0x"+a[e].substr(0,2),16),f=parseInt("0x"+a[e].substr(2,2),16),g=parseInt("0x"+a[e].substr(4,2),16),h=parseInt("0x"+a[e].substr(6,2),16),this.array.push(d,f,g,h)))}}}else this.comp=
this.height=this.width=0};x3dom.fields.SFImage.prototype.toGL=function(){var a=[];Array.map(this.array,function(c){a.push(c)});return a};x3dom.fields.MFColor=function(a){if(0!==arguments.length){var c=this;a.map(function(a){c.push(a)},this)}};x3dom.fields.MFColor.prototype=x3dom.extend([]);x3dom.fields.MFColor.parse=function(a){a=a.match(/([+\-0-9eE\.]+)/g);for(var c=[],b=0,d=a?a.length:0;b<d;b+=3)c.push(new x3dom.fields.SFColor(+a[b+0],+a[b+1],+a[b+2]));return new x3dom.fields.MFColor(c)};
x3dom.fields.MFColor.prototype.setValueByStr=function(a){for(;this.length;)this.pop();a=a.match(/([+\-0-9eE\.]+)/g);for(var c=0,b=a?a.length:0;c<b;c+=3)this.push(new x3dom.fields.SFColor(+a[c+0],+a[c+1],+a[c+2]))};x3dom.fields.MFColor.prototype.toGL=function(){var a=[];Array.map(this,function(c){a.push(c.r);a.push(c.g);a.push(c.b)});return a};x3dom.fields.MFColorRGBA=function(a){if(0!==arguments.length){var c=this;a.map(function(a){c.push(a)},this)}};x3dom.fields.MFColorRGBA.prototype=x3dom.extend([]);
x3dom.fields.MFColorRGBA.parse=function(a){a=a.match(/([+\-0-9eE\.]+)/g);for(var c=[],b=0,d=a?a.length:0;b<d;b+=4)c.push(new x3dom.fields.SFColorRGBA(+a[b+0],+a[b+1],+a[b+2],+a[b+3]));return new x3dom.fields.MFColorRGBA(c)};x3dom.fields.MFColorRGBA.prototype.setValueByStr=function(a){for(;this.length;)this.pop();a=a.match(/([+\-0-9eE\.]+)/g);for(var c=0,b=a?a.length:0;c<b;c+=4)this.push(new x3dom.fields.SFColor(+a[c+0],+a[c+1],+a[c+2],+a[c+3]))};
x3dom.fields.MFColorRGBA.prototype.toGL=function(){var a=[];Array.map(this,function(c){a.push(c.r);a.push(c.g);a.push(c.b);a.push(c.a)});return a};x3dom.fields.MFRotation=function(a){if(0!==arguments.length){var c=this;a.map(function(a){c.push(a)},this)}};x3dom.fields.MFRotation.prototype=x3dom.extend([]);
x3dom.fields.MFRotation.parse=function(a){a=a.match(/([+\-0-9eE\.]+)/g);for(var c=[],b=0,d=a?a.length:0;b<d;b+=4)c.push(x3dom.fields.Quaternion.axisAngle(new x3dom.fields.SFVec3f(+a[b+0],+a[b+1],+a[b+2]),+a[b+3]));return new x3dom.fields.MFRotation(c)};
x3dom.fields.MFRotation.prototype.setValueByStr=function(a){for(;this.length;)this.pop();a=a.match(/([+\-0-9eE\.]+)/g);for(var c=0,b=a?a.length:0;c<b;c+=4)this.push(x3dom.fields.Quaternion.axisAngle(new x3dom.fields.SFVec3f(+a[c+0],+a[c+1],+a[c+2]),+a[c+3]))};x3dom.fields.MFRotation.prototype.toGL=function(){var a=[];Array.map(this,function(c){c=c.toAxisAngle();a.push(c[0].x);a.push(c[0].y);a.push(c[0].z);a.push(c[1])});return a};
x3dom.fields.MFVec3f=function(a){if(0!==arguments.length){var c=this;a.map(function(a){c.push(a)},this)}};x3dom.fields.MFVec3f.copy=function(a){var c=new x3dom.fields.MFVec3f;a.map(function(a){c.push(x3dom.fields.SFVec3f.copy(a))},this);return c};x3dom.fields.MFVec3f.prototype=x3dom.extend([]);x3dom.fields.MFVec3f.parse=function(a){a=a.match(/([+\-0-9eE\.]+)/g);for(var c=[],b=0,d=a?a.length:0;b<d;b+=3)c.push(new x3dom.fields.SFVec3f(+a[b+0],+a[b+1],+a[b+2]));return new x3dom.fields.MFVec3f(c)};
x3dom.fields.MFVec3f.prototype.setValueByStr=function(a){for(;this.length;)this.pop();a=a.match(/([+\-0-9eE\.]+)/g);for(var c=0,b=a?a.length:0;c<b;c+=3)this.push(new x3dom.fields.SFVec3f(+a[c+0],+a[c+1],+a[c+2]))};x3dom.fields.MFVec3f.prototype.toGL=function(){var a=[];Array.map(this,function(c){a.push(c.x);a.push(c.y);a.push(c.z)});return a};x3dom.fields.MFVec2f=function(a){if(0!==arguments.length){var c=this;a.map(function(a){c.push(a)},this)}};x3dom.fields.MFVec2f.prototype=x3dom.extend([]);
x3dom.fields.MFVec2f.parse=function(a){a=a.match(/([+\-0-9eE\.]+)/g);for(var c=[],b=0,d=a?a.length:0;b<d;b+=2)c.push(new x3dom.fields.SFVec2f(+a[b+0],+a[b+1]));return new x3dom.fields.MFVec2f(c)};x3dom.fields.MFVec2f.prototype.setValueByStr=function(a){for(;this.length;)this.pop();a=a.match(/([+\-0-9eE\.]+)/g);for(var c=0,b=a?a.length:0;c<b;c+=2)this.push(new x3dom.fields.SFVec2f(+a[c+0],+a[c+1]))};
x3dom.fields.MFVec2f.prototype.toGL=function(){var a=[];Array.map(this,function(c){a.push(c.x);a.push(c.y)});return a};x3dom.fields.MFInt32=function(a){if(0!==arguments.length&&a&&a.map){var c=this;a.map(function(a){c.push(a)},this)}};x3dom.fields.MFInt32.prototype=x3dom.extend([]);x3dom.fields.MFInt32.parse=function(a){a=a.match(/([+\-]?\d+\s*){1},?\s*/g);for(var c=[],b=0,d=a?a.length:0;b<d;++b)c.push(parseInt(a[b],10));return new x3dom.fields.MFInt32(c)};
x3dom.fields.MFInt32.prototype.setValueByStr=function(a){for(;this.length;)this.pop();a=a.match(/([+\-]?\d+\s*){1},?\s*/g);for(var c=0,b=a?a.length:0;c<b;++c)this.push(parseInt(a[c],10))};x3dom.fields.MFInt32.prototype.toGL=function(){var a=[];Array.map(this,function(c){a.push(c)});return a};x3dom.fields.MFFloat=function(a){if(0!==arguments.length&&a&&a.map){var c=this;a.map(function(a){c.push(a)},this)}};x3dom.fields.MFFloat.prototype=x3dom.extend([]);
x3dom.fields.MFFloat.parse=function(a){a=a.match(/([+\-0-9eE\.]+)/g);for(var c=[],b=0,d=a?a.length:0;b<d;b++)c.push(+a[b]);return new x3dom.fields.MFFloat(c)};x3dom.fields.MFFloat.prototype.setValueByStr=function(a){for(;this.length;)this.pop();a=a.match(/([+\-0-9eE\.]+)/g);for(var c=0,b=a?a.length:0;c<b;c++)this.push(+a[c])};x3dom.fields.MFFloat.prototype.toGL=function(){var a=[];Array.map(this,function(c){a.push(c)});return a};
x3dom.fields.MFString=function(a){if(0!==arguments.length&&a&&a.map){var c=this;a.map(function(a){c.push(a)},this)}};x3dom.fields.MFString.parse=function(a){var c=[];if(a.length&&'"'==a[0])for(var b,d=/"((?:[^\\"]|\\\\|\\")*)"/g;b=d.exec(a);)b=b[1].replace(/\\([\\"])/,"$1"),void 0!==b&&c.push(b);else c.push(a);return new x3dom.fields.MFString(c)};x3dom.fields.MFString.prototype=x3dom.extend([]);
x3dom.fields.MFString.prototype.setValueByStr=function(a){for(;this.length;)this.pop();if(a.length&&'"'==a[0])for(var c,b=/"((?:[^\\"]|\\\\|\\")*)"/g;c=b.exec(a);)c=c[1].replace(/\\([\\"])/,"$1"),void 0!==c&&this.push(c);else this.push(a);return this};x3dom.fields.MFString.prototype.toString=function(){for(var a="",c=0;c<this.length;c++)a=a+this[c]+" ";return a};x3dom.fields.SFNode=function(a){this.type=a;this.node=null};x3dom.fields.SFNode.prototype.hasLink=function(a){return a?this.node===a:this.node};
x3dom.fields.SFNode.prototype.addLink=function(a){this.node=a;return!0};x3dom.fields.SFNode.prototype.rmLink=function(a){return this.node===a?(this.node=null,!0):!1};x3dom.fields.MFNode=function(a){this.type=a;this.nodes=[]};x3dom.fields.MFNode.prototype.hasLink=function(a){if(a)for(var c=0,b=this.nodes.length;c<b;c++){if(this.nodes[c]===a)return!0}else return 0<this.length;return!1};x3dom.fields.MFNode.prototype.addLink=function(a){this.nodes.push(a);return!0};
x3dom.fields.MFNode.prototype.rmLink=function(a){for(var c=0,b=this.nodes.length;c<b;c++)if(this.nodes[c]===a)return this.nodes.splice(c,1),!0;return!1};x3dom.fields.MFNode.prototype.length=function(){return this.nodes.length};
x3dom.fields.Line=function(a,c){if(0===arguments.length)this.pos=new x3dom.fields.SFVec3f(0,0,0),this.dir=new x3dom.fields.SFVec3f(0,0,1);else{this.pos=new x3dom.fields.SFVec3f(a.x,a.y,a.z);var b=c.length();b&&(b=1/b);this.dir=new x3dom.fields.SFVec3f(c.x*b,c.y*b,c.z*b)}this.exit=this.enter=0;this.hitObject=null;this.hitPoint={};this.dist=Number.MAX_VALUE};x3dom.fields.Line.prototype.toString=function(){return"Line: ["+this.pos.toString()+"; "+this.dir.toString()+"]"};
x3dom.fields.Line.prototype.intersect=function(a,c){var b=0,d=Number.MAX_VALUE,e,f;if(this.dir.x>x3dom.fields.Eps)e=1/this.dir.x,f=(a.x-this.pos.x)*e,e*=c.x-this.pos.x,e<d&&(d=e),f>b&&(b=f);else if(this.dir.x<-x3dom.fields.Eps)e=1/this.dir.x,f=(c.x-this.pos.x)*e,e*=a.x-this.pos.x,e<d&&(d=e),f>b&&(b=f);else if(this.pos.x<a.x||this.pos.x>c.x)return!1;if(this.dir.y>x3dom.fields.Eps){if(e=1/this.dir.y,f=(a.y-this.pos.y)*e,e*=c.y-this.pos.y,e<d&&(d=e),f>b&&(b=f),b-d>=x3dom.fields.Eps)return!1}else if(this.dir.y<
-x3dom.fields.Eps){if(e=1/this.dir.y,f=(c.y-this.pos.y)*e,e*=a.y-this.pos.y,e<d&&(d=e),f>b&&(b=f),b-d>=x3dom.fields.Eps)return!1}else if(this.pos.y<a.y||this.pos.y>c.y)return!1;if(this.dir.z>x3dom.fields.Eps)e=1/this.dir.z,f=(a.z-this.pos.z)*e,e*=c.z-this.pos.z,e<d&&(d=e),f>b&&(b=f);else if(this.dir.z<-x3dom.fields.Eps)e=1/this.dir.z,f=(c.z-this.pos.z)*e,e*=a.z-this.pos.z,e<d&&(d=e),f>b&&(b=f);else if(this.pos.z<a.z||this.pos.z>c.z)return!1;this.enter=b;this.exit=d;return b-d<x3dom.fields.Eps};
x3dom.fields.BoxVolume=function(a,c){2>arguments.length?(this.min=new x3dom.fields.SFVec3f(0,0,0),this.max=new x3dom.fields.SFVec3f(0,0,0),this.valid=!1):(this.min=x3dom.fields.SFVec3f.copy(a),this.max=x3dom.fields.SFVec3f.copy(c),this.valid=!0);this.updateInternals()};x3dom.fields.BoxVolume.copy=function(a){return new x3dom.fields.BoxVolume(a.min,a.max)};
x3dom.fields.BoxVolume.prototype.updateInternals=function(){this.radialVec=this.max.subtract(this.min).multiply(0.5);this.center=this.min.add(this.radialVec);this.diameter=2*this.radialVec.length()};x3dom.fields.BoxVolume.prototype.setBounds=function(a,c){this.min.setValues(a);this.max.setValues(c);this.updateInternals();this.valid=!0};
x3dom.fields.BoxVolume.prototype.setBoundsByCenterSize=function(a,c){var b=c.multiply(0.5);this.min=a.subtract(b);this.max=a.add(b);this.updateInternals();this.valid=!0};x3dom.fields.BoxVolume.prototype.extendBounds=function(a,c){this.valid?(this.min.x>a.x&&(this.min.x=a.x),this.min.y>a.y&&(this.min.y=a.y),this.min.z>a.z&&(this.min.z=a.z),this.max.x<c.x&&(this.max.x=c.x),this.max.y<c.y&&(this.max.y=c.y),this.max.z<c.z&&(this.max.z=c.z),this.updateInternals()):this.setBounds(a,c)};
x3dom.fields.BoxVolume.prototype.getBounds=function(a,c){a.setValues(this.min);c.setValues(this.max)};x3dom.fields.BoxVolume.prototype.getRadialVec=function(){return this.radialVec};x3dom.fields.BoxVolume.prototype.invalidate=function(){this.valid=!1};x3dom.fields.BoxVolume.prototype.isValid=function(){return this.valid};x3dom.fields.BoxVolume.prototype.getCenter=function(){return this.center};x3dom.fields.BoxVolume.prototype.getDiameter=function(){return this.diameter};
x3dom.fields.BoxVolume.prototype.transform=function(a){var c,b,d,e,f,g;c=e=a._03;b=f=a._13;d=g=a._23;var h=this.max.x*a._00,k=this.min.x*a._00;h>=k?(e+=h,c+=k):(e+=k,c+=h);h=this.max.y*a._01;k=this.min.y*a._01;h>=k?(e+=h,c+=k):(e+=k,c+=h);h=this.max.z*a._02;k=this.min.z*a._02;h>=k?(e+=h,c+=k):(e+=k,c+=h);h=this.max.x*a._10;k=this.min.x*a._10;h>=k?(f+=h,b+=k):(f+=k,b+=h);h=this.max.y*a._11;k=this.min.y*a._11;h>=k?(f+=h,b+=k):(f+=k,b+=h);h=this.max.z*a._12;k=this.min.z*a._12;h>=k?(f+=h,b+=k):(f+=k,
b+=h);h=this.max.x*a._20;k=this.min.x*a._20;h>=k?(g+=h,d+=k):(g+=k,d+=h);h=this.max.y*a._21;k=this.min.y*a._21;h>=k?(g+=h,d+=k):(g+=k,d+=h);h=this.max.z*a._22;k=this.min.z*a._22;h>=k?(g+=h,d+=k):(g+=k,d+=h);this.min.x=c;this.min.y=b;this.min.z=d;this.max.x=e;this.max.y=f;this.max.z=g;this.updateInternals()};
x3dom.fields.BoxVolume.prototype.transformFrom=function(a,c){var b,d,e,f,g,h;b=f=a._03;d=g=a._13;e=h=a._23;var k=c.max.x*a._00,l=c.min.x*a._00;k>=l?(f+=k,b+=l):(f+=l,b+=k);k=c.max.y*a._01;l=c.min.y*a._01;k>=l?(f+=k,b+=l):(f+=l,b+=k);k=c.max.z*a._02;l=c.min.z*a._02;k>=l?(f+=k,b+=l):(f+=l,b+=k);k=c.max.x*a._10;l=c.min.x*a._10;k>=l?(g+=k,d+=l):(g+=l,d+=k);k=c.max.y*a._11;l=c.min.y*a._11;k>=l?(g+=k,d+=l):(g+=l,d+=k);k=c.max.z*a._12;l=c.min.z*a._12;k>=l?(g+=k,d+=l):(g+=l,d+=k);k=c.max.x*a._20;l=c.min.x*
a._20;k>=l?(h+=k,e+=l):(h+=l,e+=k);k=c.max.y*a._21;l=c.min.y*a._21;k>=l?(h+=k,e+=l):(h+=l,e+=k);k=c.max.z*a._22;l=c.min.z*a._22;k>=l?(h+=k,e+=l):(h+=l,e+=k);this.min.x=b;this.min.y=d;this.min.z=e;this.max.x=f;this.max.y=g;this.max.z=h;this.updateInternals();this.valid=!0};
x3dom.fields.FrustumVolume=function(a){this.planeNormals=[];this.planeDistances=[];this.directionIndex=[];if(0!==arguments.length){for(var c=[],b=0;6>b;b++)this.planeNormals[b]=new x3dom.fields.SFVec3f(0,0,0),this.planeDistances[b]=0,this.directionIndex[b]=0,c[b]=new x3dom.fields.SFVec4f(0,0,0,0);c[0].x=a._30-a._00;c[0].y=a._31-a._01;c[0].z=a._32-a._02;c[0].w=a._33-a._03;c[1].x=a._30+a._00;c[1].y=a._31+a._01;c[1].z=a._32+a._02;c[1].w=a._33+a._03;c[2].x=a._30+a._10;c[2].y=a._31+a._11;c[2].z=a._32+
a._12;c[2].w=a._33+a._13;c[3].x=a._30-a._10;c[3].y=a._31-a._11;c[3].z=a._32-a._12;c[3].w=a._33-a._13;c[4].x=a._30+a._20;c[4].y=a._31+a._21;c[4].z=a._32+a._22;c[4].w=a._33+a._23;c[5].x=a._30-a._20;c[5].y=a._31-a._21;c[5].z=a._32-a._22;c[5].w=a._33-a._23;for(b=0;6>b;b++){var d=Math.sqrt(c[b].x*c[b].x+c[b].y*c[b].y+c[b].z*c[b].z);c[b].x/=d;c[b].y/=d;c[b].z/=d;c[b].w/=-d}b=function(a){var b=0;0<a.x&&(b|=1);0<a.y&&(b|=2);0<a.z&&(b|=4);return b};this.planeNormals[3].setValues(c[0]);this.planeDistances[3]=
c[0].w;this.directionIndex[3]=b(this.planeNormals[3]);this.planeNormals[2].setValues(c[1]);this.planeDistances[2]=c[1].w;this.directionIndex[2]=b(this.planeNormals[2]);this.planeNormals[5].setValues(c[2]);this.planeDistances[5]=c[2].w;this.directionIndex[5]=b(this.planeNormals[5]);this.planeNormals[4].setValues(c[3]);this.planeDistances[4]=c[3].w;this.directionIndex[4]=b(this.planeNormals[4]);this.planeNormals[0].setValues(c[4]);this.planeDistances[0]=c[4].w;this.directionIndex[0]=b(this.planeNormals[0]);
this.planeNormals[1].setValues(c[5]);this.planeDistances[1]=c[5].w;this.directionIndex[1]=b(this.planeNormals[1])}};
x3dom.fields.FrustumVolume.prototype.intersect=function(a,c){if(6>this.planeNormals.length)return x3dom.debug.logWarning("FrustumVolume not initialized!"),!1;var b=this,d=a.min,e=a.max,f=function(a){var b=new x3dom.fields.SFVec3f(0,0,0);b.x=a&1?d.x:e.x;b.y=a&2?d.y:e.y;b.z=a&4?d.z:e.z;return b},g=function(a,c){return 0<=b.planeNormals[a].dot(c)-b.planeDistances[a]},h=function(a){var c=f(b.directionIndex[a]);return g(a,c)},k=function(a){var c=f(b.directionIndex[a]^7);return!g(a,c)},l=1;0>c&&(c=0);for(var n=
0;6>n;n++,l<<=1)if(0==(c&l)){if(k(n))return-1;h(n)&&(c|=l)}return c};x3dom.NodeNameSpace=function(a,c){this.name=a;this.doc=c;this.baseURL="";this.defMap={};this.parent=null;this.childSpaces=[]};x3dom.NodeNameSpace.prototype.addNode=function(a,c){this.defMap[c]=a;a._nameSpace=this};x3dom.NodeNameSpace.prototype.removeNode=function(a){var c=a?this.defMap[a]:null;c&&(delete this.defMap[a],c._nameSpace=null)};x3dom.NodeNameSpace.prototype.getNamedNode=function(a){return this.defMap[a]};
x3dom.NodeNameSpace.prototype.getNamedElement=function(a){return(a=this.defMap[a])?a._xmlNode:null};x3dom.NodeNameSpace.prototype.addSpace=function(a){this.childSpaces.push(a);a.parent=this};x3dom.NodeNameSpace.prototype.removeSpace=function(a){a.parent=null;for(var c=0;c<this.childSpaces.length;c++)this.childSpaces[c]==a&&this.childSpaces.splice(c,1)};
x3dom.NodeNameSpace.prototype.setBaseURL=function(a){var c=a.lastIndexOf("/");this.baseURL=0<=c?a.substr(0,c+1):"";x3dom.debug.logInfo("setBaseURL: "+this.baseURL)};x3dom.NodeNameSpace.prototype.getURL=function(a){return void 0!==a&&a.length?"/"===a[0]||0<=a.indexOf(":")?a:this.baseURL+a:""};x3dom.hasElementAttribute=function(a){var c=this.__hasAttribute(a);!c&&a&&(c=this.__hasAttribute(a.toLowerCase()));return c};
x3dom.getElementAttribute=function(a){var c=this.__getAttribute(a);!c&&a&&(c=this.__getAttribute(a.toLowerCase()));return c||!this._x3domNode?c:this._x3domNode._vf[a]};x3dom.setElementAttribute=function(a,c){this.__setAttribute(a,c);var b=this._x3domNode;b&&(b.updateField(a,c),b._nameSpace.doc.needRender=!0)};
x3dom.NodeNameSpace.prototype.setupTree=function(a){var c=null;if(x3dom.isX3DElement(a)){if(a._x3domNode)return x3dom.debug.logWarning("Tree is already initialized"),null;void 0===a.tagName||a.__addEventListener||a.__removeEventListener||(a.__addEventListener=a.addEventListener,a.addEventListener=function(a,b,c){this._x3domNode._listeners[a]||(this._x3domNode._listeners[a]=[]);this._x3domNode._listeners[a].push(b);this.__addEventListener(a,b,c)},a.__removeEventListener=a.removeEventListener,a.removeEventListener=
function(a,b,c){var d=this._x3domNode._listeners[a];if(d)for(var e=0;e<d.length;e++)d[e]==b&&d.splice(e,1);this.__removeEventListener(a,b,c)});if(a.hasAttribute("USE")){c=this.defMap[a.getAttribute("USE")];if(!c){var b=a.getAttribute("USE").split("__");if(2<=b.length){for(var d=this;d;)d.name==b[0]&&(c=d.defMap[b[1]]),d=c?null:d.parent;c||(c=null,x3dom.debug.logWarning("Could not USE: "+a.getAttribute("USE")))}}c&&(a._x3domNode=c)}else{if("route"===a.localName.toLowerCase()){b=this.defMap[a.getAttribute("fromNode")];
d=this.defMap[a.getAttribute("toNode")];if(!b||!d)return x3dom.debug.logWarning("Broken route - can't find all DEFs for "+a.getAttribute("fromNode")+" -> "+a.getAttribute("toNode")),null;b.setupRoute(a.getAttribute("fromField"),d,a.getAttribute("toField"));a._nodeNameSpace=this;return null}b=x3dom.nodeTypesLC[a.localName.toLowerCase()];if(void 0===b)x3dom.debug.logWarning("Unrecognised X3D element &lt;"+a.localName+"&gt;.");else{!1===x3dom.userAgentFeature.supportsDOMAttrModified&&a instanceof Element&&
(a.setAttribute&&!a.__setAttribute&&(a.__setAttribute=a.setAttribute,a.setAttribute=x3dom.setElementAttribute),a.getAttribute&&!a.__getAttribute&&(a.__getAttribute=a.getAttribute,a.getAttribute=x3dom.getElementAttribute),a.hasAttribute&&!a.__hasAttribute&&(a.__hasAttribute=a.hasAttribute,a.hasAttribute=x3dom.hasElementAttribute));c=new b({doc:this.doc,xmlNode:a,nameSpace:this});a.hasAttribute("DEF")?(c._DEF=a.getAttribute("DEF"),this.defMap[c._DEF]=c):a.hasAttribute("id")&&(c._DEF=a.getAttribute("id"),
this.defMap[c._DEF]=c);void 0===a.highlight&&(a.highlight=function(a,b){var c=x3dom.fields.SFColor.parse(b);this._x3domNode.highlight(a,c);this._x3domNode._nameSpace.doc.needRender=!0});c._xmlNode=a;a._x3domNode=c;var e=this;Array.forEach(a.childNodes,function(a){var b=e.setupTree(a);b&&c.addChild(b,a.getAttribute("containerField"))});c.nodeChanged()}}}else a.localName&&(x3dom.debug.logWarning("Unrecognised X3D element &lt;"+a.localName+"&gt;."),c=null);return c};
x3dom.registerNodeType("X3DNode","Core",defineClass(null,function(a){this._DEF=this._xmlNode=null;this._nameSpace=a&&a.nameSpace?a.nameSpace:null;this._vf={};this._vfFieldTypes={};this._cf={};this._cfFieldTypes={};this._fieldWatchers={};this._routes={};this._listeners={};this._parentNodes=[];this._childNodes=[];this.addField_SFNode("metadata",x3dom.nodeTypes.X3DMetadataObject)},{type:function(){return this.constructor},typeName:function(){return this.constructor._typeName},addChild:function(a,c){if(a){var b=
null;if(c)b=this._cf[c];else for(var d in this._cf)if(this._cf.hasOwnProperty(d)){var e=this._cf[d];if(x3dom.isa(a,e.type)){b=e;break}}if(b&&b.addLink(a))return a._parentNodes.push(this),this._childNodes.push(a),a.parentAdded(this),!0}return!1},removeChild:function(a){if(a)for(var c in this._cf)if(this._cf.hasOwnProperty(c)&&this._cf[c].rmLink(a)){for(var b=a._parentNodes.length-1;0<=b;b--)a._parentNodes[b]===this&&(a._parentNodes.splice(b,1),a.parentRemoved(this));for(b=this._childNodes.length-1;0<=
b;b--)if(this._childNodes[b]===a)return this._childNodes.splice(b,1),!0}return!1},parentAdded:function(a){},parentRemoved:function(a){a=0;for(var c=this._childNodes.length;a<c;a++)this._childNodes[a]&&this._childNodes[a].parentRemoved(this)},getCurrentTransform:function(){return 1<=this._parentNodes.length?this.transformMatrix(this._parentNodes[0].getCurrentTransform()):x3dom.fields.SFMatrix4f.identity()},transformMatrix:function(a){return a},getVolume:function(){return null},invalidateVolume:function(){},
invalidateCache:function(){},volumeValid:function(){return!1},collectDrawableObjects:function(a,c,b,d,e){},highlight:function(a,c){this._vf.hasOwnProperty("diffuseColor")&&(a?(void 0===this._actDiffuseColor&&(this._actDiffuseColor=new x3dom.fields.SFColor,this._highlightOn=!1),this._highlightOn||(this._actDiffuseColor.setValues(this._vf.diffuseColor),this._highlightOn=!0),this._vf.diffuseColor.setValues(c)):void 0!==this._actDiffuseColor&&(this._vf.diffuseColor.setValues(this._actDiffuseColor),this._highlightOn=
!1,delete this._actDiffuseColor));for(var b=0,d=this._childNodes.length;b<d;b++)this._childNodes[b]&&this._childNodes[b].highlight(a,c)},findX3DDoc:function(){return this._nameSpace.doc},doIntersect:function(a){for(var c=!1,b=0;b<this._childNodes.length;b++)this._childNodes[b]&&(c=this._childNodes[b].doIntersect(a)||c);return c},postMessage:function(a,c){this._vf[a]=c;var b=this._fieldWatchers[a],d=this;b&&Array.forEach(b,function(a){a.call(d,c)})},updateField:function(a,c){var b=this._vf[a];if(void 0===
b){if(0==a.indexOf("set_")){var d=a.substr(4,a.length-1);void 0!==this._vf[d]&&(a=d,b=this._vf[a])}void 0===b&&(b={},this._vf[a]=b)}if(null!==b){try{this._vf[a].setValueByStr(c)}catch(e){try{switch((typeof this._vf[a]).toString()){case "number":this._vf[a]="number"==typeof c?c:+c;break;case "boolean":this._vf[a]="boolean"==typeof c?c:"true"==c.toLowerCase();break;case "string":this._vf[a]=c}}catch(f){x3dom.debug.logError("updateField: setValueByStr() NYI for "+typeof b)}}this.fieldChanged(a)}},setupRoute:function(a,
c,b){var d;this._vf[a]||(d=a.indexOf("set_"),0===d?(d=a.substr(4,a.length-1),this._vf[d]&&(a=d)):(d=a.indexOf("_changed"),0<d&&(d=a.substr(0,a.length-8),this._vf[d]&&(a=d))));c._vf[b]||(d=b.indexOf("set_"),0===d?(d=b.substr(4,b.length-1),c._vf[d]&&(b=d)):(d=b.indexOf("_changed"),0<d&&(d=b.substr(0,b.length-8),c._vf[d]&&(b=d))));d=this._DEF+"&"+a+"&"+c._DEF+"&"+b;this._routes[d]||(this._fieldWatchers[a]||(this._fieldWatchers[a]=[]),this._fieldWatchers[a].push(function(a){c.postMessage(b,a)}),c._fieldWatchers[b]||
(c._fieldWatchers[b]=[]),c._fieldWatchers[b].push(function(a){c._vf[b]=a;c.fieldChanged(b)}),this._routes[d]={from:this._fieldWatchers[a].length-1,to:c._fieldWatchers[b].length-1})},removeRoute:function(a,c,b){var d;this._vf[a]||(d=a.indexOf("set_"),0===d?(d=a.substr(4,a.length-1),this._vf[d]&&(a=d)):(d=a.indexOf("_changed"),0<d&&(d=a.substr(0,a.length-8),this._vf[d]&&(a=d))));c._vf[b]||(d=b.indexOf("set_"),0===d?(d=b.substr(4,b.length-1),c._vf[d]&&(b=d)):(d=b.indexOf("_changed"),0<d&&(d=b.substr(0,
b.length-8),c._vf[d]&&(b=d))));d=this._DEF+"&"+a+"&"+c._DEF+"&"+b;this._routes[d]&&(this._fieldWatchers[a].splice(this._routes[d].from,1),c._fieldWatchers[b].splice(this._routes[d].to,1),delete this._routes[d])},fieldChanged:function(a){},nodeChanged:function(){},callEvtHandler:function(a,c){if(!this._xmlNode)return c.cancelBubble;try{var b=this._xmlNode[a];c.target=this._xmlNode;if("function"===typeof b)b.call(this._xmlNode,c);else{var d=this._xmlNode.getAttribute(a);(new Function("event",d)).call(this._xmlNode,
c)}var e=this._listeners[c.type];if(e)for(b=0;b<e.length;b++)e[b].call(this._xmlNode,c)}catch(f){x3dom.debug.logException(f)}return c.cancelBubble},initSetter:function(a,c){a.__defineSetter__&&a.__defineGetter__?(a.__defineSetter__(c,function(b){a.setAttribute(c,b)}),a.__defineGetter__(c,function(){return a.getAttribute(c)})):Object.defineProperty(a,c,{set:function(b){a.setAttribute(c,b)},get:function(){return a.getAttribute(c)},configurable:!0,enumerable:!0});if(this._vf[c]&&!a.attributes[c]&&!a.attributes[c.toLowerCase()]){var b=
"";try{b=this._vf[c].toGL?this._vf[c].toGL().toString():this._vf[c].toString()}catch(d){b=this._vf[c].toString()}b||(b="");a.setAttribute(c,b)}},addField_SFInt32:function(a,c,b){this._vf[c]=a&&a.xmlNode&&a.xmlNode.hasAttribute(c)?parseInt(a.xmlNode.getAttribute(c),10):b;a&&a.xmlNode&&this.initSetter(a.xmlNode,c);this._vfFieldTypes[c]="SFInt32"},addField_SFFloat:function(a,c,b){this._vf[c]=a&&a.xmlNode&&a.xmlNode.hasAttribute(c)?+a.xmlNode.getAttribute(c):b;a&&a.xmlNode&&this.initSetter(a.xmlNode,
c);this._vfFieldTypes[c]="SFFloat"},addField_SFDouble:function(a,c,b){this._vf[c]=a&&a.xmlNode&&a.xmlNode.hasAttribute(c)?+a.xmlNode.getAttribute(c):b;a&&a.xmlNode&&this.initSetter(a.xmlNode,c);this._vfFieldTypes[c]="SFDouble"},addField_SFTime:function(a,c,b){this._vf[c]=a&&a.xmlNode&&a.xmlNode.hasAttribute(c)?+a.xmlNode.getAttribute(c):b;a&&a.xmlNode&&this.initSetter(a.xmlNode,c);this._vfFieldTypes[c]="SFTime"},addField_SFBool:function(a,c,b){this._vf[c]=a&&a.xmlNode&&a.xmlNode.hasAttribute(c)?"true"===
a.xmlNode.getAttribute(c).toLowerCase():b;a&&a.xmlNode&&this.initSetter(a.xmlNode,c);this._vfFieldTypes[c]="SFBool"},addField_SFString:function(a,c,b){this._vf[c]=a&&a.xmlNode&&a.xmlNode.hasAttribute(c)?a.xmlNode.getAttribute(c):b;a&&a.xmlNode&&this.initSetter(a.xmlNode,c);this._vfFieldTypes[c]="SFString"},addField_SFColor:function(a,c,b,d,e){this._vf[c]=a&&a.xmlNode&&a.xmlNode.hasAttribute(c)?x3dom.fields.SFColor.parse(a.xmlNode.getAttribute(c)):new x3dom.fields.SFColor(b,d,e);a&&a.xmlNode&&this.initSetter(a.xmlNode,
c);this._vfFieldTypes[c]="SFColor"},addField_SFColorRGBA:function(a,c,b,d,e,f){this._vf[c]=a&&a.xmlNode&&a.xmlNode.hasAttribute(c)?x3dom.fields.SFColorRGBA.parse(a.xmlNode.getAttribute(c)):new x3dom.fields.SFColorRGBA(b,d,e,f);a&&a.xmlNode&&this.initSetter(a.xmlNode,c);this._vfFieldTypes[c]="SFColorRGBA"},addField_SFVec2f:function(a,c,b,d){this._vf[c]=a&&a.xmlNode&&a.xmlNode.hasAttribute(c)?x3dom.fields.SFVec2f.parse(a.xmlNode.getAttribute(c)):new x3dom.fields.SFVec2f(b,d);a&&a.xmlNode&&this.initSetter(a.xmlNode,
c);this._vfFieldTypes[c]="SFVec2f"},addField_SFVec3f:function(a,c,b,d,e){this._vf[c]=a&&a.xmlNode&&a.xmlNode.hasAttribute(c)?x3dom.fields.SFVec3f.parse(a.xmlNode.getAttribute(c)):new x3dom.fields.SFVec3f(b,d,e);a&&a.xmlNode&&this.initSetter(a.xmlNode,c);this._vfFieldTypes[c]="SFVec3f"},addField_SFVec3d:function(a,c,b,d,e){this.addField_SFVec3f(a,c,b,d,e);this._vfFieldTypes[c]="SFVec3d"},addField_SFRotation:function(a,c,b,d,e,f){this._vf[c]=a&&a.xmlNode&&a.xmlNode.hasAttribute(c)?x3dom.fields.Quaternion.parseAxisAngle(a.xmlNode.getAttribute(c)):
x3dom.fields.Quaternion.axisAngle(new x3dom.fields.SFVec3f(b,d,e),f);a&&a.xmlNode&&this.initSetter(a.xmlNode,c);this._vfFieldTypes[c]="SFRotation"},addField_SFMatrix4f:function(a,c,b,d,e,f,g,h,k,l,n,q,m,p,s,t,w,z){this._vf[c]=a&&a.xmlNode&&a.xmlNode.hasAttribute(c)?x3dom.fields.SFMatrix4f.parse(a.xmlNode.getAttribute(c)):new x3dom.fields.SFMatrix4f(b,d,e,f,g,h,k,l,n,q,m,p,s,t,w,z);a&&a.xmlNode&&this.initSetter(a.xmlNode,c);this._vfFieldTypes[c]="SFMatrix4f"},addField_SFImage:function(a,c,b){this._vf[c]=
a&&a.xmlNode&&a.xmlNode.hasAttribute(c)?x3dom.fields.SFImage.parse(a.xmlNode.getAttribute(c)):new x3dom.fields.SFImage(b);a&&a.xmlNode&&this.initSetter(a.xmlNode,c);this._vfFieldTypes[c]="SFImage"},addField_MFString:function(a,c,b){this._vf[c]=a&&a.xmlNode&&a.xmlNode.hasAttribute(c)?x3dom.fields.MFString.parse(a.xmlNode.getAttribute(c)):new x3dom.fields.MFString(b);a&&a.xmlNode&&this.initSetter(a.xmlNode,c);this._vfFieldTypes[c]="MFString"},addField_MFInt32:function(a,c,b){this._vf[c]=a&&a.xmlNode&&
a.xmlNode.hasAttribute(c)?x3dom.fields.MFInt32.parse(a.xmlNode.getAttribute(c)):new x3dom.fields.MFInt32(b);a&&a.xmlNode&&this.initSetter(a.xmlNode,c);this._vfFieldTypes[c]="MFInt32"},addField_MFFloat:function(a,c,b){this._vf[c]=a&&a.xmlNode&&a.xmlNode.hasAttribute(c)?x3dom.fields.MFFloat.parse(a.xmlNode.getAttribute(c)):new x3dom.fields.MFFloat(b);a&&a.xmlNode&&this.initSetter(a.xmlNode,c);this._vfFieldTypes[c]="MFFloat"},addField_MFDouble:function(a,c,b){this._vf[c]=a&&a.xmlNode&&a.xmlNode.hasAttribute(c)?
x3dom.fields.MFFloat.parse(a.xmlNode.getAttribute(c)):new x3dom.fields.MFFloat(b);a&&a.xmlNode&&this.initSetter(a.xmlNode,c);this._vfFieldTypes[c]="MFDouble"},addField_MFColor:function(a,c,b){this._vf[c]=a&&a.xmlNode&&a.xmlNode.hasAttribute(c)?x3dom.fields.MFColor.parse(a.xmlNode.getAttribute(c)):new x3dom.fields.MFColor(b);a&&a.xmlNode&&this.initSetter(a.xmlNode,c);this._vfFieldTypes[c]="MFColor"},addField_MFColorRGBA:function(a,c,b){this._vf[c]=a&&a.xmlNode&&a.xmlNode.hasAttribute(c)?x3dom.fields.MFColorRGBA.parse(a.xmlNode.getAttribute(c)):
new x3dom.fields.MFColorRGBA(b);a&&a.xmlNode&&this.initSetter(a.xmlNode,c);this._vfFieldTypes[c]="MFColorRGBA"},addField_MFVec2f:function(a,c,b){this._vf[c]=a&&a.xmlNode&&a.xmlNode.hasAttribute(c)?x3dom.fields.MFVec2f.parse(a.xmlNode.getAttribute(c)):new x3dom.fields.MFVec2f(b);a&&a.xmlNode&&this.initSetter(a.xmlNode,c);this._vfFieldTypes[c]="MFVec2f"},addField_MFVec3f:function(a,c,b){this._vf[c]=a&&a.xmlNode&&a.xmlNode.hasAttribute(c)?x3dom.fields.MFVec3f.parse(a.xmlNode.getAttribute(c)):new x3dom.fields.MFVec3f(b);
a&&a.xmlNode&&this.initSetter(a.xmlNode,c);this._vfFieldTypes[c]="MFVec3f"},addField_MFVec3d:function(a,c,b){this.addField_MFVec3f(a,c,b);this._vfFieldTypes[c]="MFVec3d"},addField_MFRotation:function(a,c,b){this._vf[c]=a&&a.xmlNode&&a.xmlNode.hasAttribute(c)?x3dom.fields.MFRotation.parse(a.xmlNode.getAttribute(c)):new x3dom.fields.MFRotation(b);a&&a.xmlNode&&this.initSetter(a.xmlNode,c);this._vfFieldTypes[c]="MFRotation"},addField_SFNode:function(a,c){this._cf[a]=new x3dom.fields.SFNode(c);this._cfFieldTypes[a]=
"SFNode"},addField_MFNode:function(a,c){this._cf[a]=new x3dom.fields.MFNode(c);this._cfFieldTypes[a]="MFNode"}}));x3dom.registerNodeType("X3DMetadataObject","Core",defineClass(x3dom.nodeTypes.X3DNode,function(a){x3dom.nodeTypes.X3DMetadataObject.superClass.call(this,a);this.addField_SFString(a,"name","");this.addField_SFString(a,"reference","")}));
x3dom.registerNodeType("MetadataDouble","Core",defineClass(x3dom.nodeTypes.X3DMetadataObject,function(a){x3dom.nodeTypes.MetadataDouble.superClass.call(this,a);this.addField_MFDouble(a,"value",[])}));x3dom.registerNodeType("MetadataFloat","Core",defineClass(x3dom.nodeTypes.X3DMetadataObject,function(a){x3dom.nodeTypes.MetadataFloat.superClass.call(this,a);this.addField_MFFloat(a,"value",[])}));
x3dom.registerNodeType("MetadataInteger","Core",defineClass(x3dom.nodeTypes.X3DMetadataObject,function(a){x3dom.nodeTypes.MetadataInteger.superClass.call(this,a);this.addField_MFInt32(a,"value",[])}));x3dom.registerNodeType("MetadataSet","Core",defineClass(x3dom.nodeTypes.X3DMetadataObject,function(a){x3dom.nodeTypes.MetadataSet.superClass.call(this,a);this.addField_MFNode("value",x3dom.nodeTypes.X3DMetadataObject)}));
x3dom.registerNodeType("MetadataString","Core",defineClass(x3dom.nodeTypes.X3DMetadataObject,function(a){x3dom.nodeTypes.MetadataString.superClass.call(this,a);this.addField_MFString(a,"value",[])}));
x3dom.registerNodeType("Field","Core",defineClass(x3dom.nodeTypes.X3DNode,function(a){x3dom.nodeTypes.Field.superClass.call(this,a);this.addField_SFString(a,"name","");this.addField_SFString(a,"type","");this.addField_SFString(a,"value","")},{fieldChanged:function(a){var c=this;"value"===a&&Array.forEach(this._parentNodes,function(a){a.fieldChanged(c._vf.name)})}}));
x3dom.registerNodeType("X3DChildNode","Core",defineClass(x3dom.nodeTypes.X3DNode,function(a){x3dom.nodeTypes.X3DChildNode.superClass.call(this,a)}));
x3dom.registerNodeType("X3DBindableNode","Core",defineClass(x3dom.nodeTypes.X3DChildNode,function(a){x3dom.nodeTypes.X3DBindableNode.superClass.call(this,a);this.addField_SFBool(a,"bind",!1);this.addField_SFString(a,"description","");this.addField_SFBool(a,"isActive",!1);if(this._autoGen=a&&a.autoGen?!0:!1)this._vf.description="default"+this.constructor.superClass._typeName;this._stack=null},{bind:function(a){this._stack?a?this._stack.push(this):this._stack.pop(this):x3dom.debug.logError("No BindStack in "+
this.typeName()+"Bindable")},activate:function(a){this.postMessage("isActive",!0);x3dom.debug.logInfo("activate "+this.typeName()+"Bindable "+this._DEF+"/"+this._vf.description)},deactivate:function(a){this.postMessage("isActive",!1);x3dom.debug.logInfo("deactivate "+this.typeName()+"Bindable "+this._DEF+"/"+this._vf.description)},fieldChanged:function(a){0<=a.indexOf("bind")&&this.bind(this._vf.bind)},nodeChanged:function(){this._stack=this._nameSpace.doc._bindableBag.addBindable(this)}}));
x3dom.registerNodeType("X3DInfoNode","Core",defineClass(x3dom.nodeTypes.X3DChildNode,function(a){x3dom.nodeTypes.X3DInfoNode.superClass.call(this,a)}));x3dom.registerNodeType("WorldInfo","Core",defineClass(x3dom.nodeTypes.X3DInfoNode,function(a){x3dom.nodeTypes.WorldInfo.superClass.call(this,a);this.addField_MFString(a,"info",[]);this.addField_SFString(a,"title","");x3dom.debug.logInfo(this._vf.info);x3dom.debug.logInfo(this._vf.title)}));
x3dom.registerNodeType("X3DBoundedNode","Core",defineClass(x3dom.nodeTypes.X3DChildNode,function(a){x3dom.nodeTypes.X3DBoundedNode.superClass.call(this,a);this.addField_SFBool(a,"render",!0);this.addField_SFVec3f(a,"bboxCenter",0,0,0);this.addField_SFVec3f(a,"bboxSize",-1,-1,-1);this._graph={boundedNode:this,localMatrix:x3dom.fields.SFMatrix4f.identity(),globalMatrix:null,volume:new x3dom.fields.BoxVolume,worldVolume:new x3dom.fields.BoxVolume,center:new x3dom.fields.SFVec3f(0,0,0),coverage:-1}},
{fieldChanged:function(a){this._vf.hasOwnProperty(a)&&this.invalidateVolume()},nodeChanged:function(){this.invalidateVolume()},parentAdded:function(a){this.invalidateVolume()},getVolume:function(){var a=this._graph.volume;if(!this.volumeValid()&&this._vf.render)for(var c=0,b=this._childNodes.length;c<b;c++){var d=this._childNodes[c];d&&!0===d._vf.render&&(d=d.getVolume())&&d.isValid()&&a.extendBounds(d.min,d.max)}return a},invalidateVolume:function(){var a=this._graph;a.volume.invalidate();a.worldVolume.invalidate();
a.globalMatrix=null;for(var a=0,c=this._parentNodes.length;a<c;a++){var b=this._parentNodes[a];b&&b.volumeValid()&&b.invalidateVolume()}},invalidateCache:function(){var a=this._graph;a.worldVolume.invalidate();a.globalMatrix=null},cacheInvalid:function(){return null==this._graph.globalMatrix||!this._graph.worldVolume.isValid()},volumeValid:function(){return this._graph.volume.isValid()},graphState:function(){return this._graph},forceUpdateCoverage:function(){return!1}}));
x3dom.registerNodeType("X3DSensorNode","Core",defineClass(x3dom.nodeTypes.X3DChildNode,function(a){x3dom.nodeTypes.X3DSensorNode.superClass.call(this,a)}));x3dom.registerNodeType("Param","Core",defineClass(x3dom.nodeTypes.X3DNode,function(a){x3dom.nodeTypes.Param.superClass.call(this,a);x3dom.debug.logWarning('DEPRECATED: Param element needs to be child of X3D element [<a href="http://x3dom.org/docs/latest/configuration.html">DOCS</a>]')}));
x3dom.registerNodeType("X3DGroupingNode","Grouping",defineClass(x3dom.nodeTypes.X3DBoundedNode,function(a){x3dom.nodeTypes.X3DGroupingNode.superClass.call(this,a);this.addField_MFNode("children",x3dom.nodeTypes.X3DChildNode)},{collectDrawableObjects:function(a,c,b,d,e){b&&1<this._parentNodes.length&&(b=!1);b&&(d=d||this.cacheInvalid())&&this.invalidateCache();e=c.cull(a,this.graphState(),b,e);if(!(0>=e)){var f;b?(this._graph.globalMatrix||(this._graph.globalMatrix=this.transformMatrix(a)),a=this._graph.globalMatrix):
a=this.transformMatrix(a);for(var g=0,h=this._childNodes.length;g<h;g++)(f=this._childNodes[g])&&f.collectDrawableObjects(a,c,b,d,e)}}}));
x3dom.registerNodeType("Switch","Grouping",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(a){x3dom.nodeTypes.Switch.superClass.call(this,a);this.addField_SFInt32(a,"whichChoice",-1)},{fieldChanged:function(a){"whichChoice"==a&&this.invalidateVolume()},getVolume:function(){var a=this._graph.volume;if(!this.volumeValid()&&this._vf.render&&0<=this._vf.whichChoice&&this._vf.whichChoice<this._childNodes.length){var c=this._childNodes[this._vf.whichChoice];(c=c&&!0===c._vf.render?c.getVolume():null)&&
c.isValid()&&a.extendBounds(c.min,c.max)}return a},collectDrawableObjects:function(a,c,b,d,e){b&&1<this._parentNodes.length&&(b=!1);b&&(d=d||this.cacheInvalid())&&this.invalidateCache();if(!(0>this._vf.whichChoice||this._vf.whichChoice>=this._childNodes.length||0>=(e=c.cull(a,this.graphState(),b,e)))){var f;b?(this._graph.globalMatrix||(this._graph.globalMatrix=this.transformMatrix(a)),a=this._graph.globalMatrix):a=this.transformMatrix(a);(f=this._childNodes[this._vf.whichChoice])&&f.collectDrawableObjects(a,
c,b,d,e)}},doIntersect:function(a){if(0>this._vf.whichChoice||this._vf.whichChoice>=this._childNodes.length)return!1;var c=this._childNodes[this._vf.whichChoice];return c?c.doIntersect(a):!1}}));
x3dom.registerNodeType("X3DTransformNode","Grouping",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(a){x3dom.nodeTypes.X3DTransformNode.superClass.call(this,a);a?a.doc._nodeBag.trans.push(this):x3dom.debug.logWarning("X3DTransformNode: No runtime context found!");this._trafo=null;this._needCssStyleUpdates=!0},{tick:function(a){this._xmlNode&&(this._xmlNode.ontransform||this._xmlNode.hasAttribute("ontransform")||this._listeners.transform)&&(a=this.getCurrentTransform(),this.callEvtHandler("ontransform",
{target:this._xmlNode,type:"transform",worldX:a._03,worldY:a._13,worldZ:a._23,cancelBubble:!1,stopPropagation:function(){this.cancelBubble=!0}}));if(this._needCssStyleUpdates){if((a=x3dom.getStyle(this._xmlNode,"-webkit-transform")||x3dom.getStyle(this._xmlNode,"-moz-transform"))&&"none"!=a)return this._trafo.setValueByStr(a),this.invalidateVolume(),!0;this._needCssStyleUpdates=!1}return!1},transformMatrix:function(a){return a.mult(this._trafo)},getVolume:function(){var a=this._graph.volume;if(!this.volumeValid()&&
this._vf.render){this._graph.localMatrix=this._trafo;for(var c=0,b=this._childNodes.length;c<b;c++){var d=this._childNodes[c];d&&!0===d._vf.render&&(d=d.getVolume())&&d.isValid()&&a.extendBounds(d.min,d.max)}a.isValid()&&a.transform(this._trafo)}return a},doIntersect:function(a){var c=!1,b=this._trafo.inverse(),d=new x3dom.fields.SFVec3f(a.pos.x,a.pos.y,a.pos.z),e=new x3dom.fields.SFVec3f(a.dir.x,a.dir.y,a.dir.z);a.pos=b.multMatrixPnt(a.pos);a.dir=b.multMatrixVec(a.dir);a.hitObject&&(a.dist*=a.dir.length());
for(b=0;b<this._childNodes.length;b++)this._childNodes[b]&&(c=this._childNodes[b].doIntersect(a)||c);a.pos.setValues(d);a.dir.setValues(e);c&&(a.hitPoint=this._trafo.multMatrixPnt(a.hitPoint),a.dist*=a.dir.length());return c},parentRemoved:function(a){var c;if(0==this._parentNodes.length){var b=this.findX3DDoc();a=0;for(c=b._nodeBag.trans.length;a<c;a++)b._nodeBag.trans[a]===this&&b._nodeBag.trans.splice(a,1)}a=0;for(c=this._childNodes.length;a<c;a++)this._childNodes[a]&&this._childNodes[a].parentRemoved(this)}}));
x3dom.registerNodeType("Transform","Grouping",defineClass(x3dom.nodeTypes.X3DTransformNode,function(a){x3dom.nodeTypes.Transform.superClass.call(this,a);this.addField_SFVec3f(a,"center",0,0,0);this.addField_SFVec3f(a,"translation",0,0,0);this.addField_SFRotation(a,"rotation",0,0,1,0);this.addField_SFVec3f(a,"scale",1,1,1);this.addField_SFRotation(a,"scaleOrientation",0,0,1,0);this._trafo=x3dom.fields.SFMatrix4f.translation(this._vf.translation.add(this._vf.center)).mult(this._vf.rotation.toMatrix()).mult(this._vf.scaleOrientation.toMatrix()).mult(x3dom.fields.SFMatrix4f.scale(this._vf.scale)).mult(this._vf.scaleOrientation.toMatrix().inverse()).mult(x3dom.fields.SFMatrix4f.translation(this._vf.center.negate()))},
{fieldChanged:function(a){"center"==a||"translation"==a||"rotation"==a||"scale"==a||"scaleOrientation"==a?(this._trafo=x3dom.fields.SFMatrix4f.translation(this._vf.translation.add(this._vf.center)).mult(this._vf.rotation.toMatrix()).mult(this._vf.scaleOrientation.toMatrix()).mult(x3dom.fields.SFMatrix4f.scale(this._vf.scale)).mult(this._vf.scaleOrientation.toMatrix().inverse()).mult(x3dom.fields.SFMatrix4f.translation(this._vf.center.negate())),this.invalidateVolume()):"render"==a&&this.invalidateVolume()}}));
x3dom.registerNodeType("MatrixTransform","Grouping",defineClass(x3dom.nodeTypes.X3DTransformNode,function(a){x3dom.nodeTypes.MatrixTransform.superClass.call(this,a);this.addField_SFMatrix4f(a,"matrix",1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1);this._trafo=this._vf.matrix.transpose()},{fieldChanged:function(a){"matrix"==a?(this._trafo=this._vf.matrix.transpose(),this.invalidateVolume()):"render"==a&&this.invalidateVolume()}}));
x3dom.registerNodeType("Group","Grouping",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(a){x3dom.nodeTypes.Group.superClass.call(this,a)}));x3dom.registerNodeType("Block","Grouping",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(a){x3dom.nodeTypes.Block.superClass.call(this,a);this.addField_MFString(a,"nameSpaceName",[])}));
x3dom.registerNodeType("StaticGroup","Grouping",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(a){x3dom.nodeTypes.StaticGroup.superClass.call(this,a);this.addField_SFBool(a,"debug",!1);this.addField_SFBool(a,"showDebugBoxVolumes",!1);this.addField_SFString(a,"bvhType","jsBIH");this.addField_SFInt32(a,"maxObjectsPerNode",1);this.addField_SFInt32(a,"maxDepth",-1);this.addField_SFFloat(a,"minRelativeBBoxSize",0.01);this.needBvhRebuild=!0;this.bvh=this.drawableCollection=null},{getMaxDepth:function(){return-1==
this._vf.maxDepth?"jsBIH"==this._vf.bvhType?50:4:this._vf.maxDepth},collectDrawableObjects:function(a,c,b,d,e){b&&1<this._parentNodes.length&&(b=!1);b&&(d=d||this.cacheInvalid())&&this.invalidateCache();e=c.cull(a,this.graphState(),b,e);if(!(0>=e)){var f;b?(this._graph.globalMatrix||(this._graph.globalMatrix=this.transformMatrix(a)),a=this._graph.globalMatrix):a=this.transformMatrix(a);if(this.needBvhRebuild){this.drawableCollection=new x3dom.DrawableCollection({viewArea:c.viewarea,sortTrans:c.sortTrans,
viewMatrix:c.viewMatrix,projMatrix:c.projMatrix,sceneMatrix:c.sceneMatrix,frustumCulling:!1,smallFeatureThreshold:0,context:c.context});var g,h=this._childNodes.length;for(g=0;g<h;g++)(f=this._childNodes[g])&&f.collectDrawableObjects(a,this.drawableCollection,b,d,e);this.drawableCollection.concat();b=this._nameSpace.doc._scene;d=new x3dom.bvh.Settings(this._vf.debug,this._vf.showDebugBoxVolumes,this._vf.bvhType,this._vf.maxObjectsPerNode,this.getMaxDepth(),this._vf.minRelativeBBoxSize);this.bvh="jsBIH"==
this._vf.bvhType?new x3dom.bvh.BIH(b,d):new x3dom.bvh.Culler(this.drawableCollection,b,d);if(this._vf.debug||this._vf.showDebugBoxVolumes)this.bvh=new x3dom.bvh.DebugDecorator(this.bvh,b,d);h=this.drawableCollection.length;for(g=0;g<h;g++)this.bvh.addDrawable(this.drawableCollection.get(g));this.bvh.compile();this._vf.debug&&this.bvh.showCompileStats();this.needBvhRebuild=!1}x3dom.Utils.startMeasure("bvhTraverse");this.bvh.collectDrawables(c);c=x3dom.Utils.stopMeasure("bvhTraverse");this._nameSpace.doc.ctx.x3dElem.runtime.addMeasurement("BVH",
c);this.bvh.showTraverseStats(this._nameSpace.doc.ctx.x3dElem.runtime)}}}));
x3dom.registerNodeType("RemoteSelectionGroup","Grouping",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(a){x3dom.nodeTypes.RemoteSelectionGroup.superClass.call(this,a);this.addField_MFString(a,"url",["ws://localhost:35668/cstreams/0"]);this.addField_MFString(a,"label",[]);this.addField_SFInt32(a,"maxRenderedIds",-1);this.addField_SFBool(a,"reconnect",!0);this.addField_SFFloat(a,"scaleRenderedIdsOnMove",1);this.addField_SFBool(a,"enableCulling",!0);this.addField_MFString(a,"invisibleNodes",[]);
this._idList=[];this._websocket=null;this._nameObjMap={};this._createTime=[];this._visibleList=[];a?this.initializeSocket():x3dom.debug.logWarning("RemoteSelectionGroup: No runtime context found!")},{initializeSocket:function(){var a=this;if("WebSocket"in window){var c="ws://localhost:35668/cstreams/0";this._vf.url.length&&this._vf.url[0].length&&(c=this._vf.url[0]);this._websocket=new WebSocket(c);this._websocket._lastMsg=null;this._websocket._lastData="";this._websocket.onopen=function(b){x3dom.debug.logInfo("WS Connected");
b=a._nameSpace.doc._viewarea.getViewMatrix();this._lastMsg=b.toGL().toString();b=a._nameSpace.doc._viewarea.getProjectionMatrix();this._lastMsg+=","+b.toGL().toString();this.send(this._lastMsg);x3dom.debug.logInfo("WS Sent: "+this._lastMsg);this._lastData=this._lastMsg=""};this._websocket.onclose=function(b){x3dom.debug.logInfo("WS Disconnected");a._vf.reconnect&&window.setTimeout(function(){a.initializeSocket()},2E3)};this._websocket.onmessage=function(b){if(0>a._vf.maxRenderedIds)a._idList=x3dom.fields.MFString.parse(b.data);
else if(0<a._vf.maxRenderedIds){a._idList=[];for(var c=x3dom.fields.MFString.parse(b.data),e=Math.min(c.length,Math.abs(a._vf.maxRenderedIds)),f=0;f<e;++f)a._idList[f]=c[f]}0!=a._vf.maxRenderedIds&&this._lastData!=b.data&&(this._lastData=b.data,a._nameSpace.doc.needRender=!0,a.invalidateVolume())};this._websocket.onerror=function(a){x3dom.debug.logError(a.data)};this._websocket.updateCamera=function(){var b=a._nameSpace.doc._viewarea.getViewMatrix(),c=b.toGL().toString(),b=a._nameSpace.doc._viewarea.getProjectionMatrix(),
c=c+(","+b.toGL().toString());null!=this._lastMsg&&this._lastMsg!=c&&(this._lastMsg=c,this.send(c))}}else x3dom.debug.logError("Browser has no WebSocket support!")},nodeChanged:function(){var a=this._vf.label.length;this._nameObjMap={};this._createTime=Array(a);this._visibleList=Array(a);for(var c=0;c<a;++c){var b=this._childNodes[c];b&&x3dom.isa(b,x3dom.nodeTypes.X3DShapeNode)?(this._nameObjMap[this._vf.label[c]]={shape:b,pos:c},this._visibleList[c]=!0):(this._visibleList[c]=!1,x3dom.debug.logError("Invalid children: "+
this._vf.label[c]));this._createTime[c]=0}this.invalidateVolume();x3dom.debug.logInfo("RemoteSelectionGroup has "+a+" entries.")},fieldChanged:function(a){if("url"==a)this._websocket&&(this._websocket.close(),this._websocket=null),this.initializeSocket();else if("invisibleNodes"==a){a=0;for(var c=this._vf.label.length;a<c;++a){var b=this._childNodes[a];if(b&&x3dom.isa(b,x3dom.nodeTypes.X3DShapeNode)){this._visibleList[a]=!0;for(var b=0,d=this._vf.invisibleNodes.length;b<d;++b){var e=this._vf.invisibleNodes[b],
f=e.lastIndexOf("*"),g=!1;0<f&&(e=e.substring(0,f),g=!0);if(!(1>=e.length)&&(g&&0==this._vf.label[a].indexOf(e)||this._vf.label[a]==e)){this._visibleList[a]=!1;break}}}else this._visibleList[a]=!1}this.invalidateVolume()}else"render"==a&&this.invalidateVolume()},getNumRenderedObjects:function(a,c){var b=a;if(0<this._vf.maxRenderedIds){var d=Math.max(this._vf.maxRenderedIds,16),e=1;c&&(e=Math.min(this._vf.scaleRenderedIdsOnMove,1));d=Math.max(Math.round(e*d),0);b=Math.min(b,d)}return b},collectDrawableObjects:function(a,
c,b,d,e){b&&1<this._parentNodes.length&&(b=!1);b&&(d=d||this.cacheInvalid())&&this.invalidateCache();e=c.cull(a,this.graphState(),b,e);if(!(0>=e)){var f=this._nameSpace.doc._viewarea.isMovingOrAnimating(),g=(new Date).getTime(),h,k,l=this._childNodes.length;if(this._vf.enableCulling){if(this._websocket&&this._websocket.updateCamera(),this._vf.label.length){k=this.getNumRenderedObjects(this._idList.length,f);for(h=0;h<k;h++)(l=this._nameObjMap[this._idList[h]])&&l.shape?(l.shape.collectDrawableObjects(a,
c,b,d,e),this._createTime[l.pos]=g):x3dom.debug.logError("Invalid label: "+this._idList[h]);for(h=0;h<this._childNodes.length;h++)this._childNodes[h]&&!f&&0<this._createTime[h]&&1E4<g-this._createTime[h]&&this._childNodes[h]._cleanupGLObjects&&(this._childNodes[h]._cleanupGLObjects(!0),this._createTime[h]=0)}}else{k=this.getNumRenderedObjects(l,f);var n=0;for(h=0;h<l;h++){var q=this._childNodes[h];if(q){var m=!0;this._visibleList[h]&&n<k&&q.collectDrawableObjects(a,c,b,d,e)&&(this._createTime[h]=
g,n++,m=!1);m&&!f&&0<this._createTime[h]&&1E4<g-this._createTime[h]&&q._cleanupGLObjects&&(q._cleanupGLObjects(!0),this._createTime[h]=0)}}}}}}));
x3dom.registerNodeType("Scene","Core",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(a){x3dom.nodeTypes.Scene.superClass.call(this,a);this.addField_SFString(a,"pickMode","idBuf");this.addField_SFBool(a,"doPickPass",!0);this.addField_SFString(a,"shadowObjectIdMapping","");this._lastMin=new x3dom.fields.SFVec3f(0,0,0);this._lastMax=new x3dom.fields.SFVec3f(1,1,1);this._shadowIdMap=null;this.loadMapping()},{fieldChanged:function(a){"shadowObjectIdMapping"==a&&this.loadMapping()},updateVolume:function(){var a=
this.getVolume();a.isValid()&&(this._lastMin=x3dom.fields.SFVec3f.copy(a.min),this._lastMax=x3dom.fields.SFVec3f.copy(a.max))},loadMapping:function(){this._shadowIdMap=null;if(0!=this._vf.shadowObjectIdMapping.length){var a=this,c=new XMLHttpRequest;c.open("GET",encodeURI(this._nameSpace.getURL(this._vf.shadowObjectIdMapping)),!0);c.send();c.onload=function(){a._shadowIdMap=eval("("+c.response+")")}}}}));
x3dom.BindableStack=function(a,c,b,d){this._doc=a;this._type=c;this._defaultType=b;this._defaultRoot=null;this._getter=d;this._bindBag=[];this._bindStack=[]};x3dom.BindableStack.prototype.top=function(){return 0<this._bindStack.length?this._bindStack[this._bindStack.length-1]:null};x3dom.BindableStack.prototype.push=function(a){var c=this.top();c!==a&&(c&&c.deactivate(),this._bindStack.push(a),a.activate(c))};
x3dom.BindableStack.prototype.replaceTop=function(a){var c=this.top();c!==a&&c&&(c.deactivate(),this._bindStack[this._bindStack.length-1]=a,a.activate(c))};x3dom.BindableStack.prototype.pop=function(a){var c;if(a&&(c=this.top(),a!==c))return null;(c=this._bindStack.pop())&&c.deactivate();return c};
x3dom.BindableStack.prototype.switchTo=function(a){var c=this.getActive(),b=this._bindBag.length,d=0,e=0,f=-1;if(!(1>=b)){switch(a){case "first":d=this._bindBag[0];break;case "last":d=this._bindBag[b-1];break;default:for(e=0;e<b;e++)if(this._bindBag[e]==c){f=e;break}if(0<=f)for(e=f;!d;){e="next"==a?e<b-1?e+1:0:0<e?e-1:b-1;if(e==f)break;0<=this._bindBag[e]._vf.description.length&&(d=this._bindBag[e])}}d?this.replaceTop(d):x3dom.debug.logWarning("Cannot switch bindable; no other bindable with description found.")}};
x3dom.BindableStack.prototype.getActive=function(){if(0===this._bindStack.length){if(0===this._bindBag.length)if(this._defaultRoot){x3dom.debug.logInfo("create new "+this._defaultType._typeName+" for "+this._type._typeName+"-stack");var a=new this._defaultType({doc:this._doc,nameSpace:this._defaultRoot._nameSpace,autoGen:!0});this._defaultRoot.addChild(a);a.nodeChanged()}else x3dom.debug.logError("stack without defaultRoot");else x3dom.debug.logInfo("activate first "+this._type._typeName+" for "+
this._type._typeName+"-stack");this._bindStack.push(this._bindBag[0]);this._bindBag[0].activate()}return this._bindStack[this._bindStack.length-1]};
x3dom.BindableBag=function(a){this._stacks=[];this.addType("X3DViewpointNode","Viewpoint","getViewpoint",a);this.addType("X3DNavigationInfoNode","NavigationInfo","getNavigationInfo",a);this.addType("X3DBackgroundNode","Background","getBackground",a);this.addType("X3DFogNode","Fog","getFog",a);this.addType("X3DEnvironmentNode","Environment","getEnvironment",a)};
x3dom.BindableBag.prototype.addType=function(a,c,b,d){var e=x3dom.nodeTypes[a];c=x3dom.nodeTypes[c];e&&c?(a=new x3dom.BindableStack(d,e,c,b),this._stacks.push(a)):x3dom.debug.logWarning("Invalid Bindable type/defaultType: "+a+"/"+c)};x3dom.BindableBag.prototype.setRefNode=function(a){Array.forEach(this._stacks,function(c){c._defaultRoot=a;a[c._getter]=function(){return c.getActive()}})};
x3dom.BindableBag.prototype.addBindable=function(a){for(var c=0,b=this._stacks.length;c<b;c++){var d=this._stacks[c];if(x3dom.isa(a,d._type)){x3dom.debug.logInfo("register "+a.typeName()+"Bindable "+a._DEF+"/"+a._vf.description);d._bindBag.push(a);if((c=d.top())&&c._autoGen){d.replaceTop(a);a=0;for(b=d._bindBag.length;a<b;a++)if(d._bindBag[a]===c){d._bindBag.splice(a,1);break}d._defaultRoot.removeChild(c)}return d}}x3dom.debug.logError(a.typeName()+" is not a valid bindable");return null};
x3dom.registerNodeType("X3DGeometryNode","Rendering",defineClass(x3dom.nodeTypes.X3DNode,function(a){x3dom.nodeTypes.X3DGeometryNode.superClass.call(this,a);this.addField_SFBool(a,"solid",!0);this.addField_SFBool(a,"ccw",!0);this.addField_SFBool(a,"useGeoCache",!0);this._mesh=new x3dom.Mesh(this)},{getVolume:function(){return this._mesh.getVolume()},invalidateVolume:function(){this._mesh.invalidate()},getCenter:function(){return this._mesh.getCenter()},getDiameter:function(){return this._mesh.getDiameter()},
doIntersect:function(a){return this._mesh.doIntersect(a)},forceUpdateCoverage:function(){return!1},hasIndexOffset:function(){return!1},getColorTexture:function(){return null},getColorTextureURL:function(){return null},parentAdded:function(a){x3dom.isa(a,x3dom.nodeTypes.X3DShapeNode)&&(a._cleanupGLObjects&&a._cleanupGLObjects(!0),a.setAllDirty(),a.invalidateVolume())}}));
x3dom.registerNodeType("Mesh","Rendering",defineClass(x3dom.nodeTypes.X3DGeometryNode,function(a){x3dom.nodeTypes.Mesh.superClass.call(this,a);this.addField_SFString(a,"primType","triangle");this.addField_MFInt32(a,"index",[]);this.addField_MFNode("vertexAttributes",x3dom.nodeTypes.X3DVertexAttributeNode)},{nodeChanged:function(){var a=(new Date).getTime(),c,b=this._cf.vertexAttributes.nodes.length;for(c=0;c<b;c++){var d=this._cf.vertexAttributes.nodes[c]._vf.name;switch(d.toLowerCase()){case "position":this._mesh._positions[0]=
this._cf.vertexAttributes.nodes[c]._vf.value.toGL();break;case "normal":this._mesh._normals[0]=this._cf.vertexAttributes.nodes[c]._vf.value.toGL();break;case "texcoord":this._mesh._texCoords[0]=this._cf.vertexAttributes.nodes[c]._vf.value.toGL();break;case "color":this._mesh._colors[0]=this._cf.vertexAttributes.nodes[c]._vf.value.toGL();break;default:this._mesh._dynamicFields[d]={},this._mesh._dynamicFields[d].numComponents=this._cf.vertexAttributes.nodes[c]._vf.numComponents,this._mesh._dynamicFields[d].value=
this._cf.vertexAttributes.nodes[c]._vf.value.toGL()}}this._mesh._indices[0]=this._vf.index.toGL();this.invalidateVolume();this._mesh._numFaces=this._mesh._indices[0].length/3;this._mesh._numCoords=this._mesh._positions[0].length/3;a=(new Date).getTime()-a;x3dom.debug.logWarning("Mesh load time: "+a+" ms")}}));
x3dom.registerNodeType("PointSet","Rendering",defineClass(x3dom.nodeTypes.X3DGeometryNode,function(a){x3dom.nodeTypes.PointSet.superClass.call(this,a);this.addField_SFNode("coord",x3dom.nodeTypes.Coordinate);this.addField_SFNode("color",x3dom.nodeTypes.X3DColorNode);this._mesh._primType="POINTS"},{nodeChanged:function(){(new Date).getTime();var a=this._cf.coord.node;x3dom.debug.assert(a);var a=a._vf.point,c=3,b=this._cf.color.node,d=new x3dom.fields.MFColor;b&&(d=b._vf.color,x3dom.debug.assert(a.length==
d.length),x3dom.isa(b,x3dom.nodeTypes.ColorRGBA)&&(c=4));this._mesh._numColComponents=c;this._mesh._lit=!1;this._mesh._indices[0]=[];this._mesh._positions[0]=a.toGL();this._mesh._colors[0]=d.toGL();this._mesh._normals[0]=[];this._mesh._texCoords[0]=[];this.invalidateVolume();this._mesh._numCoords=this._mesh._positions[0].length/3;(new Date).getTime()},fieldChanged:function(a){var c=null;"coord"==a?(c=this._cf.coord.node._vf.point,this._mesh._positions[0]=c.toGL(),this.invalidateVolume(),Array.forEach(this._parentNodes,
function(a){a._dirty.positions=!0;a.invalidateVolume()})):"color"==a&&(c=this._cf.color.node._vf.color,this._mesh._colors[0]=c.toGL(),Array.forEach(this._parentNodes,function(a){a._dirty.colors=!0}))}}));
x3dom.registerNodeType("X3DComposedGeometryNode","Rendering",defineClass(x3dom.nodeTypes.X3DGeometryNode,function(a){x3dom.nodeTypes.X3DComposedGeometryNode.superClass.call(this,a);this.addField_SFBool(a,"colorPerVertex",!0);this.addField_SFBool(a,"normalPerVertex",!0);this.addField_SFString(a,"normalUpdateMode","fast");this.addField_MFNode("attrib",x3dom.nodeTypes.X3DVertexAttributeNode);this.addField_SFNode("coord",x3dom.nodeTypes.X3DCoordinateNode);this.addField_SFNode("normal",x3dom.nodeTypes.Normal);
this.addField_SFNode("color",x3dom.nodeTypes.X3DColorNode);this.addField_SFNode("texCoord",x3dom.nodeTypes.X3DTextureCoordinateNode)},{handleAttribs:function(){var a,c=this._cf.attrib.nodes.length;for(a=0;a<c;a++){var b=this._cf.attrib.nodes[a]._vf.name;switch(b.toLowerCase()){case "position":this._mesh._positions[0]=this._cf.attrib.nodes[a]._vf.value.toGL();break;case "normal":this._mesh._normals[0]=this._cf.attrib.nodes[a]._vf.value.toGL();break;case "texcoord":this._mesh._texCoords[0]=this._cf.attrib.nodes[a]._vf.value.toGL();
break;case "color":this._mesh._colors[0]=this._cf.attrib.nodes[a]._vf.value.toGL();break;default:this._mesh._dynamicFields[b]={},this._mesh._dynamicFields[b].numComponents=this._cf.attrib.nodes[a]._vf.numComponents,this._mesh._dynamicFields[b].value=this._cf.attrib.nodes[a]._vf.value.toGL()}}}}));
x3dom.registerNodeType("IndexedLineSet","Rendering",defineClass(x3dom.nodeTypes.X3DGeometryNode,function(a){x3dom.nodeTypes.IndexedLineSet.superClass.call(this,a);this.addField_SFBool(a,"colorPerVertex",!0);this.addField_MFNode("attrib",x3dom.nodeTypes.X3DVertexAttributeNode);this.addField_SFNode("coord",x3dom.nodeTypes.X3DCoordinateNode);this.addField_SFNode("color",x3dom.nodeTypes.X3DColorNode);this.addField_MFInt32(a,"coordIndex",[]);this.addField_MFInt32(a,"colorIndex",[]);this._mesh._primType=
"LINES"},{nodeChanged:function(){(new Date).getTime();var a=this._vf.coordIndex,c=this._vf.colorIndex,b=!1,d=!1,e=this._vf.colorPerVertex;0<c.length&&(d=!0);var f,g,b=this._cf.coord.node;x3dom.debug.assert(b);f=b.getPoints();var h=3,k=this._cf.color.node;k?(b=!0,g=k._vf.color,x3dom.isa(k,x3dom.nodeTypes.ColorRGBA)&&(h=4)):b=!1;this._mesh._indices[0]=[];this._mesh._positions[0]=[];this._mesh._colors[0]=[];var l,n,q,m,p,s;if(b&&d||f.length>x3dom.Utils.maxIndexableCoords){for(k=n=h=l=0;k<a.length;++k)if(-1===
a[k])l=0;else switch(d&&x3dom.debug.assert(-1!=c[k]),l){case 0:q=+a[k];p=d&&e?+c[k]:q;l=1;break;case 1:m=+a[k];s=d&&e?+c[k]:d&&!e?+c[n]:m;this._mesh._indices[0].push(h++,h++);this._mesh._positions[0].push(f[q].x);this._mesh._positions[0].push(f[q].y);this._mesh._positions[0].push(f[q].z);this._mesh._positions[0].push(f[m].x);this._mesh._positions[0].push(f[m].y);this._mesh._positions[0].push(f[m].z);b&&(e||(p=s),this._mesh._colors[0].push(g[p].r),this._mesh._colors[0].push(g[p].g),this._mesh._colors[0].push(g[p].b),
this._mesh._colors[0].push(g[s].r),this._mesh._colors[0].push(g[s].g),this._mesh._colors[0].push(g[s].b));l=2;n++;break;case 2:q=m,p=s,m=+a[k],s=d&&e?+c[k]:d&&!e?+c[n]:m,this._mesh._indices[0].push(h++,h++),this._mesh._positions[0].push(f[q].x),this._mesh._positions[0].push(f[q].y),this._mesh._positions[0].push(f[q].z),this._mesh._positions[0].push(f[m].x),this._mesh._positions[0].push(f[m].y),this._mesh._positions[0].push(f[m].z),b&&(e||(p=s),this._mesh._colors[0].push(g[p].r),this._mesh._colors[0].push(g[p].g),
this._mesh._colors[0].push(g[p].b),this._mesh._colors[0].push(g[s].r),this._mesh._colors[0].push(g[s].g),this._mesh._colors[0].push(g[s].b)),n++}f.length>x3dom.Utils.maxIndexableCoords&&this._mesh.splitMesh(2)}else{c=a.length;for(k=l=0;k<c;++k)if(-1==a[k])l=0;else switch(l){case 0:q=+a[k];l=1;break;case 1:m=+a[k];l=2;this._mesh._indices[0].push(q,m);break;case 2:q=m,m=+a[k],this._mesh._indices[0].push(q,m)}this._mesh._positions[0]=f.toGL();b&&(this._mesh._colors[0]=g.toGL(),this._mesh._numColComponents=
h)}this.invalidateVolume();for(k=this._mesh._numCoords=0;k<this._mesh._indices.length;k++)this._mesh._numCoords+=this._mesh._positions[k].length/3;(new Date).getTime()},fieldChanged:function(a){var c=null;if("coord"==a)c=this._cf.coord.node._vf.point,this._mesh._positions[0]=c.toGL(),this.invalidateVolume(),Array.forEach(this._parentNodes,function(a){a._dirty.positions=!0;a.invalidateVolume()});else if("color"==a)c=this._cf.color.node._vf.color,this._mesh._colors[0]=c.toGL(),Array.forEach(this._parentNodes,
function(a){a._dirty.colors=!0});else if("coordIndex"==a){this._mesh._indices[0]=[];a=this._vf.coordIndex;for(var b,d,e=c=0,f=a.length;e<f;++e)if(-1==a[e])c=0;else switch(c){case 0:b=+a[e];c=1;break;case 1:d=+a[e];c=2;this._mesh._indices[0].push(b,d);break;case 2:b=d,d=+a[e],this._mesh._indices[0].push(b,d)}this.invalidateVolume();Array.forEach(this._parentNodes,function(a){a._dirty.indexes=!0;a.invalidateVolume()})}}}));
x3dom.registerNodeType("IndexedTriangleSet","Rendering",defineClass(x3dom.nodeTypes.X3DComposedGeometryNode,function(a){x3dom.nodeTypes.IndexedTriangleSet.superClass.call(this,a);this.addField_MFInt32(a,"index",[])},{nodeChanged:function(){(new Date).getTime();this.handleAttribs();var a=this._vf.colorPerVertex,c=this._vf.normalPerVertex,b=this._vf.index,d=!1,e=!1,f=!1,g,h,k,l,d=this._cf.coord.node;x3dom.debug.assert(d);g=d._vf.point;var n=this._cf.normal.node;n?(d=!0,h=n._vf.vector):d=!1;var n="",
q=2,f=this._cf.texCoord.node;x3dom.isa(f,x3dom.nodeTypes.MultiTextureCoordinate)&&f._cf.texCoord.nodes.length&&(f=f._cf.texCoord.nodes[0]);f?f._vf.point?(e=!0,k=f._vf.point,x3dom.isa(f,x3dom.nodeTypes.TextureCoordinate3D)&&(q=3)):f._vf.mode&&(n=f._vf.mode):e=!1;var m=3,p=this._cf.color.node;p?(f=!0,l=p._vf.color,x3dom.isa(p,x3dom.nodeTypes.ColorRGBA)&&(m=4)):f=!1;this._mesh._indices[0]=[];this._mesh._positions[0]=[];this._mesh._normals[0]=[];this._mesh._texCoords[0]=[];this._mesh._colors[0]=[];for(var s,
t,w,z,u,v,r,A,D,x,y,B,C,E,F;0<g.length%3;)g.push(g.length-1);p=g.length;if(!c||p>x3dom.Utils.maxIndexableCoords){w=t=s=0;this._mesh._multiIndIndices=[];this._mesh._posSize=g.length;for(p=0;p<b.length;++p)switch(0<p&&0===p%3&&(s=0,w++),s){case 0:z=+b[p];c?r=z:c||(r=w);x=z;a?C=z:a||(C=w);s=1;break;case 1:u=+b[p];c?A=u:c||(A=w);y=u;a?E=u:a||(E=w);s=2;break;case 2:v=+b[p],c?D=v:c||(D=w),B=v,a?F=v:a||(F=w),s=3,this._mesh._indices[0].push(t++,t++,t++),this._mesh._positions[0].push(g[z].x),this._mesh._positions[0].push(g[z].y),
this._mesh._positions[0].push(g[z].z),this._mesh._positions[0].push(g[u].x),this._mesh._positions[0].push(g[u].y),this._mesh._positions[0].push(g[u].z),this._mesh._positions[0].push(g[v].x),this._mesh._positions[0].push(g[v].y),this._mesh._positions[0].push(g[v].z),d?(this._mesh._normals[0].push(h[r].x),this._mesh._normals[0].push(h[r].y),this._mesh._normals[0].push(h[r].z),this._mesh._normals[0].push(h[A].x),this._mesh._normals[0].push(h[A].y),this._mesh._normals[0].push(h[A].z),this._mesh._normals[0].push(h[D].x),
this._mesh._normals[0].push(h[D].y),this._mesh._normals[0].push(h[D].z)):this._mesh._multiIndIndices.push(z,u,v),f&&(this._mesh._colors[0].push(l[C].r),this._mesh._colors[0].push(l[C].g),this._mesh._colors[0].push(l[C].b),4===m&&this._mesh._colors[0].push(l[C].a),this._mesh._colors[0].push(l[E].r),this._mesh._colors[0].push(l[E].g),this._mesh._colors[0].push(l[E].b),4===m&&this._mesh._colors[0].push(l[E].a),this._mesh._colors[0].push(l[F].r),this._mesh._colors[0].push(l[F].g),this._mesh._colors[0].push(l[F].b),
4===m&&this._mesh._colors[0].push(l[F].a)),e&&(this._mesh._texCoords[0].push(k[x].x),this._mesh._texCoords[0].push(k[x].y),3===q&&this._mesh._texCoords[0].push(k[x].z),this._mesh._texCoords[0].push(k[y].x),this._mesh._texCoords[0].push(k[y].y),3===q&&this._mesh._texCoords[0].push(k[y].z),this._mesh._texCoords[0].push(k[B].x),this._mesh._texCoords[0].push(k[B].y),3===q&&this._mesh._texCoords[0].push(k[B].z))}d||this._mesh.calcNormals(c?Math.PI:0);e||this._mesh.calcTexCoords(n);this._mesh.splitMesh()}else{for(p=
w=0;p<b.length;p++)0<p&&0===p%3&&w++,this._mesh._indices[0].push(b[p]),!c&&d&&(this._mesh._normals[0].push(h[w].x),this._mesh._normals[0].push(h[w].y),this._mesh._normals[0].push(h[w].z)),!a&&f&&(this._mesh._colors[0].push(l[w].r),this._mesh._colors[0].push(l[w].g),this._mesh._colors[0].push(l[w].b),4===m&&this._mesh._colors[0].push(l[w].a));this._mesh._positions[0]=g.toGL();d?this._mesh._normals[0]=h.toGL():this._mesh.calcNormals(c?Math.PI:0);e?(this._mesh._texCoords[0]=k.toGL(),this._mesh._numTexComponents=
q):this._mesh.calcTexCoords(n);f&&a&&(this._mesh._colors[0]=l.toGL(),this._mesh._numColComponents=m)}this.invalidateVolume();this._mesh._numFaces=0;for(p=this._mesh._numCoords=0;p<this._mesh._indices.length;p++)this._mesh._numFaces+=this._mesh._indices[p].length/3,this._mesh._numCoords+=this._mesh._positions[p].length/3;(new Date).getTime()},fieldChanged:function(a){var c=this._cf.coord.node._vf.point;if(c.length>x3dom.Utils.maxIndexableCoords)x3dom.debug.logWarning("IndexedTriangleSet: fieldChanged with too many coordinates not yet implemented!");
else if("coord"==a)this._mesh._positions[0]=c.toGL(),this.invalidateVolume(),Array.forEach(this._parentNodes,function(a){a._dirty.positions=!0;a.invalidateVolume()});else if("color"==a){c=this._cf.color.node._vf.color;if(this._vf.colorPerVertex)this._mesh._colors[0]=c.toGL();else if(!this._vf.colorPerVertex){a=0;var b=3;x3dom.isa(this._cf.color.node,x3dom.nodeTypes.ColorRGBA)&&(b=4);this._mesh._colors[0]=[];for(var d=this._vf.index,e=0;e<d.length;++e)0<e&&0===e%3&&a++,this._mesh._colors[0].push(c[a].r),
this._mesh._colors[0].push(c[a].g),this._mesh._colors[0].push(c[a].b),4===b&&this._mesh._colors[0].push(c[a].a)}Array.forEach(this._parentNodes,function(a){a._dirty.colors=!0})}else if("normal"==a){c=this._cf.normal.node._vf.vector;if(this._vf.normalPerVertex)this._mesh._normals[0]=c.toGL();else if(!this._vf.normalPerVertex)for(d=this._vf.index,this._mesh._normals[0]=[],e=a=0;e<d.length;++e)0<e&&0===e%3&&a++,this._mesh._normals[0].push(c[a].x),this._mesh._normals[0].push(c[a].y),this._mesh._normals[0].push(c[a].z);
Array.forEach(this._parentNodes,function(a){a._dirty.normals=!0})}else"texCoord"==a&&(c=this._cf.texCoord.node,x3dom.isa(c,x3dom.nodeTypes.MultiTextureCoordinate)&&c._cf.texCoord.nodes.length&&(c=c._cf.texCoord.nodes[0]),c=c._vf.point,this._mesh._texCoords[0]=c.toGL(),Array.forEach(this._parentNodes,function(a){a._dirty.texcoords=!0}))}}));
x3dom.registerNodeType("IndexedTriangleStripSet","Rendering",defineClass(x3dom.nodeTypes.X3DComposedGeometryNode,function(a){x3dom.nodeTypes.IndexedTriangleStripSet.superClass.call(this,a);this.addField_MFInt32(a,"index",[]);this._hasIndexOffset=!1;this._indexOffset=null},{hasIndexOffset:function(){return this._hasIndexOffset},nodeChanged:function(){this.handleAttribs();var a=!1,c=!1,b=!1,d=this._vf.colorPerVertex,e=this._vf.normalPerVertex,f=this._vf.index,g,h,k,l;g=this._cf.coord.node;x3dom.debug.assert(g);
g=g._vf.point;var n=this._cf.normal.node;n?(a=!0,h=n._vf.vector):a=!1;var q="",n=2,b=this._cf.texCoord.node;x3dom.isa(b,x3dom.nodeTypes.MultiTextureCoordinate)&&b._cf.texCoord.nodes.length&&(b=b._cf.texCoord.nodes[0]);b?b._vf.point?(c=!0,k=b._vf.point,x3dom.isa(b,x3dom.nodeTypes.TextureCoordinate3D)&&(n=3)):b._vf.mode&&(q=b._vf.mode):c=!1;this._mesh._numTexComponents=n;var m=3,p=this._cf.color.node;p?(b=!0,l=p._vf.color,x3dom.isa(p,x3dom.nodeTypes.ColorRGBA)&&(m=4)):b=!1;this._mesh._numColComponents=
m;this._mesh._indices[0]=[];this._mesh._positions[0]=[];this._mesh._normals[0]=[];this._mesh._texCoords[0]=[];this._mesh._colors[0]=[];this.invalidateVolume();this._mesh._numFaces=0;var s=this._mesh._numCoords=0,t=0;if(a&&g.length<=x3dom.Utils.maxIndexableCoords){this._hasIndexOffset=!0;this._indexOffset=[];this._mesh._primType="TRIANGLESTRIP";for(var w=[0],p=0;p<f.length;p++)-1==f[p]?(s++,w.push(this._mesh._indices[0].length)):(this._mesh._indices[0].push(+f[p]),e||(this._mesh._normals[0].push(h[s].x),
this._mesh._normals[0].push(h[s].y),this._mesh._normals[0].push(h[s].z)),d||(this._mesh._colors[0].push(l[s].r),this._mesh._colors[0].push(l[s].g),this._mesh._colors[0].push(l[s].b),4===m&&this._mesh._colors[0].push(l[s].a)));this._mesh._positions[0]=g.toGL();e&&(this._mesh._normals[0]=h.toGL());c?(this._mesh._texCoords[0]=k.toGL(),this._mesh._numTexComponents=n):x3dom.debug.logWarning("IndexedTriangleStripSet: no texCoords given and won't calculate!");b&&(d&&(this._mesh._colors[0]=l.toGL()),this._mesh._numColComponents=
m);for(p=1;p<w.length;p++)c=w[p]-w[p-1],this._indexOffset.push({count:c,offset:2*w[p-1]}),this._mesh._numFaces+=c-2;this._mesh._numCoords=this._mesh._positions[0].length/3}else{this._hasIndexOffset=!1;for(var z,u,v,r,A,D,x,y,B,C,E,F=!1,p=1;p<f.length-2;++p)-1==f[p+1]?(p+=2,s++):(F?(z=f[p],u=f[p-1]):(z=f[p-1],u=f[p]),v=f[p+1],F=!F,e?(w=z,r=u,A=v):e||(w=r=A=s),D=z,x=u,y=v,d?(B=z,C=u,E=v):d||(B=C=E=s),this._mesh._indices[0].push(t++,t++,t++),this._mesh._positions[0].push(g[z].x),this._mesh._positions[0].push(g[z].y),
this._mesh._positions[0].push(g[z].z),this._mesh._positions[0].push(g[u].x),this._mesh._positions[0].push(g[u].y),this._mesh._positions[0].push(g[u].z),this._mesh._positions[0].push(g[v].x),this._mesh._positions[0].push(g[v].y),this._mesh._positions[0].push(g[v].z),a&&(this._mesh._normals[0].push(h[w].x),this._mesh._normals[0].push(h[w].y),this._mesh._normals[0].push(h[w].z),this._mesh._normals[0].push(h[r].x),this._mesh._normals[0].push(h[r].y),this._mesh._normals[0].push(h[r].z),this._mesh._normals[0].push(h[A].x),
this._mesh._normals[0].push(h[A].y),this._mesh._normals[0].push(h[A].z)),b&&(this._mesh._colors[0].push(l[B].r),this._mesh._colors[0].push(l[B].g),this._mesh._colors[0].push(l[B].b),4===m&&this._mesh._colors[0].push(l[B].a),this._mesh._colors[0].push(l[C].r),this._mesh._colors[0].push(l[C].g),this._mesh._colors[0].push(l[C].b),4===m&&this._mesh._colors[0].push(l[C].a),this._mesh._colors[0].push(l[E].r),this._mesh._colors[0].push(l[E].g),this._mesh._colors[0].push(l[E].b),4===m&&this._mesh._colors[0].push(l[E].a)),
c&&(this._mesh._texCoords[0].push(k[D].x),this._mesh._texCoords[0].push(k[D].y),3===n&&this._mesh._texCoords[0].push(k[D].z),this._mesh._texCoords[0].push(k[x].x),this._mesh._texCoords[0].push(k[x].y),3===n&&this._mesh._texCoords[0].push(k[x].z),this._mesh._texCoords[0].push(k[y].x),this._mesh._texCoords[0].push(k[y].y),3===n&&this._mesh._texCoords[0].push(k[y].z)));a||this._mesh.calcNormals(Math.PI);c||this._mesh.calcTexCoords(q);this._mesh.splitMesh();this.invalidateVolume();for(p=0;p<this._mesh._indices.length;p++)this._mesh._numFaces+=
this._mesh._indices[p].length/3,this._mesh._numCoords+=this._mesh._positions[p].length/3}},fieldChanged:function(a){if("coord"!=a&&"normal"!=a&&"texCoord"!=a&&"color"!=a)x3dom.debug.logWarning("IndexedTriangleStripSet: fieldChanged for "+a+" not yet implemented!");else{var c=this._cf.coord.node._vf.point;if(null===this._cf.normal.node||c.length>x3dom.Utils.maxIndexableCoords)if("coord"==a){this._mesh._positions[0]=[];this._mesh._indices[0]=[];this._mesh._normals[0]=[];this._mesh._texCoords[0]=[];
var b=!1,d=!1,e=!1,c=this._vf.colorPerVertex,f=this._vf.normalPerVertex;a=this._vf.index;var g,h,k,l,n=this._cf.coord.node;x3dom.debug.assert(n);g=n._vf.point;(n=this._cf.normal.node)?(b=!0,h=n._vf.vector):b=!1;var q="",n=2,m=this._cf.texCoord.node;x3dom.isa(m,x3dom.nodeTypes.MultiTextureCoordinate)&&m._cf.texCoord.nodes.length&&(m=m._cf.texCoord.nodes[0]);m?m._vf.point?(d=!0,k=m._vf.point,x3dom.isa(m,x3dom.nodeTypes.TextureCoordinate3D)&&(n=3)):m._vf.mode&&(q=m._vf.mode):d=!1;this._mesh._numTexComponents=
n;var p=3;(m=this._cf.color.node)?(e=!0,l=m._vf.color,x3dom.isa(m,x3dom.nodeTypes.ColorRGBA)&&(p=4)):e=!1;this._mesh._numColComponents=p;this._mesh._indices[0]=[];this._mesh._positions[0]=[];this._mesh._normals[0]=[];this._mesh._texCoords[0]=[];this._mesh._colors[0]=[];var s=0,t=0,w,z,u,v,r,A,D,x,y,B,C,E,F=!1;if(b||d||e){for(m=1;m<a.length-2;++m)-1==a[m+1]?(m+=2,s++):(F?(w=a[m],z=a[m-1]):(w=a[m-1],z=a[m]),u=a[m+1],F=!F,f?(v=w,r=z,A=u):f||(v=r=A=s),D=w,x=z,y=u,c?(B=w,C=z,E=u):c||(B=C=E=s),this._mesh._indices[0].push(t++,
t++,t++),this._mesh._positions[0].push(g[w].x),this._mesh._positions[0].push(g[w].y),this._mesh._positions[0].push(g[w].z),this._mesh._positions[0].push(g[z].x),this._mesh._positions[0].push(g[z].y),this._mesh._positions[0].push(g[z].z),this._mesh._positions[0].push(g[u].x),this._mesh._positions[0].push(g[u].y),this._mesh._positions[0].push(g[u].z),b&&(this._mesh._normals[0].push(h[v].x),this._mesh._normals[0].push(h[v].y),this._mesh._normals[0].push(h[v].z),this._mesh._normals[0].push(h[r].x),this._mesh._normals[0].push(h[r].y),
this._mesh._normals[0].push(h[r].z),this._mesh._normals[0].push(h[A].x),this._mesh._normals[0].push(h[A].y),this._mesh._normals[0].push(h[A].z)),e&&(this._mesh._colors[0].push(l[B].r),this._mesh._colors[0].push(l[B].g),this._mesh._colors[0].push(l[B].b),4===p&&this._mesh._colors[0].push(l[B].a),this._mesh._colors[0].push(l[C].r),this._mesh._colors[0].push(l[C].g),this._mesh._colors[0].push(l[C].b),4===p&&this._mesh._colors[0].push(l[C].a),this._mesh._colors[0].push(l[E].r),this._mesh._colors[0].push(l[E].g),
this._mesh._colors[0].push(l[E].b),4===p&&this._mesh._colors[0].push(l[E].a)),d&&(this._mesh._texCoords[0].push(k[D].x),this._mesh._texCoords[0].push(k[D].y),3===n&&this._mesh._texCoords[0].push(k[D].z),this._mesh._texCoords[0].push(k[x].x),this._mesh._texCoords[0].push(k[x].y),3===n&&this._mesh._texCoords[0].push(k[x].z),this._mesh._texCoords[0].push(k[y].x),this._mesh._texCoords[0].push(k[y].y),3===n&&this._mesh._texCoords[0].push(k[y].z)));b||this._mesh.calcNormals(Math.PI);d||this._mesh.calcTexCoords(q);
this._mesh.splitMesh()}else{F=!1;for(m=1;m<a.length;++m)-1==a[m+1]?m+=2:(F?(this._mesh._indices[0].push(a[m]),this._mesh._indices[0].push(a[m-1])):(this._mesh._indices[0].push(a[m-1]),this._mesh._indices[0].push(a[m])),this._mesh._indices[0].push(a[m+1]),F=!F);this._mesh._positions[0]=g.toGL();b?this._mesh._normals[0]=h.toGL():this._mesh.calcNormals(Math.PI);d?(this._mesh._texCoords[0]=k.toGL(),this._mesh._numTexComponents=n):this._mesh.calcTexCoords(q);e&&(this._mesh._colors[0]=l.toGL(),this._mesh._numColComponents=
p)}this.invalidateVolume();this._mesh._numFaces=0;for(m=this._mesh._numCoords=0;m<this._mesh._indices.length;m++)this._mesh._numFaces+=this._mesh._indices[m].length/3,this._mesh._numCoords+=this._mesh._positions[m].length/3;Array.forEach(this._parentNodes,function(a){a.setAllDirty();a.invalidateVolume()})}else if("color"==a){d=this._cf.color.node._vf.color;B=C=E=s=0;p=3;x3dom.isa(this._cf.color.node,x3dom.nodeTypes.ColorRGBA)&&(p=4);this._mesh._colors[0]=[];a=this._vf.index;F=!1;for(m=1;m<a.length-
2;++m)-1==a[m+1]?(m+=2,s++):(this._vf.colorPerVertex?(F?(B=a[m],C=a[m-1]):(B=a[m-1],C=a[m]),E=a[m+1],F=!F):this._vf.colorPerVertex||(B=C=E=s),this._mesh._colors[0].push(d[B].r),this._mesh._colors[0].push(d[B].g),this._mesh._colors[0].push(d[B].b),4===p&&this._mesh._colors[0].push(d[B].a),this._mesh._colors[0].push(d[C].r),this._mesh._colors[0].push(d[C].g),this._mesh._colors[0].push(d[C].b),4===p&&this._mesh._colors[0].push(d[C].a),this._mesh._colors[0].push(d[E].r),this._mesh._colors[0].push(d[E].g),
this._mesh._colors[0].push(d[E].b),4===p&&this._mesh._colors[0].push(d[E].a));Array.forEach(this._parentNodes,function(a){a._dirty.colors=!0})}else if("normal"==a){h=this._cf.normal.node._vf.vector;v=r=A=s=0;this._mesh._normals[0]=[];a=this._vf.index;F=!1;for(m=1;m<a.length-2;++m)-1==a[m+1]?(m+=2,s++):(this._vf.normalPerVertex?(F?(v=a[m],r=a[m-1]):(v=a[m-1],r=a[m]),A=a[m+1],F=!F):this._vf.normalPerVertex||(v=r=A=s),this._mesh._normals[0].push(h[v].x),this._mesh._normals[0].push(h[v].y),this._mesh._normals[0].push(h[v].z),
this._mesh._normals[0].push(h[r].x),this._mesh._normals[0].push(h[r].y),this._mesh._normals[0].push(h[r].z),this._mesh._normals[0].push(h[A].x),this._mesh._normals[0].push(h[A].y),this._mesh._normals[0].push(h[A].z));Array.forEach(this._parentNodes,function(a){a._dirty.normals=!0})}else{if("texCoord"==a){m=this._cf.texCoord.node;x3dom.isa(m,x3dom.nodeTypes.MultiTextureCoordinate)&&m._cf.texCoord.nodes.length&&(m=m._cf.texCoord.nodes[0]);v=m._vf.point;D=x=y=0;n=2;x3dom.isa(m,x3dom.nodeTypes.TextureCoordinate3D)&&
(n=3);this._mesh._texCoords[0]=[];a=this._vf.index;F=!1;for(m=1;m<a.length-2;++m)-1==a[m+1]?m+=2:(F?(D=a[m],x=a[m-1]):(D=a[m-1],x=a[m]),y=a[m+1],F=!F,this._mesh._texCoords[0].push(v[D].x),this._mesh._texCoords[0].push(v[D].y),3===n&&this._mesh._texCoords[0].push(v[D].z),this._mesh._texCoords[0].push(v[x].x),this._mesh._texCoords[0].push(v[x].y),3===n&&this._mesh._texCoords[0].tex(d[x].z),this._mesh._texCoords[0].push(v[y].x),this._mesh._texCoords[0].push(v[y].y),3===n&&this._mesh._texCoords[0].push(v[y].z));
Array.forEach(this._parentNodes,function(a){a._dirty.texcoords=!0})}}else if("coord"==a)this._mesh._positions[0]=c.toGL(),this.invalidateVolume(),Array.forEach(this._parentNodes,function(a){a._dirty.positions=!0;a.invalidateVolume()});else if("color"==a){c=this._cf.color.node._vf.color;if(this._vf.colorPerVertex)this._mesh._colors[0]=c.toGL();else if(!this._vf.colorPerVertex)for(s=0,p=3,x3dom.isa(this._cf.color.node,x3dom.nodeTypes.ColorRGBA)&&(p=4),this._mesh._colors[0]=[],a=this._vf.index,m=0;m<
a.length;++m)-1==a[m]?s++:(this._mesh._colors[0].push(c[s].r),this._mesh._colors[0].push(c[s].g),this._mesh._colors[0].push(c[s].b),4===p&&this._mesh._colors[0].push(c[s].a));Array.forEach(this._parentNodes,function(a){a._dirty.colors=!0})}else if("normal"==a){c=this._cf.normal.node._vf.vector;if(this._vf.normalPerVertex)this._mesh._normals[0]=c.toGL();else if(!this._vf.normalPerVertex)for(a=this._vf.index,this._mesh._normals[0]=[],m=s=0;m<a.length;++m)-1==a[m]?s++:(this._mesh._normals[0].push(c[s].x),
this._mesh._normals[0].push(c[s].y),this._mesh._normals[0].push(c[s].z));Array.forEach(this._parentNodes,function(a){a._dirty.normals=!0})}else"texCoord"==a&&(m=this._cf.texCoord.node,x3dom.isa(m,x3dom.nodeTypes.MultiTextureCoordinate)&&m._cf.texCoord.nodes.length&&(m=m._cf.texCoord.nodes[0]),c=m._vf.point,this._mesh._texCoords[0]=c.toGL(),Array.forEach(this._parentNodes,function(a){a._dirty.texcoords=!0}))}}}));
x3dom.registerNodeType("X3DGeometricPropertyNode","Rendering",defineClass(x3dom.nodeTypes.X3DNode,function(a){x3dom.nodeTypes.X3DGeometricPropertyNode.superClass.call(this,a)}));
x3dom.registerNodeType("X3DCoordinateNode","Rendering",defineClass(x3dom.nodeTypes.X3DGeometricPropertyNode,function(a){x3dom.nodeTypes.X3DCoordinateNode.superClass.call(this,a)},{fieldChanged:function(a){"coord"!==a&&"point"!==a||Array.forEach(this._parentNodes,function(a){a.fieldChanged("coord")})},parentAdded:function(a){a._mesh&&a._cf.coord.node!==this&&a.fieldChanged("coord")}}));
x3dom.registerNodeType("Coordinate","Rendering",defineClass(x3dom.nodeTypes.X3DCoordinateNode,function(a){x3dom.nodeTypes.Coordinate.superClass.call(this,a);this.addField_MFVec3f(a,"point",[])},{getPoints:function(){return this._vf.point}}));
x3dom.registerNodeType("Normal","Rendering",defineClass(x3dom.nodeTypes.X3DGeometricPropertyNode,function(a){x3dom.nodeTypes.Normal.superClass.call(this,a);this.addField_MFVec3f(a,"vector",[])},{fieldChanged:function(a){"normal"!==a&&"vector"!==a||Array.forEach(this._parentNodes,function(a){a.fieldChanged("normal")})},parentAdded:function(a){a._mesh&&a._cf.normal.node!==this&&a.fieldChanged("normal")}}));
x3dom.registerNodeType("X3DColorNode","Rendering",defineClass(x3dom.nodeTypes.X3DGeometricPropertyNode,function(a){x3dom.nodeTypes.X3DColorNode.superClass.call(this,a)},{fieldChanged:function(a){"color"===a&&Array.forEach(this._parentNodes,function(a){a.fieldChanged("color")})},parentAdded:function(a){a._mesh&&a._cf.color.node!==this&&a.fieldChanged("color")}}));
x3dom.registerNodeType("Color","Rendering",defineClass(x3dom.nodeTypes.X3DColorNode,function(a){x3dom.nodeTypes.Color.superClass.call(this,a);this.addField_MFColor(a,"color",[])}));x3dom.registerNodeType("ColorRGBA","Rendering",defineClass(x3dom.nodeTypes.X3DColorNode,function(a){x3dom.nodeTypes.ColorRGBA.superClass.call(this,a);this.addField_MFColorRGBA(a,"color",[])}));
x3dom.registerNodeType("X3DAppearanceNode","Shape",defineClass(x3dom.nodeTypes.X3DNode,function(a){x3dom.nodeTypes.X3DAppearanceNode.superClass.call(this,a)}));
x3dom.registerNodeType("Appearance","Shape",defineClass(x3dom.nodeTypes.X3DAppearanceNode,function(a){x3dom.nodeTypes.Appearance.superClass.call(this,a);this.addField_SFNode("material",x3dom.nodeTypes.X3DMaterialNode);this.addField_SFNode("texture",x3dom.nodeTypes.X3DTextureNode);this.addField_SFNode("textureTransform",x3dom.nodeTypes.X3DTextureTransformNode);this.addField_SFNode("lineProperties",x3dom.nodeTypes.LineProperties);this.addField_SFNode("colorMaskMode",x3dom.nodeTypes.ColorMaskMode);this.addField_SFNode("blendMode",
x3dom.nodeTypes.BlendMode);this.addField_SFNode("depthMode",x3dom.nodeTypes.DepthMode);this.addField_MFNode("shaders",x3dom.nodeTypes.X3DShaderNode);this.addField_SFString(a,"sortType","auto");this.addField_SFInt32(a,"sortKey",0);this._shader=null},{nodeChanged:function(){this._cf.shaders.nodes.length&&(this._shader=this._cf.shaders.nodes[0]);this.checkSortType()},checkSortType:function(){"auto"==this._vf.sortType&&(this._cf.material.node&&0<this._cf.material.node._vf.transparency?this._vf.sortType=
"transparent":this._cf.texture.node&&this._cf.texture.node._vf.url.length?0<=this._cf.texture.node._vf.url[0].toLowerCase().indexOf(".png")?this._vf.sortType="transparent":this._vf.sortType="opaque":this._vf.sortType="opaque")},texTransformMatrix:function(){return null===this._cf.textureTransform.node?x3dom.fields.SFMatrix4f.identity():this._cf.textureTransform.node.texTransformMatrix()},parentAdded:function(a){this!=x3dom.nodeTypes.Appearance._defaultNode&&a.setAppDirty()}}));
x3dom.nodeTypes.Appearance.defaultNode=function(){x3dom.nodeTypes.Appearance._defaultNode||(x3dom.nodeTypes.Appearance._defaultNode=new x3dom.nodeTypes.Appearance,x3dom.nodeTypes.Appearance._defaultNode.nodeChanged());return x3dom.nodeTypes.Appearance._defaultNode};x3dom.registerNodeType("X3DAppearanceChildNode","Shape",defineClass(x3dom.nodeTypes.X3DNode,function(a){x3dom.nodeTypes.X3DAppearanceChildNode.superClass.call(this,a)}));
x3dom.registerNodeType("BlendMode","Shape",defineClass(x3dom.nodeTypes.X3DAppearanceChildNode,function(a){x3dom.nodeTypes.BlendMode.superClass.call(this,a);this.addField_SFString(a,"srcFactor","src_alpha");this.addField_SFString(a,"destFactor","one_minus_src_alpha");this.addField_SFColor(a,"color",1,1,1);this.addField_SFFloat(a,"colorTransparency",0);this.addField_SFString(a,"alphaFunc","none");this.addField_SFFloat(a,"alphaFuncValue",0);this.addField_SFString(a,"equation","none")}));
x3dom.registerNodeType("DepthMode","Shape",defineClass(x3dom.nodeTypes.X3DAppearanceChildNode,function(a){x3dom.nodeTypes.DepthMode.superClass.call(this,a);this.addField_SFBool(a,"enableDepthTest",!0);this.addField_SFString(a,"depthFunc","none");this.addField_SFBool(a,"readOnly",!1);this.addField_SFFloat(a,"zNearRange",-1);this.addField_SFFloat(a,"zFarRange",-1)}));
x3dom.registerNodeType("ColorMaskMode","Shape",defineClass(x3dom.nodeTypes.X3DAppearanceChildNode,function(a){x3dom.nodeTypes.ColorMaskMode.superClass.call(this,a);this.addField_SFBool(a,"maskR",!0);this.addField_SFBool(a,"maskG",!0);this.addField_SFBool(a,"maskB",!0);this.addField_SFBool(a,"maskA",!0)}));
x3dom.registerNodeType("LineProperties","Shape",defineClass(x3dom.nodeTypes.X3DAppearanceChildNode,function(a){x3dom.nodeTypes.LineProperties.superClass.call(this,a);this.addField_SFBool(a,"applied",!0);this.addField_SFInt32(a,"linetype",1);this.addField_SFFloat(a,"linewidthScaleFactor",0)}));
x3dom.registerNodeType("X3DMaterialNode","Shape",defineClass(x3dom.nodeTypes.X3DAppearanceChildNode,function(a){x3dom.nodeTypes.X3DMaterialNode.superClass.call(this,a);this.addField_SFFloat(a,"ambientIntensity",0.2);this.addField_SFColor(a,"diffuseColor",0.8,0.8,0.8);this.addField_SFColor(a,"emissiveColor",0,0,0);this.addField_SFFloat(a,"shininess",0.2);this.addField_SFColor(a,"specularColor",0,0,0);this.addField_SFFloat(a,"transparency",0)}));
x3dom.registerNodeType("Material","Shape",defineClass(x3dom.nodeTypes.X3DMaterialNode,function(a){x3dom.nodeTypes.Material.superClass.call(this,a)},{fieldChanged:function(a){"ambientIntensity"!=a&&"diffuseColor"!=a&&"emissiveColor"!=a&&"shininess"!=a&&"specularColor"!=a&&"transparency"!=a||Array.forEach(this._parentNodes,function(a){Array.forEach(a._parentNodes,function(a){a._dirty.material=!0});a.checkSortType()})}}));
x3dom.nodeTypes.Material.defaultNode=function(){x3dom.nodeTypes.Material._defaultNode||(x3dom.nodeTypes.Material._defaultNode=new x3dom.nodeTypes.Material,x3dom.nodeTypes.Material._defaultNode.nodeChanged());return x3dom.nodeTypes.Material._defaultNode};
x3dom.registerNodeType("TwoSidedMaterial","Shape",defineClass(x3dom.nodeTypes.X3DMaterialNode,function(a){x3dom.nodeTypes.TwoSidedMaterial.superClass.call(this,a);this.addField_SFFloat(a,"backAmbientIntensity",0.2);this.addField_SFColor(a,"backDiffuseColor",0.8,0.8,0.8);this.addField_SFColor(a,"backEmissiveColor",0,0,0);this.addField_SFFloat(a,"backShininess",0.2);this.addField_SFColor(a,"backSpecularColor",0,0,0);this.addField_SFFloat(a,"backTransparency",0);this.addField_SFBool(a,"separateBackColor",
!1)},{fieldChanged:function(a){"ambientIntensity"!=a&&"diffuseColor"!=a&&"emissiveColor"!=a&&"shininess"!=a&&"specularColor"!=a&&"transparency"!=a&&"backAmbientIntensity"!=a&&"backDiffuseColor"!=a&&"backEmissiveColor"!=a&&"backShininess"!=a&&"backSpecularColor"!=a&&"backTransparency"!=a&&"separateBackColor"!=a||Array.forEach(this._parentNodes,function(a){Array.forEach(a._parentNodes,function(a){a._dirty.material=!0});a.checkSortType()})}}));
x3dom.registerNodeType("X3DShapeNode","Shape",defineClass(x3dom.nodeTypes.X3DBoundedNode,function(a){x3dom.nodeTypes.X3DShapeNode.superClass.call(this,a);this.addField_SFBool(a,"isPickable",!0);this.addField_SFNode("appearance",x3dom.nodeTypes.X3DAppearanceNode);this.addField_SFNode("geometry",x3dom.nodeTypes.X3DGeometryNode);this._objectID=0;this._cleanupGLObjects=this._shaderProperties=null;this._dirty={positions:!0,normals:!0,texcoords:!0,colors:!0,indexes:!0,texture:!0,material:!0,text:!0,shader:!0};
this._coordStrideOffset=[0,0];this._normalStrideOffset=[0,0];this._texCoordStrideOffset=[0,0];this._colorStrideOffset=[0,0];this._tessellationProperties=[]},{collectDrawableObjects:function(a,c,b,d,e){var f=this.graphState();b&&1<this._parentNodes.length&&(b=!1);b&&(d||this.cacheInvalid())&&this.invalidateCache();if(!this._cf.geometry.node||0>=c.cull(a,f,b,e))return!1;b&&!this._graph.globalMatrix&&(this._graph.globalMatrix=a);c.addShape(this,a,f);return!0},getVolume:function(){var a=this._graph.volume;
if(!this.volumeValid()&&this._vf.render){var c=this._cf.geometry.node;(c=c?c.getVolume():null)&&c.isValid()&&a.extendBounds(c.min,c.max)}return a},getCenter:function(){var a=this._cf.geometry.node;return a?a.getCenter():new x3dom.fields.SFVec3f(0,0,0)},getDiameter:function(){var a=this._cf.geometry.node;return a?a.getDiameter():0},doIntersect:function(a){return this._cf.geometry.node.doIntersect(a)},forceUpdateCoverage:function(){var a=this._cf.geometry.node;return a?a.forceUpdateCoverage():!1},tessellationProperties:function(){var a=
this._cf.geometry.node;return a&&a._indexOffset?a._indexOffset:this._tessellationProperties},isSolid:function(){return this._cf.geometry.node._vf.solid},isCCW:function(){return this._cf.geometry.node._vf.ccw},parentRemoved:function(a){for(var c=0,b=this._childNodes.length;c<b;c++){var d=this._childNodes[c];d&&d.parentRemoved(this)}a&&a.invalidateVolume();0<this._parentNodes.length&&this.invalidateVolume();this._cleanupGLObjects&&this._cleanupGLObjects()},unsetDirty:function(){this._dirty.positions=
!1;this._dirty.normals=!1;this._dirty.texcoords=!1;this._dirty.colors=!1;this._dirty.indexes=!1;this._dirty.texture=!1;this._dirty.material=!1;this._dirty.text=!1;this._dirty.shader=!1},unsetGeoDirty:function(){this._dirty.positions=!1;this._dirty.normals=!1;this._dirty.texcoords=!1;this._dirty.colors=!1;this._dirty.indexes=!1},setAllDirty:function(){this._dirty.positions=!0;this._dirty.normals=!0;this._dirty.texcoords=!0;this._dirty.colors=!0;this._dirty.indexes=!0;this._dirty.texture=!0;this._dirty.material=
!0;this._dirty.text=!0;this._dirty.shader=!0;this.invalidateVolume()},setAppDirty:function(){this._dirty.texture=!0;this._dirty.material=!0;this._dirty.shader=!0},setGeoDirty:function(){this._dirty.positions=!0;this._dirty.normals=!0;this._dirty.texcoords=!0;this._dirty.colors=!0;this._dirty.indexes=!0;this.invalidateVolume()},getShaderProperties:function(a){if(null==this._shaderProperties||!0==this._dirty.shader||void 0!==this._webgl&&this._webgl.dirtyLighting!=x3dom.Utils.checkDirtyLighting(a))this._shaderProperties=
x3dom.Utils.generateProperties(a,this),this._dirty.shader=!1,void 0!==this._webgl&&(this._webgl.dirtyLighting=x3dom.Utils.checkDirtyLighting(a));return this._shaderProperties},getTextures:function(){var a=[],c=this._cf.appearance.node;if(c){var b=c._cf.texture.node;b&&(x3dom.isa(b,x3dom.nodeTypes.MultiTexture)?a=a.concat(b.getTextures()):a.push(b));(c=c._cf.shaders.nodes[0])&&x3dom.isa(c,x3dom.nodeTypes.CommonSurfaceShader)&&(a=a.concat(c.getTextures()))}(c=this._cf.geometry.node)&&(x3dom.isa(c,x3dom.nodeTypes.ImageGeometry)?
a=a.concat(c.getTextures()):x3dom.isa(c,x3dom.nodeTypes.Text)&&(a=a.concat(c)));return a}}));x3dom.registerNodeType("Shape","Shape",defineClass(x3dom.nodeTypes.X3DShapeNode,function(a){x3dom.nodeTypes.Shape.superClass.call(this,a)},{nodeChanged:function(){this._cf.geometry.node?this._objectID||(this._objectID=++x3dom.nodeTypes.Shape.objectID,x3dom.nodeTypes.Shape.idMap.nodeID[this._objectID]=this):this._DEF&&x3dom.debug.logError("No geometry given in Shape/"+this._DEF);this.invalidateVolume()}}));
x3dom.nodeTypes.Shape.objectID=0;x3dom.nodeTypes.Shape.idMap={nodeID:{},remove:function(a){for(var c in this.nodeID)if(this.nodeID.hasOwnProperty(c)){var b=this.nodeID[c];b._objectID&&a._objectID&&b._objectID===a._objectID&&(delete this.nodeID[c],x3dom.debug.logInfo("Unreg "+b._objectID))}}};
x3dom.registerNodeType("X3DLightNode","Lighting",defineClass(x3dom.nodeTypes.X3DChildNode,function(a){x3dom.nodeTypes.X3DLightNode.superClass.call(this,a);a?a.doc._nodeBag.lights.push(this):x3dom.debug.logWarning("X3DLightNode: No runtime context found!");this._lightID=0;this._dirty=!0;this.addField_SFFloat(a,"ambientIntensity",0);this.addField_SFColor(a,"color",1,1,1);this.addField_SFFloat(a,"intensity",1);this.addField_SFBool(a,"global",!1);this.addField_SFBool(a,"on",!0);this.addField_SFFloat(a,
"shadowIntensity",0);this.addField_SFInt32(a,"shadowMapSize",1024);this.addField_SFInt32(a,"shadowFilterSize",0);this.addField_SFFloat(a,"shadowOffset",0);this.addField_SFFloat(a,"zNear",-1);this.addField_SFFloat(a,"zFar",-1)},{getViewMatrix:function(a){return x3dom.fields.SFMatrix4f.identity},nodeChanged:function(){this._lightID||(this._lightID=++x3dom.nodeTypes.X3DLightNode.lightID)},fieldChanged:function(a){this._vf.hasOwnProperty(a)&&(this._dirty=!0)},parentRemoved:function(a){if(0===this._parentNodes.length){a=
this.findX3DDoc();for(var c=0,b=a._nodeBag.lights.length;c<b;c++)a._nodeBag.lights[c]===this&&a._nodeBag.lights.splice(c,1)}}}));x3dom.nodeTypes.X3DLightNode.lightID=0;
x3dom.registerNodeType("DirectionalLight","Lighting",defineClass(x3dom.nodeTypes.X3DLightNode,function(a){x3dom.nodeTypes.DirectionalLight.superClass.call(this,a);this.addField_SFVec3f(a,"direction",0,0,-1);this.addField_SFInt32(a,"shadowCascades",1);this.addField_SFFloat(a,"shadowSplitFactor",1);this.addField_SFFloat(a,"shadowSplitOffset",0.1)},{getViewMatrix:function(a){var c=this.getCurrentTransform().multMatrixVec(this._vf.direction).normalize();return x3dom.fields.Quaternion.rotateFromTo(new x3dom.fields.SFVec3f(0,
0,-1),c).toMatrix().transpose().mult(x3dom.fields.SFMatrix4f.translation(a.negate()))}}));
x3dom.registerNodeType("PointLight","Lighting",defineClass(x3dom.nodeTypes.X3DLightNode,function(a){x3dom.nodeTypes.PointLight.superClass.call(this,a);this.addField_SFVec3f(a,"attenuation",1,0,0);this.addField_SFVec3f(a,"location",0,0,0);this.addField_SFFloat(a,"radius",100);this._vf.global=!0},{getViewMatrix:function(a){var c=this.getCurrentTransform().multMatrixPnt(this._vf.location);return x3dom.fields.Quaternion.rotateFromTo(new x3dom.fields.SFVec3f(0,0,-1),a).toMatrix().transpose().mult(x3dom.fields.SFMatrix4f.translation(c.negate()))}}));
x3dom.registerNodeType("SpotLight","Lighting",defineClass(x3dom.nodeTypes.X3DLightNode,function(a){x3dom.nodeTypes.SpotLight.superClass.call(this,a);this.addField_SFVec3f(a,"direction",0,0,-1);this.addField_SFVec3f(a,"attenuation",1,0,0);this.addField_SFVec3f(a,"location",0,0,0);this.addField_SFFloat(a,"radius",100);this.addField_SFFloat(a,"beamWidth",1.5707963);this.addField_SFFloat(a,"cutOffAngle",1.5707963);this.addField_SFInt32(a,"shadowCascades",1);this.addField_SFFloat(a,"shadowSplitFactor",
1);this.addField_SFFloat(a,"shadowSplitOffset",0.1);this._vf.global=!0},{getViewMatrix:function(a){a=this.getCurrentTransform().multMatrixPnt(this._vf.location);var c=this.getCurrentTransform().multMatrixVec(this._vf.direction).normalize();return x3dom.fields.Quaternion.rotateFromTo(new x3dom.fields.SFVec3f(0,0,-1),c).toMatrix().transpose().mult(x3dom.fields.SFMatrix4f.translation(a.negate()))}}));
x3dom.registerNodeType("X3DFollowerNode","Followers",defineClass(x3dom.nodeTypes.X3DChildNode,function(a){x3dom.nodeTypes.X3DFollowerNode.superClass.call(this,a);a?a.doc._nodeBag.followers.push(this):x3dom.debug.logWarning("X3DFollowerNode: No runtime context found!");this.addField_SFBool(a,"isActive",!1);this._eps=x3dom.fields.Eps},{parentRemoved:function(a){if(0===this._parentNodes.length){a=this.findX3DDoc();for(var c=0,b=a._nodeBag.followers.length;c<b;c++)a._nodeBag.followers[c]===this&&a._nodeBag.followers.splice(c,
1)}},tick:function(a){return!1},stepResponse:function(a){return 0>=a?0:a>=this._vf.duration?1:this.stepResponseCore(a/this._vf.duration)},stepResponseCore:function(a){return 0.5-0.5*Math.cos(a*Math.PI)}}));x3dom.registerNodeType("X3DChaserNode","Followers",defineClass(x3dom.nodeTypes.X3DFollowerNode,function(a){x3dom.nodeTypes.X3DChaserNode.superClass.call(this,a);this.addField_SFTime(a,"duration",1);this._initDone=!1;this._bufferEndTime=this._currTime=this._stepTime=0;this._numSupports=60}));
x3dom.registerNodeType("X3DDamperNode","Followers",defineClass(x3dom.nodeTypes.X3DFollowerNode,function(a){x3dom.nodeTypes.X3DDamperNode.superClass.call(this,a);this.addField_SFTime(a,"tau",0.3);this.addField_SFFloat(a,"tolerance",-1);this.addField_SFInt32(a,"order",3);this._eps=0>this._vf.tolerance?this._eps:this._vf.tolerance;this._lastTick=0}));
x3dom.registerNodeType("ColorChaser","Followers",defineClass(x3dom.nodeTypes.X3DChaserNode,function(a){x3dom.nodeTypes.ColorChaser.superClass.call(this,a);this.addField_SFColor(a,"initialDestination",0.8,0.8,0.8);this.addField_SFColor(a,"initialValue",0.8,0.8,0.8);this.addField_SFColor(a,"value",0,0,0);this.addField_SFColor(a,"destination",0,0,0);this._buffer=new x3dom.fields.MFColor;this._previousValue=new x3dom.fields.SFColor(0,0,0);this._value=new x3dom.fields.SFColor(0,0,0);this.initialize()},
{fieldChanged:function(a){if(0<=a.indexOf("destination"))this.initialize(),this.updateBuffer(this._currTime),this._vf.isActive||this.postMessage("isActive",!0);else if(0<=a.indexOf("value")){this.initialize();this._previousValue.setValues(this._vf.value);for(a=1;a<this._buffer.length;a++)this._buffer[a].setValues(this._vf.value);this.postMessage("value",this._vf.value);this._vf.isActive||this.postMessage("isActive",!0)}},initialize:function(){if(!this._initDone){this._initDone=!0;this._vf.destination=
this._vf.initialDestination;this._buffer.length=this._numSupports;this._buffer[0]=this._vf.initialDestination;for(var a=1;a<this._buffer.length;a++)this._buffer[a]=this._vf.initialValue;this._previousValue=this._vf.initialValue;this._stepTime=this._vf.duration/this._numSupports;a=!this._buffer[0].equals(this._buffer[1],this._eps);this._vf.isActive!==a&&this.postMessage("isActive",a)}},tick:function(a){this.initialize();this._currTime=a;if(!this._bufferEndTime)return this._bufferEndTime=a,this._value=
this._vf.initialValue,this.postMessage("value",this._value),!0;a=this.updateBuffer(a);for(var c=this._previousValue,b=this._buffer[this._buffer.length-1].subtract(this._previousValue),b=b.multiply(this.stepResponse((this._buffer.length-1+a)*this._stepTime)),c=c.add(b),d=this._buffer.length-2;0<=d;d--)b=this._buffer[d].subtract(this._buffer[d+1]),b=b.multiply(this.stepResponse((d+a)*this._stepTime)),c=c.add(b);c.equals(this._value,this._eps)?this.postMessage("isActive",!1):(this._value.setValues(c),
this.postMessage("value",this._value));return this._vf.isActive},updateBuffer:function(a){a=(a-this._bufferEndTime)/this._stepTime;var c,b,d;if(1<=a){b=Math.floor(a);a-=b;if(b<this._buffer.length){this._previousValue=this._buffer[this._buffer.length-b];for(c=this._buffer.length-1;c>=b;c--)this._buffer[c]=this._buffer[c-b];for(c=0;c<b;c++)d=c/b,this._buffer[c]=this._buffer[b].multiply(d).add(this._vf.destination.multiply(1-d))}else for(this._previousValue=b==this._buffer.length?this._buffer[0]:this._vf.destination,
c=0;c<this._buffer.length;c++)this._buffer[c]=this._vf.destination;this._bufferEndTime+=b*this._stepTime}return a}}));
x3dom.registerNodeType("ColorDamper","Followers",defineClass(x3dom.nodeTypes.X3DDamperNode,function(a){x3dom.nodeTypes.ColorDamper.superClass.call(this,a);this.addField_SFColor(a,"initialDestination",0.8,0.8,0.8);this.addField_SFColor(a,"initialValue",0.8,0.8,0.8);this.addField_SFColor(a,"value",0,0,0);this.addField_SFColor(a,"destination",0,0,0);this._value0=new x3dom.fields.SFColor(0,0,0);this._value1=new x3dom.fields.SFColor(0,0,0);this._value2=new x3dom.fields.SFColor(0,0,0);this._value3=new x3dom.fields.SFColor(0,
0,0);this._value4=new x3dom.fields.SFColor(0,0,0);this._value5=new x3dom.fields.SFColor(0,0,0);this.initialize()},{fieldChanged:function(a){"tolerance"===a?this._eps=0>this._vf.tolerance?0.001:this._vf.tolerance:0<=a.indexOf("destination")?this._value0.equals(this._vf.destination,this._eps)||(this._value0=this._vf.destination,this._vf.isActive||this.postMessage("isActive",!0)):0<=a.indexOf("value")&&(this._value1.setValues(this._vf.value),this._value2.setValues(this._vf.value),this._value3.setValues(this._vf.value),
this._value4.setValues(this._vf.value),this._value5.setValues(this._vf.value),this._lastTick=0,this.postMessage("value",this._value5),this._vf.isActive||(this._lastTick=0,this.postMessage("isActive",!0)))},initialize:function(){this._value0.setValues(this._vf.initialDestination);this._value1.setValues(this._vf.initialValue);this._value2.setValues(this._vf.initialValue);this._value3.setValues(this._vf.initialValue);this._value4.setValues(this._vf.initialValue);this._value5.setValues(this._vf.initialValue);
this._lastTick=0;var a=!this._value0.equals(this._value1,this._eps);this._vf.isActive!==a&&this.postMessage("isActive",a)},distance:function(a,c){var b=a.subtract(c);return Math.sqrt(b.r*b.r+b.g*b.g+b.b*b.b)},tick:function(a){if(!this._lastTick)return this._lastTick=a,!1;var c=Math.exp(-(a-this._lastTick)/this._vf.tau);this._value1=0<this._vf.order&&this._vf.tau?this._value0.add(this._value1.subtract(this._value0).multiply(c)):new x3dom.fields.SFColor(this._value0.r,this._value0.g,this._value0.b);
this._value2=1<this._vf.order&&this._vf.tau?this._value1.add(this._value2.subtract(this._value1).multiply(c)):new x3dom.fields.SFColor(this._value1.r,this._value1.g,this._value1.b);this._value3=2<this._vf.order&&this._vf.tau?this._value2.add(this._value3.subtract(this._value2).multiply(c)):new x3dom.fields.SFColor(this._value2.r,this._value2.g,this._value2.b);this._value4=3<this._vf.order&&this._vf.tau?this._value3.add(this._value4.subtract(this._value3).multiply(c)):new x3dom.fields.SFColor(this._value3.r,
this._value3.g,this._value3.b);this._value5=4<this._vf.order&&this._vf.tau?this._value4.add(this._value5.subtract(this._value4).multiply(c)):new x3dom.fields.SFColor(this._value4.r,this._value4.g,this._value4.b);c=this.distance(this._value1,this._value0);if(1<this._vf.order){var b=this.distance(this._value2,this._value1);b>c&&(c=b)}2<this._vf.order&&(b=this.distance(this._value3,this._value2),b>c&&(c=b));3<this._vf.order&&(b=this.distance(this._value4,this._value3),b>c&&(c=b));4<this._vf.order&&(b=
this.distance(this._value5,this._value4),b>c&&(c=b));if(c<=this._eps)return this._value1.setValues(this._value0),this._value2.setValues(this._value0),this._value3.setValues(this._value0),this._value4.setValues(this._value0),this._value5.setValues(this._value0),this.postMessage("value",this._value0),this.postMessage("isActive",!1),this._lastTick=0,!1;this.postMessage("value",this._value5);this._lastTick=a;return!0}}));
x3dom.registerNodeType("OrientationChaser","Followers",defineClass(x3dom.nodeTypes.X3DChaserNode,function(a){x3dom.nodeTypes.OrientationChaser.superClass.call(this,a);this.addField_SFRotation(a,"initialDestination",0,1,0,0);this.addField_SFRotation(a,"initialValue",0,1,0,0);this.addField_SFRotation(a,"value",0,1,0,0);this.addField_SFRotation(a,"destination",0,1,0,0);this._numSupports=30;this._buffer=new x3dom.fields.MFRotation;this._previousValue=new x3dom.fields.Quaternion(0,1,0,0);this._value=new x3dom.fields.Quaternion(0,
1,0,0);this.initialize()},{fieldChanged:function(a){if(0<=a.indexOf("destination"))this.initialize(),this.updateBuffer(this._currTime),this._vf.isActive||this.postMessage("isActive",!0);else if(0<=a.indexOf("value")){this.initialize();this._previousValue.setValues(this._vf.value);for(a=1;a<this._buffer.length;a++)this._buffer[a].setValues(this._vf.value);this.postMessage("value",this._vf.value);this._vf.isActive||this.postMessage("isActive",!0)}},initialize:function(){if(!this._initDone){this._initDone=
!0;this._vf.destination=x3dom.fields.Quaternion.copy(this._vf.initialDestination);this._buffer.length=this._numSupports;this._buffer[0]=x3dom.fields.Quaternion.copy(this._vf.initialDestination);for(var a=1;a<this._buffer.length;a++)this._buffer[a]=x3dom.fields.Quaternion.copy(this._vf.initialValue);this._previousValue=x3dom.fields.Quaternion.copy(this._vf.initialValue);this._stepTime=this._vf.duration/this._numSupports;a=!this._buffer[0].equals(this._buffer[1],this._eps);this._vf.isActive!==a&&this.postMessage("isActive",
a)}},tick:function(a){this.initialize();this._currTime=a;if(!this._bufferEndTime)return this._bufferEndTime=a,this._value=x3dom.fields.Quaternion.copy(this._vf.initialValue),this.postMessage("value",this._value),!0;a=this.updateBuffer(a);for(var c=x3dom.fields.Quaternion.copy(this._previousValue),b=this._previousValue.inverse().multiply(this._buffer[this._buffer.length-1]),c=c.slerp(c.multiply(b),this.stepResponse((this._buffer.length-1+a)*this._stepTime)),d=this._buffer.length-2;0<=d;d--)b=this._buffer[d+
1].inverse().multiply(this._buffer[d]),c=c.slerp(c.multiply(b),this.stepResponse((d+a)*this._stepTime));c.equals(this._value,this._eps)?this.postMessage("isActive",!1):(c=c.normalize(c),this._value.setValues(c),this.postMessage("value",this._value));return this._vf.isActive},updateBuffer:function(a){a=(a-this._bufferEndTime)/this._stepTime;var c,b,d;if(1<=a){b=Math.floor(a);a-=b;if(b<this._buffer.length){this._previousValue=x3dom.fields.Quaternion.copy(this._buffer[this._buffer.length-b]);for(c=this._buffer.length-
1;c>=b;c--)this._buffer[c]=x3dom.fields.Quaternion.copy(this._buffer[c-b]);for(c=0;c<b;c++)d=c/b,this._buffer[c]=this._vf.destination.slerp(this._buffer[b],d)}else for(this._previousValue=x3dom.fields.Quaternion.copy(b==this._buffer.length?this._buffer[0]:this._vf.destination),c=0;c<this._buffer.length;c++)this._buffer[c]=x3dom.fields.Quaternion.copy(this._vf.destination);this._bufferEndTime+=b*this._stepTime}return a}}));
x3dom.registerNodeType("OrientationDamper","Followers",defineClass(x3dom.nodeTypes.X3DDamperNode,function(a){x3dom.nodeTypes.OrientationDamper.superClass.call(this,a);this.addField_SFRotation(a,"initialDestination",0,1,0,0);this.addField_SFRotation(a,"initialValue",0,1,0,0);this.addField_SFRotation(a,"value",0,1,0,0);this.addField_SFRotation(a,"destination",0,1,0,0);this._value0=new x3dom.fields.Quaternion(0,1,0,0);this._value1=new x3dom.fields.Quaternion(0,1,0,0);this._value2=new x3dom.fields.Quaternion(0,
1,0,0);this._value3=new x3dom.fields.Quaternion(0,1,0,0);this._value4=new x3dom.fields.Quaternion(0,1,0,0);this._value5=new x3dom.fields.Quaternion(0,1,0,0);this.initialize()},{fieldChanged:function(a){"tolerance"===a?this._eps=0>this._vf.tolerance?0.001:this._vf.tolerance:0<=a.indexOf("destination")?this._value0.equals(this._vf.destination,this._eps)||(this._value0=this._vf.destination,this._vf.isActive||this.postMessage("isActive",!0)):0<=a.indexOf("value")&&(this._value1.setValues(this._vf.value),
this._value2.setValues(this._vf.value),this._value3.setValues(this._vf.value),this._value4.setValues(this._vf.value),this._value5.setValues(this._vf.value),this._lastTick=0,this.postMessage("value",this._value5),this._vf.isActive||(this._lastTick=0,this.postMessage("isActive",!0)))},initialize:function(){this._value0.setValues(this._vf.initialDestination);this._value1.setValues(this._vf.initialValue);this._value2.setValues(this._vf.initialValue);this._value3.setValues(this._vf.initialValue);this._value4.setValues(this._vf.initialValue);
this._value5.setValues(this._vf.initialValue);this._lastTick=0;var a=!this._value0.equals(this._value1,this._eps);this._vf.isActive!==a&&this.postMessage("isActive",a)},tick:function(a){if(!this._lastTick)return this._lastTick=a,!1;var c=Math.exp(-(a-this._lastTick)/this._vf.tau);this._value1=0<this._vf.order&&this._vf.tau?this._value0.slerp(this._value1,c):new x3dom.fields.Quaternion(this._value0.x,this._value0.y,this._value0.z,this._value0.w);this._value2=1<this._vf.order&&this._vf.tau?this._value1.slerp(this._value2,
c):new x3dom.fields.Quaternion(this._value1.x,this._value1.y,this._value1.z,this._value1.w);this._value3=2<this._vf.order&&this._vf.tau?this._value2.slerp(this._value3,c):new x3dom.fields.Quaternion(this._value2.x,this._value2.y,this._value2.z,this._value2.w);this._value4=3<this._vf.order&&this._vf.tau?this._value3.slerp(this._value4,c):new x3dom.fields.Quaternion(this._value3.x,this._value3.y,this._value3.z,this._value3.w);this._value5=4<this._vf.order&&this._vf.tau?this._value4.slerp(this._value5,
c):new x3dom.fields.Quaternion(this._value4.x,this._value4.y,this._value4.z,this._value4.w);c=Math.abs(this._value1.inverse().multiply(this._value0).angle());if(1<this._vf.order){var b=Math.abs(this._value2.inverse().multiply(this._value1).angle());b>c&&(c=b)}2<this._vf.order&&(b=Math.abs(this._value3.inverse().multiply(this._value2).angle()),b>c&&(c=b));3<this._vf.order&&(b=Math.abs(this._value4.inverse().multiply(this._value3).angle()),b>c&&(c=b));4<this._vf.order&&(b=Math.abs(this._value5.inverse().multiply(this._value4).angle()),
b>c&&(c=b));if(c<=this._eps)return this._value1.setValues(this._value0),this._value2.setValues(this._value0),this._value3.setValues(this._value0),this._value4.setValues(this._value0),this._value5.setValues(this._value0),this.postMessage("value",this._value0),this.postMessage("isActive",!1),this._lastTick=0,!1;this.postMessage("value",this._value5);this._lastTick=a;return!0}}));
x3dom.registerNodeType("PositionChaser","Followers",defineClass(x3dom.nodeTypes.X3DChaserNode,function(a){x3dom.nodeTypes.PositionChaser.superClass.call(this,a);this.addField_SFVec3f(a,"initialDestination",0,0,0);this.addField_SFVec3f(a,"initialValue",0,0,0);this.addField_SFVec3f(a,"value",0,0,0);this.addField_SFVec3f(a,"destination",0,0,0);this._buffer=new x3dom.fields.MFVec3f;this._previousValue=new x3dom.fields.SFVec3f(0,0,0);this._value=new x3dom.fields.SFVec3f(0,0,0);this.initialize()},{fieldChanged:function(a){if(0<=
a.indexOf("destination"))this.initialize(),this.updateBuffer(this._currTime),this._vf.isActive||this.postMessage("isActive",!0);else if(0<=a.indexOf("value")){this.initialize();this._previousValue.setValues(this._vf.value);for(a=1;a<this._buffer.length;a++)this._buffer[a].setValues(this._vf.value);this.postMessage("value",this._vf.value);this._vf.isActive||this.postMessage("isActive",!0)}},initialize:function(){if(!this._initDone){this._initDone=!0;this._vf.destination=x3dom.fields.SFVec3f.copy(this._vf.initialDestination);
this._buffer.length=this._numSupports;this._buffer[0]=x3dom.fields.SFVec3f.copy(this._vf.initialDestination);for(var a=1;a<this._buffer.length;a++)this._buffer[a]=x3dom.fields.SFVec3f.copy(this._vf.initialValue);this._previousValue=x3dom.fields.SFVec3f.copy(this._vf.initialValue);this._stepTime=this._vf.duration/this._numSupports;a=!this._buffer[0].equals(this._buffer[1],this._eps);this._vf.isActive!==a&&this.postMessage("isActive",a)}},tick:function(a){this.initialize();this._currTime=a;if(!this._bufferEndTime)return this._bufferEndTime=
a,this._value=x3dom.fields.SFVec3f.copy(this._vf.initialValue),this.postMessage("value",this._value),!0;a=this.updateBuffer(a);for(var c=x3dom.fields.SFVec3f.copy(this._previousValue),b=this._buffer[this._buffer.length-1].subtract(this._previousValue),b=b.multiply(this.stepResponse((this._buffer.length-1+a)*this._stepTime)),c=c.add(b),d=this._buffer.length-2;0<=d;d--)b=this._buffer[d].subtract(this._buffer[d+1]),b=b.multiply(this.stepResponse((d+a)*this._stepTime)),c=c.add(b);c.equals(this._value,
this._eps)?this.postMessage("isActive",!1):(this._value.setValues(c),this.postMessage("value",this._value));return this._vf.isActive},updateBuffer:function(a){a=(a-this._bufferEndTime)/this._stepTime;var c,b,d;if(1<=a){b=Math.floor(a);a-=b;if(b<this._buffer.length){this._previousValue=x3dom.fields.SFVec3f.copy(this._buffer[this._buffer.length-b]);for(c=this._buffer.length-1;c>=b;c--)this._buffer[c]=x3dom.fields.SFVec3f.copy(this._buffer[c-b]);for(c=0;c<b;c++)d=c/b,this._buffer[c]=this._buffer[b].multiply(d).add(this._vf.destination.multiply(1-
d))}else for(this._previousValue=x3dom.fields.SFVec3f.copy(b==this._buffer.length?this._buffer[0]:this._vf.destination),c=0;c<this._buffer.length;c++)this._buffer[c]=x3dom.fields.SFVec3f.copy(this._vf.destination);this._bufferEndTime+=b*this._stepTime}return a}}));
x3dom.registerNodeType("PositionChaser2D","Followers",defineClass(x3dom.nodeTypes.X3DChaserNode,function(a){x3dom.nodeTypes.PositionChaser2D.superClass.call(this,a);this.addField_SFVec2f(a,"initialDestination",0,0);this.addField_SFVec2f(a,"initialValue",0,0);this.addField_SFVec2f(a,"value",0,0);this.addField_SFVec2f(a,"destination",0,0);this._buffer=new x3dom.fields.MFVec2f;this._previousValue=new x3dom.fields.SFVec2f(0,0);this._value=new x3dom.fields.SFVec2f(0,0);this.initialize()},{fieldChanged:function(a){if(0<=
a.indexOf("destination"))this.initialize(),this.updateBuffer(this._currTime),this._vf.isActive||this.postMessage("isActive",!0);else if(0<=a.indexOf("value")){this.initialize();this._previousValue.setValues(this._vf.value);for(a=1;a<this._buffer.length;a++)this._buffer[a].setValues(this._vf.value);this.postMessage("value",this._vf.value);this._vf.isActive||this.postMessage("isActive",!0)}},initialize:function(){if(!this._initDone){this._initDone=!0;this._vf.destination=x3dom.fields.SFVec2f.copy(this._vf.initialDestination);
this._buffer.length=this._numSupports;this._buffer[0]=x3dom.fields.SFVec2f.copy(this._vf.initialDestination);for(var a=1;a<this._buffer.length;a++)this._buffer[a]=x3dom.fields.SFVec2f.copy(this._vf.initialValue);this._previousValue=x3dom.fields.SFVec2f.copy(this._vf.initialValue);this._stepTime=this._vf.duration/this._numSupports;a=!this._buffer[0].equals(this._buffer[1],this._eps);this._vf.isActive!==a&&this.postMessage("isActive",a)}},tick:function(a){this.initialize();this._currTime=a;if(!this._bufferEndTime)return this._bufferEndTime=
a,this._value=x3dom.fields.SFVec2f.copy(this._vf.initialValue),this.postMessage("value",this._value),!0;a=this.updateBuffer(a);for(var c=x3dom.fields.SFVec2f.copy(this._previousValue),b=this._buffer[this._buffer.length-1].subtract(this._previousValue),b=b.multiply(this.stepResponse((this._buffer.length-1+a)*this._stepTime)),c=c.add(b),d=this._buffer.length-2;0<=d;d--)b=this._buffer[d].subtract(this._buffer[d+1]),b=b.multiply(this.stepResponse((d+a)*this._stepTime)),c=c.add(b);c.equals(this._value,
this._eps)?this.postMessage("isActive",!1):(this._value.setValues(c),this.postMessage("value",this._value));return this._vf.isActive},updateBuffer:function(a){a=(a-this._bufferEndTime)/this._stepTime;var c,b,d;if(1<=a){b=Math.floor(a);a-=b;if(b<this._buffer.length){this._previousValue=x3dom.fields.SFVec2f.copy(this._buffer[this._buffer.length-b]);for(c=this._buffer.length-1;c>=b;c--)this._buffer[c]=x3dom.fields.SFVec2f.copy(this._buffer[c-b]);for(c=0;c<b;c++)d=c/b,this._buffer[c]=this._buffer[b].multiply(d).add(this._vf.destination.multiply(1-
d))}else for(this._previousValue=x3dom.fields.SFVec2f.copy(b==this._buffer.length?this._buffer[0]:this._vf.destination),c=0;c<this._buffer.length;c++)this._buffer[c]=x3dom.fields.SFVec2f.copy(this._vf.destination);this._bufferEndTime+=b*this._stepTime}return a}}));
x3dom.registerNodeType("PositionDamper","Followers",defineClass(x3dom.nodeTypes.X3DDamperNode,function(a){x3dom.nodeTypes.PositionDamper.superClass.call(this,a);this.addField_SFVec3f(a,"initialDestination",0,0,0);this.addField_SFVec3f(a,"initialValue",0,0,0);this.addField_SFVec3f(a,"value",0,0,0);this.addField_SFVec3f(a,"destination",0,0,0);this._value0=new x3dom.fields.SFVec3f(0,0,0);this._value1=new x3dom.fields.SFVec3f(0,0,0);this._value2=new x3dom.fields.SFVec3f(0,0,0);this._value3=new x3dom.fields.SFVec3f(0,
0,0);this._value4=new x3dom.fields.SFVec3f(0,0,0);this._value5=new x3dom.fields.SFVec3f(0,0,0);this.initialize()},{fieldChanged:function(a){"tolerance"===a?this._eps=0>this._vf.tolerance?0.001:this._vf.tolerance:0<=a.indexOf("destination")?this._value0.equals(this._vf.destination,this._eps)||(this._value0=this._vf.destination,this._vf.isActive||this.postMessage("isActive",!0)):0<=a.indexOf("value")&&(this._value1.setValues(this._vf.value),this._value2.setValues(this._vf.value),this._value3.setValues(this._vf.value),
this._value4.setValues(this._vf.value),this._value5.setValues(this._vf.value),this._lastTick=0,this.postMessage("value",this._value5),this._vf.isActive||(this._lastTick=0,this.postMessage("isActive",!0)))},initialize:function(){this._value0.setValues(this._vf.initialDestination);this._value1.setValues(this._vf.initialValue);this._value2.setValues(this._vf.initialValue);this._value3.setValues(this._vf.initialValue);this._value4.setValues(this._vf.initialValue);this._value5.setValues(this._vf.initialValue);
this._lastTick=0;var a=!this._value0.equals(this._value1,this._eps);this._vf.isActive!==a&&this.postMessage("isActive",a)},tick:function(a){if(!this._lastTick)return this._lastTick=a,!1;var c=Math.exp(-(a-this._lastTick)/this._vf.tau);this._value1=0<this._vf.order&&this._vf.tau?this._value0.add(this._value1.subtract(this._value0).multiply(c)):new x3dom.fields.SFVec3f(this._value0.x,this._value0.y,this._value0.z);this._value2=1<this._vf.order&&this._vf.tau?this._value1.add(this._value2.subtract(this._value1).multiply(c)):
new x3dom.fields.SFVec3f(this._value1.x,this._value1.y,this._value1.z);this._value3=2<this._vf.order&&this._vf.tau?this._value2.add(this._value3.subtract(this._value2).multiply(c)):new x3dom.fields.SFVec3f(this._value2.x,this._value2.y,this._value2.z);this._value4=3<this._vf.order&&this._vf.tau?this._value3.add(this._value4.subtract(this._value3).multiply(c)):new x3dom.fields.SFVec3f(this._value3.x,this._value3.y,this._value3.z);this._value5=4<this._vf.order&&this._vf.tau?this._value4.add(this._value5.subtract(this._value4).multiply(c)):
new x3dom.fields.SFVec3f(this._value4.x,this._value4.y,this._value4.z);c=this._value1.subtract(this._value0).length();if(1<this._vf.order){var b=this._value2.subtract(this._value1).length();b>c&&(c=b)}2<this._vf.order&&(b=this._value3.subtract(this._value2).length(),b>c&&(c=b));3<this._vf.order&&(b=this._value4.subtract(this._value3).length(),b>c&&(c=b));4<this._vf.order&&(b=this._value5.subtract(this._value4).length(),b>c&&(c=b));if(c<=this._eps)return this._value1.setValues(this._value0),this._value2.setValues(this._value0),
this._value3.setValues(this._value0),this._value4.setValues(this._value0),this._value5.setValues(this._value0),this.postMessage("value",this._value0),this.postMessage("isActive",!1),this._lastTick=0,!1;this.postMessage("value",this._value5);this._lastTick=a;return!0}}));
x3dom.registerNodeType("PositionDamper2D","Followers",defineClass(x3dom.nodeTypes.X3DDamperNode,function(a){x3dom.nodeTypes.PositionDamper2D.superClass.call(this,a);this.addField_SFVec2f(a,"initialDestination",0,0);this.addField_SFVec2f(a,"initialValue",0,0);this.addField_SFVec2f(a,"value",0,0);this.addField_SFVec2f(a,"destination",0,0);this._value0=new x3dom.fields.SFVec2f(0,0);this._value1=new x3dom.fields.SFVec2f(0,0);this._value2=new x3dom.fields.SFVec2f(0,0);this._value3=new x3dom.fields.SFVec2f(0,
0);this._value4=new x3dom.fields.SFVec2f(0,0);this._value5=new x3dom.fields.SFVec2f(0,0);this.initialize()},{fieldChanged:function(a){"tolerance"===a?this._eps=0>this._vf.tolerance?0.001:this._vf.tolerance:0<=a.indexOf("destination")?this._value0.equals(this._vf.destination,this._eps)||(this._value0=this._vf.destination,this._vf.isActive||this.postMessage("isActive",!0)):0<=a.indexOf("value")&&(this._value1.setValues(this._vf.value),this._value2.setValues(this._vf.value),this._value3.setValues(this._vf.value),
this._value4.setValues(this._vf.value),this._value5.setValues(this._vf.value),this._lastTick=0,this.postMessage("value",this._value5),this._vf.isActive||(this._lastTick=0,this.postMessage("isActive",!0)))},initialize:function(){this._value0.setValues(this._vf.initialDestination);this._value1.setValues(this._vf.initialValue);this._value2.setValues(this._vf.initialValue);this._value3.setValues(this._vf.initialValue);this._value4.setValues(this._vf.initialValue);this._value5.setValues(this._vf.initialValue);
this._lastTick=0;var a=!this._value0.equals(this._value1,this._eps);this._vf.isActive!==a&&this.postMessage("isActive",a)},tick:function(a){if(!this._lastTick)return this._lastTick=a,!1;var c=Math.exp(-(a-this._lastTick)/this._vf.tau);this._value1=0<this._vf.order&&this._vf.tau?this._value0.add(this._value1.subtract(this._value0).multiply(c)):new x3dom.fields.SFVec2f(this._value0.x,this._value0.y,this._value0.z);this._value2=1<this._vf.order&&this._vf.tau?this._value1.add(this._value2.subtract(this._value1).multiply(c)):
new x3dom.fields.SFVec2f(this._value1.x,this._value1.y,this._value1.z);this._value3=2<this._vf.order&&this._vf.tau?this._value2.add(this._value3.subtract(this._value2).multiply(c)):new x3dom.fields.SFVec2f(this._value2.x,this._value2.y,this._value2.z);this._value4=3<this._vf.order&&this._vf.tau?this._value3.add(this._value4.subtract(this._value3).multiply(c)):new x3dom.fields.SFVec2f(this._value3.x,this._value3.y,this._value3.z);this._value5=4<this._vf.order&&this._vf.tau?this._value4.add(this._value5.subtract(this._value4).multiply(c)):
new x3dom.fields.SFVec2f(this._value4.x,this._value4.y,this._value4.z);c=this._value1.subtract(this._value0).length();if(1<this._vf.order){var b=this._value2.subtract(this._value1).length();b>c&&(c=b)}2<this._vf.order&&(b=this._value3.subtract(this._value2).length(),b>c&&(c=b));3<this._vf.order&&(b=this._value4.subtract(this._value3).length(),b>c&&(c=b));4<this._vf.order&&(b=this._value5.subtract(this._value4).length(),b>c&&(c=b));if(c<=this._eps)return this._value1.setValues(this._value0),this._value2.setValues(this._value0),
this._value3.setValues(this._value0),this._value4.setValues(this._value0),this._value5.setValues(this._value0),this.postMessage("value",this._value0),this.postMessage("isActive",!1),this._lastTick=0,!1;this.postMessage("value",this._value5);this._lastTick=a;return!0}}));
x3dom.registerNodeType("ScalarChaser","Followers",defineClass(x3dom.nodeTypes.X3DChaserNode,function(a){x3dom.nodeTypes.ScalarChaser.superClass.call(this,a);this.addField_SFFloat(a,"initialDestination",0);this.addField_SFFloat(a,"initialValue",0);this.addField_SFFloat(a,"value",0);this.addField_SFFloat(a,"destination",0);this._buffer=[];this._value=this._previousValue=0;this.initialize()},{fieldChanged:function(a){if(0<=a.indexOf("destination"))this.initialize(),this.updateBuffer(this._currTime),
this._vf.isActive||this.postMessage("isActive",!0);else if(0<=a.indexOf("value")){this.initialize();this._previousValue=this._vf.value;for(a=1;a<this._buffer.length;a++)this._buffer[a]=this._vf.value;this.postMessage("value",this._vf.value);this._vf.isActive||this.postMessage("isActive",!0)}},initialize:function(){if(!this._initDone){this._initDone=!0;this._vf.destination=this._vf.initialDestination;this._buffer.length=this._numSupports;this._buffer[0]=this._vf.initialDestination;for(var a=1;a<this._buffer.length;a++)this._buffer[a]=
this._vf.initialValue;this._previousValue=this._vf.initialValue;this._stepTime=this._vf.duration/this._numSupports;a=Math.abs(this._buffer[0]-this._buffer[1])>this._eps;this._vf.isActive!==a&&this.postMessage("isActive",a)}},tick:function(a){this.initialize();this._currTime=a;if(!this._bufferEndTime)return this._bufferEndTime=a,this._value=this._vf.initialValue,this.postMessage("value",this._value),!0;a=this.updateBuffer(a);for(var c=this._previousValue,b=this._buffer[this._buffer.length-1]-this._previousValue,
b=b*this.stepResponse((this._buffer.length-1+a)*this._stepTime),c=c+b,d=this._buffer.length-2;0<=d;d--)b=this._buffer[d]-this._buffer[d+1],b*=this.stepResponse((d+a)*this._stepTime),c+=b;Math.abs(c-this._value)>this._eps?(this._value=c,this.postMessage("value",this._value)):this.postMessage("isActive",!1);return this._vf.isActive},updateBuffer:function(a){a=(a-this._bufferEndTime)/this._stepTime;var c,b,d;if(1<=a){b=Math.floor(a);a-=b;if(b<this._buffer.length){this._previousValue=this._buffer[this._buffer.length-
b];for(c=this._buffer.length-1;c>=b;c--)this._buffer[c]=this._buffer[c-b];for(c=0;c<b;c++)d=c/b,this._buffer[c]=this._buffer[b]*d+this._vf.destination*(1-d)}else for(this._previousValue=b==this._buffer.length?this._buffer[0]:this._vf.destination,c=0;c<this._buffer.length;c++)this._buffer[c]=this._vf.destination;this._bufferEndTime+=b*this._stepTime}return a}}));
x3dom.registerNodeType("ScalarDamper","Followers",defineClass(x3dom.nodeTypes.X3DDamperNode,function(a){x3dom.nodeTypes.ScalarDamper.superClass.call(this,a);this.addField_SFFloat(a,"initialDestination",0);this.addField_SFFloat(a,"initialValue",0);this.addField_SFFloat(a,"value",0);this.addField_SFFloat(a,"destination",0);this._value5=this._value4=this._value3=this._value2=this._value1=this._value0=0;this.initialize()},{fieldChanged:function(a){"tolerance"===a?this._eps=0>this._vf.tolerance?0.001:
this._vf.tolerance:0<=a.indexOf("destination")?Math.abs(this._value0-this._vf.destination)>this._eps&&(this._value0=this._vf.destination,this._vf.isActive||this.postMessage("isActive",!0)):0<=a.indexOf("value")&&(this._value5=this._value4=this._value3=this._value2=this._value1=this._vf.value,this._lastTick=0,this.postMessage("value",this._value5),this._vf.isActive||(this._lastTick=0,this.postMessage("isActive",!0)))},initialize:function(){this._value0=this._vf.initialDestination;this._value5=this._value4=
this._value3=this._value2=this._value1=this._vf.initialValue;this._lastTick=0;var a=Math.abs(this._value0-this._value1)>this._eps;this._vf.isActive!==a&&this.postMessage("isActive",a)},tick:function(a){if(!this._lastTick)return this._lastTick=a,!1;var c=Math.exp(-(a-this._lastTick)/this._vf.tau);this._value1=0<this._vf.order&&this._vf.tau?this._value0+c*(this._value1-this._value0):this._value0;this._value2=1<this._vf.order&&this._vf.tau?this._value1+c*(this._value2-this._value1):this._value1;this._value3=
2<this._vf.order&&this._vf.tau?this._value2+c*(this._value3-this._value2):this._value2;this._value4=3<this._vf.order&&this._vf.tau?this._value3+c*(this._value4-this._value3):this._value3;this._value5=4<this._vf.order&&this._vf.tau?this._value4+c*(this._value5-this._value4):this._value4;c=Math.abs(this._value1-this._value0);if(1<this._vf.order){var b=Math.abs(this._value2-this._value1);b>c&&(c=b)}2<this._vf.order&&(b=Math.abs(this._value3-this._value2),b>c&&(c=b));3<this._vf.order&&(b=Math.abs(this._value4-
this._value3),b>c&&(c=b));4<this._vf.order&&(b=Math.abs(this._value5-this._value4),b>c&&(c=b));if(c<=this._eps)return this._value5=this._value4=this._value3=this._value2=this._value1=this._value0,this.postMessage("value",this._value0),this.postMessage("isActive",!1),this._lastTick=0,!1;this.postMessage("value",this._value5);this._lastTick=a;return!0}}));
x3dom.registerNodeType("CoordinateDamper","Followers",defineClass(x3dom.nodeTypes.X3DDamperNode,function(a){x3dom.nodeTypes.CoordinateDamper.superClass.call(this,a);this.addField_MFVec3f(a,"initialDestination",[]);this.addField_MFVec3f(a,"initialValue",[]);this.addField_MFVec3f(a,"value",[]);this.addField_MFVec3f(a,"destination",[]);x3dom.debug.logWarning("CoordinateDamper NYI")}));
x3dom.registerNodeType("TexCoordDamper2D","Followers",defineClass(x3dom.nodeTypes.X3DDamperNode,function(a){x3dom.nodeTypes.TexCoordDamper2D.superClass.call(this,a);this.addField_MFVec2f(a,"initialDestination",[]);this.addField_MFVec2f(a,"initialValue",[]);this.addField_MFVec2f(a,"value",[]);this.addField_MFVec2f(a,"destination",[]);x3dom.debug.logWarning("TexCoordDamper2D NYI")}));
x3dom.registerNodeType("X3DInterpolatorNode","Interpolation",defineClass(x3dom.nodeTypes.X3DChildNode,function(a){x3dom.nodeTypes.X3DInterpolatorNode.superClass.call(this,a);this.addField_MFFloat(a,"key",[]);this.addField_SFFloat(a,"set_fraction",0)},{linearInterp:function(a,c){if(a<=this._vf.key[0])return this._vf.keyValue[0];if(a>=this._vf.key[this._vf.key.length-1])return this._vf.keyValue[this._vf.key.length-1];for(var b=0;b<this._vf.key.length-1;++b)if(this._vf.key[b]<a&&a<=this._vf.key[b+1])return c(this._vf.keyValue[b],
this._vf.keyValue[b+1],(a-this._vf.key[b])/(this._vf.key[b+1]-this._vf.key[b]));return this._vf.keyValue[0]}}));
x3dom.registerNodeType("OrientationInterpolator","Interpolation",defineClass(x3dom.nodeTypes.X3DInterpolatorNode,function(a){x3dom.nodeTypes.OrientationInterpolator.superClass.call(this,a);this.addField_MFRotation(a,"keyValue",[])},{fieldChanged:function(a){"set_fraction"===a&&(a=this.linearInterp(this._vf.set_fraction,function(a,b,d){return a.slerp(b,d)}),this.postMessage("value_changed",a))}}));
x3dom.registerNodeType("PositionInterpolator","Interpolation",defineClass(x3dom.nodeTypes.X3DInterpolatorNode,function(a){x3dom.nodeTypes.PositionInterpolator.superClass.call(this,a);this.addField_MFVec3f(a,"keyValue",[])},{fieldChanged:function(a){"set_fraction"===a&&(a=this.linearInterp(this._vf.set_fraction,function(a,b,d){return a.multiply(1-d).add(b.multiply(d))}),this.postMessage("value_changed",a))}}));
x3dom.registerNodeType("NormalInterpolator","Interpolation",defineClass(x3dom.nodeTypes.X3DInterpolatorNode,function(a){x3dom.nodeTypes.NormalInterpolator.superClass.call(this,a);this.addField_MFVec3f(a,"keyValue",[])},{fieldChanged:function(a){"set_fraction"===a&&(a=this.linearInterp(this._vf.set_fraction,function(a,b,d){return a.multiply(1-d).add(b.multiply(d)).normalize()}),this.postMessage("value_changed",a))}}));
x3dom.registerNodeType("ColorInterpolator","Interpolation",defineClass(x3dom.nodeTypes.X3DInterpolatorNode,function(a){x3dom.nodeTypes.ColorInterpolator.superClass.call(this,a);this.addField_MFColor(a,"keyValue",[])},{fieldChanged:function(a){"set_fraction"===a&&(a=this.linearInterp(this._vf.set_fraction,function(a,b,d){return a.multiply(1-d).add(b.multiply(d))}),this.postMessage("value_changed",a))}}));
x3dom.registerNodeType("ScalarInterpolator","Interpolation",defineClass(x3dom.nodeTypes.X3DInterpolatorNode,function(a){x3dom.nodeTypes.ScalarInterpolator.superClass.call(this,a);this.addField_MFFloat(a,"keyValue",[])},{fieldChanged:function(a){"set_fraction"===a&&(a=this.linearInterp(this._vf.set_fraction,function(a,b,d){return(1-d)*a+d*b}),this.postMessage("value_changed",a))}}));
x3dom.registerNodeType("CoordinateInterpolator","Interpolation",defineClass(x3dom.nodeTypes.X3DInterpolatorNode,function(a){x3dom.nodeTypes.CoordinateInterpolator.superClass.call(this,a);this.addField_MFVec3f(a,"keyValue",[]);if(a&&a.xmlNode.hasAttribute("keyValue")){this._vf.keyValue=[];a=x3dom.fields.MFVec3f.parse(a.xmlNode.getAttribute("keyValue"));for(var c=0<this._vf.key.length?this._vf.key.length:1,b=a.length/c,d=0;d<c;d++){for(var e=new x3dom.fields.MFVec3f,f=0;f<b;f++)e.push(a[d*b+f]);this._vf.keyValue.push(e)}}},
{fieldChanged:function(a){"set_fraction"===a&&(a=this.linearInterp(this._vf.set_fraction,function(a,b,d){for(var e=new x3dom.fields.MFVec3f,f=0;f<a.length;f++)e.push(a[f].multiply(1-d).add(b[f].multiply(d)));return e}),this.postMessage("value_changed",a))}}));
x3dom.registerNodeType("TimeSensor","Time",defineClass(x3dom.nodeTypes.X3DSensorNode,function(a){x3dom.nodeTypes.TimeSensor.superClass.call(this,a);a?a.doc._nodeBag.timer.push(this):x3dom.debug.logWarning("TimeSensor: No runtime context found!");this.addField_SFTime(a,"cycleInterval",1);this.addField_SFBool(a,"enabled",!0);this.addField_SFBool(a,"loop",!1);this.addField_SFTime(a,"startTime",0);this.addField_SFTime(a,"stopTime",0);this.addField_SFTime(a,"pauseTime",0);this.addField_SFTime(a,"resumeTime",
0);this.addField_SFTime(a,"cycleTime",0);this.addField_SFTime(a,"elapsedTime",0);this.addField_SFFloat(a,"fraction_changed",0);this.addField_SFBool(a,"isActive",!1);this.addField_SFBool(a,"isPaused",!1);this.addField_SFTime(a,"time",0);this.addField_SFBool(a,"first",!0);this.addField_SFFloat(a,"firstCycle",0);this._prevCycle=-1;this._activatedTime=this._cycleStopTime=this._lastTime=0;0<this._vf.startTime&&this._updateCycleStopTime();this._backupStartTime=this._vf.startTime;this._backupStopTime=this._vf.stopTime;
this._backupCycleInterval=this._vf.cycleInterval},{tick:function(a){if(!this._vf.enabled)return this._lastTime=a,!1;var c=0<this._vf.cycleInterval&&a>=this._vf.startTime&&(a<this._vf.stopTime||this._vf.stopTime<=this._vf.startTime)&&(!0==this._vf.loop||!1==this._vf.loop&&a<this._cycleStopTime);c&&!this._vf.isActive&&(this.postMessage("isActive",!0),this._activatedTime=a);if(c||this._vf.isActive){this.postMessage("elapsedTime",a-this._activatedTime);var b=a>=this._vf.pauseTime&&this._vf.pauseTime>
this._vf.resumeTime;b&&!this._vf.isPaused?(this.postMessage("isPaused",!0),this.postMessage("pauseTime",a)):!b&&this._vf.isPaused&&(this.postMessage("isPaused",!1),this.postMessage("resumeTime",a));if(!b){var b=this._getCycleAt(a),d=Math.floor(b),e=this._vf.startTime+d*this._vf.cycleInterval,f=0;this._vf.stopTime>this._vf.startTime&&this._lastTime<this._vf.stopTime&&a>=this._vf.stopTime?f=this._vf.stopTime:this._lastTime<e&&a>=e&&(f=e);0<f&&(a=f,b=this._getCycleAt(a),d=Math.floor(b));b-=d;b<x3dom.fields.Eps&&
(b=this._lastTime<this._vf.startTime?0:1,this.postMessage("cycleTime",a));this.postMessage("fraction_changed",b);this.postMessage("time",a)}}!c&&this._vf.isActive&&this.postMessage("isActive",!1);this._lastTime=a;return!0},fieldChanged:function(a){"enabled"==a?!this._vf.enabled&&this._vf.isActive&&this.postMessage("isActive",!1):"startTime"==a?this._vf.isActive?this._vf.startTime=this._backupStartTime:(this._backupStartTime=this._vf.startTime,this._updateCycleStopTime()):"stopTime"==a?this._vf.isActive&&
this._vf.stopTime<=this._vf.startTime?this._vf.stopTime=this._backupStopTime:this._backupStopTime=this._vf.stopTime:"cycleInterval"==a?this._vf.isActive?this._vf.cycleInterval=this._backupCycleInterval:(this._backupCycleInterval=this._vf.cycleInterval,this._updateCycleStopTime()):"loop"==a&&this._updateCycleStopTime()},parentRemoved:function(a){if(0===this._parentNodes.length){a=this.findX3DDoc();for(var c=0,b=a._nodeBag.timer.length;c<b;c++)a._nodeBag.timer[c]===this&&a._nodeBag.timer.splice(c,1)}},
_getCycleAt:function(a){return Math.max(0,a-this._vf.startTime)/this._vf.cycleInterval},_updateCycleStopTime:function(){if(!1==this._vf.loop){var a=(new Date).getTime()/1E3,a=Math.floor(this._getCycleAt(a))+1;this._cycleStopTime=this._vf.startTime+a*this._vf.cycleInterval}else this._cycleStopTime=0}}));
x3dom.registerNodeType("X3DTimeDependentNode","Time",defineClass(x3dom.nodeTypes.X3DChildNode,function(a){x3dom.nodeTypes.X3DTimeDependentNode.superClass.call(this,a);this.addField_SFBool(a,"loop",!1)}));
x3dom.registerNodeType("Anchor","Networking",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(a){x3dom.nodeTypes.Anchor.superClass.call(this,a);this.addField_MFString(a,"url",[]);this.addField_MFString(a,"parameter",[])},{doIntersect:function(a){for(var c=!1,b=0;b<this._childNodes.length;b++)this._childNodes[b]&&(c=this._childNodes[b].doIntersect(a)||c);return c},handleTouch:function(){var a=this._vf.url.length?this._vf.url[0]:"",c=a.search("#"),b="";0<=c&&(b=a.slice(c+1));var c=this._vf.parameter.length?
this._vf.parameter[0]:"",d=c.search("target="),e="";0<=d&&(e=c.slice(d+7));x3dom.debug.logInfo("Anchor url="+a+", target="+e+", #viewpoint="+b);0==e.length||"_blank"==e?window.open(this._nameSpace.getURL(a),e):window.location=this._nameSpace.getURL(a)}}));
x3dom.registerNodeType("Inline","Networking",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(a){x3dom.nodeTypes.Inline.superClass.call(this,a);this.addField_MFString(a,"url",[]);this.addField_SFBool(a,"load",!0);this.addField_MFString(a,"nameSpaceName",[]);this.addField_SFBool(a,"mapDEFToID",!1);this.count=0;this.numRetries=x3dom.nodeTypes.Inline.MaximumRetries},{fieldChanged:function(a){if("url"==a){if(0!=this._vf.nameSpaceName.length&&(a=this._xmlNode)&&a.hasChildNodes())for(;1<=a.childNodes.length;)a.removeChild(a.firstChild);
this.nodeChanged()}else"render"==a&&this.invalidateVolume()},fireEvents:function(a){if(this._xmlNode&&(this._xmlNode["on"+a]||this._xmlNode.hasAttribute("on"+a)||this._listeners[a])){var c={target:this._xmlNode,type:a,error:"error"==a?"XMLHttpRequest Error":"",cancelBubble:!1,stopPropagation:function(){this.cancelBubble=!0}};try{var b=this._xmlNode["on"+a];if("function"===typeof b)b.call(this._xmlNode,c);else{var d=this._xmlNode.getAttribute("on"+a);(new Function("event",d)).call(this._xmlNode,c)}var e=
this._listeners[a];if(e)for(a=0;a<e.length;a++)e[a].call(this._xmlNode,c)}catch(f){x3dom.debug.logException(f)}}},nodeChanged:function(){var a=this,c=new window.XMLHttpRequest;c.overrideMimeType&&c.overrideMimeType("text/xml");c.onreadystatechange=function(){if(4!=c.readyState)return c;if(c.status===x3dom.nodeTypes.Inline.AwaitTranscoding&&a.count<a.numRetries){a.count++;var b=+c.getResponseHeader("Refresh")||5;x3dom.debug.logInfo("Statuscode "+c.status+" and send new request in "+b+" sec.");window.setTimeout(function(){a._nameSpace.doc.downloadCount-=
1;a.nodeChanged()},1E3*b);return c}if(200!==c.status&&0!==c.status)return a.fireEvents("error"),x3dom.debug.logError("XHR status: "+c.status+" - XMLHttpRequest requires web server running!"),a._nameSpace.doc.downloadCount-=1,a.count=0,c;if(200==c.status||0==c.status)a.count=0;x3dom.debug.logInfo("Inline: downloading "+a._vf.url[0]+" done.");var d=b=null,g=null,g=null,g="Microsoft Internet Explorer"!=navigator.appName?c.responseXML:(new DOMParser).parseFromString(c.responseText,"text/xml");void 0!==
g&&null!==g?b=g.getElementsByTagName("Scene")[0]||g.getElementsByTagName("scene")[0]:a.fireEvents("error");b?(d=0!=a._vf.nameSpaceName.length?a._vf.nameSpaceName.toString().replace(" ",""):"",g=new x3dom.NodeNameSpace(d,a._nameSpace.doc),d=a._vf.url.length?a._vf.url[0]:"","/"===d[0]||0<=d.indexOf(":")?g.setBaseURL(d):g.setBaseURL(a._nameSpace.baseURL+d),d=g.setupTree(b),a._nameSpace.addSpace(g),0!=a._vf.nameSpaceName.length&&Array.forEach(b.childNodes,function(b){b instanceof Element&&(setNamespace(a._vf.nameSpaceName,
b,a._vf.mapDEFToID),a._xmlNode.appendChild(b))})):g&&g.localName?x3dom.debug.logError("No Scene in "+g.localName):x3dom.debug.logError("No Scene in resource");b=x3dom.getGlobal();for(0<a._childNodes.length&&a._childNodes[0]&&a._childNodes[0]._nameSpace&&a._nameSpace.removeSpace(a._childNodes[0]._nameSpace);0!==a._childNodes.length;)b._remover=a.removeChild(a._childNodes[0]);delete b._remover;if(d){a.addChild(d);a.invalidateVolume();a._nameSpace.doc.downloadCount-=1;a._nameSpace.doc.needRender=!0;
x3dom.debug.logInfo("Inline: added "+a._vf.url[0]+" to scene.");var h=a._nameSpace.doc._scene;h&&(h.invalidateVolume(),window.setTimeout(function(){a.invalidateVolume();h.updateVolume();a._nameSpace.doc.needRender=!0},1E3));a.fireEvents("load")}g=b=g=d=null;return c};if(this._vf.url.length&&this._vf.url[0].length){var b=this._nameSpace.getURL(this._vf.url[0]);"blob:"!==b.substr(0,5)&&(b=encodeURI(b));c.open("GET",b,!0);this._nameSpace.doc.downloadCount+=1;try{c.send(null)}catch(d){this.fireEvents("error"),
x3dom.debug.logError(this._vf.url[0]+": "+d)}}}}));x3dom.nodeTypes.Inline.AwaitTranscoding=202;x3dom.nodeTypes.Inline.MaximumRetries=15;function setNamespace(a,c,b){c instanceof Element&&void 0!==c.__setAttribute&&(c.hasAttribute("id")?c.__setAttribute("id",a.toString().replace(" ","")+"__"+c.getAttribute("id")):c.hasAttribute("DEF")&&b&&c.__setAttribute("id",a.toString().replace(" ","")+"__"+c.getAttribute("DEF")));c.hasChildNodes()&&Array.forEach(c.childNodes,function(c){setNamespace(a,c,b)})}
x3dom.registerNodeType("X3DBackgroundNode","EnvironmentalEffects",defineClass(x3dom.nodeTypes.X3DBindableNode,function(a){x3dom.nodeTypes.X3DBackgroundNode.superClass.call(this,a);this.addField_SFBool(a,"withCredentials",!1);this._dirty=!0},{getSkyColor:function(){return new x3dom.fields.SFColor(0,0,0)},getTransparency:function(){return 0},getTexUrl:function(){return[]}}));
x3dom.registerNodeType("X3DFogNode","EnvironmentalEffects",defineClass(x3dom.nodeTypes.X3DBindableNode,function(a){x3dom.nodeTypes.X3DFogNode.superClass.call(this,a)},{}));x3dom.registerNodeType("Fog","EnvironmentalEffects",defineClass(x3dom.nodeTypes.X3DFogNode,function(a){x3dom.nodeTypes.Fog.superClass.call(this,a);this.addField_SFColor(a,"color",1,1,1);this.addField_SFString(a,"fogType","LINEAR");this.addField_SFFloat(a,"visibilityRange",0)},{}));
x3dom.registerNodeType("Background","EnvironmentalEffects",defineClass(x3dom.nodeTypes.X3DBackgroundNode,function(a){x3dom.nodeTypes.Background.superClass.call(this,a);var c=a&&a.autoGen?1:0;this.addField_MFColor(a,"skyColor",[new x3dom.fields.SFColor(0,0,0)]);this.addField_MFFloat(a,"skyAngle",[]);this.addField_MFColor(a,"groundColor",[]);this.addField_MFFloat(a,"groundAngle",[]);this.addField_SFFloat(a,"transparency",c);this.addField_MFString(a,"backUrl",[]);this.addField_MFString(a,"bottomUrl",
[]);this.addField_MFString(a,"frontUrl",[]);this.addField_MFString(a,"leftUrl",[]);this.addField_MFString(a,"rightUrl",[]);this.addField_MFString(a,"topUrl",[])},{fieldChanged:function(a){0<a.indexOf("Url")||"transparency"==a||0<=a.search("sky")||0<=a.search("ground")?this._dirty=!0:0<=a.indexOf("bind")&&this.bind(this._vf.bind)},getSkyColor:function(){return this._vf.skyColor},getGroundColor:function(){return this._vf.groundColor},getTransparency:function(){return this._vf.transparency},getTexUrl:function(){return[this._nameSpace.getURL(this._vf.backUrl[0]),
this._nameSpace.getURL(this._vf.frontUrl[0]),this._nameSpace.getURL(this._vf.bottomUrl[0]),this._nameSpace.getURL(this._vf.topUrl[0]),this._nameSpace.getURL(this._vf.leftUrl[0]),this._nameSpace.getURL(this._vf.rightUrl[0])]}}));x3dom.registerNodeType("X3DEnvironmentNode","EnvironmentalEffects",defineClass(x3dom.nodeTypes.X3DBindableNode,function(a){x3dom.nodeTypes.X3DEnvironmentNode.superClass.call(this,a)}));
x3dom.registerNodeType("Environment","EnvironmentalEffects",defineClass(x3dom.nodeTypes.X3DEnvironmentNode,function(a){x3dom.nodeTypes.Environment.superClass.call(this,a);this.addField_SFBool(a,"sortTrans",!0);this.addField_SFBool(a,"shadowExcludeTransparentObjects",!1);this.addField_SFBool(a,"frustumCulling",!0);this.addField_SFBool(a,"smallFeatureCulling",!1);this.addField_SFFloat(a,"smallFeatureThreshold",1);this.addField_SFBool(a,"occlusionCulling",!1);this.addField_SFFloat(a,"occlusionVisibilityThreshold",
0);this.addField_SFBool(a,"lowPriorityCulling",!1);this.addField_SFFloat(a,"lowPriorityThreshold",1);this.addField_SFBool(a,"tessellationDetailCulling",!1);this.addField_SFFloat(a,"tessellationErrorThreshold",0);this.addField_SFBool(a,"enableARC",!1);this.addField_SFFloat(a,"minFrameRate",1);this.addField_SFFloat(a,"maxFrameRate",62.5);this.addField_SFFloat(a,"userDataFactor",-1);this.addField_SFFloat(a,"smallFeatureFactor",-1);this.addField_SFFloat(a,"occlusionVisibilityFactor",-1);this.addField_SFFloat(a,
"lowPriorityFactor",-1);this.addField_SFFloat(a,"tessellationErrorFactor",-1);this.checkSanity()},{checkSanity:function(){var a=function(a,b,d,e){return a&&b==e?d:a||b==e?b:e};this._smallFeatureThreshold=a(this._vf.smallFeatureCulling,this._vf.smallFeatureThreshold,10,0);this._lowPriorityThreshold=a(this._vf.lowPriorityCulling,this._vf.lowPriorityThreshold,0.5,1);this._occlusionVisibilityThreshold=a(this._vf.occlusionCulling,this._vf.occlusionVisibilityThreshold,1,0);this._tessellationErrorThreshold=
a(this._vf.tessellationDetailCulling,this._vf.tessellationErrorThreshold,1,0)}}));
x3dom.registerNodeType("X3DViewpointNode","Navigation",defineClass(x3dom.nodeTypes.X3DBindableNode,function(a){x3dom.nodeTypes.X3DViewpointNode.superClass.call(this,a);a&&a.xmlNode&&(a=a.xmlNode,a.resetView||a.getFieldOfView||a.getNear||a.getFar||(a.resetView=function(){var a=this._x3domNode;a.resetView();a._nameSpace.doc.needRender=!0},a.getFieldOfView=function(){return this._x3domNode.getFieldOfView()},a.getNear=function(){return this._x3domNode.getNear()},a.getFar=function(){return this._x3domNode.getFar()}))},
{activate:function(a){var c=this._nameSpace.doc._viewarea;a&&c.animateTo(this,a._autoGen?null:a);c._needNavigationMatrixUpdate=!0;x3dom.nodeTypes.X3DBindableNode.prototype.activate.call(this,a)},deactivate:function(a){x3dom.nodeTypes.X3DBindableNode.prototype.deactivate.call(this,a)},getTransformation:function(){return this.getCurrentTransform()},getCenterOfRotation:function(){return new x3dom.fields.SFVec3f(0,0,0)},getFieldOfView:function(){return 1.57079633},setView:function(a){var c=this.getCurrentTransform();
this._viewMatrix=a.mult(c)},resetView:function(){},getNear:function(){return 0.1},getFar:function(){return 1E4},getImgPlaneHeightAtDistOne:function(){return 2},getViewMatrix:function(){return null},getProjectionMatrix:function(a){return null}}));
x3dom.registerNodeType("Viewpoint","Navigation",defineClass(x3dom.nodeTypes.X3DViewpointNode,function(a){x3dom.nodeTypes.Viewpoint.superClass.call(this,a);this.addField_SFFloat(a,"fieldOfView",0.785398);this.addField_SFVec3f(a,"position",0,0,10);this.addField_SFRotation(a,"orientation",0,0,0,1);this.addField_SFVec3f(a,"centerOfRotation",0,0,0);this.addField_SFFloat(a,"zNear",-1);this.addField_SFFloat(a,"zFar",-1);this._viewMatrix=x3dom.fields.SFMatrix4f.translation(this._vf.position).mult(this._vf.orientation.toMatrix()).inverse();
this._projMatrix=null;this._lastAspect=1;this._zRatio=1E4;this._zNear=this._vf.zNear;this._zFar=this._vf.zFar;this._imgPlaneHeightAtDistOne=2*Math.tan(this._vf.fieldOfView/2)},{fieldChanged:function(a){"position"==a||"orientation"==a?this.resetView():"fieldOfView"==a||"zNear"==a||"zFar"==a?(this._projMatrix=null,this._zNear=this._vf.zNear,this._zFar=this._vf.zFar,this._imgPlaneHeightAtDistOne=2*Math.tan(this._vf.fieldOfView/2)):0<=a.indexOf("bind")&&this.bind(this._vf.bind)},getCenterOfRotation:function(){return this._vf.centerOfRotation},
getViewMatrix:function(){return this._viewMatrix},getFieldOfView:function(){return this._vf.fieldOfView},resetView:function(){this._viewMatrix=x3dom.fields.SFMatrix4f.translation(this._vf.position).mult(this._vf.orientation.toMatrix()).inverse()},getNear:function(){return this._zNear},getFar:function(){return this._zFar},getImgPlaneHeightAtDistOne:function(){return this._imgPlaneHeightAtDistOne},getProjectionMatrix:function(a){var c=this._vf.fieldOfView,b=this._vf.zFar,d=this._vf.zNear;if(0>=d||0>=
b){var d=0.8,b=1.2,e=this._nameSpace.doc._viewarea,f=e._scene,g=x3dom.fields.SFVec3f.copy(f._lastMin),h=x3dom.fields.SFVec3f.copy(f._lastMax).subtract(g),f=h.length()/2,k=e.getViewMatrix().inverse(),e=k.e3(),l=new x3dom.fields.SFVec3f(0,0,0),n=new x3dom.fields.SFVec3f(1,1,1),q=new x3dom.fields.Quaternion(0,0,1,0),m=new x3dom.fields.Quaternion(0,0,1,0);k.getTransform(l,q,n,m);l=k=n.x;l<n.y&&(l=n.y);k>n.y&&(k=n.y);l<n.z&&(l=n.z);k>n.z&&(k=n.z);1<l?d/=l:k>x3dom.fields.Eps&&1>k&&(b/=k);g=g.add(h.multiply(0.5));
g=e.subtract(g).length();f?(d=g>f?(g-f)*d:0,b*=g+f):(d=0.1,b=1E5);d=Math.max(d,Math.max(x3dom.fields.Eps,b/this._zRatio));b>this._vf.zNear&&0<this._vf.zNear&&(d=this._vf.zNear);this._vf.zFar>d&&(b=this._vf.zFar);b<=d&&(b=d+1)}null==this._projMatrix?this._projMatrix=x3dom.fields.SFMatrix4f.perspective(c,a,d,b):this._zNear!=d||this._zFar!=b?(c=d-b,this._projMatrix._22=(d+b)/c,this._projMatrix._23=2*d*b/c):this._lastAspect!=a&&(this._projMatrix._00=1/Math.tan(c/2)/a);this._zNear=d;this._zFar=b;this._lastAspect=
a;return this._projMatrix}}));
x3dom.registerNodeType("OrthoViewpoint","Navigation",defineClass(x3dom.nodeTypes.X3DViewpointNode,function(a){x3dom.nodeTypes.OrthoViewpoint.superClass.call(this,a);this.addField_MFFloat(a,"fieldOfView",[-1,-1,1,1]);this.addField_SFVec3f(a,"position",0,0,10);this.addField_SFRotation(a,"orientation",0,0,0,1);this.addField_SFVec3f(a,"centerOfRotation",0,0,0);this.addField_SFFloat(a,"zNear",0.1);this.addField_SFFloat(a,"zFar",1E4);this._projMatrix=this._viewMatrix=null;this._lastAspect=1;this.resetView()},
{fieldChanged:function(a){"position"==a||"orientation"==a?this.resetView():"fieldOfView"==a||"zNear"==a||"zFar"==a?(this._projMatrix=null,this.resetView()):0<=a.indexOf("bind")&&this.bind(this._vf.bind)},getCenterOfRotation:function(){return this._vf.centerOfRotation},getViewMatrix:function(){return this._viewMatrix},resetView:function(){var a=x3dom.fields.SFMatrix4f.translation(new x3dom.fields.SFVec3f((this._vf.fieldOfView[0]+this._vf.fieldOfView[2])/2,(this._vf.fieldOfView[1]+this._vf.fieldOfView[3])/
2,0));this._viewMatrix=x3dom.fields.SFMatrix4f.translation(this._vf.position).mult(this._vf.orientation.toMatrix());this._viewMatrix=this._viewMatrix.mult(a).inverse()},getNear:function(){return this._vf.zNear},getFar:function(){return this._vf.zFar},getProjectionMatrix:function(a){if(null==this._projMatrix||this._lastAspect!=a){var c=this.getNear(),b=this.getFar();this._projMatrix=x3dom.fields.SFMatrix4f.ortho(this._vf.fieldOfView[0],this._vf.fieldOfView[2],this._vf.fieldOfView[1],this._vf.fieldOfView[3],
c,b,a)}this._lastAspect=a;return this._projMatrix}}));
x3dom.registerNodeType("Viewfrustum","Navigation",defineClass(x3dom.nodeTypes.X3DViewpointNode,function(a){x3dom.nodeTypes.Viewfrustum.superClass.call(this,a);this.addField_SFMatrix4f(a,"modelview",1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1);this.addField_SFMatrix4f(a,"projection",1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1);this._viewMatrix=this._vf.modelview.transpose().inverse();this._projMatrix=this._vf.projection.transpose();this._centerOfRotation=new x3dom.fields.SFVec3f(0,0,0)},{fieldChanged:function(a){"modelview"==
a?this.resetView():"projection"==a?this._projMatrix=this._vf.projection.transpose():0<=a.indexOf("bind")&&this.bind(this._vf.bind)},getCenterOfRotation:function(){return this._centerOfRotation},getViewMatrix:function(){return this._viewMatrix},getFieldOfView:function(){return 2*Math.atan(1/this._projMatrix._11)},getImgPlaneHeightAtDistOne:function(){return 2/this._projMatrix._11},resetView:function(){this._viewMatrix=this._vf.modelview.transpose().inverse();this._centerOfRotation=new x3dom.fields.SFVec3f(0,
0,0)},getProjectionMatrix:function(a){return this._projMatrix}}));x3dom.registerNodeType("X3DNavigationInfoNode","Navigation",defineClass(x3dom.nodeTypes.X3DBindableNode,function(a){x3dom.nodeTypes.X3DNavigationInfoNode.superClass.call(this,a)}));
x3dom.registerNodeType("NavigationInfo","Navigation",defineClass(x3dom.nodeTypes.X3DNavigationInfoNode,function(a){x3dom.nodeTypes.NavigationInfo.superClass.call(this,a);this.addField_SFBool(a,"headlight",!0);this.addField_MFString(a,"type",["EXAMINE","ANY"]);this.addField_MFFloat(a,"typeParams",[-0.4,60,0.05,2.8]);this.addField_SFString(a,"explorationMode","all");this.addField_MFFloat(a,"avatarSize",[0.25,1.6,0.75]);this.addField_SFFloat(a,"visibilityLimit",0);this.addField_SFFloat(a,"speed",1);
this.addField_SFTime(a,"transitionTime",1);this.addField_MFString(a,"transitionType",["LINEAR"]);this._validTypes="none examine turntable fly freefly lookat lookaround walk game helicopter any".split(" ");this._heliUpdated=!1;a=this.checkType(this.getType());x3dom.debug.logInfo("NavType: "+a)},{fieldChanged:function(a){if("typeParams"==a)this._heliUpdated=!1;else if("type"==a){a=this.checkType(this.getType());switch(a){case "game":this._nameSpace.doc._viewarea.initMouseState();break;case "helicopter":this._heliUpdated=
!1}this._vf.type[0]=a;x3dom.debug.logInfo("Switch to "+a+" mode.")}},setType:function(a,c){var b=this.checkType(a.toLowerCase()),d=this.checkType(this.getType());switch(b){case "game":d!==b&&(c?c.initMouseState():this._nameSpace.doc._viewarea.initMouseState());break;case "helicopter":d!==b&&(this._heliUpdated=!1)}this._vf.type[0]=b;x3dom.debug.logInfo("Switch to "+b+" mode.")},getType:function(){var a=this._vf.type[0].toLowerCase();1>=a.length?a="none":"any"==a&&(a="examine");return a},getTypeParams:function(){var a=
this._vf.typeParams.length;return[1<=a?this._vf.typeParams[0]:-0.4,2<=a?this._vf.typeParams[1]:60,3<=a?this._vf.typeParams[2]:x3dom.fields.Eps,4<=a?this._vf.typeParams[3]:Math.PI-x3dom.fields.Eps]},setTypeParams:function(a){for(var c=0;c<a.length;c++)this._vf.typeParams[c]=a[c]},checkType:function(a){if(-1<this._validTypes.indexOf(a))return a;x3dom.debug.logWarning(a+" is no valid navigation type, use one of "+this._validTypes.toString());return"examine"},getExplorationMode:function(){switch(this._vf.explorationMode.toLowerCase()){case "all":return 7;
case "rotate":return 1;case "zoom":return 2;case "pan":return 4;case "none":return 0;default:return 7}}}));
x3dom.registerNodeType("Billboard","Navigation",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(a){x3dom.nodeTypes.Billboard.superClass.call(this,a);this.addField_SFVec3f(a,"axisOfRotation",0,1,0);this._eye=new x3dom.fields.SFVec3f(0,0,0);this._eyeViewUp=new x3dom.fields.SFVec3f(0,0,0);this._eyeLook=new x3dom.fields.SFVec3f(0,0,0)},{collectDrawableObjects:function(a,c,b,d,e){b&&1<this._parentNodes.length&&(b=!1);b&&(d=d||this.cacheInvalid())&&this.invalidateCache();e=c.cull(a,this.graphState(),
b,e);if(!(0>=e)){b=!1;var f=this.getVolume(),g=x3dom.fields.SFVec3f.MAX(),h=x3dom.fields.SFVec3f.MIN();f.getBounds(g,h);var k=c.viewMatrix,f=new x3dom.fields.SFVec3f(0,0,0),f=k.inverse().multMatrixPnt(f),k=k.mult(a);this._eye=a.inverse().multMatrixPnt(f);this._eyeViewUp=new x3dom.fields.SFVec3f(k._10,k._11,k._12);this._eyeLook=new x3dom.fields.SFVec3f(k._20,k._21,k._22);f=x3dom.fields.SFMatrix4f.identity();f=h.add(g).multiply(0.5);f=this._eye.subtract(f);this._vf.axisOfRotation.equals(new x3dom.fields.SFVec3f(0,
0,0),x3dom.fields.Eps)?(f=x3dom.fields.Quaternion.rotateFromTo(f,new x3dom.fields.SFVec3f(0,0,1)).toMatrix().transpose(),h=f.multMatrixPnt(new x3dom.fields.SFVec3f(0,1,0)).normalize(),g=f.multMatrixPnt(new x3dom.fields.SFVec3f(0,0,1)).normalize(),this._eyeViewUp.equals(new x3dom.fields.SFVec3f(0,0,0),x3dom.fields.Eps)||(g=x3dom.fields.Quaternion.rotateFromTo(this._eyeLook,g),h=g.toMatrix().transpose().multMatrixVec(h),h=x3dom.fields.Quaternion.rotateFromTo(this._eyeViewUp,h),f=g.toMatrix().transpose().mult(f),
f=h.toMatrix().transpose().mult(f))):(f=this._vf.axisOfRotation.cross(f).normalize(),0>this._eye.z&&(f=f.multiply(-1)),f=Math.asin(f.dot(new x3dom.fields.SFVec3f(0,0,1))),0>this._eye.z&&(f+=Math.PI),f=x3dom.fields.SFMatrix4f.parseRotation(this._vf.axisOfRotation.x+", "+this._vf.axisOfRotation.y+", "+this._vf.axisOfRotation.z+", "+-1*f));a=this.transformMatrix(a.mult(f));f=0;for(g=this._childNodes.length;f<g;f++)(h=this._childNodes[f])&&h.collectDrawableObjects(a,c,b,d,e)}}}));
x3dom.registerNodeType("Collision","Navigation",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(a){x3dom.nodeTypes.Collision.superClass.call(this,a);this.addField_SFBool(a,"enabled",!0);this.addField_SFNode("proxy",x3dom.nodeTypes.X3DGroupingNode)},{collectDrawableObjects:function(a,c,b,d,e){b&&1<this._parentNodes.length&&(b=!1);b&&(d=d||this.cacheInvalid())&&this.invalidateCache();e=c.cull(a,this.graphState(),b,e);if(!(0>=e)){var f;b?(this._graph.globalMatrix||(this._graph.globalMatrix=this.transformMatrix(a)),
a=this._graph.globalMatrix):a=this.transformMatrix(a);for(var g=0,h=this._childNodes.length;g<h;g++)(f=this._childNodes[g])&&f!==this._cf.proxy.node&&f.collectDrawableObjects(a,c,b,d,e)}}}));
x3dom.registerNodeType("X3DLODNode","Navigation",defineClass(x3dom.nodeTypes.X3DGroupingNode,function(a){x3dom.nodeTypes.X3DLODNode.superClass.call(this,a);this.addField_SFBool(a,"forceTransitions",!1);this.addField_SFVec3f(a,"center",0,0,0);this._eye=new x3dom.fields.SFVec3f(0,0,0)},{collectDrawableObjects:function(a,c,b,d,e){b&&1<this._parentNodes.length&&(b=!1);b&&(d=d||this.cacheInvalid())&&this.invalidateCache();e=c.cull(a,this.graphState(),b,e);0>=e||this.visitChildren(a,c,!1,d,e)},visitChildren:function(a,
c,b,d,e){}}));
x3dom.registerNodeType("LOD","Navigation",defineClass(x3dom.nodeTypes.X3DLODNode,function(a){x3dom.nodeTypes.LOD.superClass.call(this,a);this.addField_MFFloat(a,"range",[]);this._lastRangePos=-1},{visitChildren:function(a,c,b,d,e){var f=0,g=this._childNodes.length,h=this.getVolume(),k=x3dom.fields.SFVec3f.MAX(),l=x3dom.fields.SFVec3f.MIN();h.getBounds(k,l);var h=c.viewMatrix,n=new x3dom.fields.SFVec3f(0,0,0),n=h.inverse().multMatrixPnt(n);this._eye=a.inverse().multMatrixPnt(n);for(k=l.add(k).multiply(0.5).add(this._vf.center).subtract(this._eye).length();f<
this._vf.range.length&&k>this._vf.range[f];)f++;f&&f>=g&&(f=g-1);this._lastRangePos=f;f=this._childNodes[f];g&&f&&(a=this.transformMatrix(a),f.collectDrawableObjects(a,c,b,d,e))},getVolume:function(){var a=this._graph.volume;if(!this.volumeValid()&&this._vf.render){var c,b;if(0<=this._lastRangePos)(b=(c=this._childNodes[this._lastRangePos])&&!0===c._vf.render?c.getVolume():null)&&b.isValid()&&a.extendBounds(b.min,b.max);else for(var d=0,e=this._childNodes.length;d<e;d++)(c=this._childNodes[d])&&!0===
c._vf.render&&(b=c.getVolume())&&b.isValid()&&a.extendBounds(b.min,b.max)}return a},nodeChanged:function(){this.invalidateVolume()},fieldChanged:function(a){"render"!=a&&"center"!=a&&"range"!=a||this.invalidateVolume()}}));
x3dom.registerNodeType("DynamicLOD","Navigation",defineClass(x3dom.nodeTypes.X3DLODNode,function(a){x3dom.nodeTypes.DynamicLOD.superClass.call(this,a);this.addField_SFFloat(a,"subScale",0.5);this.addField_SFVec2f(a,"size",2,2);this.addField_SFVec2f(a,"subdivision",1,1);this.addField_SFNode("root",x3dom.nodeTypes.X3DShapeNode);this.addField_SFString(a,"urlHead","http://r");this.addField_SFString(a,"urlCenter",".ortho.tiles.virtualearth.net/tiles/h");this.addField_SFString(a,"urlTail",".png?g=-1");
this.rootGeometry=new x3dom.nodeTypes.Plane(a);this.level=0;this.quadrant=4;this.cell=""},{nodeChanged:function(){var a=this._cf.root.node;null!=a&&null==a._cf.geometry.node&&(this.rootGeometry._vf.size.setValues(this._vf.size),this.rootGeometry._vf.subdivision.setValues(this._vf.subdivision),this.rootGeometry._vf.center.setValues(this._vf.center),this.rootGeometry.fieldChanged("subdivision"),this._cf.root.node.addChild(this.rootGeometry),this.rootGeometry.nodeChanged(),this._cf.root.node.nodeChanged(),
this._nameSpace.doc.needRender=!0)},visitChildren:function(a,c,b,d,e){var f=this._cf.root.node;if(null!=f){var g=c.viewMatrix,h=new x3dom.fields.SFVec3f(0,0,0),h=g.inverse().multMatrixPnt(h);this._eye=a.inverse().multMatrixPnt(h);g=this._vf.center.subtract(this._eye).length();if(g>x3dom.fields.Eps&&g*this._vf.subScale<=this._vf.size.length())if(1>=this._childNodes.length)for(a=[new x3dom.fields.SFVec3f(-0.25*this._vf.size.x,0.25*this._vf.size.y,0),new x3dom.fields.SFVec3f(0.25*this._vf.size.x,0.25*
this._vf.size.y,0),new x3dom.fields.SFVec3f(-0.25*this._vf.size.x,-0.25*this._vf.size.y,0),new x3dom.fields.SFVec3f(0.25*this._vf.size.x,-0.25*this._vf.size.y,0)],f=0;4>f;f++)c=new x3dom.nodeTypes.DynamicLOD,c._nameSpace=this._nameSpace,c._eye.setValues(this._eye),c.level=this.level+1,c.quadrant=f,c.cell=this.cell+f,c._vf.urlHead=this._vf.urlHead,c._vf.urlCenter=this._vf.urlCenter,c._vf.urlTail=this._vf.urlTail,c._vf.center=this._vf.center.add(a[f]),c._vf.size=this._vf.size.multiply(0.5),c._vf.subdivision.setValues(this._vf.subdivision),
b=new x3dom.nodeTypes.Appearance,d=new x3dom.nodeTypes.ImageTexture,d._nameSpace=this._nameSpace,d._vf.url[0]=this._vf.urlHead+c.quadrant+this._vf.urlCenter+c.cell+this._vf.urlTail,b.addChild(d),d.nodeChanged(),d=new x3dom.nodeTypes.Shape,d._nameSpace=this._nameSpace,d.addChild(b),b.nodeChanged(),c.addChild(d,"root"),d.nodeChanged(),this.addChild(c),c.nodeChanged();else for(f=1;f<this._childNodes.length;f++)this._childNodes[f].collectDrawableObjects(a,c,b,d,e);else f.collectDrawableObjects(a,c,b,
d,e)}},getVolume:function(){var a=this._graph.volume;a.isValid()||(a.min.setValues(this._vf.center),a.min.x-=0.5*this._vf.size.x,a.min.y-=0.5*this._vf.size.y,a.min.z-=x3dom.fields.Eps,a.max.setValues(this._vf.center),a.max.x+=0.5*this._vf.size.x,a.max.y+=0.5*this._vf.size.y,a.max.z+=x3dom.fields.Eps);return a}}));x3dom.registerNodeType("X3DFontStyleNode","Text",defineClass(x3dom.nodeTypes.X3DNode,function(a){x3dom.nodeTypes.X3DFontStyleNode.superClass.call(this,a)}));
x3dom.registerNodeType("FontStyle","Text",defineClass(x3dom.nodeTypes.X3DFontStyleNode,function(a){x3dom.nodeTypes.FontStyle.superClass.call(this,a);this.addField_MFString(a,"family",["SERIF"]);this.addField_SFBool(a,"horizontal",!0);this.addField_MFString(a,"justify",["BEGIN"]);this.addField_SFString(a,"language","");this.addField_SFBool(a,"leftToRight",!0);this.addField_SFFloat(a,"size",1);this.addField_SFFloat(a,"spacing",1);this.addField_SFString(a,"style","PLAIN");this.addField_SFBool(a,"topToBottom",
!0)},{fieldChanged:function(a){"family"!=a&&"horizontal"!=a&&"justify"!=a&&"language"!=a&&"leftToRight"!=a&&"size"!=a&&"spacing"!=a&&"style"!=a&&"topToBottom"!=a||Array.forEach(this._parentNodes,function(c){c.fieldChanged(a)})}}));x3dom.nodeTypes.FontStyle.defaultNode=function(){x3dom.nodeTypes.FontStyle._defaultNode||(x3dom.nodeTypes.FontStyle._defaultNode=new x3dom.nodeTypes.FontStyle,x3dom.nodeTypes.FontStyle._defaultNode.nodeChanged());return x3dom.nodeTypes.FontStyle._defaultNode};
x3dom.registerNodeType("Text","Text",defineClass(x3dom.nodeTypes.X3DGeometryNode,function(a){x3dom.nodeTypes.Text.superClass.call(this,a);this.addField_MFString(a,"string",[]);this.addField_MFFloat(a,"length",[]);this.addField_SFFloat(a,"maxExtent",0);this.addField_SFNode("fontStyle",x3dom.nodeTypes.X3DFontStyleNode);this._mesh._positions[0]=[];this._mesh._normals[0]=[0,0,1,0,0,1,0,0,1,0,0,1];this._mesh._texCoords[0]=[0,0,1,0,1,1,0,1];this._mesh._colors[0]=[];this._mesh._indices[0]=[0,1,2,2,3,0];
this._mesh._invalidate=!0;this._mesh._numFaces=2;this._mesh._numCoords=4},{nodeChanged:function(){this._cf.fontStyle.node||this.addChild(x3dom.nodeTypes.FontStyle.defaultNode());this.invalidateVolume()},fieldChanged:function(a){if("string"==a||"length"==a||"maxExtent"==a)this.invalidateVolume(),Array.forEach(this._parentNodes,function(a){a.setAllDirty()})}}));
x3dom.registerNodeType("X3DSoundNode","Sound",defineClass(x3dom.nodeTypes.X3DChildNode,function(a){x3dom.nodeTypes.X3DSoundNode.superClass.call(this,a)}));
x3dom.registerNodeType("Sound","Sound",defineClass(x3dom.nodeTypes.X3DSoundNode,function(a){x3dom.nodeTypes.Sound.superClass.call(this,a);this.addField_SFNode("source",x3dom.nodeTypes.X3DSoundSourceNode)},{nodeChanged:function(){if(!this._cf.source.node&&this._xmlNode){x3dom.debug.logInfo("No AudioClip child node given, searching for &lt;audio&gt; elements...");try{Array.forEach(this._xmlNode.childNodes,function(a){if(1===a.nodeType&&(x3dom.debug.logInfo("### Found &lt;"+a.nodeName+"&gt; tag."),"audio"===
a.localName.toLowerCase())){var b=a.getAttribute("loop"),b=b?"loop"===b.toLowerCase():!1,d=a.cloneNode(!1);a.parentNode.removeChild(a);a=null;"Microsoft Internet Explorer"!=navigator.appName&&document.body.appendChild(d);d.addEventListener("canplaythrough",function(){d.play()},!0);d.addEventListener("ended",function(){b&&d.play()},!0)}})}catch(a){x3dom.debug.logException(a)}}}}));
x3dom.registerNodeType("X3DSoundSourceNode","Sound",defineClass(x3dom.nodeTypes.X3DTimeDependentNode,function(a){x3dom.nodeTypes.X3DSoundSourceNode.superClass.call(this,a)}));
x3dom.registerNodeType("AudioClip","Sound",defineClass(x3dom.nodeTypes.X3DSoundSourceNode,function(a){x3dom.nodeTypes.AudioClip.superClass.call(this,a);this.addField_MFString(a,"url",[]);this.addField_SFBool(a,"enabled",!0);this.addField_SFBool(a,"loop",!1);this._audio=null},{nodeChanged:function(){this._audio=document.createElement("audio");this._audio.setAttribute("autobuffer","true");"Microsoft Internet Explorer"!=navigator.appName&&document.body.appendChild(this._audio);for(var a=0;a<this._vf.url.length;a++){var c=
this._nameSpace.getURL(this._vf.url[a]);x3dom.debug.logInfo("Adding sound file: "+c);var b=document.createElement("source");b.setAttribute("src",c);this._audio.appendChild(b)}var d=this;this._audio.addEventListener("canplaythrough",function(){d._audio.play()},!0);this._audio.addEventListener("ended",function(){!0===d._vf.loop&&d._audio.play()},!0)},fieldChanged:function(a){if("enabled"===a)!0===this._vf.enabled?this._audio.play():this._audio.pause();else if("loop"===a)!0===this._vf.loop&&this._audio.play();
else if("url"===a){for(this._audio.pause();this._audio.hasChildNodes();)this._audio.removeChild(this._audio.firstChild);for(a=0;a<this._vf.url.length;a++){var c=this._nameSpace.getURL(this._vf.url[a]);x3dom.debug.logInfo("Adding sound file: "+c);var b=document.createElement("source");b.setAttribute("src",c);this._audio.appendChild(b)}}}}));
x3dom.registerNodeType("X3DTextureTransformNode","Texturing",defineClass(x3dom.nodeTypes.X3DAppearanceChildNode,function(a){x3dom.nodeTypes.X3DTextureTransformNode.superClass.call(this,a)}));
x3dom.registerNodeType("TextureTransform","Texturing",defineClass(x3dom.nodeTypes.X3DTextureTransformNode,function(a){x3dom.nodeTypes.TextureTransform.superClass.call(this,a);this.addField_SFVec2f(a,"center",0,0);this.addField_SFFloat(a,"rotation",0);this.addField_SFVec2f(a,"scale",1,1);this.addField_SFVec2f(a,"translation",0,0);a=new x3dom.fields.SFVec3f(-this._vf.center.x,-this._vf.center.y,1);var c=new x3dom.fields.SFVec3f(this._vf.center.x,this._vf.center.y,0),b=new x3dom.fields.SFVec3f(this._vf.translation.x,
this._vf.translation.y,0),d=new x3dom.fields.SFVec3f(this._vf.scale.x,this._vf.scale.y,0);this._trafo=x3dom.fields.SFMatrix4f.translation(a).mult(x3dom.fields.SFMatrix4f.scale(d)).mult(x3dom.fields.SFMatrix4f.rotationZ(this._vf.rotation)).mult(x3dom.fields.SFMatrix4f.translation(c.add(b)))},{fieldChanged:function(a){if("center"==a||"rotation"==a||"scale"==a||"translation"==a){a=new x3dom.fields.SFVec3f(-this._vf.center.x,-this._vf.center.y,1);var c=new x3dom.fields.SFVec3f(this._vf.center.x,this._vf.center.y,
0),b=new x3dom.fields.SFVec3f(this._vf.translation.x,this._vf.translation.y,0),d=new x3dom.fields.SFVec3f(this._vf.scale.x,this._vf.scale.y,0);this._trafo=x3dom.fields.SFMatrix4f.translation(a).mult(x3dom.fields.SFMatrix4f.scale(d)).mult(x3dom.fields.SFMatrix4f.rotationZ(this._vf.rotation)).mult(x3dom.fields.SFMatrix4f.translation(c.add(b)))}},texTransformMatrix:function(){return this._trafo}}));
x3dom.registerNodeType("TextureProperties","Texturing",defineClass(x3dom.nodeTypes.X3DNode,function(a){x3dom.nodeTypes.TextureProperties.superClass.call(this,a);this.addField_SFFloat(a,"anisotropicDegree",1);this.addField_SFColorRGBA(a,"borderColor",0,0,0,0);this.addField_SFInt32(a,"borderWidth",0);this.addField_SFString(a,"boundaryModeS","REPEAT");this.addField_SFString(a,"boundaryModeT","REPEAT");this.addField_SFString(a,"boundaryModeR","REPEAT");this.addField_SFString(a,"magnificationFilter","FASTEST");
this.addField_SFString(a,"minificationFilter","FASTEST");this.addField_SFString(a,"textureCompression","FASTEST");this.addField_SFFloat(a,"texturePriority",0);this.addField_SFBool(a,"generateMipMaps",!1)},{fieldChanged:function(a){this._vf.hasOwnProperty(a)&&(Array.forEach(this._parentNodes,function(a){Array.forEach(a._parentNodes,function(a){Array.forEach(a._parentNodes,function(a){a._dirty.texture=!0})})}),this._nameSpace.doc.needRender=!0)}}));
x3dom.registerNodeType("X3DTextureNode","Texturing",defineClass(x3dom.nodeTypes.X3DAppearanceChildNode,function(a){x3dom.nodeTypes.X3DTextureNode.superClass.call(this,a);this.addField_SFInt32(a,"origChannelCount",0);this.addField_MFString(a,"url",[]);this.addField_SFBool(a,"repeatS",!0);this.addField_SFBool(a,"repeatT",!0);this.addField_SFBool(a,"scale",!0);this.addField_SFBool(a,"withCredentials",!1);this.addField_SFNode("textureProperties",x3dom.nodeTypes.TextureProperties);this._isCanvas=this._needPerFrameUpdate=
!1;this._type="diffuseMap";this._blending=1==this._vf.origChannelCount||2==this._vf.origChannelCount},{invalidateGLObject:function(){Array.forEach(this._parentNodes,function(a){Array.forEach(a._parentNodes,function(a){a._dirty.texture=!0})});this._nameSpace.doc.needRender=!0},parentAdded:function(a){Array.forEach(a._parentNodes,function(a){a._dirty.texture=!0})},parentRemoved:function(a){Array.forEach(a._parentNodes,function(a){a._dirty.texture=!0})},fieldChanged:function(a){if("url"==a||"origChannelCount"==
a||"repeatS"==a||"repeatT"==a||"scale"==a||"withCredentials"==a){var c=this;Array.forEach(this._parentNodes,function(a){if(x3dom.isa(a,x3dom.nodeTypes.X3DAppearanceNode))a.nodeChanged(),Array.forEach(a._parentNodes,function(a){a._dirty.texture=!0});else if(x3dom.isa(a,x3dom.nodeTypes.ImageGeometry)){var d=null;c._xmlNode&&c._xmlNode.hasAttribute("containerField")&&(d=c._xmlNode.getAttribute("containerField"),a._dirty[d]=!0)}})}},getTexture:function(a){return 0===a?this:null},size:function(){return 1}}));
x3dom.registerNodeType("MultiTexture","Texturing",defineClass(x3dom.nodeTypes.X3DTextureNode,function(a){x3dom.nodeTypes.MultiTexture.superClass.call(this,a);this.addField_MFNode("texture",x3dom.nodeTypes.X3DTextureNode)},{getTexture:function(a){return 0<=a&&a<this._cf.texture.nodes.length?this._cf.texture.nodes[a]:null},getTextures:function(){return this._cf.texture.nodes},size:function(){return this._cf.texture.nodes.length}}));
x3dom.registerNodeType("Texture","Texturing",defineClass(x3dom.nodeTypes.X3DTextureNode,function(a){x3dom.nodeTypes.Texture.superClass.call(this,a);this.addField_SFBool(a,"hideChildren",!0);this._video=null;this._intervalID=0;this._canvas=null},{nodeChanged:function(){if(!this._vf.url.length&&this._xmlNode){x3dom.debug.logInfo("No Texture URL given, searching for &lt;img&gt; elements...");var a=this;try{Array.forEach(this._xmlNode.childNodes,function(b){if(1===b.nodeType){var c=b.getAttribute("src");
c?(a._vf.url.push(c),x3dom.debug.logInfo(a._vf.url[a._vf.url.length-1]),"video"===b.localName&&(a._needPerFrameUpdate=!0,a._video=document.createElement("video"),a._video.setAttribute("autobuffer","true"),document.getElementsByTagName("body")[0].appendChild(a._video),a._video.style.display="none")):"canvas"===b.localName.toLowerCase()&&(a._needPerFrameUpdate=!0,a._isCanvas=!0,a._canvas=b);b.style&&a._vf.hideChildren&&(b.style.display="none",b.style.visibility="hidden");x3dom.debug.logInfo("### Found &lt;"+
b.nodeName+"&gt; tag.")}})}catch(c){x3dom.debug.logException(c)}}}}));
x3dom.registerNodeType("RenderedTexture","Texturing",defineClass(x3dom.nodeTypes.X3DTextureNode,function(a){x3dom.nodeTypes.RenderedTexture.superClass.call(this,a);a?a.doc._nodeBag.renderTextures.push(this):x3dom.debug.logWarning("RenderedTexture: No runtime context found!");this.addField_SFNode("viewpoint",x3dom.nodeTypes.X3DViewpointNode);this.addField_SFNode("background",x3dom.nodeTypes.X3DBackgroundNode);this.addField_SFNode("fog",x3dom.nodeTypes.X3DFogNode);this.addField_SFNode("scene",x3dom.nodeTypes.X3DNode);
this.addField_MFNode("excludeNodes",x3dom.nodeTypes.X3DNode);this.addField_MFInt32(a,"dimensions",[128,128,4]);this.addField_SFString(a,"update","NONE");this.addField_SFBool(a,"showNormals",!1);this.addField_SFString(a,"stereoMode","NONE");this.addField_SFFloat(a,"interpupillaryDistance",0.064);this.hScreenSize=0.14976;this.vScreenSize=0.09356;this.vScreenCenter=this.vScreenSize/2;this.eyeToScreenDistance=0.041;this.lensSeparationDistance=0.0635;this.distortionK=[1,0.22,0.24,0];this.lensCenter=1-
2*this.lensSeparationDistance/this.hScreenSize;x3dom.debug.assert(3<=this._vf.dimensions.length);this._needRenderUpdate=this._clearParents=!0},{nodeChanged:function(){this._needRenderUpdate=this._clearParents=!0},fieldChanged:function(a){switch(a){case "excludeNodes":this._clearParents=!0;break;case "update":if("NEXT_FRAME_ONLY"==this._vf.update.toUpperCase()||"ALWAYS"==this._vf.update.toUpperCase())this._needRenderUpdate=!0}},getViewMatrix:function(){if(this._clearParents&&this._cf.excludeNodes.nodes.length){var a=
this;Array.forEach(this._cf.excludeNodes.nodes,function(b){for(var c=0,d=b._parentNodes.length;c<d;c++)b._parentNodes[c]===a&&(b._parentNodes.splice(c,1),b.parentRemoved(a))});this._clearParents=!1}var c=this._nameSpace.doc._scene.getViewpoint(),b=this._cf.viewpoint.node,d=null,d=null===b||b===c?this._nameSpace.doc._viewarea.getViewMatrix():b.getCurrentTransform().mult(b.getViewMatrix()),c=this._vf.stereoMode.toUpperCase();"NONE"!=c&&(b=this._vf.interpupillaryDistance/2,"RIGHT_EYE"==c&&(b=-b),d=(new x3dom.fields.SFMatrix4f(1,
0,0,b,0,1,0,0,0,0,1,0,0,0,0,1)).mult(d));return d},getProjectionMatrix:function(){var a=this._nameSpace.doc,c=a._scene.getViewpoint(),b=this._cf.viewpoint.node,d=null,e=this._vf.dimensions[0],f=this._vf.dimensions[1],g=this._vf.stereoMode.toUpperCase(),h="NONE"!=g;null===b||b===c?(d=x3dom.fields.SFMatrix4f.copy(a._viewarea.getProjectionMatrix()),h?(a=2*Math.atan(this.vScreenSize/(2*this.eyeToScreenDistance)),a=1/Math.tan(a/2)):a=1/Math.tan(c._vf.fieldOfView/2),d._00=a/(e/f),d._11=a):d=b.getProjectionMatrix(e/
f);h&&(e=this.lensCenter,"RIGHT_EYE"==g&&(e=-e),d=(new x3dom.fields.SFMatrix4f(1,0,0,e,0,1,0,0,0,0,1,0,0,0,0,1)).mult(d));return d},getWCtoCCMatrix:function(){var a=this.getViewMatrix();return this.getProjectionMatrix().mult(a)},parentRemoved:function(a){if(0===this._parentNodes.length){a=this.findX3DDoc();for(var c=0,b=a._nodeBag.renderTextures.length;c<b;c++)a._nodeBag.renderTextures[c]===this&&a._nodeBag.renderTextures.splice(c,1)}this._cf.scene.node&&this._cf.scene.node.parentRemoved(this)}}));
x3dom.registerNodeType("PixelTexture","Texturing",defineClass(x3dom.nodeTypes.X3DTextureNode,function(a){x3dom.nodeTypes.PixelTexture.superClass.call(this,a);this.addField_SFImage(a,"image",0,0,0)},{fieldChanged:function(a){"image"==a&&this.invalidateGLObject()}}));x3dom.registerNodeType("ImageTexture","Texturing",defineClass(x3dom.nodeTypes.Texture,function(a){x3dom.nodeTypes.ImageTexture.superClass.call(this,a)}));
x3dom.registerNodeType("MovieTexture","Texturing",defineClass(x3dom.nodeTypes.Texture,function(a){x3dom.nodeTypes.MovieTexture.superClass.call(this,a);this.addField_SFBool(a,"loop",!1);this.addField_SFFloat(a,"speed",1);this.addField_SFTime(a,"pauseTime",0);this.addField_SFFloat(a,"pitch",1);this.addField_SFTime(a,"resumeTime",0);this.addField_SFTime(a,"startTime",0);this.addField_SFTime(a,"stopTime",0)}));
x3dom.registerNodeType("X3DEnvironmentTextureNode","CubeMapTexturing",defineClass(x3dom.nodeTypes.X3DTextureNode,function(a){x3dom.nodeTypes.X3DEnvironmentTextureNode.superClass.call(this,a)},{getTexUrl:function(){return[]},getTexSize:function(){return-1}}));
x3dom.registerNodeType("ComposedCubeMapTexture","CubeMapTexturing",defineClass(x3dom.nodeTypes.X3DEnvironmentTextureNode,function(a){x3dom.nodeTypes.ComposedCubeMapTexture.superClass.call(this,a);this.addField_SFNode("back",x3dom.nodeTypes.Texture);this.addField_SFNode("front",x3dom.nodeTypes.Texture);this.addField_SFNode("bottom",x3dom.nodeTypes.Texture);this.addField_SFNode("top",x3dom.nodeTypes.Texture);this.addField_SFNode("left",x3dom.nodeTypes.Texture);this.addField_SFNode("right",x3dom.nodeTypes.Texture);
this._type="cubeMap"},{getTexUrl:function(){return[this._nameSpace.getURL(this._cf.back.node._vf.url[0]),this._nameSpace.getURL(this._cf.front.node._vf.url[0]),this._nameSpace.getURL(this._cf.bottom.node._vf.url[0]),this._nameSpace.getURL(this._cf.top.node._vf.url[0]),this._nameSpace.getURL(this._cf.left.node._vf.url[0]),this._nameSpace.getURL(this._cf.right.node._vf.url[0])]}}));
x3dom.registerNodeType("GeneratedCubeMapTexture","CubeMapTexturing",defineClass(x3dom.nodeTypes.X3DEnvironmentTextureNode,function(a){x3dom.nodeTypes.GeneratedCubeMapTexture.superClass.call(this,a);this.addField_SFInt32(a,"size",128);this.addField_SFString(a,"update","NONE");this._type="cubeMap";x3dom.debug.logWarning("GeneratedCubeMapTexture NYI")},{getTexSize:function(){return this._vf.size}}));
x3dom.registerNodeType("X3DTextureCoordinateNode","Texturing",defineClass(x3dom.nodeTypes.X3DGeometricPropertyNode,function(a){x3dom.nodeTypes.X3DTextureCoordinateNode.superClass.call(this,a)},{fieldChanged:function(a){"texCoord"!==a&&"point"!==a&&"parameter"!==a&&"mode"!==a||Array.forEach(this._parentNodes,function(a){a.fieldChanged("texCoord")})},parentAdded:function(a){a._mesh&&a._cf.texCoord.node!==this&&a.fieldChanged("texCoord")}}));
x3dom.registerNodeType("TextureCoordinate","Texturing",defineClass(x3dom.nodeTypes.X3DTextureCoordinateNode,function(a){x3dom.nodeTypes.TextureCoordinate.superClass.call(this,a);this.addField_MFVec2f(a,"point",[])}));x3dom.registerNodeType("TextureCoordinateGenerator","Texturing",defineClass(x3dom.nodeTypes.X3DTextureCoordinateNode,function(a){x3dom.nodeTypes.TextureCoordinateGenerator.superClass.call(this,a);this.addField_SFString(a,"mode","SPHERE");this.addField_MFFloat(a,"parameter",[])}));
x3dom.registerNodeType("MultiTextureCoordinate","Texturing",defineClass(x3dom.nodeTypes.X3DTextureCoordinateNode,function(a){x3dom.nodeTypes.MultiTextureCoordinate.superClass.call(this,a);this.addField_MFNode("texCoord",x3dom.nodeTypes.X3DTextureCoordinateNode)}));x3dom.registerNodeType("Uniform","Shaders",defineClass(x3dom.nodeTypes.Field,function(a){x3dom.nodeTypes.Uniform.superClass.call(this,a)}));
x3dom.registerNodeType("SurfaceShaderTexture","Shaders",defineClass(x3dom.nodeTypes.X3DTextureNode,function(a){x3dom.nodeTypes.SurfaceShaderTexture.superClass.call(this,a);this.addField_SFInt32(a,"textureCoordinatesId",0);this.addField_SFString(a,"channelMask","DEFAULT");this.addField_SFBool(a,"isSRGB",!1);this.addField_SFNode("texture",x3dom.nodeTypes.X3DTextureNode);this.addField_SFNode("textureTransform",x3dom.nodeTypes.X3DTextureTransformNode)}));
x3dom.registerNodeType("X3DShaderNode","Shaders",defineClass(x3dom.nodeTypes.X3DAppearanceChildNode,function(a){x3dom.nodeTypes.X3DShaderNode.superClass.call(this,a);this.addField_SFString(a,"language","")}));
x3dom.registerNodeType("CommonSurfaceShader","Shaders",defineClass(x3dom.nodeTypes.X3DShaderNode,function(a){x3dom.nodeTypes.CommonSurfaceShader.superClass.call(this,a);this.addField_SFInt32(a,"tangentTextureCoordinatesId",-1);this.addField_SFInt32(a,"binormalTextureCoordinatesId",-1);this.addField_SFVec3f(a,"emissiveFactor",0,0,0);this.addField_SFInt32(a,"emissiveTextureId",-1);this.addField_SFInt32(a,"emissiveTextureCoordinatesId",0);this.addField_SFString(a,"emissiveTextureChannelMask","rgb");
this.addField_SFVec3f(a,"ambientFactor",0.2,0.2,0.2);this.addField_SFInt32(a,"ambientTextureId",-1);this.addField_SFInt32(a,"ambientTextureCoordinatesId",0);this.addField_SFString(a,"ambientTextureChannelMask","rgb");this.addField_SFVec3f(a,"diffuseFactor",0.8,0.8,0.8);this.addField_SFInt32(a,"diffuseTextureId",-1);this.addField_SFInt32(a,"diffuseTextureCoordinatesId",0);this.addField_SFString(a,"diffuseTextureChannelMask","rgb");this.addField_SFVec3f(a,"specularFactor",0,0,0);this.addField_SFInt32(a,
"specularTextureId",-1);this.addField_SFInt32(a,"specularTextureCoordinatesId",0);this.addField_SFString(a,"specularTextureChannelMask","rgb");this.addField_SFFloat(a,"shininessFactor",0.2);this.addField_SFInt32(a,"shininessTextureId",-1);this.addField_SFInt32(a,"shininessTextureCoordinatesId",0);this.addField_SFString(a,"shininessTextureChannelMask","a");this.addField_SFString(a,"normalFormat","UNORM");this.addField_SFString(a,"normalSpace","TANGENT");this.addField_SFInt32(a,"normalTextureId",-1);
this.addField_SFInt32(a,"normalTextureCoordinatesId",0);this.addField_SFString(a,"normalTextureChannelMask","rgb");this.addField_SFVec3f(a,"reflectionFactor",0,0,0);this.addField_SFInt32(a,"reflectionTextureId",-1);this.addField_SFInt32(a,"reflectionTextureCoordinatesId",0);this.addField_SFString(a,"reflectionTextureChannelMask","rgb");this.addField_SFVec3f(a,"transmissionFactor",0,0,0);this.addField_SFInt32(a,"transmissionTextureId",-1);this.addField_SFInt32(a,"transmissionTextureCoordinatesId",
0);this.addField_SFString(a,"transmissionTextureChannelMask","rgb");this.addField_SFVec3f(a,"environmentFactor",1,1,1);this.addField_SFInt32(a,"environmentTextureId",-1);this.addField_SFInt32(a,"environmentTextureCoordinatesId",0);this.addField_SFString(a,"environmentTextureChannelMask","rgb");this.addField_SFFloat(a,"relativeIndexOfRefraction",1);this.addField_SFFloat(a,"fresnelBlend",0);this.addField_SFString(a,"displacementAxis","y");this.addField_SFFloat(a,"displacementFactor",255);this.addField_SFInt32(a,
"displacementTextureId",-1);this.addField_SFInt32(a,"displacementTextureCoordinatesId",0);this.addField_SFNode("emissiveTexture",x3dom.nodeTypes.X3DTextureNode);this.addField_SFNode("ambientTexture",x3dom.nodeTypes.X3DTextureNode);this.addField_SFNode("diffuseTexture",x3dom.nodeTypes.X3DTextureNode);this.addField_SFNode("specularTexture",x3dom.nodeTypes.X3DTextureNode);this.addField_SFNode("shininessTexture",x3dom.nodeTypes.X3DTextureNode);this.addField_SFNode("normalTexture",x3dom.nodeTypes.X3DTextureNode);
this.addField_SFNode("reflectionTexture",x3dom.nodeTypes.X3DTextureNode);this.addField_SFNode("transmissionTexture",x3dom.nodeTypes.X3DTextureNode);this.addField_SFNode("environmentTexture",x3dom.nodeTypes.X3DTextureNode);this.addField_SFNode("displacementTexture",x3dom.nodeTypes.X3DTextureNode);this.addField_SFNode("diffuseDisplacementTexture",x3dom.nodeTypes.X3DTextureNode);this.addField_SFVec3f(a,"normalScale",2,2,2);this.addField_SFVec3f(a,"normalBias",-1,-1,-1);this.addField_SFFloat(a,"alphaFactor",
1);this.addField_SFBool(a,"invertAlphaTexture",!1);this.addField_SFInt32(a,"alphaTextureId",-1);this.addField_SFInt32(a,"alphaTextureCoordinatesId",0);this.addField_SFString(a,"alphaTextureChannelMask","a");this.addField_SFNode("alphaTexture",x3dom.nodeTypes.X3DTextureNode);this._dirty={}},{getDiffuseMap:function(){return this._cf.diffuseTexture.node?(this._cf.diffuseTexture.node._cf.texture.node._type="diffuseMap",this._cf.diffuseTexture.node._cf.texture.node):null},getNormalMap:function(){return this._cf.normalTexture.node?
(this._cf.normalTexture.node._cf.texture.node._type="normalMap",this._cf.normalTexture.node._cf.texture.node):null},getAmbientMap:function(){return this._cf.ambientTexture.node?(this._cf.ambientTexture.node._cf.texture.node._type="ambientMap",this._cf.ambientTexture.node._cf.texture.node):null},getSpecularMap:function(){return this._cf.specularTexture.node?(this._cf.specularTexture.node._cf.texture.node._type="specularMap",this._cf.specularTexture.node._cf.texture.node):null},getShininessMap:function(){return this._cf.shininessTexture.node?
(this._cf.shininessTexture.node._cf.texture.node._type="shininessMap",this._cf.shininessTexture.node._cf.texture.node):null},getAlphaMap:function(){return this._cf.alphaTexture.node?(this._cf.alphaTexture.node._cf.texture.node._type="alphaMap",this._cf.alphaTexture.node._cf.texture.node):null},getDisplacementMap:function(){return this._cf.displacementTexture.node?(this._cf.displacementTexture.node._cf.texture.node._type="displacementMap",this._cf.displacementTexture.node._cf.texture.node):null},getDiffuseDisplacementMap:function(){return this._cf.diffuseDisplacementTexture.node?
(this._cf.diffuseDisplacementTexture.node._cf.texture.node._type="diffuseDisplacementMap",this._cf.diffuseDisplacementTexture.node._cf.texture.node):null},getTextures:function(){var a=[],c=this.getDiffuseMap();c&&a.push(c);(c=this.getNormalMap())&&a.push(c);(c=this.getSpecularMap())&&a.push(c);(c=this.getDisplacementMap())&&a.push(c);(c=this.getDiffuseDisplacementMap())&&a.push(c);return a}}));
x3dom.registerNodeType("ComposedShader","Shaders",defineClass(x3dom.nodeTypes.X3DShaderNode,function(a){x3dom.nodeTypes.ComposedShader.superClass.call(this,a);this.addField_MFNode("fields",x3dom.nodeTypes.Field);this.addField_MFNode("parts",x3dom.nodeTypes.ShaderPart);this._fragment=this._vertex=null;x3dom.nodeTypes.ComposedShader.ShaderInfoMsgShown||(x3dom.debug.logInfo("Current ComposedShader node implementation limitations:\nVertex attributes (if given in the standard X3D fields 'coord', 'color', 'normal', 'texCoord'), matrices and texture are provided as follows...\n(see also <a href='http://x3dom.org/x3dom/doc/help/composedShader.html'>http://x3dom.org/x3dom/doc/help/composedShader.html</a>)\n    attribute vec3 position;\n    attribute vec3 normal;\n    attribute vec2 texcoord;\n    attribute vec3 color;\n    uniform mat4 modelViewProjectionMatrix;\n    uniform mat4 modelViewMatrix;\n    uniform mat4 normalMatrix;\n    uniform mat4 viewMatrix;\n    uniform sampler2D tex;\n"),
x3dom.nodeTypes.ComposedShader.ShaderInfoMsgShown=!0)},{nodeChanged:function(){var a,c=this._cf.parts.nodes.length;for(a=0;a<c;a++)"vertex"==this._cf.parts.nodes[a]._vf.type.toLowerCase()?this._vertex=this._cf.parts.nodes[a]:"fragment"==this._cf.parts.nodes[a]._vf.type.toLowerCase()&&(this._fragment=this._cf.parts.nodes[a]);var b={},c=this._cf.fields.nodes.length;for(a=0;a<c;a++){var d=this._cf.fields.nodes[a]._vf.name;b.xmlNode=this._cf.fields.nodes[a]._xmlNode;var e=!1;if(void 0===b.xmlNode||null===
b.xmlNode)b.xmlNode=document.createElement("field"),e=!0;b.xmlNode.setAttribute(d,this._cf.fields.nodes[a]._vf.value);(new Function("ctx","name","this.addField_"+this._cf.fields.nodes[a]._vf.type+"(ctx, name);")).call(this,b,d);e&&(b.xmlNode=null)}Array.forEach(this._parentNodes,function(a){Array.forEach(a._parentNodes,function(a){a._cleanupGLObjects&&a._cleanupGLObjects();a.setAllDirty()})})},fieldChanged:function(a){var c,b=this._cf.fields.nodes.length;for(c=0;c<b;c++){var d=this._cf.fields.nodes[c]._vf.name;
if(d===a){a=this._cf.fields.nodes[c]._vf.value;try{this._vf[d].setValueByStr(a)}catch(e){try{switch((typeof this._vf[d]).toString()){case "number":this._vf[d]=+a;break;case "boolean":this._vf[d]="true"===a.toLowerCase();break;case "string":this._vf[d]=a}}catch(f){x3dom.debug.logError("setValueByStr() NYI for "+typeof this._vf[d])}}break}}"url"===d&&Array.forEach(this._parentNodes,function(a){Array.forEach(a._parentNodes,function(a){a._dirty.shader=!0})})},parentAdded:function(a){a.nodeChanged()}}));
x3dom.nodeTypes.ComposedShader.ShaderInfoMsgShown=!1;
x3dom.registerNodeType("ShaderPart","Shaders",defineClass(x3dom.nodeTypes.X3DNode,function(a){x3dom.nodeTypes.ShaderPart.superClass.call(this,a);this.addField_MFString(a,"url",[]);this.addField_SFString(a,"type","VERTEX");x3dom.debug.assert("vertex"==this._vf.type.toLowerCase()||"fragment"==this._vf.type.toLowerCase())},{nodeChanged:function(){var a;a=this._xmlNode;if(void 0!==a&&null!==a){var c=this;if(c._vf.url.length&&-1==c._vf.url[0].indexOf("\n")){var b=new XMLHttpRequest;b.open("GET",encodeURI(c._nameSpace.getURL(c._vf.url[0])),
!1);b.onload=function(){c._vf.url=new x3dom.fields.MFString([]);c._vf.url.push(b.response)};b.onerror=function(){x3dom.debug.logError("Could not load file '"+c._vf.url[0]+"'.")};b.send(null)}else{c._vf.url.length&&(c._vf.url=new x3dom.fields.MFString([]));try{c._vf.url.push(a.childNodes[1].nodeValue),a.removeChild(a.childNodes[1])}catch(d){Array.forEach(a.childNodes,function(a){3===a.nodeType?c._vf.url.push(a.nodeValue):4===a.nodeType&&c._vf.url.push(a.data);a.parentNode.removeChild(a)})}}}Array.forEach(this._parentNodes,
function(a){a.nodeChanged()})},fieldChanged:function(a){"url"===a&&Array.forEach(this._parentNodes,function(a){a.fieldChanged("url")})},parentAdded:function(a){a.nodeChanged()}}));x3dom.registerNodeType("X3DVertexAttributeNode","Shaders",defineClass(x3dom.nodeTypes.X3DGeometricPropertyNode,function(a){x3dom.nodeTypes.X3DVertexAttributeNode.superClass.call(this,a);this.addField_SFString(a,"name","")}));
x3dom.registerNodeType("FloatVertexAttribute","Shaders",defineClass(x3dom.nodeTypes.X3DVertexAttributeNode,function(a){x3dom.nodeTypes.FloatVertexAttribute.superClass.call(this,a);this.addField_SFInt32(a,"numComponents",4);this.addField_MFFloat(a,"value",[])}));x3dom.registerNodeType("X3DSpatialGeometryNode","Geometry3D",defineClass(x3dom.nodeTypes.X3DGeometryNode,function(a){x3dom.nodeTypes.X3DSpatialGeometryNode.superClass.call(this,a)}));
x3dom.registerNodeType("Plane","Geometry3D",defineClass(x3dom.nodeTypes.X3DSpatialGeometryNode,function(a){x3dom.nodeTypes.Plane.superClass.call(this,a);this.addField_SFVec2f(a,"size",2,2);this.addField_SFVec2f(a,"subdivision",1,1);this.addField_SFVec3f(a,"center",0,0,0);this.addField_MFString(a,"primType",["TRIANGLES"]);this._vf.primType.length&&(this._mesh._primType=this._vf.primType[0]);var c=this._vf.size.x,b=this._vf.size.y,d=this._vf.subdivision.x,e=this._vf.subdivision.y,f="Plane_"+c+"-"+b+
"-"+d+"-"+e+"-"+this._vf.center.x+"-"+this._vf.center.y+"-"+this._vf.center.z;if(a&&this._vf.useGeoCache&&void 0!==x3dom.geoCache[f])this._mesh=x3dom.geoCache[f];else{for(var g=a=0,h=c/d,k=b/e,c=c/2,b=b/2,g=0;g<=e;g++)for(a=0;a<=d;a++)this._mesh._positions[0].push(this._vf.center.x+a*h-c),this._mesh._positions[0].push(this._vf.center.y+g*k-b),this._mesh._positions[0].push(this._vf.center.z),this._mesh._normals[0].push(0),this._mesh._normals[0].push(0),this._mesh._normals[0].push(1),this._mesh._texCoords[0].push(a/
d),this._mesh._texCoords[0].push(g/e);for(g=1;g<=e;g++)for(a=0;a<d;a++)this._mesh._indices[0].push((g-1)*(d+1)+a),this._mesh._indices[0].push((g-1)*(d+1)+a+1),this._mesh._indices[0].push(g*(d+1)+a),this._mesh._indices[0].push(g*(d+1)+a),this._mesh._indices[0].push((g-1)*(d+1)+a+1),this._mesh._indices[0].push(g*(d+1)+a+1);this._mesh._invalidate=!0;this._mesh._numFaces=this._mesh._indices[0].length/3;this._mesh._numCoords=this._mesh._positions[0].length/3;x3dom.geoCache[f]=this._mesh}},{fieldChanged:function(a){if("size"==
a||"center"==a){this._mesh._positions[0]=[];a=this._vf.size.x;var c=this._vf.size.y,b=this._vf.subdivision.x,d=this._vf.subdivision.y,e=0,f=0,g=a/b,h=c/d;a/=2;c/=2;for(f=0;f<=d;f++)for(e=0;e<=b;e++)this._mesh._positions[0].push(this._vf.center.x+e*g-a),this._mesh._positions[0].push(this._vf.center.y+f*h-c),this._mesh._positions[0].push(this._vf.center.z);this.invalidateVolume();this._mesh._numCoords=this._mesh._positions[0].length/3;Array.forEach(this._parentNodes,function(a){a._dirty.positions=!0;
a.invalidateVolume()})}else if("subdivision"==a){this._mesh._positions[0]=[];this._mesh._indices[0]=[];this._mesh._normals[0]=[];this._mesh._texCoords[0]=[];a=this._vf.size.x;c=this._vf.size.y;b=this._vf.subdivision.x;d=this._vf.subdivision.y;f=e=0;g=a/b;h=c/d;a/=2;c/=2;for(f=0;f<=d;f++)for(e=0;e<=b;e++)this._mesh._positions[0].push(this._vf.center.x+e*g-a),this._mesh._positions[0].push(this._vf.center.y+f*h-c),this._mesh._positions[0].push(this._vf.center.z),this._mesh._normals[0].push(0),this._mesh._normals[0].push(0),
this._mesh._normals[0].push(1),this._mesh._texCoords[0].push(e/b),this._mesh._texCoords[0].push(f/d);for(f=1;f<=d;f++)for(e=0;e<b;e++)this._mesh._indices[0].push((f-1)*(b+1)+e),this._mesh._indices[0].push((f-1)*(b+1)+e+1),this._mesh._indices[0].push(f*(b+1)+e),this._mesh._indices[0].push(f*(b+1)+e),this._mesh._indices[0].push((f-1)*(b+1)+e+1),this._mesh._indices[0].push(f*(b+1)+e+1);this.invalidateVolume();this._mesh._numFaces=this._mesh._indices[0].length/3;this._mesh._numCoords=this._mesh._positions[0].length/
3;Array.forEach(this._parentNodes,function(a){a.setAllDirty();a.invalidateVolume()})}}}));
x3dom.registerNodeType("Box","Geometry3D",defineClass(x3dom.nodeTypes.X3DSpatialGeometryNode,function(a){x3dom.nodeTypes.Box.superClass.call(this,a);this.addField_SFVec3f(a,"size",2,2,2);a=this._vf.size.x;var c=this._vf.size.y,b=this._vf.size.z,d="Box_"+a+"-"+c+"-"+b;this._vf.useGeoCache&&void 0!==x3dom.geoCache[d]?this._mesh=x3dom.geoCache[d]:(a/=2,c/=2,b/=2,this._mesh._positions[0]=[-a,-c,-b,-a,c,-b,a,c,-b,a,-c,-b,-a,-c,b,-a,c,b,a,c,b,a,-c,b,-a,-c,-b,-a,-c,b,-a,c,b,-a,c,-b,a,-c,-b,a,-c,b,a,c,b,
a,c,-b,-a,c,-b,-a,c,b,a,c,b,a,c,-b,-a,-c,-b,-a,-c,b,a,-c,b,a,-c,-b],this._mesh._normals[0]=[0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0],this._mesh._texCoords[0]=[1,0,1,1,0,1,0,0,0,0,0,1,1,1,1,0,0,0,1,0,1,1,0,1,1,0,0,0,0,1,1,1,0,1,0,0,1,0,1,1,0,0,0,1,1,1,1,0],this._mesh._indices[0]=[0,1,2,2,3,0,4,7,5,5,7,6,8,9,10,10,11,8,12,14,13,14,12,15,16,17,18,18,19,16,20,22,21,22,20,23],this._mesh._invalidate=
!0,this._mesh._numFaces=12,this._mesh._numCoords=24,x3dom.geoCache[d]=this._mesh)},{fieldChanged:function(a){if("size"===a){a=this._vf.size.x/2;var c=this._vf.size.y/2,b=this._vf.size.z/2;this._mesh._positions[0]=[-a,-c,-b,-a,c,-b,a,c,-b,a,-c,-b,-a,-c,b,-a,c,b,a,c,b,a,-c,b,-a,-c,-b,-a,-c,b,-a,c,b,-a,c,-b,a,-c,-b,a,-c,b,a,c,b,a,c,-b,-a,c,-b,-a,c,b,a,c,b,a,c,-b,-a,-c,-b,-a,-c,b,a,-c,b,a,-c,-b];this.invalidateVolume();Array.forEach(this._parentNodes,function(a){a._dirty.positions=!0;a.invalidateVolume()})}}}));
x3dom.registerNodeType("Sphere","Geometry3D",defineClass(x3dom.nodeTypes.X3DSpatialGeometryNode,function(a){x3dom.nodeTypes.Sphere.superClass.call(this,a);this.addField_SFFloat(a,"radius",a?1:1E4);this.addField_SFVec2f(a,"subdivision",24,24);var c=1,b=this._vf.radius,d=this._vf.subdivision.x,e=this._vf.subdivision.y,f="Sphere_"+b+"-"+d+"-"+e;if(this._vf.useGeoCache&&void 0!==x3dom.geoCache[f])this._mesh=x3dom.geoCache[f];else{a&&(c=a.doc.properties.getProperty("PrimitiveQuality","Medium"));if(x3dom.Utils.isNumber(c))c=
parseFloat(c);else switch(c.toLowerCase()){case "low":c=0.3;break;case "medium":c=0.5;break;case "high":c=1}this._quality=c;a=Math.floor(d*c);for(var e=Math.floor(e*c),g,h,k,l,n,q,m,c=0;c<=a;c++)for(d=c*Math.PI/a,g=Math.sin(d),h=Math.cos(d),d=0;d<=e;d++)k=2*d*Math.PI/e,l=Math.sin(k),k=Math.cos(k),k=-k*g,n=-h,l=-l*g,q=0.25-d/e,m=c/a,this._mesh._positions[0].push(b*k),this._mesh._positions[0].push(b*n),this._mesh._positions[0].push(b*l),this._mesh._normals[0].push(k),this._mesh._normals[0].push(n),
this._mesh._normals[0].push(l),this._mesh._texCoords[0].push(q),this._mesh._texCoords[0].push(m);for(c=0;c<a;c++)for(d=0;d<e;d++)b=c*(e+1)+d,g=b+e+1,this._mesh._indices[0].push(b),this._mesh._indices[0].push(g),this._mesh._indices[0].push(b+1),this._mesh._indices[0].push(g),this._mesh._indices[0].push(g+1),this._mesh._indices[0].push(b+1);this._mesh._invalidate=!0;this._mesh._numFaces=this._mesh._indices[0].length/3;this._mesh._numCoords=this._mesh._positions[0].length/3;x3dom.geoCache[f]=this._mesh}},
{fieldChanged:function(a){if("radius"===a){this._mesh._positions[0]=[];var c=this._vf.radius;a=this._vf.subdivision.x;var b=this._vf.subdivision.y,d=this._quality,e;a=Math.floor(a*d);for(var d=Math.floor(b*d),f,g,h,k,l,b=0;b<=a;b++)for(e=b*Math.PI/a,f=Math.sin(e),g=Math.cos(e),e=0;e<=d;e++)h=2*e*Math.PI/d,k=Math.sin(h),h=Math.cos(h),h=-h*f,l=-g,k=-k*f,this._mesh._positions[0].push(c*h),this._mesh._positions[0].push(c*l),this._mesh._positions[0].push(c*k);this.invalidateVolume();this._mesh._numCoords=
this._mesh._positions[0].length/3;Array.forEach(this._parentNodes,function(a){a._dirty.positions=!0;a.invalidateVolume()})}else if("subdivision"===a){this._mesh._positions[0]=[];this._mesh._indices[0]=[];this._mesh._normals[0]=[];this._mesh._texCoords[0]=[];c=this._vf.radius;a=this._vf.subdivision.x;b=this._vf.subdivision.y;d=this._quality;a=Math.floor(a*d);for(var d=Math.floor(b*d),n,q,b=0;b<=a;b++)for(e=b*Math.PI/a,f=Math.sin(e),g=Math.cos(e),e=0;e<=d;e++)h=2*e*Math.PI/d,k=Math.sin(h),h=Math.cos(h),
h=-h*f,l=-g,k=-k*f,n=0.25-e/d,q=b/a,this._mesh._positions[0].push(c*h),this._mesh._positions[0].push(c*l),this._mesh._positions[0].push(c*k),this._mesh._normals[0].push(h),this._mesh._normals[0].push(l),this._mesh._normals[0].push(k),this._mesh._texCoords[0].push(n),this._mesh._texCoords[0].push(q);for(b=0;b<a;b++)for(e=0;e<d;e++)c=b*(d+1)+e,f=c+d+1,this._mesh._indices[0].push(c),this._mesh._indices[0].push(f),this._mesh._indices[0].push(c+1),this._mesh._indices[0].push(f),this._mesh._indices[0].push(f+
1),this._mesh._indices[0].push(c+1);this.invalidateVolume();this._mesh._numFaces=this._mesh._indices[0].length/3;this._mesh._numCoords=this._mesh._positions[0].length/3;Array.forEach(this._parentNodes,function(a){a.setAllDirty();a.invalidateVolume()})}}}));
x3dom.registerNodeType("Torus","Geometry3D",defineClass(x3dom.nodeTypes.X3DSpatialGeometryNode,function(a){x3dom.nodeTypes.Torus.superClass.call(this,a);var c=2*Math.PI;this.addField_SFFloat(a,"innerRadius",0.5);this.addField_SFFloat(a,"outerRadius",1);this.addField_SFFloat(a,"angle",c);this.addField_SFBool(a,"caps",!0);this.addField_SFVec2f(a,"subdivision",24,24);this.addField_SFBool(a,"insideOutsideRadius",!1);0>this._vf.angle?this._vf.angle=0:this._vf.angle>c&&(this._vf.angle=c);this._origCCW=
this._vf.ccw;a=this._vf.innerRadius;var b=this._vf.outerRadius;if(!0==this._vf.insideOutsideRadius){if(a>b){var d=a;a=b;b=d}d=(b-a)/2;b=a+d;a=d;this._vf.ccw=!this._origCCW}var e=this._vf.subdivision.x,d=this._vf.subdivision.y,e=Math.max(3,Math.round(this._vf.angle/c*e)),f="Torus_"+a+"_"+b+"_"+this._vf.angle+"_"+this._vf.subdivision+"-"+this._vf.caps;if(this._vf.useGeoCache&&void 0!==x3dom.geoCache[f])this._mesh=x3dom.geoCache[f];else{var g=this._vf.angle/e,h=c/d,k,l,n,q,m,p,s,t,w;for(n=k=0;k<=e;k++,
n+=g)for(m=Math.cos(n),p=Math.sin(n),q=l=0;l<=d;l++,q+=h)s=Math.cos(q),t=Math.sin(q),w=b+a*s,this._vf.insideOutsideRadius?(this._mesh._positions[0].push(m*w,a*t,-p*w),this._mesh._normals[0].push(m*s,t,-p*s)):(this._mesh._positions[0].push(m*w,-p*w,a*t),this._mesh._normals[0].push(m*s,-p*s,t)),this._mesh._texCoords[0].push(-k/e,l/d);for(k=0;k<d;k++)for(l=0;l<e;l++)this._mesh._indices[0].push(l*(d+1)+k),this._mesh._indices[0].push(l*(d+1)+k+1),this._mesh._indices[0].push((l+1)*(d+1)+k),this._mesh._indices[0].push(l*
(d+1)+k+1),this._mesh._indices[0].push((l+1)*(d+1)+k+1),this._mesh._indices[0].push((l+1)*(d+1)+k);if(this._vf.angle<c&&!0==this._vf.caps){c=this._mesh._positions[0].length/3;this._vf.insideOutsideRadius?(this._mesh._positions[0].push(b,0,0),this._mesh._normals[0].push(0,0,1)):(this._mesh._positions[0].push(b,0,0),this._mesh._normals[0].push(0,1,0));this._mesh._texCoords[0].push(0.5,0.5);for(q=l=0;l<=d;l++,q+=h)s=Math.cos(q),t=Math.sin(q),w=b+a*s,this._vf.insideOutsideRadius?(this._mesh._positions[0].push(w,
t*a,0),this._mesh._normals[0].push(0,0,1)):(this._mesh._positions[0].push(w,0,t*a),this._mesh._normals[0].push(0,1,0)),this._mesh._texCoords[0].push(0.5*(1+s),0.5*(1-t)),0<l&&(this._mesh._indices[0].push(c),this._mesh._indices[0].push(c+l),this._mesh._indices[0].push(c+l-1)),l==d&&(this._mesh._indices[0].push(c),this._mesh._indices[0].push(c+1),this._mesh._indices[0].push(c+l));m=Math.cos(this._vf.angle);p=Math.sin(this._vf.angle);c=this._mesh._positions[0].length/3;e=-p;g=-m;this._vf.insideOutsideRadius?
(this._mesh._positions[0].push(m*b,0,-p*b),this._mesh._normals[0].push(e,0,g)):(this._mesh._positions[0].push(m*b,-p*b,0),this._mesh._normals[0].push(e,g,0));this._mesh._texCoords[0].push(0.5,0.5);for(q=l=0;l<=d;l++,q+=h)s=Math.cos(q),t=Math.sin(q),w=b+a*s,this._vf.insideOutsideRadius?(this._mesh._positions[0].push(m*w,t*a,-p*w),this._mesh._normals[0].push(e,0,g)):(this._mesh._positions[0].push(m*w,-p*w,t*a),this._mesh._normals[0].push(e,g,0)),this._mesh._texCoords[0].push(1-0.5*(1+s),0.5*(1-t)),
0<l&&(this._mesh._indices[0].push(c),this._mesh._indices[0].push(c+l-1),this._mesh._indices[0].push(c+l)),l==d&&(this._mesh._indices[0].push(c),this._mesh._indices[0].push(c+l),this._mesh._indices[0].push(c+1))}this._mesh._invalidate=!0;this._mesh._numFaces=this._mesh._indices[0].length/3;this._mesh._numCoords=this._mesh._positions[0].length/3;x3dom.geoCache[f]=this._mesh}},{fieldChanged:function(a){if("innerRadius"==a||"outerRadius"==a||"subdivision"==a||"angle"==a||"insideOutsideRadius"==a||"caps"==
a){var c=2*Math.PI;0>this._vf.angle?this._vf.angle=0:this._vf.angle>c&&(this._vf.angle=c);a=this._vf.innerRadius;var b=this._vf.outerRadius;if(!0==this._vf.insideOutsideRadius){if(a>b){var d=a;a=b;b=d}d=(b-a)/2;b=a+d;a=d;this._vf.ccw=!this._origCCW}else this._vf.ccw=this._origCCW;var e=this._vf.subdivision.x,d=this._vf.subdivision.y,e=Math.max(3,Math.round(this._vf.angle/c*e)),f=this._vf.angle/e,g=c/d,h,k,l,n,q,m,p,s,t;this._mesh._positions[0]=[];this._mesh._normals[0]=[];this._mesh._texCoords[0]=
[];this._mesh._indices[0]=[];for(l=h=0;h<=e;h++,l+=f)for(q=Math.cos(l),m=Math.sin(l),n=k=0;k<=d;k++,n+=g)p=Math.cos(n),s=Math.sin(n),t=b+a*p,this._vf.insideOutsideRadius?(this._mesh._positions[0].push(q*t,a*s,-m*t),this._mesh._normals[0].push(q*p,s,-m*p)):(this._mesh._positions[0].push(q*t,-m*t,a*s),this._mesh._normals[0].push(q*p,-m*p,s)),this._mesh._texCoords[0].push(-h/e,k/d);for(h=0;h<d;h++)for(k=0;k<e;k++)this._mesh._indices[0].push(k*(d+1)+h),this._mesh._indices[0].push(k*(d+1)+h+1),this._mesh._indices[0].push((k+
1)*(d+1)+h),this._mesh._indices[0].push(k*(d+1)+h+1),this._mesh._indices[0].push((k+1)*(d+1)+h+1),this._mesh._indices[0].push((k+1)*(d+1)+h);if(this._vf.angle<c&&!0==this._vf.caps){c=this._mesh._positions[0].length/3;this._vf.insideOutsideRadius?(this._mesh._positions[0].push(b,0,0),this._mesh._normals[0].push(0,0,1)):(this._mesh._positions[0].push(b,0,0),this._mesh._normals[0].push(0,1,0));this._mesh._texCoords[0].push(0.5,0.5);for(n=k=0;k<=d;k++,n+=g)p=Math.cos(n),s=Math.sin(n),t=b+a*p,this._vf.insideOutsideRadius?
(this._mesh._positions[0].push(t,s*a,0),this._mesh._normals[0].push(0,0,1)):(this._mesh._positions[0].push(t,0,s*a),this._mesh._normals[0].push(0,1,0)),this._mesh._texCoords[0].push(0.5*(1+p),0.5*(1-s)),0<k&&(this._mesh._indices[0].push(c),this._mesh._indices[0].push(c+k),this._mesh._indices[0].push(c+k-1)),k==d&&(this._mesh._indices[0].push(c),this._mesh._indices[0].push(c+1),this._mesh._indices[0].push(c+k));q=Math.cos(this._vf.angle);m=Math.sin(this._vf.angle);c=this._mesh._positions[0].length/
3;e=-m;f=-q;this._vf.insideOutsideRadius?(this._mesh._positions[0].push(q*b,0,-m*b),this._mesh._normals[0].push(e,0,f)):(this._mesh._positions[0].push(q*b,-m*b,0),this._mesh._normals[0].push(e,f,0));this._mesh._texCoords[0].push(0.5,0.5);for(n=k=0;k<=d;k++,n+=g)p=Math.cos(n),s=Math.sin(n),t=b+a*p,this._vf.insideOutsideRadius?(this._mesh._positions[0].push(q*t,s*a,-m*t),this._mesh._normals[0].push(e,0,f)):(this._mesh._positions[0].push(q*t,-m*t,s*a),this._mesh._normals[0].push(e,f,0)),this._mesh._texCoords[0].push(1-
0.5*(1+p),0.5*(1-s)),0<k&&(this._mesh._indices[0].push(c),this._mesh._indices[0].push(c+k-1),this._mesh._indices[0].push(c+k)),k==d&&(this._mesh._indices[0].push(c),this._mesh._indices[0].push(c+k),this._mesh._indices[0].push(c+1))}this.invalidateVolume();this._mesh._numFaces=this._mesh._indices[0].length/3;this._mesh._numCoords=this._mesh._positions[0].length/3;Array.forEach(this._parentNodes,function(a){a.setAllDirty();a.invalidateVolume()})}}}));
x3dom.registerNodeType("Cone","Geometry3D",defineClass(x3dom.nodeTypes.X3DSpatialGeometryNode,function(a){x3dom.nodeTypes.Cone.superClass.call(this,a);this.addField_SFFloat(a,"bottomRadius",1);this.addField_SFFloat(a,"topRadius",0);this.addField_SFFloat(a,"height",2);this.addField_SFBool(a,"bottom",!0);this.addField_SFBool(a,"side",!0);this.addField_SFBool(a,"top",!0);this.addField_SFFloat(a,"subdivision",32);a="Cone_"+this._vf.bottomRadius+"_"+this._vf.height+"_"+this._vf.top+"_"+this._vf.bottom+
"_"+this._vf.side+"_"+this._vf.topRadius+"_"+this._vf.subdivision;if(this._vf.useGeoCache&&void 0!==x3dom.geoCache[a])this._mesh=x3dom.geoCache[a];else{var c=this._vf.bottomRadius,b=this._vf.height,d=this._vf.topRadius,e=this._vf.subdivision,f,g,h=2*Math.PI/e,k=(c-d)/b,l=1/Math.sqrt(1+k*k),n=0,q=0;if(this._vf.side&&0<b)for(var m=0,p=0,q=n=0;n<=e;n++)f=n*h,g=Math.sin(f),f=-Math.cos(f),d>x3dom.fields.Eps&&(m=g*d,p=f*d),this._mesh._positions[0].push(m,b/2,p),this._mesh._normals[0].push(g/l,k/l,f/l),
this._mesh._texCoords[0].push(1-n/e,1),this._mesh._positions[0].push(g*c,-b/2,f*c),this._mesh._normals[0].push(g/l,k/l,f/l),this._mesh._texCoords[0].push(1-n/e,0),0<n&&(this._mesh._indices[0].push(q),this._mesh._indices[0].push(q+2),this._mesh._indices[0].push(q+1),this._mesh._indices[0].push(q+1),this._mesh._indices[0].push(q+2),this._mesh._indices[0].push(q+3),q+=2);if(this._vf.bottom&&0<c){k=this._mesh._positions[0].length/3;for(n=e-1;0<=n;n--)f=n*h,g=c*Math.sin(f),f=-c*Math.cos(f),this._mesh._positions[0].push(g,
-b/2,f),this._mesh._normals[0].push(0,-1,0),this._mesh._texCoords[0].push(g/c/2+0.5,f/c/2+0.5);c=k+1;for(n=2;n<e;n++)this._mesh._indices[0].push(c),this._mesh._indices[0].push(k),c=k+n,this._mesh._indices[0].push(c)}if(this._vf.top&&d>x3dom.fields.Eps){k=this._mesh._positions[0].length/3;for(n=e-1;0<=n;n--)f=n*h,g=d*Math.sin(f),f=-d*Math.cos(f),this._mesh._positions[0].push(g,b/2,f),this._mesh._normals[0].push(0,1,0),this._mesh._texCoords[0].push(g/d/2+0.5,1-f/d/2+0.5);c=k+1;for(n=2;n<e;n++)this._mesh._indices[0].push(k),
this._mesh._indices[0].push(c),c=k+n,this._mesh._indices[0].push(c)}this._mesh._invalidate=!0;this._mesh._numFaces=this._mesh._indices[0].length/3;this._mesh._numCoords=this._mesh._positions[0].length/3;x3dom.geoCache[a]=this._mesh}},{fieldChanged:function(a){if("bottomRadius"==a||"topRadius"==a||"height"==a||"subdivision"==a||"bottom"==a||"top"==a||"side"==a){this._mesh._positions[0]=[];this._mesh._indices[0]=[];this._mesh._normals[0]=[];this._mesh._texCoords[0]=[];var c=this._vf.bottomRadius;a=
this._vf.height;var b=this._vf.topRadius,d=this._vf.subdivision,e,f,g=2*Math.PI/d,h=(c-b)/a,k=1/Math.sqrt(1+h*h),l=0,n=0;if(this._vf.side&&0<a)for(var q=0,m=0,n=l=0;l<=d;l++)e=l*g,f=Math.sin(e),e=-Math.cos(e),b>x3dom.fields.Eps&&(q=f*b,m=e*b),this._mesh._positions[0].push(q,a/2,m),this._mesh._normals[0].push(f/k,h/k,e/k),this._mesh._texCoords[0].push(1-l/d,1),this._mesh._positions[0].push(f*c,-a/2,e*c),this._mesh._normals[0].push(f/k,h/k,e/k),this._mesh._texCoords[0].push(1-l/d,0),0<l&&(this._mesh._indices[0].push(n),
this._mesh._indices[0].push(n+2),this._mesh._indices[0].push(n+1),this._mesh._indices[0].push(n+1),this._mesh._indices[0].push(n+2),this._mesh._indices[0].push(n+3),n+=2);if(this._vf.bottom&&0<c){h=this._mesh._positions[0].length/3;for(l=d-1;0<=l;l--)e=l*g,f=c*Math.sin(e),e=-c*Math.cos(e),this._mesh._positions[0].push(f,-a/2,e),this._mesh._normals[0].push(0,-1,0),this._mesh._texCoords[0].push(f/c/2+0.5,e/c/2+0.5);c=h+1;for(l=2;l<d;l++)this._mesh._indices[0].push(c),this._mesh._indices[0].push(h),
c=h+l,this._mesh._indices[0].push(c)}if(this._vf.top&&b>x3dom.fields.Eps){h=this._mesh._positions[0].length/3;for(l=d-1;0<=l;l--)e=l*g,f=b*Math.sin(e),e=-b*Math.cos(e),this._mesh._positions[0].push(f,a/2,e),this._mesh._normals[0].push(0,1,0),this._mesh._texCoords[0].push(f/b/2+0.5,1-e/b/2+0.5);c=h+1;for(l=2;l<d;l++)this._mesh._indices[0].push(h),this._mesh._indices[0].push(c),c=h+l,this._mesh._indices[0].push(c)}this.invalidateVolume();this._mesh._numFaces=this._mesh._indices[0].length/3;this._mesh._numCoords=
this._mesh._positions[0].length/3;Array.forEach(this._parentNodes,function(a){a.setAllDirty();a.invalidateVolume()})}}}));
x3dom.registerNodeType("Cylinder","Geometry3D",defineClass(x3dom.nodeTypes.X3DSpatialGeometryNode,function(a){x3dom.nodeTypes.Cylinder.superClass.call(this,a);this.addField_SFFloat(a,"radius",1);this.addField_SFFloat(a,"height",2);this.addField_SFBool(a,"bottom",!0);this.addField_SFBool(a,"top",!0);this.addField_SFFloat(a,"subdivision",32);this.addField_SFBool(a,"side",!0);a=this._vf.subdivision;var c="Cylinder_"+this._vf.radius+"_"+this._vf.height+"_"+this._vf.bottom+"_"+this._vf.top+"_"+this._vf.side+
"_"+this._vf.subdivision;if(this._vf.useGeoCache&&void 0!==x3dom.geoCache[c])this._mesh=x3dom.geoCache[c];else{var b=this._vf.radius,d=this._vf.height/2,e,f,g=2*Math.PI/a,h,k;if(this._vf.side)for(k=h=0;h<=a;h++)e=h*g,f=Math.sin(e),e=-Math.cos(e),this._mesh._positions[0].push(f*b,-d,e*b),this._mesh._normals[0].push(f,0,e),this._mesh._texCoords[0].push(1-h/a,0),this._mesh._positions[0].push(f*b,d,e*b),this._mesh._normals[0].push(f,0,e),this._mesh._texCoords[0].push(1-h/a,1),0<h&&(this._mesh._indices[0].push(k),
this._mesh._indices[0].push(k+1),this._mesh._indices[0].push(k+2),this._mesh._indices[0].push(k+2),this._mesh._indices[0].push(k+1),this._mesh._indices[0].push(k+3),k+=2);if(0<b){k=this._mesh._positions[0].length/3;if(this._vf.top){for(h=a-1;0<=h;h--)e=h*g,f=b*Math.sin(e),e=-b*Math.cos(e),this._mesh._positions[0].push(f,d,e),this._mesh._normals[0].push(0,1,0),this._mesh._texCoords[0].push(f/b/2+0.5,-e/b/2+0.5);f=k+1;for(h=2;h<a;h++)this._mesh._indices[0].push(k),this._mesh._indices[0].push(f),f=k+
h,this._mesh._indices[0].push(f);k=this._mesh._positions[0].length/3}if(this._vf.bottom){for(h=a-1;0<=h;h--)e=h*g,f=b*Math.sin(e),e=-b*Math.cos(e),this._mesh._positions[0].push(f,-d,e),this._mesh._normals[0].push(0,-1,0),this._mesh._texCoords[0].push(f/b/2+0.5,e/b/2+0.5);f=k+1;for(h=2;h<a;h++)this._mesh._indices[0].push(f),this._mesh._indices[0].push(k),f=k+h,this._mesh._indices[0].push(f)}}this._mesh._invalidate=!0;this._mesh._numFaces=this._mesh._indices[0].length/3;this._mesh._numCoords=this._mesh._positions[0].length/
3;x3dom.geoCache[c]=this._mesh}},{fieldChanged:function(a){if("radius"===a||"height"===a){this._mesh._positions[0]=[];a=this._vf.radius;var c=this._vf.height/2,b=this._vf.subdivision,d,e,f,g=2*Math.PI/b;if(this._vf.side)for(f=0;f<=b;f++)d=f*g,e=Math.sin(d),d=-Math.cos(d),this._mesh._positions[0].push(e*a,-c,d*a),this._mesh._positions[0].push(e*a,c,d*a);if(0<a){var h=this._mesh._positions[0].length/3;if(this._vf.top)for(f=b-1;0<=f;f--)d=f*g,e=a*Math.sin(d),d=-a*Math.cos(d),this._mesh._positions[0].push(e,
c,d)}if(this._vf.bottom)for(f=b-1;0<=f;f--)d=f*g,e=a*Math.sin(d),d=-a*Math.cos(d),this._mesh._positions[0].push(e,-c,d);this.invalidateVolume();this._mesh._numCoords=this._mesh._positions[0].length/3;Array.forEach(this._parentNodes,function(a){a._dirty.positions=!0;a.invalidateVolume()})}else if("subdivision"===a||"bottom"===a||"top"===a||"side"===a){this._mesh._positions[0]=[];this._mesh._indices[0]=[];this._mesh._normals[0]=[];this._mesh._texCoords[0]=[];a=this._vf.radius;c=this._vf.height/2;b=
this._vf.subdivision;g=2*Math.PI/b;h=0;if(this._vf.side)for(h=f=0;f<=b;f++)d=f*g,e=Math.sin(d),d=-Math.cos(d),this._mesh._positions[0].push(e*a,-c,d*a),this._mesh._normals[0].push(e,0,d),this._mesh._texCoords[0].push(1-f/b,0),this._mesh._positions[0].push(e*a,c,d*a),this._mesh._normals[0].push(e,0,d),this._mesh._texCoords[0].push(1-f/b,1),0<f&&(this._mesh._indices[0].push(h+0),this._mesh._indices[0].push(h+1),this._mesh._indices[0].push(h+2),this._mesh._indices[0].push(h+2),this._mesh._indices[0].push(h+
1),this._mesh._indices[0].push(h+3),h+=2);if(0<a){h=this._mesh._positions[0].length/3;if(this._vf.top){for(f=b-1;0<=f;f--)d=f*g,e=a*Math.sin(d),d=-a*Math.cos(d),this._mesh._positions[0].push(e,c,d),this._mesh._normals[0].push(0,1,0),this._mesh._texCoords[0].push(e/a/2+0.5,-d/a/2+0.5);e=h+1;for(f=2;f<b;f++)this._mesh._indices[0].push(h),this._mesh._indices[0].push(e),e=h+f,this._mesh._indices[0].push(e);h=this._mesh._positions[0].length/3}if(this._vf.bottom){for(f=b-1;0<=f;f--)d=f*g,e=a*Math.sin(d),
d=-a*Math.cos(d),this._mesh._positions[0].push(e,-c,d),this._mesh._normals[0].push(0,-1,0),this._mesh._texCoords[0].push(e/a/2+0.5,d/a/2+0.5);e=h+1;for(f=2;f<b;f++)this._mesh._indices[0].push(e),this._mesh._indices[0].push(h),e=h+f,this._mesh._indices[0].push(e)}}this.invalidateVolume();this._mesh._numFaces=this._mesh._indices[0].length/3;this._mesh._numCoords=this._mesh._positions[0].length/3;Array.forEach(this._parentNodes,function(a){a.setAllDirty();a.invalidateVolume()})}}}));
x3dom.registerNodeType("X3DBinaryContainerGeometryNode","Geometry3D",defineClass(x3dom.nodeTypes.X3DSpatialGeometryNode,function(a){x3dom.nodeTypes.X3DBinaryContainerGeometryNode.superClass.call(this,a);this.addField_SFVec3f(a,"position",0,0,0);this.addField_SFVec3f(a,"size",1,1,1);this.addField_MFInt32(a,"vertexCount",[0]);this.addField_MFString(a,"primType",["TRIANGLES"]);this._mesh._invalidate=!1;this._mesh._numCoords=0;this._mesh._numFaces=0;this._diameter=this._vf.size.length()},{getMin:function(){var a=
this._mesh._vol;a.isValid()||a.setBoundsByCenterSize(this._vf.position,this._vf.size);return a.min},getMax:function(){var a=this._mesh._vol;a.isValid()||a.setBoundsByCenterSize(this._vf.position,this._vf.size);return a.max},getVolume:function(){var a=this._mesh._vol;a.isValid()||a.setBoundsByCenterSize(this._vf.position,this._vf.size);return a},invalidateVolume:function(){},getCenter:function(){return this._vf.position},getDiameter:function(){return this._diameter}}));
x3dom.registerNodeType("BinaryGeometry","Geometry3D",defineClass(x3dom.nodeTypes.X3DBinaryContainerGeometryNode,function(a){x3dom.nodeTypes.BinaryGeometry.superClass.call(this,a);this.addField_SFString(a,"index","");this.addField_SFString(a,"coord","");this.addField_SFString(a,"normal","");this.addField_SFString(a,"texCoord","");this.addField_SFString(a,"color","");this.addField_SFString(a,"tangent","");this.addField_SFString(a,"binormal","");this.addField_SFString(a,"indexType","Uint16");this.addField_SFString(a,
"coordType","Float32");this.addField_SFString(a,"normalType","Float32");this.addField_SFString(a,"texCoordType","Float32");this.addField_SFString(a,"colorType","Float32");this.addField_SFString(a,"tangentType","Float32");this.addField_SFString(a,"binormalType","Float32");this.addField_SFBool(a,"normalAsSphericalCoordinates",!1);this.addField_SFBool(a,"rgbaColors",!1);this.addField_SFInt32(a,"numTexCoordComponents",2);this.addField_SFBool(a,"normalPerVertex",!0);this.addField_SFBool(a,"idsPerVertex",
!1);this._hasStrideOffset=!1;this._mesh._numPosComponents=this._vf.normalAsSphericalCoordinates?4:3;this._mesh._numTexComponents=this._vf.numTexCoordComponents;this._mesh._numColComponents=this._vf.rgbaColors?4:3;this._mesh._numNormComponents=this._vf.normalAsSphericalCoordinates?2:3;for(a=this._vertexCountSum=0;a<this._vf.vertexCount.length;++a)this._vertexCountSum+=this._vf.vertexCount[a]},{parentAdded:function(a){var c,b;c=this._vf.coord.lastIndexOf("#");b=this._vf.coord.lastIndexOf("+");0<=c&&
0<=b?(c=+this._vf.coord.substring(++c,b),b=+this._vf.coord.substring(b),a._coordStrideOffset=[b,c],this._hasStrideOffset=!0,0==c/8-Math.floor(c/8)&&(this._mesh._numPosComponents=4)):0<=b&&(b=+this._vf.coord.substring(b),a._coordStrideOffset=[b,0],0==b/8-Math.floor(b/8)&&(this._mesh._numPosComponents=4));c=this._vf.normal.lastIndexOf("#");b=this._vf.normal.lastIndexOf("+");0<=c&&0<=b?(c=+this._vf.normal.substring(++c,b),b=+this._vf.normal.substring(b),a._normalStrideOffset=[b,c]):0<=b&&(b=+this._vf.normal.substring(b),
a._normalStrideOffset=[b,0]);c=this._vf.texCoord.lastIndexOf("#");b=this._vf.texCoord.lastIndexOf("+");0<=c&&0<=b?(c=+this._vf.texCoord.substring(++c,b),b=+this._vf.texCoord.substring(b),a._texCoordStrideOffset=[b,c]):0<=b&&(b=+this._vf.texCoord.substring(b),a._texCoordStrideOffset=[b,0]);c=this._vf.color.lastIndexOf("#");b=this._vf.color.lastIndexOf("+");0<=c&&0<=b?(c=+this._vf.color.substring(++c,b),b=+this._vf.color.substring(b),a._colorStrideOffset=[b,c]):0<=b&&(b=+this._vf.color.substring(b),
a._colorStrideOffset=[b,0]);"Uint16"==this._vf.indexType||x3dom.caps.INDEX_UINT||x3dom.debug.logWarning("Index type "+this._vf.indexType+" problematic")},doIntersect:function(a){var c=this.getMin(),b=this.getMax();return a.intersect(c,b)&&a.enter<a.dist?(a.dist=a.enter,a.hitObject=this,a.hitPoint=a.pos.add(a.dir.multiply(a.enter)),!0):!1},getPrecisionMax:function(a){switch(this._vf[a]){case "Int8":return 127;case "Uint8":return 255;case "Int16":return 32767;case "Uint16":return 65535;case "Int32":return 2147483647;
case "Uint32":return 4294967295;default:return 1}}}));x3dom.registerNodeType("PopGeometryLevel","Geometry3D",defineClass(x3dom.nodeTypes.X3DGeometricPropertyNode,function(a){x3dom.nodeTypes.PopGeometryLevel.superClass.call(this,a);this.addField_SFString(a,"src","");this.addField_SFInt32(a,"numIndices",0);this.addField_SFInt32(a,"vertexDataBufferOffset",0)},{getSrc:function(){return this._vf.src},getNumIndices:function(){return this._vf.numIndices},getVertexDataBufferOffset:function(){return this._vf.vertexDataBufferOffset}}));
x3dom.registerNodeType("PopGeometry","Geometry3D",defineClass(x3dom.nodeTypes.X3DBinaryContainerGeometryNode,function(a){x3dom.nodeTypes.PopGeometry.superClass.call(this,a);this.addField_SFVec3f(a,"tightSize",1,1,1);this.addField_SFVec3f(a,"maxBBSize",1,1,1);this.addField_SFVec3f(a,"bbMinModF",0,0,0);this.addField_SFVec3f(a,"bbMaxModF",1,1,1);this.addField_SFVec3f(a,"bbMin",0,0,0);this.addField_SFVec3f(a,"bbShiftVec",0,0,0);this._vf.bbMinModF.x>this._vf.bbMaxModF.x&&(this._vf.bbShiftVec.x=1);this._vf.bbMinModF.y>
this._vf.bbMaxModF.y&&(this._vf.bbShiftVec.y=1);this._vf.bbMinModF.z>this._vf.bbMaxModF.z&&(this._vf.bbShiftVec.z=1);this.addField_MFNode("levels",x3dom.nodeTypes.PopGeometryLevel);this.addField_SFInt32(a,"attributeStride",0);this.addField_SFInt32(a,"positionOffset",0);this.addField_SFInt32(a,"normalOffset",0);this.addField_SFInt32(a,"texcoordOffset",0);this.addField_SFInt32(a,"colorOffset",0);this.addField_SFInt32(a,"numAnchorVertices",0);this.addField_SFInt32(a,"positionPrecision",2);this.addField_SFInt32(a,
"normalPrecision",1);this.addField_SFInt32(a,"texcoordPrecision",2);this.addField_SFInt32(a,"colorPrecision",1);this.addField_SFInt32(a,"minPrecisionLevel",-1);this.addField_SFInt32(a,"maxPrecisionLevel",-1);this.addField_SFFloat(a,"precisionFactor",1);this.addField_SFString(a,"coordType","Uint16");this.addField_SFString(a,"normalType","Uint8");this.addField_SFString(a,"texCoordType","Uint16");this.addField_SFString(a,"colorType","Uint8");this.addField_SFInt32(a,"vertexBufferSize",0);this.addField_SFBool(a,
"indexedRendering",!1);this.addField_SFBool(a,"sphericalNormals",!1);this.addField_MFInt32(a,"originalVertexCount",[0]);for(a=0;a<this._vf.vertexCount.length;++a)this._vf.originalVertexCount[a]=this._vf.vertexCount[a];this._vf.maxBBSize=x3dom.fields.SFVec3f.copy(this._vf.size);this._vf.size=this._vf.tightSize;this._diameter=this._vf.size.length();this._bbMinBySize=[Math.floor(this._vf.bbMin.x/this._vf.maxBBSize.x),Math.floor(this._vf.bbMin.y/this._vf.maxBBSize.y),Math.floor(this._vf.bbMin.z/this._vf.maxBBSize.z)];
this._volRadius=this._vf.size.length()/2;this._volLargestRadius=this._vf.maxBBSize.length()/2;this._mesh._numPosComponents=this._vf.sphericalNormals?4:3;this._mesh._numNormComponents=this._vf.sphericalNormals?2:3;this._mesh._numTexComponents=2;this._mesh._numColComponents=3;x3dom.nodeTypes.PopGeometry.numTotalVerts+=this.getVertexCount();x3dom.nodeTypes.PopGeometry.numTotalTris+=(this.hasIndex()?this.getTotalNumberOfIndices():this.getVertexCount())/3},{forceUpdateCoverage:function(){return!0},getBBoxShiftVec:function(){return this._vf.bbShiftVec},
getBBoxSize:function(){return this._vf.size},hasIndex:function(){return this._vf.indexedRendering},getTotalNumberOfIndices:function(){if(this._vf.indexedRendering){for(var a=0,c=0;c<this._vf.originalVertexCount.length;++c)a+=this._vf.originalVertexCount[c];return a}return 0},getVertexCount:function(){for(var a=0,c=0;c<this._vf.originalVertexCount.length;++c)a+=this._vf.originalVertexCount[c];return a},adaptVertexCount:function(a){for(var c=0,b=0;b<this._vf.originalVertexCount.length;++b)if(this._vf.originalVertexCount[b]+
c<=a)this._vf.vertexCount[b]=this._vf.originalVertexCount[b],c+=this._vf.originalVertexCount[b];else{this._vf.vertexCount[b]=a-c;break}},hasNormal:function(){return 0!=this._vf.normalOffset&&!this._vf.sphericalNormals},hasTexCoord:function(){return 0!=this._vf.texcoordOffset},hasColor:function(){return 0!=this._vf.colorOffset},getPositionPrecision:function(){return this._vf.positionPrecision},getNormalPrecision:function(){return this._vf.normalPrecision},getTexCoordPrecision:function(){return this._vf.texcoordPrecision},
getColorPrecision:function(){return this._vf.colorPrecision},getAttributeStride:function(){return this._vf.attributeStride},getPositionOffset:function(){return this._vf.positionOffset},getNormalOffset:function(){return this._vf.normalOffset},getTexCoordOffset:function(){return this._vf.texcoordOffset},getColorOffset:function(){return this._vf.colorOffset},getBufferTypeStringFromByteCount:function(a){switch(a){case 1:return"Uint8";case 2:return"Uint16";default:return 0}},getDataURLs:function(){for(var a=
[],c=0;c<this._cf.levels.nodes.length;++c)a.push(this._cf.levels.nodes[c].getSrc());return a},getNumIndicesByLevel:function(a){return this._cf.levels.nodes[a].getNumIndices()},getNumLevels:function(a){return this._cf.levels.nodes.length},getVertexDataBufferOffset:function(a){return this._cf.levels.nodes[a].getVertexDataBufferOffset()},getPrecisionMax:function(a){switch(this._vf[a]){case "Uint8":return 255;case "Uint16":return 65535;default:return 1}}}));
x3dom.nodeTypes.PopGeometry.ErrorToleranceFactor=1;x3dom.nodeTypes.PopGeometry.PrecisionFactorOnMove=1;x3dom.nodeTypes.PopGeometry.numRenderedVerts=0;x3dom.nodeTypes.PopGeometry.numRenderedTris=0;x3dom.nodeTypes.PopGeometry.numTotalVerts=0;x3dom.nodeTypes.PopGeometry.numTotalTris=0;x3dom.nodeTypes.PopGeometry.powLUT=[32768,16384,8192,4096,2048,1024,512,256,128,64,32,16,8,4,2,1];
x3dom.registerNodeType("BitLODGeoComponent","Geometry3D",defineClass(x3dom.nodeTypes.X3DGeometricPropertyNode,function(a){x3dom.nodeTypes.BitLODGeoComponent.superClass.call(this,a);this.addField_SFString(a,"src","");this.addField_MFInt32(a,"format",[]);this.addField_MFString(a,"attrib",[]);this._attribShift=[];this._attribShiftDec=[];this._mask=[];this._bitsPerComponent=0},{nodeChanged:function(){for(var a=0;a<this._vf.format.length;a++)this._bitsPerComponent+=this._vf.format[a]},getSrc:function(){return this._vf.src},
getFormat:function(){return this._vf.format},getAttrib:function(a){return this._vf.attrib[a]},getNumAttribs:function(){return this._vf.attrib.length}}));
x3dom.registerNodeType("BitLODGeometry","Geometry3D",defineClass(x3dom.nodeTypes.X3DBinaryContainerGeometryNode,function(a){x3dom.nodeTypes.BitLODGeometry.superClass.call(this,a);this.addField_SFString(a,"index","");this.addField_SFBool(a,"usesVLCIndices",!1);this.addField_SFBool(a,"clientSideNormals",!1);this.addField_SFBool(a,"normalAsSphericalCoordinates",!1);this.addField_SFBool(a,"normalPerVertex",!0);this.addField_MFNode("components",x3dom.nodeTypes.BitLODGeoComponent);this.addField_SFString(a,
"coordType","Uint16");this.addField_SFString(a,"normalType","Uint16");this.addField_SFString(a,"texCoordType","Uint16");this.addField_SFString(a,"colorType","Uint16");this._hasStrideOffset=!1;this._mesh._numTexComponents=2;this._mesh._numColComponents=3;this._vf.clientSideNormals=!1;this._vf.normalPerVertex=!this._vf.clientSideNormals;this._vf.normalAsSphericalCoordinates=this._vf.normalPerVertex;this._mesh._numNormComponents=this._vf.normalAsSphericalCoordinates?2:3},{parentAdded:function(a){a._coordStrideOffset=
[12,0];a._normalStrideOffset=[12,8];a._texCoordStrideOffset=[4,0];a._colorStrideOffset=[6,0]},hasIndex:function(){return this._vf.index.length?!0:!1},usesVLCIndices:function(){return!0==this._vf.usesVLCIndices},usesClientSideNormals:function(){return!0==this._vf.clientSideNormals},hasColor:function(){for(var a=0;a<this.getNumComponents();a++)for(var c=0;c<this.getComponent(a).getNumAttribs();c++)if("color3"==this.getComponent(a).getAttrib(c))return!0;return!1},hasTexCoord:function(){for(var a=0;a<
this.getNumComponents();a++)for(var c=0;c<this.getComponent(a).getNumAttribs();c++)if("texcoord2"==this.getComponent(a).getAttrib(c))return!0;return!1},getCoordNormalURLs:function(){for(var a=[],c=0;c<this.getNumComponents();c++)for(var b=0;b<this.getComponent(c).getNumAttribs();b++)"coord3"==this.getComponent(c).getAttrib(b)&&a.push(this.getComponent(c).getSrc());return a},getTexCoordURLs:function(){for(var a=[],c=0;c<this.getNumComponents();c++)for(var b=0;b<this.getComponent(c).getNumAttribs();b++)"texcoord2"==
this.getComponent(c).getAttrib(b)&&a.push(this.getComponent(c).getSrc());return a},getColorURLs:function(){for(var a=[],c=0;c<this.getNumComponents();c++)for(var b=0;b<this.getComponent(c).getNumAttribs();b++)"color3"==this.getComponent(c).getAttrib(b)&&a.push(this.getComponent(c).getSrc());return a},getNumPrimTypes:function(){return this._vf.primType.length},getPrimType:function(a){return a<this.getNumPrimTypes()?this._vf.primType[a].toUpperCase():""},getNumVertexCounts:function(){return this._vf.vertexCount.length},
getVertexCount:function(a){return a<this.getNumVertexCounts()?this._vf.vertexCount[a]:0},setVertexCount:function(a,c){this._vf.vertexCount[a]=c},getNumComponents:function(){return this._cf.components.nodes.length},getComponent:function(a){return this._cf.components.nodes[a]},getComponentsURLs:function(){for(var a=[],c=0;c<this._cf.components.nodes.length;c++)a[c]=this._cf.components.nodes[c].getSrc();return a},getComponentFormats:function(){for(var a=[],c=0;c<this._cf.components.nodes.length;c++)a[c]=
this._cf.components.nodes[c]._vf.format;return a},getComponentAttribs:function(){for(var a=[],c=0;c<this._cf.components.nodes.length;c++)a[c]=this._cf.components.nodes[c]._vf.attrib;return a},getNumVertices:function(){for(var a=0,c=0;c<this._vf.vertexCount.length;c++)a+=this._vf.vertexCount[c];return a},getAttribType:function(a){switch(a){case 8:return"Uint8";case 16:return"Uint16";case 32:return"Float32";default:return 0}},getPrecisionMax:function(a){switch(this._vf[a]){case "Int8":return 127;case "Uint8":return 255-
(Math.pow(2,8-this.loadedLevels)-1);case "Int16":return 32767;case "Uint16":return"normalType"===a?65535-(Math.pow(2,16-this.loadedLevels)-1):65535-(Math.pow(2,16-2*this.loadedLevels)-1);case "Int32":return 2147483647;case "Uint32":return 4294967295;default:return 1}}}));
x3dom.registerNodeType("ImageGeometry","Geometry3D",defineClass(x3dom.nodeTypes.X3DBinaryContainerGeometryNode,function(a){x3dom.nodeTypes.ImageGeometry.superClass.call(this,a);this.addField_SFVec2f(a,"implicitMeshSize",256,256);this.addField_SFInt32(a,"numColorComponents",3);this.addField_SFInt32(a,"numTexCoordComponents",2);this.addField_SFNode("index",x3dom.nodeTypes.X3DTextureNode);this.addField_MFNode("coord",x3dom.nodeTypes.X3DTextureNode);this.addField_SFNode("normal",x3dom.nodeTypes.X3DTextureNode);
this.addField_SFNode("texCoord",x3dom.nodeTypes.X3DTextureNode);this.addField_SFNode("color",x3dom.nodeTypes.X3DTextureNode);this._mesh._numColComponents=this._vf.numColorComponents;this._mesh._numTexComponents=this._vf.numTexCoordComponents;0==this._vf.implicitMeshSize.y&&(this._vf.implicitMeshSize.y=this._vf.implicitMeshSize.x);if("webgl"==x3dom.caps.BACKEND&&0<x3dom.caps.MAX_VERTEX_TEXTURE_IMAGE_UNITS)if(a="ImageGeometry_"+this._vf.implicitMeshSize.x+"_"+this._vf.implicitMeshSize.y,this._vf.useGeoCache&&
void 0!==x3dom.geoCache[a])this._mesh=x3dom.geoCache[a];else{for(var c=0;c<this._vf.implicitMeshSize.y;c++)for(var b=0;b<this._vf.implicitMeshSize.x;b++)this._mesh._positions[0].push(b/this._vf.implicitMeshSize.x,c/this._vf.implicitMeshSize.y,0);this._mesh._numFaces=this._mesh._indices[0].length/3;this._mesh._numCoords=this._mesh._positions[0].length/3;x3dom.geoCache[a]=this._mesh}this._vol=new x3dom.fields.BoxVolume;this._dirty={coord:!0,normal:!0,texCoord:!0,color:!0,index:!0}},{setGeoDirty:function(){this._dirty.coord=
!0;this._dirty.normal=!0;this._dirty.texCoords=!0;this._dirty.color=!0;this._dirty.index=!0},unsetGeoDirty:function(){this._dirty.coord=!1;this._dirty.normal=!1;this._dirty.texCoords=!1;this._dirty.color=!1;this._dirty.index=!1},nodeChanged:function(){Array.forEach(this._parentNodes,function(a){a._dirty.positions=!0;a._dirty.normals=!0;a._dirty.texcoords=!0;a._dirty.colors=!0});this._vol.invalidate()},fieldChanged:function(a){"index"==a||"coord"==a||"normal"==a||"texCoord"==a||"color"==a?(this._dirty[a]=
!0,this._vol.invalidate()):"implicitMeshSize"==a&&this._vol.invalidate()},getMin:function(){var a=this._vol;a.isValid()||a.setBoundsByCenterSize(this._vf.position,this._vf.size);return a.min},getMax:function(){var a=this._vol;a.isValid()||a.setBoundsByCenterSize(this._vf.position,this._vf.size);return a.max},getVolume:function(){var a=this._vol;a.isValid()||a.setBoundsByCenterSize(this._vf.position,this._vf.size);return a},numCoordinateTextures:function(){return this._cf.coord.nodes.length},getIndexTexture:function(){return this._cf.index.node?
(this._cf.index.node._type="IG_index",this._cf.index.node):null},getIndexTextureURL:function(){return this._cf.index.node?this._cf.index.node._vf.url:null},getCoordinateTexture:function(a){return this._cf.coord.nodes[a]?(this._cf.coord.nodes[a]._type="IG_coords"+a,this._cf.coord.nodes[a]):null},getCoordinateTextureURL:function(a){return this._cf.coord.nodes[a]?this._cf.coord.nodes[a]._vf.url:null},getCoordinateTextureURLs:function(){for(var a=[],c=0;c<this._cf.coord.nodes.length;c++)a.push(this._cf.coord.nodes[c]._vf.url);
return a},getNormalTexture:function(){return this._cf.normal.node?(this._cf.normal.node._type="IG_normals",this._cf.normal.node):null},getNormalTextureURL:function(){return this._cf.normal.node?this._cf.normal.node._vf.url:null},getTexCoordTexture:function(){return this._cf.texCoord.node?(this._cf.texCoord.node._type="IG_texCoords",this._cf.texCoord.node):null},getTexCoordTextureURL:function(){return this._cf.texCoord.node?this._cf.texCoord.node._vf.url:null},getColorTexture:function(){return this._cf.color.node?
(this._cf.color.node._type="IG_colors",this._cf.color.node):null},getColorTextureURL:function(){return this._cf.color.node?this._cf.color.node._vf.url:null},getTextures:function(){var a=[],c=this.getIndexTexture();c&&a.push(c);for(i=0;i<this.numCoordinateTextures();i++)(c=this.getCoordinateTexture(i))&&a.push(c);(c=this.getNormalTexture())&&a.push(c);(c=this.getTexCoordTexture())&&a.push(c);(c=this.getColorTexture())&&a.push(c);return a}}));
x3dom.registerNodeType("IndexedFaceSet","Geometry3D",defineClass(x3dom.nodeTypes.X3DComposedGeometryNode,function(a){x3dom.nodeTypes.IndexedFaceSet.superClass.call(this,a);this.addField_SFFloat(a,"creaseAngle",0);this.addField_SFBool(a,"convex",!0);this.addField_MFInt32(a,"coordIndex",[]);this.addField_MFInt32(a,"normalIndex",[]);this.addField_MFInt32(a,"colorIndex",[]);this.addField_MFInt32(a,"texCoordIndex",[])},{nodeChanged:function(){(new Date).getTime();this.handleAttribs();var a=this._vf.coordIndex;
a.length&&-1!=a[a.length-1]&&(a.push(-1),x3dom.debug.logWarning("Last index value should be -1."));var c=this._vf.normalIndex,b=this._vf.texCoordIndex,d=this._vf.colorIndex,e=!1,f=!1,g=!1,h=!1,k=!1,l=!1,n=this._vf.colorPerVertex,q=this._vf.normalPerVertex;0<c.length&&(f=!0);0<b.length&&(h=!0);0<d.length&&(l=!0);var m,p,s,t,e=this._cf.coord.node;x3dom.debug.assert(e);m=e.getPoints();var w=this._cf.normal.node;w?(e=!0,p=w._vf.vector):e=!1;var w="",z=2,u=this._cf.texCoord.node;x3dom.isa(u,x3dom.nodeTypes.MultiTextureCoordinate)&&
u._cf.texCoord.nodes.length&&(u=u._cf.texCoord.nodes[0]);u?u._vf.point?(g=!0,s=u._vf.point,x3dom.isa(u,x3dom.nodeTypes.TextureCoordinate3D)&&(z=3)):u._vf.mode&&(w=u._vf.mode):g=!1;this._mesh._numTexComponents=z;var v=3;(u=this._cf.color.node)?(k=!0,t=u._vf.color,x3dom.isa(u,x3dom.nodeTypes.ColorRGBA)&&(v=4)):k=!1;this._mesh._numColComponents=v;this._mesh._indices[0]=[];this._mesh._positions[0]=[];this._mesh._normals[0]=[];this._mesh._texCoords[0]=[];this._mesh._colors[0]=[];var r,A,D,x,y,B,C,E,F,
I,K,J,H,G;if(this._vf.creaseAngle<=x3dom.fields.Eps||m.length>x3dom.Utils.maxIndexableCoords||e&&f||g&&h||k&&l){this._vf.creaseAngle<=x3dom.fields.Eps&&x3dom.debug.logWarning("Fallback to inefficient multi-index mode since creaseAngle=0.");if(this._vf.convex)for(x=A=0,this._mesh._multiIndIndices=[],this._mesh._posSize=m.length,u=0;u<a.length;++u)if(-1==a[u])A=0,x++;else switch(f&&x3dom.debug.assert(-1!=c[u]),h&&x3dom.debug.assert(-1!=b[u]),l&&x3dom.debug.assert(-1!=d[u]),A){case 0:r=+a[u];B=f&&q?
+c[u]:f&&!q?+c[x]:q?r:x;F=h?+b[u]:r;J=l&&n?+d[u]:l&&!n?+d[x]:n?r:x;A=1;break;case 1:D=+a[u];C=f&&q?+c[u]:f&&!q?+c[x]:q?D:x;I=h?+b[u]:D;H=l&&n?+d[u]:l&&!n?+d[x]:n?D:x;A=2;break;case 2:y=+a[u];E=f&&q?+c[u]:f&&!q?+c[x]:q?y:x;K=h?+b[u]:y;G=l&&n?+d[u]:l&&!n?+d[x]:n?y:x;A=3;this._mesh._positions[0].push(m[r].x);this._mesh._positions[0].push(m[r].y);this._mesh._positions[0].push(m[r].z);this._mesh._positions[0].push(m[D].x);this._mesh._positions[0].push(m[D].y);this._mesh._positions[0].push(m[D].z);this._mesh._positions[0].push(m[y].x);
this._mesh._positions[0].push(m[y].y);this._mesh._positions[0].push(m[y].z);e&&(this._mesh._normals[0].push(p[B].x),this._mesh._normals[0].push(p[B].y),this._mesh._normals[0].push(p[B].z),this._mesh._normals[0].push(p[C].x),this._mesh._normals[0].push(p[C].y),this._mesh._normals[0].push(p[C].z),this._mesh._normals[0].push(p[E].x),this._mesh._normals[0].push(p[E].y),this._mesh._normals[0].push(p[E].z));this._mesh._multiIndIndices.push(r,D,y);k&&(this._mesh._colors[0].push(t[J].r),this._mesh._colors[0].push(t[J].g),
this._mesh._colors[0].push(t[J].b),4===v&&this._mesh._colors[0].push(t[J].a),this._mesh._colors[0].push(t[H].r),this._mesh._colors[0].push(t[H].g),this._mesh._colors[0].push(t[H].b),4===v&&this._mesh._colors[0].push(t[H].a),this._mesh._colors[0].push(t[G].r),this._mesh._colors[0].push(t[G].g),this._mesh._colors[0].push(t[G].b),4===v&&this._mesh._colors[0].push(t[G].a));g&&(this._mesh._texCoords[0].push(s[F].x),this._mesh._texCoords[0].push(s[F].y),3===z&&this._mesh._texCoords[0].push(s[F].z),this._mesh._texCoords[0].push(s[I].x),
this._mesh._texCoords[0].push(s[I].y),3===z&&this._mesh._texCoords[0].push(s[I].z),this._mesh._texCoords[0].push(s[K].x),this._mesh._texCoords[0].push(s[K].y),3===z&&this._mesh._texCoords[0].push(s[K].z));break;case 3:D=y;I=K;q&&(C=E);n&&(H=G);y=+a[u];if(f&&q)E=+c[u];else if(!f||q)E=q?y:x;K=h?+b[u]:y;if(l&&n)G=+d[u];else if(!l||n)G=n?y:x;this._mesh._positions[0].push(m[r].x);this._mesh._positions[0].push(m[r].y);this._mesh._positions[0].push(m[r].z);this._mesh._positions[0].push(m[D].x);this._mesh._positions[0].push(m[D].y);
this._mesh._positions[0].push(m[D].z);this._mesh._positions[0].push(m[y].x);this._mesh._positions[0].push(m[y].y);this._mesh._positions[0].push(m[y].z);e&&(this._mesh._normals[0].push(p[B].x),this._mesh._normals[0].push(p[B].y),this._mesh._normals[0].push(p[B].z),this._mesh._normals[0].push(p[C].x),this._mesh._normals[0].push(p[C].y),this._mesh._normals[0].push(p[C].z),this._mesh._normals[0].push(p[E].x),this._mesh._normals[0].push(p[E].y),this._mesh._normals[0].push(p[E].z));this._mesh._multiIndIndices.push(r,
D,y);k&&(this._mesh._colors[0].push(t[J].r),this._mesh._colors[0].push(t[J].g),this._mesh._colors[0].push(t[J].b),4===v&&this._mesh._colors[0].push(t[J].a),this._mesh._colors[0].push(t[H].r),this._mesh._colors[0].push(t[H].g),this._mesh._colors[0].push(t[H].b),4===v&&this._mesh._colors[0].push(t[H].a),this._mesh._colors[0].push(t[G].r),this._mesh._colors[0].push(t[G].g),this._mesh._colors[0].push(t[G].b),4===v&&this._mesh._colors[0].push(t[G].a));g&&(this._mesh._texCoords[0].push(s[F].x),this._mesh._texCoords[0].push(s[F].y),
3===z&&this._mesh._texCoords[0].push(s[F].z),this._mesh._texCoords[0].push(s[I].x),this._mesh._texCoords[0].push(s[I].y),3===z&&this._mesh._texCoords[0].push(s[I].z),this._mesh._texCoords[0].push(s[K].x),this._mesh._texCoords[0].push(s[K].y),3===z&&this._mesh._texCoords[0].push(s[K].z))}else{r=new x3dom.DoublyLinkedList;for(var M,L,u=x=D=0;u<a.length;++u)if(-1==a[u]){y=x3dom.EarClipping.getMultiIndexes(r);for(r=0;r<y.indices.length;r++)this._mesh._indices[0].push(D),D++,this._mesh._positions[0].push(y.point[r].x,
y.point[r].y,y.point[r].z),e&&this._mesh._normals[0].push(y.normals[r].x,y.normals[r].y,y.normals[r].z),k&&(this._mesh._colors[0].push(y.colors[r].r,y.colors[r].g,y.colors[r].b),4===v&&this._mesh._colors[0].push(y.colors[r].a)),g&&(this._mesh._texCoords[0].push(y.texCoords[r].x,y.texCoords[r].y),3===z&&this._mesh._texCoords[0].push(y.texCoords[r].z));r=new x3dom.DoublyLinkedList;x++}else e&&(A=f&&q?p[c[u]]:f&&!q?p[c[x]]:p[a[u]]),k&&(M=l&&n?t[d[u]]:l&&!n?t[d[x]]:n?t[a[u]]:t[x]),g&&(L=h?s[b[u]]:s[a[u]]),
r.appendNode(new x3dom.DoublyLinkedList.ListNode(m[a[u]],a[u],A,M,L));this._mesh.splitMesh()}e||this._mesh.calcNormals(this._vf.creaseAngle,this._vf.ccw);g||this._mesh.calcTexCoords(w)}else{A=0;if(this._vf.convex)for(u=0;u<a.length;++u)if(-1==a[u])A=0;else switch(A){case 0:B=+a[u];A=1;break;case 1:C=+a[u];A=2;break;case 2:E=+a[u];A=3;this._mesh._indices[0].push(B,C,E);break;case 3:C=E,E=+a[u],this._mesh._indices[0].push(B,C,E)}else for(r=new x3dom.DoublyLinkedList,u=0;u<a.length;++u)if(-1==a[u]){c=
x3dom.EarClipping.getIndexes(r);for(r=0;r<c.length;r++)this._mesh._indices[0].push(c[r]);r=new x3dom.DoublyLinkedList}else r.appendNode(new x3dom.DoublyLinkedList.ListNode(m[a[u]],a[u]));this._mesh._positions[0]=m.toGL();e?this._mesh._normals[0]=p.toGL():this._mesh.calcNormals(this._vf.creaseAngle,this._vf.ccw);g?(this._mesh._texCoords[0]=s.toGL(),this._mesh._numTexComponents=z):this._mesh.calcTexCoords(w);k&&(this._mesh._colors[0]=t.toGL(),this._mesh._numColComponents=v)}this.invalidateVolume();
this._mesh._numFaces=0;for(u=this._mesh._numCoords=0;u<this._mesh._positions.length;u++)a=this._mesh._indices[u].length,g=this._mesh._positions[u].length/3,this._mesh._numCoords+=g,this._mesh._numFaces=0<a?this._mesh._numFaces+a/3:this._mesh._numFaces+g/3},fieldChanged:function(a){if("coord"!=a&&"normal"!=a&&"texCoord"!=a&&"color"!=a&&"coordIndex"!=a)x3dom.debug.logWarning("IndexedFaceSet: fieldChanged for "+a+" not yet implemented!");else{var c=this._cf.coord.node._vf.point,b=c.length,d=this._cf.texCoord.node;
x3dom.isa(d,x3dom.nodeTypes.MultiTextureCoordinate)&&d._cf.texCoord.nodes.length&&(d=d._cf.texCoord.nodes[0]);if((this._vf.creaseAngle<=x3dom.fields.Eps||b>x3dom.Utils.maxIndexableCoords||0<this._vf.normalIndex.length&&this._cf.normal.node||0<this._vf.texCoordIndex.length&&d||0<this._vf.colorIndex.length&&this._cf.color.node)&&this._mesh._multiIndIndices){var e=!this._cf.normal.node&&"none"!=this._vf.normalUpdateMode.toLowerCase(),b=this._mesh._multiIndIndices.length;this._mesh._positions[0]=[];this._mesh._indices[0]=
[];if("coord"==a&&b){e&&(this._mesh._normals[0]=[]);for(d=0;d<b;d+=3){var f=c[this._mesh._multiIndIndices[d]],g=c[this._mesh._multiIndIndices[d+1]],h=c[this._mesh._multiIndIndices[d+2]];this._mesh._positions[0].push(f.x,f.y,f.z);this._mesh._positions[0].push(g.x,g.y,g.z);this._mesh._positions[0].push(h.x,h.y,h.z);e&&(f=f.subtract(g),g=g.subtract(h),g=f.cross(g).normalize(),this._vf.ccw||(g=g.negate()),this._mesh._normals[0].push(g.x,g.y,g.z),this._mesh._normals[0].push(g.x,g.y,g.z),this._mesh._normals[0].push(g.x,
g.y,g.z))}this.invalidateVolume();Array.forEach(this._parentNodes,function(a){a._dirty.positions=!0;e&&(a._dirty.normals=!0)})}else{this._mesh._normals[0]=[];this._mesh._texCoords[0]=[];this._mesh._colors[0]=[];c=this._vf.coordIndex;b=this._vf.normalIndex;a=this._vf.texCoordIndex;var k=this._vf.colorIndex,l=!1,n=!1,q=!1,m=!1,p=!1,s=!1,t=this._vf.colorPerVertex,w=this._vf.normalPerVertex;0<b.length&&(n=!0);0<a.length&&(m=!0);0<k.length&&(s=!0);var z,d=this._cf.coord.node;x3dom.debug.assert(d);z=d.getPoints();
(d=this._cf.normal.node)?(l=!0,g=d._vf.vector):l=!1;var u="",v=2,d=this._cf.texCoord.node;x3dom.isa(d,x3dom.nodeTypes.MultiTextureCoordinate)&&d._cf.texCoord.nodes.length&&(d=d._cf.texCoord.nodes[0]);d?d._vf.point?(q=!0,h=d._vf.point,x3dom.isa(d,x3dom.nodeTypes.TextureCoordinate3D)&&(v=3)):d._vf.mode&&(u=d._vf.mode):q=!1;this._mesh._numTexComponents=v;var r=3;(d=this._cf.color.node)?(p=!0,f=d._vf.color,x3dom.isa(d,x3dom.nodeTypes.ColorRGBA)&&(r=4)):p=!1;this._mesh._numColComponents=r;var A,D,x,y,
B,C,E,F,I,K,J,H,G,M,L;if(this._vf.convex)for(y=x=D=0,this._mesh._multiIndIndices=[],this._mesh._posSize=z.length,d=0;d<c.length;++d)if(-1==c[d])D=0,y++;else switch(n&&x3dom.debug.assert(-1!=b[d]),m&&x3dom.debug.assert(-1!=a[d]),s&&x3dom.debug.assert(-1!=k[d]),D){case 0:A=+c[d];E=n&&w?+b[d]:n&&!w?+b[y]:w?A:y;K=m?+a[d]:A;G=s&&t?+k[d]:s&&!t?+k[y]:t?A:y;D=1;break;case 1:B=+c[d];F=n&&w?+b[d]:n&&!w?+b[y]:w?B:y;J=m?+a[d]:B;M=s&&t?+k[d]:s&&!t?+k[y]:t?B:y;D=2;break;case 2:C=+c[d];I=n&&w?+b[d]:n&&!w?+b[y]:
w?C:y;H=m?+a[d]:C;L=s&&t?+k[d]:s&&!t?+k[y]:t?C:y;D=3;this._mesh._positions[0].push(z[A].x);this._mesh._positions[0].push(z[A].y);this._mesh._positions[0].push(z[A].z);this._mesh._positions[0].push(z[B].x);this._mesh._positions[0].push(z[B].y);this._mesh._positions[0].push(z[B].z);this._mesh._positions[0].push(z[C].x);this._mesh._positions[0].push(z[C].y);this._mesh._positions[0].push(z[C].z);l&&(this._mesh._normals[0].push(g[E].x),this._mesh._normals[0].push(g[E].y),this._mesh._normals[0].push(g[E].z),
this._mesh._normals[0].push(g[F].x),this._mesh._normals[0].push(g[F].y),this._mesh._normals[0].push(g[F].z),this._mesh._normals[0].push(g[I].x),this._mesh._normals[0].push(g[I].y),this._mesh._normals[0].push(g[I].z));this._mesh._multiIndIndices.push(A,B,C);p&&(this._mesh._colors[0].push(f[G].r),this._mesh._colors[0].push(f[G].g),this._mesh._colors[0].push(f[G].b),4===r&&this._mesh._colors[0].push(f[G].a),this._mesh._colors[0].push(f[M].r),this._mesh._colors[0].push(f[M].g),this._mesh._colors[0].push(f[M].b),
4===r&&this._mesh._colors[0].push(f[M].a),this._mesh._colors[0].push(f[L].r),this._mesh._colors[0].push(f[L].g),this._mesh._colors[0].push(f[L].b),4===r&&this._mesh._colors[0].push(f[L].a));q&&(this._mesh._texCoords[0].push(h[K].x),this._mesh._texCoords[0].push(h[K].y),3===v&&this._mesh._texCoords[0].push(h[K].z),this._mesh._texCoords[0].push(h[J].x),this._mesh._texCoords[0].push(h[J].y),3===v&&this._mesh._texCoords[0].push(h[J].z),this._mesh._texCoords[0].push(h[H].x),this._mesh._texCoords[0].push(h[H].y),
3===v&&this._mesh._texCoords[0].push(h[H].z));break;case 3:B=C;J=H;w&&(F=I);t&&(M=L);C=+c[d];if(n&&w)I=+b[d];else if(!n||w)I=w?C:y;H=m?+a[d]:C;if(s&&t)L=+k[d];else if(!s||t)L=t?C:y;this._mesh._positions[0].push(z[A].x);this._mesh._positions[0].push(z[A].y);this._mesh._positions[0].push(z[A].z);this._mesh._positions[0].push(z[B].x);this._mesh._positions[0].push(z[B].y);this._mesh._positions[0].push(z[B].z);this._mesh._positions[0].push(z[C].x);this._mesh._positions[0].push(z[C].y);this._mesh._positions[0].push(z[C].z);
l&&(this._mesh._normals[0].push(g[E].x),this._mesh._normals[0].push(g[E].y),this._mesh._normals[0].push(g[E].z),this._mesh._normals[0].push(g[F].x),this._mesh._normals[0].push(g[F].y),this._mesh._normals[0].push(g[F].z),this._mesh._normals[0].push(g[I].x),this._mesh._normals[0].push(g[I].y),this._mesh._normals[0].push(g[I].z));this._mesh._multiIndIndices.push(A,B,C);p&&(this._mesh._colors[0].push(f[G].r),this._mesh._colors[0].push(f[G].g),this._mesh._colors[0].push(f[G].b),4===r&&this._mesh._colors[0].push(f[G].a),
this._mesh._colors[0].push(f[M].r),this._mesh._colors[0].push(f[M].g),this._mesh._colors[0].push(f[M].b),4===r&&this._mesh._colors[0].push(f[M].a),this._mesh._colors[0].push(f[L].r),this._mesh._colors[0].push(f[L].g),this._mesh._colors[0].push(f[L].b),4===r&&this._mesh._colors[0].push(f[L].a));q&&(this._mesh._texCoords[0].push(h[K].x),this._mesh._texCoords[0].push(h[K].y),3===v&&this._mesh._texCoords[0].push(h[K].z),this._mesh._texCoords[0].push(h[J].x),this._mesh._texCoords[0].push(h[J].y),3===v&&
this._mesh._texCoords[0].push(h[J].z),this._mesh._texCoords[0].push(h[H].x),this._mesh._texCoords[0].push(h[H].y),3===v&&this._mesh._texCoords[0].push(h[H].z))}else{A=new x3dom.DoublyLinkedList;for(var N,O,d=y=x=0;d<c.length;++d)if(-1==c[d]){B=x3dom.EarClipping.getMultiIndexes(A);for(A=0;A<B.indices.length;A++)this._mesh._indices[0].push(x),x++,this._mesh._positions[0].push(B.point[A].x,B.point[A].y,B.point[A].z),l&&this._mesh._normals[0].push(B.normals[A].x,B.normals[A].y,B.normals[A].z),p&&(this._mesh._colors[0].push(B.colors[A].r,
B.colors[A].g,B.colors[A].b),4===r&&this._mesh._colors[0].push(B.colors[A].a)),q&&(this._mesh._texCoords[0].push(B.texCoords[A].x,B.texCoords[A].y),3===v&&this._mesh._texCoords[0].push(B.texCoords[A].z));A=new x3dom.DoublyLinkedList;y++}else l&&(D=n&&w?g[b[d]]:n&&!w?g[b[y]]:g[c[d]]),p&&(N=s&&t?f[k[d]]:s&&!t?f[k[y]]:f[c[d]]),q&&(O=m?h[a[d]]:h[c[d]]),A.appendNode(new x3dom.DoublyLinkedList.ListNode(z[c[d]],c[d],D,N,O));this._mesh.splitMesh()}l||this._mesh.calcNormals(this._vf.creaseAngle,this._vf.ccw);
q||this._mesh.calcTexCoords(u);this.invalidateVolume();this._mesh._numFaces=0;for(d=this._mesh._numCoords=0;d<this._mesh._positions.length;d++)g=this._mesh._indices[d].length,h=this._mesh._positions[d].length/3,this._mesh._numCoords+=h,this._mesh._numFaces=0<g?this._mesh._numFaces+g/3:this._mesh._numFaces+h/3;Array.forEach(this._parentNodes,function(a){a.setGeoDirty()})}}else if("coord"==a)e=!this._cf.normal.node&&"none"!=this._vf.normalUpdateMode.toLowerCase(),this._mesh._positions[0]=c.toGL(),e&&
this._mesh.calcNormals(this._vf.creaseAngle,this._vf.ccw),this.invalidateVolume(),Array.forEach(this._parentNodes,function(a){a._dirty.positions=!0;e&&(a._dirty.normals=!0);a.invalidateVolume()});else if("color"==a)c=this._cf.color.node._vf.color,this._mesh._colors[0]=c.toGL(),Array.forEach(this._parentNodes,function(a){a._dirty.colors=!0});else if("normal"==a)c=this._cf.normal.node._vf.vector,this._mesh._normals[0]=c.toGL(),Array.forEach(this._parentNodes,function(a){a._dirty.normals=!0});else if("texCoord"==
a)d=this._cf.texCoord.node,x3dom.isa(d,x3dom.nodeTypes.MultiTextureCoordinate)&&d._cf.texCoord.nodes.length&&(d=d._cf.texCoord.nodes[0]),c=d._vf.point,this._mesh._texCoords[0]=c.toGL(),Array.forEach(this._parentNodes,function(a){a._dirty.texcoords=!0});else if("coordIndex"==a){e=!this._cf.normal.node&&"none"!=this._vf.normalUpdateMode.toLowerCase();c=this._vf.coordIndex;D=0;b=c.length;this._mesh._indices[0]=[];for(d=0;d<b;++d)if(-1==c[d])D=0;else switch(D){case 0:A=+c[d];D=1;break;case 1:B=+c[d];
D=2;break;case 2:C=+c[d];D=3;this._mesh._indices[0].push(A,B,C);break;case 3:B=C,C=+c[d],this._mesh._indices[0].push(A,B,C)}e&&this._mesh.calcNormals(this._vf.creaseAngle,this._vf.ccw);Array.forEach(this._parentNodes,function(a){a._dirty.indexes=!0;e&&(a._dirty.normals=!0)})}}}}));x3dom.registerNodeType("X3DTexture3DNode","Texturing3D",defineClass(x3dom.nodeTypes.X3DTextureNode,function(a){x3dom.nodeTypes.X3DTexture3DNode.superClass.call(this,a)}));
x3dom.registerNodeType("ComposedTexture3D","Texturing3D",defineClass(x3dom.nodeTypes.X3DTexture3DNode,function(a){x3dom.nodeTypes.ComposedTexture3D.superClass.call(this,a);this.addField_MFNode("texture",x3dom.nodeTypes.X3DTexture3DNode)}));x3dom.registerNodeType("ImageTexture3D","Texturing3D",defineClass(x3dom.nodeTypes.X3DTexture3DNode,function(a){x3dom.nodeTypes.ImageTexture3D.superClass.call(this,a)}));
x3dom.registerNodeType("PixelTexture3D","Texturing3D",defineClass(x3dom.nodeTypes.X3DTexture3DNode,function(a){x3dom.nodeTypes.PixelTexture3D.superClass.call(this,a)}));x3dom.registerNodeType("TextureCoordinate3D","Texturing3D",defineClass(x3dom.nodeTypes.X3DTextureCoordinateNode,function(a){x3dom.nodeTypes.TextureCoordinate3D.superClass.call(this,a);this.addField_MFVec3f(a,"point",[])}));
x3dom.registerNodeType("TextureTransform3D","Texturing3D",defineClass(x3dom.nodeTypes.X3DTextureTransformNode,function(a){x3dom.nodeTypes.TextureTransform3D.superClass.call(this,a);this.addField_SFVec3f(a,"center",0,0,0);this.addField_SFRotation(a,"rotation",0,0,1,0);this.addField_SFVec3f(a,"scale",1,1,1);this.addField_SFVec3f(a,"translation",0,0,0);this.addField_SFRotation(a,"scaleOrientation",0,0,1,0)}));
x3dom.registerNodeType("TextureTransformMatrix3D","Texturing3D",defineClass(x3dom.nodeTypes.X3DTextureTransformNode,function(a){x3dom.nodeTypes.TextureTransformMatrix3D.superClass.call(this,a);this.addField_SFMatrix4f(a,"matrix",1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)}));
x3dom.registerNodeType("ImageTextureAtlas","Texturing",defineClass(x3dom.nodeTypes.Texture,function(a){x3dom.nodeTypes.ImageTextureAtlas.superClass.call(this,a);this.addField_SFInt32(a,"numberOfSlices",0);this.addField_SFInt32(a,"slicesOverX",0);this.addField_SFInt32(a,"slicesOverY",0)}));x3dom.versionInfo={version:"1.6.0-dev",revision:"4b57adecbb771db4151961cf7032bb5c53b788f9",date:"Wed Nov 13 17:33:04 2013 +0100"};